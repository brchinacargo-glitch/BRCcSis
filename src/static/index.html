<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRCcSis</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <!-- Bibliotecas para exportação -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #228B22 0%, #DC143C 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* Estilos específicos para botões de cotação */
        #btn-solicitar-cotacao,
        #btn-nova-cotacao,
        #salvar-cotacao,
        button[onclick*="cotacao"],
        .bg-orange-600 {
            background-color: #ea580c !important;
            color: white !important;
            border: none !important;
        }
        
        #btn-solicitar-cotacao:hover,
        #btn-nova-cotacao:hover,
        #salvar-cotacao:hover,
        button[onclick*="cotacao"]:hover,
        .bg-orange-600:hover {
            background-color: #c2410c !important;
        }
        
        /* Garantir que links com aparência de botão também funcionem */
        a.bg-orange-600 {
            background-color: #ea580c !important;
            color: white !important;
            text-decoration: none !important;
        }
        
        a.bg-orange-600:hover {
            background-color: #c2410c !important;
            color: white !important;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Estilos para abas de modalidade */
        .tab-modalidade {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .tab-modalidade.active {
            border-color: #ea580c !important;
            color: #ea580c !important;
        }
        
        .tab-modalidade:hover:not(.active) {
            border-color: #d1d5db !important;
            color: #374151 !important;
        }
        
        /* Estilos para cards de cotação */
        .cotacao-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .cotacao-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .cotacao-card.solicitada {
            border-left-color: #3b82f6;
        }
        
        .cotacao-card.aceita_operador {
            border-left-color: #f59e0b;
        }
        
        .cotacao-card.cotacao_enviada {
            border-left-color: #8b5cf6;
        }
        
        .cotacao-card.aceita_consultor {
            border-left-color: #10b981;
        }
        
        .cotacao-card.negada_consultor {
            border-left-color: #ef4444;
        }
        
        .cotacao-card.finalizada {
            border-left-color: #6b7280;
        }
        
        /* Badge de status */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-solicitada {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .status-aceita_operador {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .status-cotacao_enviada {
            background-color: #ede9fe;
            color: #6b21a8;
        }
        
        .status-aceita_consultor {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .status-negada_consultor {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .status-finalizada {
            background-color: #f3f4f6;
            color: #374151;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <img src="logo-brchina.png" alt="BRChina" class="h-10 mr-3">
                    <div>
                        <h1 class="text-2xl font-bold">BRCcSis</h1>
                        <p class="text-sm text-green-200">v1.3.4</p>
                    </div>
                </div>
                <nav class="hidden md:flex space-x-6">
                    <a href="#" class="hover:text-green-200 transition-colors" id="nav-dashboard">Dashboard</a>
                    <a href="#" class="hover:text-green-200 transition-colors" id="nav-empresas">Empresas</a>
                    <a href="#" class="hover:text-green-200 transition-colors" id="nav-cotacoes">Cotações</a>
                    <a href="#" class="hover:text-green-200 transition-colors" id="nav-analytics">Analytics</a>
                    <a href="#" class="hover:text-green-200 transition-colors" id="nav-cadastro">Cadastrar</a>
                    <button id="btn-logout" class="hover:text-green-200 transition-colors">
                        <i class="fas fa-sign-out-alt mr-1"></i>Sair
                    </button>
                </nav>
                <button class="md:hidden text-white">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Dashboard Section -->
    <section id="dashboard" class="container mx-auto px-6 py-8">
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Dashboard</h2>
            <p class="text-gray-600">Visão geral do sistema BRCcSis</p>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        <i class="fas fa-building text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total de Empresas</p>
                        <p class="text-2xl font-bold text-gray-900" id="total-empresas">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-red-100 text-red-600">
                        <i class="fas fa-certificate text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Certificadas</p>
                        <p class="text-2xl font-bold text-gray-900" id="empresas-certificadas">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        <i class="fas fa-warehouse text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Com Armazém</p>
                        <p class="text-2xl font-bold text-gray-900" id="empresas-armazem">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-red-100 text-red-600">
                        <i class="fas fa-globe text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Abrangência Nacional</p>
                        <p class="text-2xl font-bold text-gray-900" id="empresas-nacional">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Ações Rápidas</h3>
            <div class="grid grid-cols-1 md:grid-cols-8 gap-4">
                <button id="btn-cadastrar-nova" class="flex items-center justify-center p-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>
                    Cadastrar Nova Empresa
                </button>
                <button id="btn-buscar-empresas" class="flex items-center justify-center p-4 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                    <i class="fas fa-search mr-2"></i>
                    Buscar Empresas
                </button>
                <button id="btn-solicitar-cotacao" class="flex items-center justify-center p-4 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors">
                    <i class="fas fa-calculator mr-2"></i>
                    Solicitar Cotação
                </button>
                <button id="btn-exportar-dados" class="flex items-center justify-center p-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-download mr-2"></i>
                    Exportar Dados
                </button>
                <button id="btn-importar-dados" class="flex items-center justify-center p-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-upload mr-2"></i>
                    Importar Dados
                </button>
                <button id="btn-importar-excel" class="flex items-center justify-center p-4 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                    <i class="fas fa-file-excel mr-2"></i>
                    Importar Excel
                </button>
                <button id="btn-template-excel" class="flex items-center justify-center p-4 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                    <i class="fas fa-download mr-2"></i>
                    Baixar Template Excel
                </button>
                <button id="btn-administracao" class="flex items-center justify-center p-4 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors">
                    <i class="fas fa-users-cog mr-2"></i>
                    Administração
                </button>
            </div>
        </div>

        <!-- Analytics Dashboard -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Gráfico de Empresas por Região -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Empresas por Região</h3>
                    <i class="fas fa-map-marked-alt text-gray-400"></i>
                </div>
                <canvas id="chart-empresas-regiao" width="400" height="300" style="width: 100%; height: 300px;"></canvas>
            </div>

            <!-- Gráfico de Tipos de Carga -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Tipos de Carga</h3>
                    <i class="fas fa-boxes text-gray-400"></i>
                </div>
                <canvas id="chart-tipos-carga" width="400" height="300" style="width: 100%; height: 300px;"></canvas>
            </div>
        </div>

        <!-- Gráficos de Linha -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Crescimento de Empresas -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Crescimento Mensal</h3>
                    <i class="fas fa-chart-line text-gray-400"></i>
                </div>
                <canvas id="chart-crescimento" width="400" height="300" style="width: 100%; height: 300px;"></canvas>
            </div>

            <!-- Certificações -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Certificações</h3>
                    <i class="fas fa-award text-gray-400"></i>
                </div>
                <canvas id="chart-certificacoes" width="400" height="300" style="width: 100%; height: 300px;"></canvas>
            </div>
        </div>

        <!-- Tabela de Métricas Avançadas -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">Métricas Detalhadas</h3>
                <div class="flex space-x-2">
                    <button id="btn-export-pdf" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                        <i class="fas fa-file-pdf mr-2"></i>PDF
                    </button>
                    <button id="btn-export-excel" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-file-excel mr-2"></i>Excel
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full table-auto">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Métrica</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>
                        </tr>
                    </thead>
                    <tbody id="metricas-tabela" class="bg-white divide-y divide-gray-200">
                        <!-- Dados serão carregados via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Empresas Section -->
    <section id="empresas" class="container mx-auto px-6 py-8" style="display: none;">
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Empresas Cadastradas</h2>
            <p class="text-gray-600">Busque e filtre empresas de transporte e logística</p>
        </div>

        <!-- Filtros -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Filtros de Busca</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Razão Social</label>
                    <input type="text" id="filtro-razao-social" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite a razão social">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">CNPJ</label>
                    <input type="text" id="filtro-cnpj" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite o CNPJ">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Etiqueta</label>
                    <select id="filtro-etiqueta" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todas as etiquetas</option>
                        <option value="CADASTRADA">CADASTRADA</option>
                        <option value="PARCEIRA">PARCEIRA</option>
                        <option value="ENCERRADO">ENCERRADO</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Carga</label>
                    <select id="filtro-tipo-carga" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todos os tipos</option>
                        <option value="Carga Fracionada">Carga Fracionada</option>
                        <option value="Carga Geral">Carga Geral</option>
                        <option value="Carga Lotação">Carga Lotação</option>
                        <option value="Carga Perigosa">Carga Perigosa</option>
                        <option value="Carga Refrigerada">Carga Refrigerada</option>
                        <option value="Granel Líquido">Granel Líquido</option>
                        <option value="Granel Sólido">Granel Sólido</option>
                        <option value="Produtos Químicos">Produtos Químicos</option>
                        <option value="Transporte de Container">Transporte de Container</option>
                        <option value="Materiais de Construção">Materiais de Construção</option>
                        <option value="Veículos">Veículos</option>
                        <option value="Máquinas e Equipamentos">Máquinas e Equipamentos</option>
                        <option value="Produtos Eletrônicos">Produtos Eletrônicos</option>
                        <option value="Produtos Têxteis">Produtos Têxteis</option>
                        <option value="Produtos Siderúrgicos">Produtos Siderúrgicos</option>
                        <option value="Produtos Agrícolas">Produtos Agrícolas</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Certificação</label>
                    <select id="filtro-certificacao" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todas as certificações</option>
                        <option value="ISO 9001">ISO 9001</option>
                        <option value="SASSMAQ">SASSMAQ</option>
                        <option value="OEA">OEA</option>
                        <option value="ISO 14001">ISO 14001</option>
                        <option value="ISO 45001">ISO 45001</option>
                        <option value="PBQP-H">PBQP-H</option>
                        <option value="HACCP">HACCP</option>
                        <option value="BRC">BRC</option>
                        <option value="IFS">IFS</option>
                        <option value="SQF">SQF</option>
                        <option value="FSSC 22000">FSSC 22000</option>
                        <option value="ISO 22000">ISO 22000</option>
                        <option value="GDP">GDP</option>
                        <option value="IATA">IATA</option>
                        <option value="IMDG">IMDG</option>
                        <option value="ADR">ADR</option>
                        <option value="C-TPAT">C-TPAT</option>
                        <option value="BASC">BASC</option>
                        <option value="CTPAT">CTPAT</option>
                        <option value="AEO">AEO</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Portos Atendidos</label>
                    <select id="filtro-portos-atendidos" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todos os portos</option>
                        <option value="Ponta da Madeira (Maranhão)">Ponta da Madeira (Maranhão)</option>
                        <option value="Porto da Alumar (Maranhão)">Porto da Alumar (Maranhão)</option>
                        <option value="Porto de Angra dos Reis (Rio de Janeiro)">Porto de Angra dos Reis (Rio de Janeiro)</option>
                        <option value="Porto de Antonina (Paraná)">Porto de Antonina (Paraná)</option>
                        <option value="Porto de Aratu (Bahia)">Porto de Aratu (Bahia)</option>
                        <option value="Porto de Areia Branca (Rio Grande do Norte)">Porto de Areia Branca (Rio Grande do Norte)</option>
                        <option value="Porto de Barra do Riacho (Espírito Santo)">Porto de Barra do Riacho (Espírito Santo)</option>
                        <option value="Porto de Barra dos Coqueiros (Sergipe)">Porto de Barra dos Coqueiros (Sergipe)</option>
                        <option value="Porto de Belém (Pará)">Porto de Belém (Pará)</option>
                        <option value="Porto de Cabedelo (Paraíba)">Porto de Cabedelo (Paraíba)</option>
                        <option value="Porto de Ilhéus (Bahia)">Porto de Ilhéus (Bahia)</option>
                        <option value="Porto de Imbituba (Santa Catarina)">Porto de Imbituba (Santa Catarina)</option>
                        <option value="Porto de Itaguaí (Rio de Janeiro)">Porto de Itaguaí (Rio de Janeiro)</option>
                        <option value="Porto de Itajaí (Santa Catarina)">Porto de Itajaí (Santa Catarina)</option>
                        <option value="Porto de Itapoá (Santa Catarina)">Porto de Itapoá (Santa Catarina)</option>
                        <option value="Porto de Jaraguá (Alagoas)">Porto de Jaraguá (Alagoas)</option>
                        <option value="Porto de Natal (Rio Grande do Norte)">Porto de Natal (Rio Grande do Norte)</option>
                        <option value="Porto de Navegantes (Santa Catarina)">Porto de Navegantes (Santa Catarina)</option>
                        <option value="Porto de Niterói (Rio de Janeiro)">Porto de Niterói (Rio de Janeiro)</option>
                        <option value="Porto de Paranaguá (Paraná)">Porto de Paranaguá (Paraná)</option>
                        <option value="Porto do Pecém (Ceará)">Porto do Pecém (Ceará)</option>
                        <option value="Porto de Rio Grande (Rio Grande do Sul)">Porto de Rio Grande (Rio Grande do Sul)</option>
                        <option value="Porto de Salvador (Bahia)">Porto de Salvador (Bahia)</option>
                        <option value="Porto de Macapá (Amapá)">Porto de Macapá (Amapá)</option>
                        <option value="Porto de Santos (São Paulo)">Porto de Santos (São Paulo)</option>
                        <option value="Porto de São Francisco do Sul (Santa Catarina)">Porto de São Francisco do Sul (Santa Catarina)</option>
                        <option value="Porto de São Sebastião (São Paulo)">Porto de São Sebastião (São Paulo)</option>
                        <option value="Porto de Suape (Pernambuco)">Porto de Suape (Pernambuco)</option>
                        <option value="Porto de Tubarão (Espírito Santo)">Porto de Tubarão (Espírito Santo)</option>
                        <option value="Porto de Vila do Conde (Pará)">Porto de Vila do Conde (Pará)</option>
                        <option value="Porto de Vitória (Espírito Santo)">Porto de Vitória (Espírito Santo)</option>
                        <option value="Porto do Açu (Rio de Janeiro)">Porto do Açu (Rio de Janeiro)</option>
                        <option value="Porto do Forno (Rio de Janeiro)">Porto do Forno (Rio de Janeiro)</option>
                        <option value="Porto do Itaqui (Maranhão)">Porto do Itaqui (Maranhão)</option>
                        <option value="Porto do Mucuripe (Ceará)">Porto do Mucuripe (Ceará)</option>
                        <option value="Porto do Recife (Pernambuco)">Porto do Recife (Pernambuco)</option>
                        <option value="Porto do Rio de Janeiro (Rio de Janeiro)">Porto do Rio de Janeiro (Rio de Janeiro)</option>
                        <option value="Porto Pesqueiro de Laguna (Santa Catarina)">Porto Pesqueiro de Laguna (Santa Catarina)</option>
                        <option value="Porto Piauí (Piauí)">Porto Piauí (Piauí)</option>
                        <option value="Porto Sudeste (Rio de Janeiro)">Porto Sudeste (Rio de Janeiro)</option>
                        <option value="Terminal de Miramar (Pará)">Terminal de Miramar (Pará)</option>
                        <option value="Terminal de Praia Mole (Espírito Santo)">Terminal de Praia Mole (Espírito Santo)</option>
                        <option value="Porto de Cáceres (Mato Grosso)">Porto de Cáceres (Mato Grosso)</option>
                        <option value="Porto de Cachoeira do Sul (Rio Grande do Sul)">Porto de Cachoeira do Sul (Rio Grande do Sul)</option>
                        <option value="Porto de Caracaraí (Roraima)">Porto de Caracaraí (Roraima)</option>
                        <option value="Porto de Charqueadas (Rio Grande do Sul)">Porto de Charqueadas (Rio Grande do Sul)</option>
                        <option value="Porto de Corumbá (Mato Grosso do Sul)">Porto de Corumbá (Mato Grosso do Sul)</option>
                        <option value="Porto de Eirunepé (Amazonas)">Porto de Eirunepé (Amazonas)</option>
                        <option value="Porto de Estrela (Rio Grande do Sul)">Porto de Estrela (Rio Grande do Sul)</option>
                        <option value="Terminal de Itacoatiara (Amazonas)">Terminal de Itacoatiara (Amazonas)</option>
                        <option value="Porto de Juazeiro (Bahia)">Porto de Juazeiro (Bahia)</option>
                        <option value="Porto de Ladário (Mato Grosso do Sul)">Porto de Ladário (Mato Grosso do Sul)</option>
                        <option value="Porto de Manaus (Amazonas)">Porto de Manaus (Amazonas)</option>
                        <option value="Porto de Pelotas (Rio Grande do Sul)">Porto de Pelotas (Rio Grande do Sul)</option>
                        <option value="Porto de Parintins (Amazonas)">Porto de Parintins (Amazonas)</option>
                        <option value="Porto de Petrolina (Pernambuco)">Porto de Petrolina (Pernambuco)</option>
                        <option value="Porto de Pirapora (Minas Gerais)">Porto de Pirapora (Minas Gerais)</option>
                        <option value="Porto de Porto Alegre (Rio Grande do Sul)">Porto de Porto Alegre (Rio Grande do Sul)</option>
                        <option value="Porto de Porto Murtinho (Mato Grosso do Sul)">Porto de Porto Murtinho (Mato Grosso do Sul)</option>
                        <option value="Porto de Porto Velho (Rondônia)">Porto de Porto Velho (Rondônia)</option>
                        <option value="Porto Internacional de Porto Xavier (Rio Grande do Sul)">Porto Internacional de Porto Xavier (Rio Grande do Sul)</option>
                        <option value="Porto de Santana (Amapá)">Porto de Santana (Amapá)</option>
                        <option value="Porto de Santarém (Pará)">Porto de Santarém (Pará)</option>
                        <option value="Porto de Tabatinga (Amazonas)">Porto de Tabatinga (Amazonas)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Regulamentação</label>
                    <select id="filtro-tipo-regulamentacao" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todas as regulamentações</option>
                        <option value="RNTRC">RNTRC</option>
                        <option value="ANTT">ANTT</option>
                        <option value="AET">AET</option>
                        <option value="AATPP">AATPP</option>
                        <option value="CIPP">CIPP</option>
                        <option value="ANVISA">ANVISA</option>
                        <option value="IBAMA">IBAMA</option>
                        <option value="INMETRO">INMETRO</option>
                        <option value="MAPA">MAPA</option>
                        <option value="ANP">ANP</option>
                        <option value="ANTAQ">ANTAQ</option>
                        <option value="ANAC">ANAC</option>
                        <option value="Receita Federal">Receita Federal</option>
                        <option value="Polícia Federal">Polícia Federal</option>
                        <option value="Exército Brasileiro">Exército Brasileiro</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Frota</label>
                    <select id="filtro-tipo-frota" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todos os tipos</option>
                        <option value="Própria">Própria</option>
                        <option value="Terceirizada">Terceirizada</option>
                        <option value="Mista">Mista</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Veículo</label>
                    <select id="filtro-tipo-veiculo" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todos os veículos</option>
                        <option value="Caminhão Toco">Caminhão Toco</option>
                        <option value="Caminhão Truck">Caminhão Truck</option>
                        <option value="Carreta">Carreta</option>
                        <option value="Bitrem">Bitrem</option>
                        <option value="Rodotrem">Rodotrem</option>
                        <option value="Van">Van</option>
                        <option value="Utilitário">Utilitário</option>
                        <option value="Caminhão Baú">Caminhão Baú</option>
                        <option value="Caminhão Frigorífico">Caminhão Frigorífico</option>
                        <option value="Caminhão Tanque">Caminhão Tanque</option>
                        <option value="Caminhão Cegonha">Caminhão Cegonha</option>
                        <option value="Caminhão Munck">Caminhão Munck</option>
                        <option value="Caminhão Prancha">Caminhão Prancha</option>
                        <option value="Caminhão Graneleiro">Caminhão Graneleiro</option>
                        <option value="Caminhão Silo">Caminhão Silo</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Possui Seguro?</label>
                    <select id="filtro-possui-seguro" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todos</option>
                        <option value="true">Sim</option>
                        <option value="false">Não</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tecnologia</label>
                    <select id="filtro-nome-tecnologia" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todas as tecnologias</option>
                        <option value="TMS">TMS</option>
                        <option value="WMS">WMS</option>
                        <option value="GPS">GPS</option>
                        <option value="RFID">RFID</option>
                        <option value="IoT">IoT</option>
                        <option value="EDI">EDI</option>
                        <option value="API">API</option>
                        <option value="ERP">ERP</option>
                        <option value="CRM">CRM</option>
                        <option value="BI">BI</option>
                        <option value="Blockchain">Blockchain</option>
                        <option value="Inteligência Artificial">Inteligência Artificial</option>
                        <option value="Machine Learning">Machine Learning</option>
                        <option value="Big Data">Big Data</option>
                        <option value="Cloud Computing">Cloud Computing</option>
                        <option value="Mobile">Mobile</option>
                        <option value="Telemática">Telemática</option>
                        <option value="Rastreamento Satelital">Rastreamento Satelital</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Segmento Cliente</label>
                    <select id="filtro-segmento-cliente" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todos os segmentos</option>
                        <option value="Indústria Automotiva">Indústria Automotiva</option>
                        <option value="Indústria Alimentícia">Indústria Alimentícia</option>
                        <option value="Indústria Farmacêutica">Indústria Farmacêutica</option>
                        <option value="Indústria Química">Indústria Química</option>
                        <option value="Indústria Têxtil">Indústria Têxtil</option>
                        <option value="Indústria Siderúrgica">Indústria Siderúrgica</option>
                        <option value="Indústria de Papel e Celulose">Indústria de Papel e Celulose</option>
                        <option value="Indústria de Construção Civil">Indústria de Construção Civil</option>
                        <option value="Agronegócio">Agronegócio</option>
                        <option value="Varejo">Varejo</option>
                        <option value="E-commerce">E-commerce</option>
                        <option value="Atacado">Atacado</option>
                        <option value="Distribuidoras">Distribuidoras</option>
                        <option value="Supermercados">Supermercados</option>
                        <option value="Farmácias">Farmácias</option>
                        <option value="Hospitais">Hospitais</option>
                        <option value="Laboratórios">Laboratórios</option>
                        <option value="Petróleo e Gás">Petróleo e Gás</option>
                        <option value="Mineração">Mineração</option>
                        <option value="Energia">Energia</option>
                        <option value="Telecomunicações">Telecomunicações</option>
                        <option value="Tecnologia">Tecnologia</option>
                        <option value="Governo">Governo</option>
                        <option value="ONGs">ONGs</option>
                        <option value="Cooperativas">Cooperativas</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Certificação Ambiental</label>
                    <select id="filtro-certificacao-ambiental" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todas as certificações</option>
                        <option value="ISO 14001">ISO 14001</option>
                        <option value="LEED">LEED</option>
                        <option value="BREEAM">BREEAM</option>
                        <option value="AQUA">AQUA</option>
                        <option value="PROCEL">PROCEL</option>
                        <option value="INMETRO">INMETRO</option>
                        <option value="Carbon Trust">Carbon Trust</option>
                        <option value="GHG Protocol">GHG Protocol</option>
                        <option value="CDP">CDP</option>
                        <option value="FSC">FSC</option>
                        <option value="PEFC">PEFC</option>
                        <option value="Cradle to Cradle">Cradle to Cradle</option>
                        <option value="EPEAT">EPEAT</option>
                        <option value="Energy Star">Energy Star</option>
                        <option value="Green Seal">Green Seal</option>
                        <option value="EcoVadis">EcoVadis</option>
                        <option value="B Corp">B Corp</option>
                    </select>
                </div>
            </div>
            <div class="mt-4 flex space-x-4">
                <button id="btn-buscar-filtros" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                    <i class="fas fa-search mr-2"></i>Buscar
                </button>
                <button id="btn-limpar-filtros" class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
                    <i class="fas fa-eraser mr-2"></i>Limpar
                </button>
            </div>
        </div>

        <!-- Lista de Empresas -->
        <div class="bg-white rounded-lg shadow-md">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">Resultados da Busca</h3>
                <p class="text-sm text-gray-600" id="resultado-count">Carregando...</p>
            </div>
            <div id="lista-empresas" class="divide-y divide-gray-200">
                <!-- Empresas serão carregadas aqui -->
            </div>
            <div class="p-6 border-t border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                        Mostrando <span id="showing-from">1</span> a <span id="showing-to">10</span> de <span id="total-results">0</span> resultados
                    </div>
                    <div class="flex space-x-2">
                        <button id="btn-prev" class="px-3 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors" disabled>
                            Anterior
                        </button>
                        <button id="btn-next" class="px-3 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors" disabled>
                            Próximo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Cadastro Section -->
    <section id="cadastro" class="container mx-auto px-6 py-8" style="display: none;">
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Cadastrar Nova Empresa</h2>
            <p class="text-gray-600">Preencha os dados da empresa de transporte e logística</p>
        </div>

        <form id="form-cadastro" class="space-y-8">
            <!-- Dados Básicos -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Dados Básicos</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Razão Social *</label>
                        <input type="text" name="razao_social" id="razao_social" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p id="razao_social_error" class="text-red-500 text-xs italic hidden">A Razão Social é obrigatória.</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome Fantasia</label>
                        <input type="text" name="nome_fantasia" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">CNPJ *</label>
                        <input type="text" name="cnpj" id="cnpj" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="00.000.000/0000-00">
                        <p id="cnpj_error" class="text-red-500 text-xs italic hidden">O CNPJ é obrigatório e deve estar no formato 00.000.000/0000-00.</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Inscrição Estadual</label>
                        <input type="text" name="inscricao_estadual" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Endereço Completo</label>
                        <textarea name="endereco_completo" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Telefone Comercial</label>
                        <input type="text" name="telefone_comercial" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="(00) 0000-0000">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Telefone Emergencial</label>
                        <input type="text" name="telefone_emergencial" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="(00) 00000-0000">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">E-mail</label>
                        <input type="email" name="email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Website</label>
                        <input type="url" name="website" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="www.exemplo.com.br">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data de Fundação</label>
                        <input type="date" name="data_fundacao" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Link para Cotação</label>
                        <input type="url" name="link_cotacao" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Link direto para cotação da transportadora">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                        <textarea name="observacoes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Observações gerais sobre a empresa..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Etiqueta</label>
                        <select name="etiqueta" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="CADASTRADA">CADASTRADA</option>
                            <option value="PARCEIRA">PARCEIRA</option>
                            <option value="ENCERRADO">ENCERRADO</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Status da empresa no sistema</p>
                    </div>
                </div>
            </div>

            <!-- Modalidades e Tipos de Carga -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Modalidades e Tipos de Carga</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Modalidades de Transporte</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" name="modalidades_transporte" value="Rodoviário" class="mr-2">
                                Rodoviário
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="modalidades_transporte" value="Multimodal" class="mr-2">
                                Multimodal
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="modalidades_transporte" value="Ferroviário" class="mr-2">
                                Ferroviário
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="modalidades_transporte" value="Aquaviário" class="mr-2">
                                Aquaviário
                            </label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipos de Carga</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Carga Geral" class="mr-2">
                                Carga Geral
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Carga Perigosa" class="mr-2">
                                Carga Perigosa
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Carga Refrigerada" class="mr-2">
                                Carga Refrigerada
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Granel Líquido" class="mr-2">
                                Granel Líquido
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Granel Sólido" class="mr-2">
                                Granel Sólido
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Produtos Químicos" class="mr-2">
                                Produtos Químicos
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Produtos Farmacêuticos" class="mr-2">
                                Produtos Farmacêuticos
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Carga Fracionada" class="mr-2">
                                Carga Fracionada
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Carga Lotação" class="mr-2">
                                Carga Lotação
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Transporte de Container" class="mr-2">
                                Transporte de Container
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Produtos Alimentícios" class="mr-2">
                                Produtos Alimentícios
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Materiais de Construção" class="mr-2">
                                Materiais de Construção
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Veículos" class="mr-2">
                                Veículos
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Máquinas e Equipamentos" class="mr-2">
                                Máquinas e Equipamentos
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Produtos Eletrônicos" class="mr-2">
                                Produtos Eletrônicos
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Produtos Têxteis" class="mr-2">
                                Produtos Têxteis
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Produtos Siderúrgicos" class="mr-2">
                                Produtos Siderúrgicos
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Produtos Agrícolas" class="mr-2">
                                Produtos Agrícolas
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Regulamentação e Licenças -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Regulamentação e Licenças</h3>
                <div id="regulamentacoes-container" class="space-y-4 mb-4">
                    <!-- Regulamentações serão adicionadas aqui via JS -->
                </div>
                <button type="button" id="btn-add-regulamentacao" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Adicionar Regulamentação
                </button>
            </div>

            <!-- Certificações de Qualidade e Segurança -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Certificações de Qualidade e Segurança</h3>
                <div id="certificacoes-container" class="space-y-4 mb-4">
                    <!-- Certificações serão adicionadas aqui via JS -->
                </div>
                <button type="button" id="btn-add-certificacao" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Adicionar Certificação
                </button>
            </div>

            <!-- Abrangência Geográfica -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Abrangência Geográfica</h3>
                <div id="abrangencia-container" class="space-y-4 mb-4">
                    <!-- Abrangências serão adicionadas aqui via JS -->
                </div>
                <button type="button" id="btn-add-abrangencia" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Adicionar Abrangência
                </button>
            </div>

            <!-- Frota -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Frota</h3>
                <div id="frota-container" class="space-y-4 mb-4">
                    <!-- Frota será adicionada aqui via JS -->
                </div>
                <button type="button" id="btn-add-frota" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Adicionar Frota
                </button>
            </div>

            <!-- Armazenagem -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Armazenagem</h3>
                <div id="armazenagem-container" class="space-y-4 mb-4">
                    <!-- Armazenagem será adicionada aqui via JS -->
                </div>
                <button type="button" id="btn-add-armazenagem" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Adicionar Armazenagem
                </button>
            </div>

            <!-- Portos e Terminais -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Portos e Terminais</h3>
                <div id="portos-terminais-container" class="space-y-4 mb-4">
                    <!-- Portos e Terminais serão adicionados aqui via JS -->
                </div>
                <button type="button" id="btn-add-porto-terminal" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Adicionar Porto/Terminal
                </button>
            </div>

            <!-- Seguros e Coberturas -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Seguros e Coberturas</h3>
                <div id="seguros-coberturas-container" class="space-y-4 mb-4">
                    <!-- Seguros e Coberturas serão adicionados aqui via JS -->
                </div>
                <button type="button" id="btn-add-seguro-cobertura" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Adicionar Seguro/Cobertura
                </button>
            </div>

            <!-- Tecnologia e Integração -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Tecnologia e Integração</h3>
                <div id="tecnologias-container" class="space-y-4 mb-4">
                    <!-- Tecnologias serão adicionadas aqui via JS -->
                </div>
                <button type="button" id="btn-add-tecnologia" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Adicionar Tecnologia
                </button>
            </div>

            <!-- Desempenho e Qualidade de Serviço -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Desempenho e Qualidade de Serviço</h3>
                <div id="desempenho-qualidade-container" class="space-y-4 mb-4">
                    <!-- Desempenho e Qualidade serão adicionados aqui via JS -->
                </div>
                <button type="button" id="btn-add-desempenho-qualidade" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Adicionar Desempenho/Qualidade
                </button>
            </div>

            <!-- Clientes e Segmentos -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Clientes e Segmentos</h3>
                <div id="clientes-segmentos-container" class="space-y-4 mb-4">
                    <!-- Clientes e Segmentos serão adicionados aqui via JS -->
                </div>
                <button type="button" id="btn-add-cliente-segmento" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Adicionar Cliente/Segmento
                </button>
            </div>

            <!-- Recursos Humanos -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Recursos Humanos</h3>
                <div id="recursos-humanos-container" class="space-y-4 mb-4">
                    <!-- Recursos Humanos serão adicionados aqui via JS -->
                </div>
                <button type="button" id="btn-add-recurso-humano" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Adicionar Recurso Humano
                </button>
            </div>

            <!-- Sustentabilidade e Responsabilidade Social -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Sustentabilidade e Responsabilidade Social</h3>
                <div id="sustentabilidade-container" class="space-y-4 mb-4">
                    <!-- Sustentabilidade será adicionada aqui via JS -->
                </div>
                <button type="button" id="btn-add-sustentabilidade" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Adicionar Sustentabilidade
                </button>
            </div>

            <!-- Botões de Ação -->
            <div class="flex justify-end space-x-4">
                <button type="button" id="btn-cancelar-cadastro" class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
                    Cancelar
                </button>
                <button type="submit" id="btn-salvar-empresa" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                    <i class="fas fa-save mr-2"></i>Salvar Empresa
                </button>
            </div>
        </form>
    </section>

    <!-- Modal de Detalhes da Empresa -->
    <div id="modal-detalhes" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-gray-800">Detalhes da Empresa</h3>
                    <button id="btn-fechar-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div id="conteudo-modal" class="p-6">
                <!-- Conteúdo será carregado aqui -->
            </div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let currentPage = 1;
        let totalPages = 1;
        let currentFilters = {};

        // Função para formatar data corretamente no padrão dia/mês/ano
        function formatarDataBrasil(dataString) {
            if (!dataString) return 'N/A';
            
            // Parse da data considerando que vem no formato YYYY-MM-DD
            const partes = dataString.split('-');
            if (partes.length !== 3) return 'N/A';
            
            const ano = partes[0];
            const mes = partes[1];
            const dia = partes[2];
            
            return `${dia}/${mes}/${ano}`;
        }

        // Aguardar carregamento completo do DOM
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM carregado, inicializando sistema...');
            
            // Inicializar dados
            loadDashboardStats();
            loadEmpresas();
            
            // Configurar event listeners para navegação
            setupNavigationListeners();
            
            // Configurar event listeners para botões
            setupButtonListeners();
            
            // Configurar event listeners para formulários
            setupFormListeners();
            
            // Configurar event listeners para modal
            setupModalListeners();
        });

        // Função para mostrar seção de cotações
        function mostrarSecaoCotacoes() {
            console.log('Mostrando seção de cotações...');
            // Ocultar outras seções
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('empresas').style.display = 'none';
            document.getElementById('cadastro').style.display = 'none';
            
            // Ocultar seção de analytics
            const secaoAnalytics = document.getElementById('analytics');
            if (secaoAnalytics) {
                secaoAnalytics.style.display = 'none';
                secaoAnalytics.classList.add('hidden');
            }
            
            // Mostrar rodapé na seção de cotações
            const footers = document.querySelectorAll('footer');
            footers.forEach(footer => {
                footer.style.display = 'block';
            });
            
            // Mostrar seção de cotações
            const secaoCotacoes = document.getElementById('secao-cotacoes');
            if (secaoCotacoes) {
                secaoCotacoes.style.display = 'block';
                secaoCotacoes.classList.remove('hidden');
                carregarCotacoes();
                carregarEstatisticasCotacoes();
            } else {
                console.log('ERRO: Seção de cotações não encontrada!');
            }
        }

        // Função para mostrar seção de Analytics
        function mostrarSecaoAnalytics() {
            console.log('Navegando para Analytics...');
            
            // Ocultar todas as seções principais
            const sections = ['dashboard', 'empresas', 'cadastro'];
            sections.forEach(id => {
                const section = document.getElementById(id);
                if (section) {
                    section.style.display = 'none';
                }
            });
            
            // Ocultar seção de cotações
            const secaoCotacoes = document.getElementById('secao-cotacoes');
            if (secaoCotacoes) {
                secaoCotacoes.style.display = 'none';
                secaoCotacoes.classList.add('hidden');
            }
            
            // Ocultar rodapé na seção de analytics
            const footers = document.querySelectorAll('footer');
            footers.forEach(footer => {
                footer.style.display = 'none';
            });
            
            // Mostrar seção de analytics
            const secaoAnalytics = document.getElementById('analytics');
            if (secaoAnalytics) {
                secaoAnalytics.style.display = 'block';
                secaoAnalytics.classList.remove('hidden');
                carregarConteudoAnalytics();
            } else {
                console.log('ERRO: Seção de analytics não encontrada!');
            }
        }

        // Configurar event listeners para navegação
        function setupNavigationListeners() {
            // Navegação principal
            document.getElementById('nav-dashboard').addEventListener('click', function(e) {
                e.preventDefault();
                showSection('dashboard');
            });
            
            document.getElementById('nav-empresas').addEventListener('click', function(e) {
                e.preventDefault();
                showSection('empresas');
            });
            
            document.getElementById('nav-cotacoes').addEventListener('click', function(e) {
                e.preventDefault();
                mostrarSecaoCotacoes();
            });
            
            document.getElementById('nav-cadastro').addEventListener('click', function(e) {
                e.preventDefault();
                showSection('cadastro');
            });
        }

        // Configurar event listeners para botões
        function setupButtonListeners() {
            // Botões do dashboard
            document.getElementById('btn-cadastrar-nova').addEventListener('click', function() {
                showSection('cadastro');
            });
            
            document.getElementById('btn-buscar-empresas').addEventListener('click', function() {
                showSection('empresas');
            });
            
            document.getElementById('btn-exportar-dados').addEventListener('click', function() {
                exportData();
            });
            
            // Botões de filtros
            document.getElementById('btn-buscar-filtros').addEventListener('click', function() {
                buscarEmpresas();
            });
            
            document.getElementById('btn-limpar-filtros').addEventListener('click', function() {
                limparFiltros();
            });
            
            // Botões de paginação
            document.getElementById('btn-prev').addEventListener('click', function() {
                previousPage();
            });
            
            document.getElementById('btn-next').addEventListener('click', function() {
                nextPage();
            });
            
            // Botões de adicionar campos dinâmicos
            document.getElementById('btn-add-regulamentacao').addEventListener('click', function() {
                addRegulamentacao();
            });
            
            document.getElementById('btn-add-certificacao').addEventListener('click', function() {
                addCertificacao();
            });
            
            document.getElementById('btn-add-abrangencia').addEventListener('click', function() {
                addAbrangencia();
            });
            
            document.getElementById('btn-add-frota').addEventListener('click', function() {
                addFrota();
            });
            
            document.getElementById('btn-add-armazenagem').addEventListener('click', function() {
                addArmazenagem();
            });
            
            document.getElementById('btn-add-porto-terminal').addEventListener('click', function() {
                addPortoTerminal();
            });
            
            document.getElementById('btn-add-seguro-cobertura').addEventListener('click', function() {
                addSeguroCobertura();
            });
            
            document.getElementById('btn-add-tecnologia').addEventListener('click', function() {
                addTecnologia();
            });
            
            document.getElementById('btn-add-desempenho-qualidade').addEventListener('click', function() {
                addDesempenhoQualidade();
            });
            
            document.getElementById('btn-add-cliente-segmento').addEventListener('click', function() {
                addClienteSegmento();
            });
            
            document.getElementById('btn-add-recurso-humano').addEventListener('click', function() {
                addRecursoHumano();
            });
            
            document.getElementById('btn-add-sustentabilidade').addEventListener('click', function() {
                addSustentabilidade();
            });
            
            // Botões do formulário de cadastro
            document.getElementById('btn-cancelar-cadastro').addEventListener('click', function() {
                limparFormularioCadastro();
                showSection('empresas');
            });
        }

        // Configurar event listeners para formulários
        function setupFormListeners() {
            document.getElementById("form-cadastro").addEventListener("submit", function(e) {
                e.preventDefault();
                if (validateForm()) {
                    cadastrarEmpresa();
                }
            });
        }

        // Função de validação do formulário
        function validateForm() {
            let isValid = true;

            // Validação Razão Social
            const razaoSocialInput = document.getElementById("razao_social");
            const razaoSocialError = document.getElementById("razao_social_error");
            if (razaoSocialInput.value.trim() === "") {
                razaoSocialError.classList.remove("hidden");
                isValid = false;
            } else {
                razaoSocialError.classList.add("hidden");
            }

            // Validação CNPJ - mais flexível
            const cnpjInput = document.getElementById("cnpj");
            const cnpjError = document.getElementById("cnpj_error");
            const cnpjValue = cnpjInput.value.trim();
            
            // Aceitar CNPJ com ou sem formatação
            const cnpjPattern = /^\d{2}\.?\d{3}\.?\d{3}\/?\d{4}-?\d{2}$/;
            const cnpjSomenteNumeros = /^\d{14}$/;
            
            if (cnpjValue === "" || (!cnpjPattern.test(cnpjValue) && !cnpjSomenteNumeros.test(cnpjValue))) {
                cnpjError.textContent = "CNPJ é obrigatório. Use formato 00.000.000/0000-00 ou apenas números.";
                cnpjError.classList.remove("hidden");
                isValid = false;
            } else {
                cnpjError.classList.add("hidden");
            }

            return isValid;
        }

        // Configurar event listeners para modal
        function setupModalListeners() {
            document.getElementById('btn-fechar-modal').addEventListener('click', function() {
                fecharModal();
            });
            
            // Fechar modal ao clicar fora - REMOVIDO para evitar fechamento acidental
            // document.getElementById('modal-detalhes').addEventListener('click', function(e) {
            //     if (e.target === this) {
            //         fecharModal();
            //     }
            // });
        }

        // Navegação entre seções
        function showSection(sectionId) {
            console.log('Navegando para seção:', sectionId);
            
            // Se estiver saindo da seção de cadastro, limpar o formulário (EXCETO se estiver editando)
            const currentSection = document.querySelector('section:not([style*="display: none"])');
            if (currentSection && currentSection.id === 'cadastro' && sectionId !== 'cadastro' && !window.editingEmpresaId) {
                limparFormularioCadastro();
            }
            
            // Lista completa de seções para controlar
            const sections = ['dashboard', 'empresas', 'cadastro'];
            sections.forEach(id => {
                const section = document.getElementById(id);
                if (section) {
                    section.style.display = id === sectionId ? 'block' : 'none';
                }
            });
            
            // Controlar seções especiais (cotações e analytics)
            const secaoCotacoes = document.getElementById('secao-cotacoes');
            const secaoAnalytics = document.getElementById('analytics');
            
            if (secaoCotacoes) {
                secaoCotacoes.style.display = 'none';
                secaoCotacoes.classList.add('hidden');
            }
            
            if (secaoAnalytics) {
                secaoAnalytics.style.display = 'none';
                secaoAnalytics.classList.add('hidden');
            }
            
            // Controlar visibilidade do rodapé - mostrar apenas no dashboard e cotações
            const footers = document.querySelectorAll('footer');
            footers.forEach(footer => {
                // Mostrar rodapé apenas no dashboard e na seção de cotações
                const mostrarRodape = sectionId === 'dashboard' || sectionId === 'cotacoes';
                footer.style.display = mostrarRodape ? 'block' : 'none';
            });
            
            if (sectionId === 'empresas') {
                loadEmpresas();
            } else if (sectionId === 'dashboard') {
                loadDashboardStats();
            }
        }

        // Carregar estatísticas do dashboard
        async function loadDashboardStats() {
            try {
                console.log('Carregando estatísticas do dashboard...');
                const response = await fetch('/api/empresas');
                const data = await response.json();
                
                document.getElementById('total-empresas').textContent = data.total || 0;
                
                // Carregar detalhes para estatísticas específicas
                let certificadas = 0;
                let comArmazem = 0;
                let nacional = 0;
                
                for (let i = 1; i <= data.total; i++) {
                    try {
                        const detailResponse = await fetch(`/api/empresas/${i}`);
                        const empresa = await detailResponse.json();
                        
                        if (empresa.certificacoes && empresa.certificacoes.length > 0) {
                            certificadas++;
                        }
                        
                        if (empresa.armazenagem && empresa.armazenagem.some(a => a.possui_armazem)) {
                            comArmazem++;
                        }
                        
                        if (empresa.abrangencia_geografica && empresa.abrangencia_geografica.some(a => a.tipo_abrangencia === 'Nacional')) {
                            nacional++;
                        }
                    } catch (e) {
                        console.error('Erro ao carregar detalhes da empresa:', e);
                    }
                }
                
                document.getElementById('empresas-certificadas').textContent = certificadas;
                document.getElementById('empresas-armazem').textContent = comArmazem;
                document.getElementById('empresas-nacional').textContent = nacional;
                
                // Carregar gráficos do dashboard
                carregarDadosAnalytics();
                
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            }
        }

        // Carregar lista de empresas
        async function loadEmpresas(page = 1) {
            try {
                console.log('Carregando empresas, página:', page);
                const params = new URLSearchParams({
                    page: page,
                    per_page: 10,
                    ...currentFilters
                });
                
                const response = await fetch(`/api/empresas?${params}`);
                const data = await response.json();
                
                displayEmpresas(data.empresas);
                updatePagination(data);
                
                document.getElementById('resultado-count').textContent = 
                    `${data.total} empresa(s) encontrada(s)`;
                
            } catch (error) {
                console.error('Erro ao carregar empresas:', error);
                document.getElementById('lista-empresas').innerHTML = 
                    '<div class="p-6 text-center text-red-600">Erro ao carregar empresas</div>';
            }
        }

        // Exibir empresas na lista
        function displayEmpresas(empresas) {
            const container = document.getElementById('lista-empresas');
            
            if (empresas.length === 0) {
                container.innerHTML = '<div class="p-6 text-center text-gray-500">Nenhuma empresa encontrada</div>';
                return;
            }
            
            container.innerHTML = empresas.map(empresa => `
                <div class="p-6 hover:bg-gray-50 transition-colors">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3">
                                <h4 class="text-lg font-semibold text-gray-800">${empresa.razao_social}</h4>
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                                    empresa.etiqueta === 'PARCEIRA' ? 'bg-green-100 text-green-800' :
                                    empresa.etiqueta === 'ENCERRADO' ? 'bg-red-100 text-red-800' :
                                    'bg-blue-100 text-blue-800'
                                }">${empresa.etiqueta || 'CADASTRADA'}</span>
                            </div>
                            <p class="text-sm text-gray-600">${empresa.nome_fantasia || 'N/A'}</p>
                            <div class="mt-2 flex items-center space-x-4 text-sm text-gray-500">
                                <span><i class="fas fa-id-card mr-1"></i>${empresa.cnpj}</span>
                                <span><i class="fas fa-envelope mr-1"></i>${empresa.email || 'N/A'}</span>
                                <span><i class="fas fa-phone mr-1"></i>${empresa.telefone_comercial || 'N/A'}</span>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="verDetalhes(${empresa.id})" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                                <i class="fas fa-eye mr-1"></i>Ver Detalhes
                            </button>
                            <button onclick="editarEmpresa(${empresa.id})" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
                                <i class="fas fa-edit mr-1"></i>Editar
                            </button>
                            <button onclick="confirmarExclusao(${empresa.id}, '${empresa.razao_social}')" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors ml-2">
                                <i class="fas fa-trash-alt mr-1"></i>Excluir
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Atualizar paginação
        function updatePagination(data) {
            currentPage = data.current_page;
            totalPages = data.pages;
            
            document.getElementById('showing-from').textContent = 
                data.empresas.length > 0 ? ((currentPage - 1) * data.per_page) + 1 : 0;
            document.getElementById('showing-to').textContent = 
                Math.min(currentPage * data.per_page, data.total);
            document.getElementById('total-results').textContent = data.total;
            
            document.getElementById('btn-prev').disabled = currentPage <= 1;
            document.getElementById('btn-next').disabled = currentPage >= totalPages;
        }

        // Navegação de páginas
        function previousPage() {
            if (currentPage > 1) {
                loadEmpresas(currentPage - 1);
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                loadEmpresas(currentPage + 1);
            }
        }

        // Buscar empresas com filtros
        function buscarEmpresas() {
            console.log('Buscando empresas com filtros...');
            currentFilters = {
                razao_social: document.getElementById('filtro-razao-social').value,
                cnpj: document.getElementById("filtro-cnpj").value,
                etiqueta: document.getElementById("filtro-etiqueta").value,
                tipo_carga: document.getElementById("filtro-tipo-carga").value,
                certificacao: document.getElementById("filtro-certificacao").value,
                portos_atendidos: document.getElementById("filtro-portos-atendidos").value,
                tipo_regulamentacao: document.getElementById("filtro-tipo-regulamentacao").value,
                tipo_frota: document.getElementById("filtro-tipo-frota").value,
                tipo_veiculo: document.getElementById("filtro-tipo-veiculo").value,
                possui_seguro: document.getElementById("filtro-possui-seguro").value,
                nome_tecnologia: document.getElementById("filtro-nome-tecnologia").value,
                segmento_cliente: document.getElementById("filtro-segmento-cliente").value,
                certificacao_ambiental: document.getElementById("filtro-certificacao-ambiental").value
            };
            
            // Remover filtros vazios
            Object.keys(currentFilters).forEach(key => {
                if (!currentFilters[key]) {
                    delete currentFilters[key];
                }
            });
            
            loadEmpresas(1);
        }

        // Limpar filtros
        function limparFiltros() {
            console.log('Limpando filtros...');
            document.getElementById('filtro-razao-social').value = '';
            document.getElementById('filtro-cnpj').value = '';
            document.getElementById('filtro-etiqueta').value = '';
            document.getElementById('filtro-tipo-carga').value = '';
            document.getElementById('filtro-certificacao').value = '';
            document.getElementById('filtro-portos-atendidos').value = '';
            document.getElementById('filtro-tipo-regulamentacao').value = '';
            document.getElementById('filtro-tipo-frota').value = '';
            document.getElementById('filtro-tipo-veiculo').value = '';
            document.getElementById('filtro-possui-seguro').value = '';
            document.getElementById('filtro-nome-tecnologia').value = '';
            document.getElementById('filtro-segmento-cliente').value = '';
            document.getElementById('filtro-certificacao-ambiental').value = '';
            
            currentFilters = {};
            loadEmpresas(1);
        }

        // Ver detalhes da empresa
        async function verDetalhes(empresaId) {
            try {
                console.log('Carregando detalhes da empresa:', empresaId);
                const response = await fetch(`/api/empresas/${empresaId}`);
                const empresa = await response.json();
                
                const modal = document.getElementById('modal-detalhes');
                const conteudo = document.getElementById('conteudo-modal');
                
                conteudo.innerHTML = `
                    <div class="space-y-6">
                        <!-- Dados Básicos -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Dados Básicos</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div><strong>Razão Social:</strong> ${empresa.razao_social}</div>
                                <div><strong>Nome Fantasia:</strong> ${empresa.nome_fantasia || 'N/A'}</div>
                                <div><strong>CNPJ:</strong> ${empresa.cnpj}</div>
                                <div><strong>Inscrição Estadual:</strong> ${empresa.inscricao_estadual || 'N/A'}</div>
                                <div class="md:col-span-2"><strong>Endereço:</strong> ${empresa.endereco_completo || 'N/A'}</div>
                                <div><strong>Telefone Comercial:</strong> ${empresa.telefone_comercial || 'N/A'}</div>
                                <div><strong>Telefone Emergencial:</strong> ${empresa.telefone_emergencial || 'N/A'}</div>
                                <div><strong>E-mail:</strong> ${empresa.email ? `<a href="mailto:${empresa.email}" class="text-blue-600 hover:text-blue-800 underline">${empresa.email}</a>` : 'N/A'}</div>
                                <div><strong>Website:</strong> ${empresa.website ? `<a href="${empresa.website.startsWith('http') ? empresa.website : 'https://' + empresa.website}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">${empresa.website}</a>` : 'N/A'}</div>
                                ${empresa.link_cotacao ? `<div><strong>Cotação:</strong> <a href="${empresa.link_cotacao.startsWith('http') ? empresa.link_cotacao : 'https://' + empresa.link_cotacao}" target="_blank" class="inline-flex items-center px-3 py-1 bg-orange-600 text-white text-sm rounded-lg hover:bg-orange-700 transition-colors"><i class="fas fa-calculator mr-2"></i>Solicitar Cotação</a></div>` : ''}
                                <div><strong>Data de Fundação:</strong> ${formatarDataBrasil(empresa.data_fundacao)}</div>
                                ${empresa.observacoes ? `<div><strong>Observações:</strong> ${empresa.observacoes}</div>` : ''}
                            </div>
                        </div>
                        
                        <!-- Certificações -->
                        ${empresa.certificacoes && empresa.certificacoes.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Certificações</h4>
                            <div class="space-y-2">
                                ${empresa.certificacoes.map(cert => `
                                    <div class="bg-green-50 p-3 rounded-md">
                                        <div class="font-medium text-green-800">${cert.nome_certificacao}</div>
                                        <div class="text-sm text-green-600">
                                            Número: ${cert.numero_certificacao || 'N/A'} | 
                                            Válido até: ${formatarDataBrasil(cert.data_validade)} | 
                                            Certificador: ${cert.orgao_certificador || 'N/A'}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Tipos de Carga -->
                        ${empresa.tipos_carga && empresa.tipos_carga.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Tipos de Carga</h4>
                            <div class="flex flex-wrap gap-2">
                                ${empresa.tipos_carga.map(tipo => `
                                    <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">${tipo.tipo_carga}</span>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Modalidades de Transporte -->
                        ${empresa.modalidades_transporte && empresa.modalidades_transporte.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Modalidades de Transporte</h4>
                            <div class="flex flex-wrap gap-2">
                                ${empresa.modalidades_transporte.map(modal => `
                                    <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm">${modal.modalidade}</span>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Abrangência Geográfica -->
                        ${empresa.abrangencia_geografica && empresa.abrangencia_geografica.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Abrangência Geográfica</h4>
                            <div class="space-y-2">
                                ${empresa.abrangencia_geografica.map(abr => `
                                    <div class="bg-yellow-50 p-3 rounded-md">
                                        <div class="font-medium text-yellow-800">${abr.tipo_abrangencia}</div>
                                        <div class="text-sm text-yellow-600">${abr.detalhes || 'N/A'}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Armazenagem -->
                        ${empresa.armazenagem && empresa.armazenagem.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Armazenagem</h4>
                            <div class="space-y-2">
                                ${empresa.armazenagem.map(arm => `
                                    <div class="bg-gray-50 p-3 rounded-md">
                                        <div class="font-medium">${arm.possui_armazem ? 'Possui Armazém' : 'Não possui armazém'}</div>
                                        ${arm.possui_armazem ? `
                                            <div class="text-sm text-gray-600 mt-1">
                                                <div>Localização: ${arm.localizacao || 'N/A'}</div>
                                                <div>Capacidade: ${arm.capacidade_m2 || 'N/A'} m² | ${arm.capacidade_m3 || 'N/A'} m³</div>
                                                <div>Tipos: ${arm.tipos_armazenagem || 'N/A'}</div>
                                                <div>Serviços: ${arm.servicos_oferecidos || 'N/A'}</div>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Regulamentações e Licenças -->
                        ${empresa.regulamentacoes && empresa.regulamentacoes.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Regulamentações e Licenças</h4>
                            <div class="space-y-2">
                                ${empresa.regulamentacoes.map(reg => `
                                    <div class="bg-red-50 p-3 rounded-md">
                                        <div class="font-medium text-red-800">${reg.tipo_regulamentacao}</div>
                                        <div class="text-sm text-red-600">
                                            Registro: ${reg.numero_registro || 'N/A'} | 
                                            Emissão: ${formatarDataBrasil(reg.data_emissao)} | 
                                            Validade: ${formatarDataBrasil(reg.data_validade)} | 
                                            Órgão: ${reg.orgao_emissor || 'N/A'}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Frota -->
                        ${empresa.frota && empresa.frota.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Frota</h4>
                            <div class="space-y-2">
                                ${empresa.frota.map(frota => `
                                    <div class="bg-blue-50 p-3 rounded-md">
                                        <div class="font-medium text-blue-800">${frota.tipo_frota} - ${frota.tipo_veiculo}</div>
                                        <div class="text-sm text-blue-600">
                                            Carroceria: ${frota.tipo_carroceria || 'N/A'} | 
                                            Quantidade: ${frota.quantidade || 'N/A'} | 
                                            Capacidade: ${frota.capacidade || 'N/A'}t | 
                                            Ano Médio: ${frota.ano_medio || 'N/A'}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Portos e Terminais -->
                        ${empresa.portos_terminais && empresa.portos_terminais.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Portos e Terminais</h4>
                            <div class="space-y-2">
                                ${(() => {
                                    // Agrupar terminais por porto
                                    const portoTerminais = {};
                                    empresa.portos_terminais.forEach(item => {
                                        if (!portoTerminais[item.nome_porto_terminal]) {
                                            portoTerminais[item.nome_porto_terminal] = [];
                                        }
                                        portoTerminais[item.nome_porto_terminal].push(item.tipo_terminal);
                                    });
                                    
                                    // Gerar HTML para cada porto com seus terminais
                                    return Object.keys(portoTerminais).map(porto => `
                                        <div class="bg-teal-50 p-3 rounded-md">
                                            <div class="font-medium text-teal-800">${porto}</div>
                                            <div class="text-sm text-teal-600">
                                                Terminais: ${portoTerminais[porto].filter(t => t).join(', ') || 'N/A'}
                                            </div>
                                        </div>
                                    `).join('');
                                })()}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Seguros e Coberturas -->
                        ${empresa.seguros_coberturas && empresa.seguros_coberturas.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Seguros e Coberturas</h4>
                            <div class="space-y-2">
                                ${empresa.seguros_coberturas.map(seguro => `
                                    <div class="bg-orange-50 p-3 rounded-md">
                                        <div class="font-medium text-orange-800">${seguro.tipo_seguro}</div>
                                        <div class="text-sm text-orange-600">
                                            Seguradora: ${seguro.seguradora || 'N/A'} | 
                                            Cobertura: ${seguro.valor_cobertura || 'N/A'} | 
                                            Validade: ${formatarDataBrasil(seguro.data_validade)}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Tecnologias e Integração -->
                        ${empresa.tecnologias && empresa.tecnologias.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Tecnologias e Integração</h4>
                            <div class="space-y-2">
                                ${empresa.tecnologias.map(tech => `
                                    <div class="bg-indigo-50 p-3 rounded-md">
                                        <div class="font-medium text-indigo-800">${tech.nome_tecnologia}</div>
                                        <div class="text-sm text-indigo-600">${tech.detalhes || 'N/A'}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Clientes e Segmentos -->
                        ${empresa.clientes_segmentos && empresa.clientes_segmentos.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Clientes e Segmentos</h4>
                            <div class="space-y-2">
                                ${empresa.clientes_segmentos.map(cliente => `
                                    <div class="bg-pink-50 p-3 rounded-md">
                                        <div class="font-medium text-pink-800">${cliente.segmento}</div>
                                        <div class="text-sm text-pink-600">Principais Clientes: ${cliente.principais_clientes || 'N/A'}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Desempenho e Qualidade -->
                        ${empresa.desempenho_qualidade && empresa.desempenho_qualidade.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Desempenho e Qualidade</h4>
                            <div class="space-y-2">
                                ${empresa.desempenho_qualidade.map(desemp => `
                                    <div class="bg-green-50 p-3 rounded-md">
                                        <div class="text-sm text-green-600">
                                            Prazo Médio: ${desemp.prazo_medio_atendimento || 'N/A'} ${desemp.unidade_prazo || 'dias'} | 
                                            Avarias/Extravios: ${desemp.indice_avarias_extravios || 'N/A'}% | 
                                            Entregas no Prazo: ${desemp.indice_entregas_prazo || 'N/A'}%
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Recursos Humanos -->
                        ${empresa.recursos_humanos && empresa.recursos_humanos.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Recursos Humanos</h4>
                            <div class="space-y-2">
                                ${empresa.recursos_humanos.map(rh => `
                                    <div class="bg-cyan-50 p-3 rounded-md">
                                        <div class="font-medium text-cyan-800">Funcionários: ${rh.numero_funcionarios || 'N/A'}</div>
                                        <div class="text-sm text-cyan-600">Treinamentos: ${rh.programas_treinamento || 'N/A'}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Sustentabilidade -->
                        ${empresa.sustentabilidade && empresa.sustentabilidade.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Sustentabilidade</h4>
                            <div class="space-y-2">
                                ${empresa.sustentabilidade.map(sust => `
                                    <div class="bg-emerald-50 p-3 rounded-md">
                                        <div class="font-medium text-emerald-800">${sust.certificacao_ambiental}</div>
                                        <div class="text-sm text-emerald-600">Programas: ${sust.programas_reducao_emissoes || 'N/A'}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                modal.classList.add('show');
                modal.classList.add('fade-in');
                
            } catch (error) {
                console.error('Erro ao carregar detalhes:', error);
                alert('Erro ao carregar detalhes da empresa');
            }
        }

        // Fechar modal
        function fecharModal() {
            const modal = document.getElementById('modal-detalhes');
            modal.classList.remove('show');
            modal.classList.remove('fade-in');
        }

        // Cadastrar nova empresa ou atualizar empresa existente
        async function cadastrarEmpresa() {
            const isEditing = window.editingEmpresaId;
            console.log(isEditing ? 'Atualizando empresa...' : 'Cadastrando nova empresa...');
            
            const form = document.getElementById('form-cadastro');
            if (!form) {
                console.error('Formulário não encontrado!');
                alert('Erro: Formulário não encontrado!');
                return;
            }
            
            const formData = new FormData(form);
            
            // Coletar dados do formulário
            const empresaData = {
                razao_social: formData.get('razao_social'),
                nome_fantasia: formData.get('nome_fantasia'),
                cnpj: formData.get('cnpj'),
                inscricao_estadual: formData.get('inscricao_estadual'),
                endereco_completo: formData.get('endereco_completo'),
                telefone_comercial: formData.get('telefone_comercial'),
                telefone_emergencial: formData.get('telefone_emergencial'),
                email: formData.get('email'),
                website: formData.get('website'),
                link_cotacao: formData.get('link_cotacao'),
                data_fundacao: formData.get('data_fundacao'),
                observacoes: formData.get('observacoes'),
                etiqueta: formData.get('etiqueta'),
                modalidades_transporte: formData.getAll('modalidades_transporte'),
                tipos_carga: formData.getAll('tipos_carga'),
                regulamentacoes: getDynamicFormData('regulamentacoes'),
                certificacoes: getDynamicFormData('certificacoes'),
                abrangencia_geografica: getDynamicFormData('abrangencia'),
                frota: getDynamicFormData('frota'),
                armazenagem: getDynamicFormData('armazenagem'),
                portos_terminais: getDynamicFormData('portos-terminais'),
                seguros_coberturas: getDynamicFormData('seguros-coberturas'),
                tecnologias: getDynamicFormData('tecnologias'),
                desempenho_qualidade: getDynamicFormData('desempenho-qualidade'),
                clientes_segmentos: getDynamicFormData('clientes-segmentos'),
                recursos_humanos: getDynamicFormData('recursos-humanos'),
                sustentabilidade: getDynamicFormData('sustentabilidade')
            };
            
            console.log('Dados da empresa:', empresaData);
            
            try {
                let response;
                if (isEditing) {
                    // Atualizar empresa existente
                    response = await fetch(`/api/empresas/${window.editingEmpresaId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(empresaData)
                    });
                } else {
                    // Criar nova empresa
                    response = await fetch('/api/empresas', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(empresaData)
                    });
                }
                
                if (response.ok) {
                    alert(isEditing ? 'Empresa atualizada com sucesso!' : 'Empresa cadastrada com sucesso!');
                    
                    // Limpar formulário e resetar estado
                    form.reset();
                    limparCamposDinamicos();
                    resetarFormulario();
                    
                    // Navegar para a lista de empresas
                    showSection('empresas');
                    loadEmpresas(1);
                } else {
                    const error = await response.json();
                    alert('Erro ao ' + (isEditing ? 'atualizar' : 'cadastrar') + ' empresa: ' + error.error);
                }
                
            } catch (error) {
                console.error('Erro ao ' + (isEditing ? 'atualizar' : 'cadastrar') + ' empresa:', error);
                alert('Erro ao ' + (isEditing ? 'atualizar' : 'cadastrar') + ' empresa');
            }
        }
        
        // Função para limpar campos dinâmicos
        function limparCamposDinamicos() {
            // Não limpar se estiver editando uma empresa
            if (window.editingEmpresaId) {
                console.log('Não limpando campos dinâmicos - editando empresa:', window.editingEmpresaId);
                return;
            }
            
            console.log('Limpando campos dinâmicos...');
            const containers = [
                'regulamentacoes-container', 'certificacoes-container', 'abrangencia-container',
                'frota-container', 'armazenagem-container', 'portos-terminais-container',
                'seguros-coberturas-container', 'tecnologias-container', 'desempenho-qualidade-container',
                'clientes-segmentos-container', 'recursos-humanos-container', 'sustentabilidade-container'
            ];
            
            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = '';
                }
            });
        }
        
        // Função para resetar o formulário para modo de cadastro
        function resetarFormulario() {
            // Limpar ID de edição
            window.editingEmpresaId = null;
            
            // Resetar texto do botão
            const submitBtn = document.querySelector('#form-cadastro button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Salvar Empresa';
            }
            
            // Resetar título da seção
            const titulo = document.querySelector('#cadastro h2');
            if (titulo) {
                titulo.textContent = 'Cadastrar Nova Empresa';
            }
        }

        // Editar empresa
        async function editarEmpresa(empresaId) {
            try {
                console.log('Carregando empresa para edição:', empresaId);
                const response = await fetch(`/api/empresas/${empresaId}`);
                const empresa = await response.json();
                
                // Limpar formulário antes de preencher com novos dados
                const form = document.getElementById('form-cadastro');
                form.reset();
                
                // Limpar todos os containers dinâmicos
                const containers = [
                    'regulamentacoes-container', 'certificacoes-container', 'modalidades-container',
                    'tipos-carga-container', 'abrangencia-container', 'frota-container', 
                    'armazenagem-container', 'portos-terminais-container', 'seguros-coberturas-container',
                    'tecnologias-container', 'desempenho-qualidade-container', 'clientes-segmentos-container',
                    'recursos-humanos-container', 'sustentabilidade-container'
                ];
                
                containers.forEach(containerId => {
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.innerHTML = '';
                    }
                });
                
                // Armazenar ID da empresa sendo editada
                window.editingEmpresaId = empresaId;
                
                // Navegar para a seção de cadastro
                showSection('cadastro');
                
                // Preencher os dados básicos
                document.querySelector('input[name="razao_social"]').value = empresa.razao_social || '';
                document.querySelector('input[name="nome_fantasia"]').value = empresa.nome_fantasia || '';
                document.querySelector('input[name="cnpj"]').value = empresa.cnpj || '';
                document.querySelector('input[name="inscricao_estadual"]').value = empresa.inscricao_estadual || '';
                document.querySelector('textarea[name="endereco_completo"]').value = empresa.endereco_completo || '';
                document.querySelector('input[name="telefone_comercial"]').value = empresa.telefone_comercial || '';
                document.querySelector('input[name="telefone_emergencial"]').value = empresa.telefone_emergencial || '';
                document.querySelector('input[name="email"]').value = empresa.email || '';
                document.querySelector('input[name="website"]').value = empresa.website || '';
                document.querySelector('input[name="link_cotacao"]').value = empresa.link_cotacao || '';
                document.querySelector('input[name="data_fundacao"]').value = empresa.data_fundacao || '';
                document.querySelector('textarea[name="observacoes"]').value = empresa.observacoes || '';
                document.querySelector('select[name="etiqueta"]').value = empresa.etiqueta || 'CADASTRADA';
                
                // Preencher modalidades de transporte
                empresa.modalidades_transporte?.forEach(modalidade => {
                    const checkbox = document.querySelector(`input[name="modalidades_transporte"][value="${modalidade.modalidade}"]`);
                    if (checkbox) checkbox.checked = true;
                });
                
                // Preencher tipos de carga
                empresa.tipos_carga?.forEach(tipo => {
                    const checkbox = document.querySelector(`input[name="tipos_carga"][value="${tipo.tipo_carga}"]`);
                    if (checkbox) checkbox.checked = true;
                });
                
                // Preencher campos dinâmicos
                preencherCamposDinamicos('regulamentacoes', empresa.regulamentacoes || []);
                preencherCamposDinamicos('certificacoes', empresa.certificacoes || []);
                preencherCamposDinamicos('abrangencia', empresa.abrangencia_geografica || []);
                preencherCamposDinamicos('frota', empresa.frota || []);
                preencherCamposDinamicos('armazenagem', empresa.armazenagem || []);
                
                // LIMPEZA EXTRA PARA PORTOS - GARANTIR QUE ESTÁ VAZIO
                const portosContainer = document.getElementById('portos-terminais-container');
                if (portosContainer) {
                    portosContainer.innerHTML = '';
                    console.log('Container de portos limpo antes de preencher');
                }
                
                preencherCamposDinamicos('portos-terminais', empresa.portos_terminais || []);
                preencherCamposDinamicos('seguros-coberturas', empresa.seguros_coberturas || []);
                preencherCamposDinamicos('tecnologias', empresa.tecnologias || []);
                preencherCamposDinamicos('desempenho-qualidade', empresa.desempenho_qualidade || []);
                preencherCamposDinamicos('clientes-segmentos', empresa.clientes_segmentos || []);
                preencherCamposDinamicos('recursos-humanos', empresa.recursos_humanos || []);
                preencherCamposDinamicos('sustentabilidade', empresa.sustentabilidade || []);
                
                // Alterar o texto do botão para "Atualizar Empresa"
                const submitBtn = document.querySelector('#form-cadastro button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'Atualizar Empresa';
                }
                
                // Alterar o título da seção
                const titulo = document.querySelector('#cadastro h2');
                if (titulo) {
                    titulo.textContent = 'Editar Empresa';
                }
                
            } catch (error) {
                console.error('Erro ao carregar empresa para edição:', error);
                alert('Erro ao carregar dados da empresa');
            }
        }
        
        // Função auxiliar para preencher campos dinâmicos
        function preencherCamposDinamicos(prefix, dados) {
            console.log('Executando preencherCamposDinamicos para:', prefix, 'com', dados?.length || 0, 'itens');
            
            // Proteção específica contra execução dupla para portos-terminais
            // if (prefix === 'portos-terminais') {
            //     if (window.portosJaPreenchidos) {
            //         console.log('EXECUÇÃO DUPLA BLOQUEADA para portos-terminais');
            //         return;
            //     }
            //     window.portosJaPreenchidos = true;
            //     // Reset após 1 segundo para permitir nova edição
            //     setTimeout(() => {
            //         window.portosJaPreenchidos = false;
            //     }, 1000);
            // }
            
            const container = document.getElementById(`${prefix}-container`);
            if (!container || !dados || dados.length === 0) return;
            
            // Limpar container
            container.innerHTML = '';
            
            // Adicionar cada item
            dados.forEach((item, index) => {
                // Chamar a função apropriada para adicionar o campo
                switch(prefix) {
                    case 'regulamentacoes':
                        addRegulamentacao();
                        break;
                    case 'certificacoes':
                        addCertificacao();
                        break;
                    case 'abrangencia':
                        addAbrangencia();
                        break;
                    case 'frota':
                        addFrota();
                        break;
                    case 'armazenagem':
                        addArmazenagem();
                        break;
                    case 'portos-terminais':
                        console.log('Dados de portos recebidos:', dados);
                        
                        // Limpar o container de portos e terminais antes de preencher
                        container.innerHTML = '';

                        dados.forEach(item => {
                            if (item.nome_porto_terminal && item.tipo_terminal) {
                                addPortoTerminal(); // Adiciona um novo conjunto de campos de porto/terminal
                                const portoDiv = container.lastElementChild;
                                const portoSelect = portoDiv.querySelector('.porto-select');
                                const terminalSelect = portoDiv.querySelector('.terminal-select');

                                if (portoSelect) {
                                    portoSelect.value = item.nome_porto_terminal;
                                    // Chamar atualizarTerminais para popular os terminais corretos para o porto selecionado
                                    atualizarTerminais(portoSelect, container.children.length - 1);
                                }
                                if (terminalSelect) {
                                    terminalSelect.value = item.tipo_terminal;
                                }
                            }
                        });
                        break;
                    case 'seguros-coberturas':
                        addSeguroCobertura();
                        break;
                    case 'tecnologias':
                        addTecnologia();
                        break;
                    case 'desempenho-qualidade':
                        addDesempenhoQualidade();
                        break;
                    case 'clientes-segmentos':
                        addClienteSegmento();
                        break;
                    case 'recursos-humanos':
                        addRecursoHumano();
                        break;
                    case 'sustentabilidade':
                        addSustentabilidade();
                        break;
                }
                
                // Preencher os valores no último item adicionado
                const lastDiv = container.lastElementChild;
                if (lastDiv) {
                    Object.keys(item).forEach(key => {
                        const input = lastDiv.querySelector(`[name*="[${key}]"]`);
                        if (input) {
                            if (input.type === 'checkbox') {
                                input.checked = item[key];
                            } else {
                                input.value = item[key];
                            }
                        }
                    });
                }
            });
        }

        // Função auxiliar para coletar dados de campos dinâmicos
        function getDynamicFormData(prefix) {
            // Função específica para portos-terminais
            if (prefix === 'portos-terminais') {
                return getPortosTerminaisData();
            }
            
            const data = [];
            const container = document.getElementById(`${prefix}-container`);
            if (!container) return data;

            Array.from(container.children).forEach(div => {
                const item = {};
                Array.from(div.querySelectorAll('input, select, textarea')).forEach(input => {
                    const nameMatch = input.name.match(/\[(\w+)\]$/);
                    if (nameMatch) {
                        const name = nameMatch[1];
                        if (input.type === 'checkbox') {
                            item[name] = input.checked;
                        } else if (input.type === 'number') {
                            item[name] = parseFloat(input.value) || 0;
                        } else {
                            item[name] = input.value;
                        }
                    }
                });
                if (Object.keys(item).length > 0) {
                    data.push(item);
                }
            });
            return data;
        }

        function getPortosTerminaisData() {
            const dataSet = new Set();
            const container = document.getElementById('portos-terminais-container');
            if (!container) return [];

            Array.from(container.children).forEach(div => {
                const portoSelect = div.querySelector('.porto-select');
                const terminalSelect = div.querySelector('.terminal-select');
                
                if (portoSelect && terminalSelect && portoSelect.value && terminalSelect.value) {
                    const key = `${portoSelect.value}|${terminalSelect.value}`;
                    dataSet.add(key);
                }

                // Coletar terminais adicionais
                const terminaisAdicionais = div.querySelector('[id^="terminais-adicionais-"]');
                if (terminaisAdicionais) {
                    Array.from(terminaisAdicionais.children).forEach(terminalDiv => {
                        const terminalSelect = terminalDiv.querySelector('select');
                        const hiddenInput = terminalDiv.querySelector('input[type="hidden"]');
                        
                        if (terminalSelect && hiddenInput && terminalSelect.value) {
                            const key = `${hiddenInput.value}|${terminalSelect.value}`;
                            dataSet.add(key);
                        }
                    });
                }
            });

            // Converter Set de volta para array de objetos
            const data = [];
            dataSet.forEach(key => {
                const [nome_porto_terminal, tipo_terminal] = key.split('|');
                data.push({
                    nome_porto_terminal,
                    tipo_terminal
                });
            });

            console.log('Dados de portos coletados (sem duplicatas):', data);
            return data;
        }

        // Funções para adicionar campos dinâmicos
        function addRegulamentacao() {
            const container = document.getElementById("regulamentacoes-container");
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-md relative';
            div.innerHTML = `
                <button type="button" onclick="this.parentNode.remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Regulamentação</label>
                    <select name="regulamentacoes[${index}][tipo_regulamentacao]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="RNTRC">RNTRC (Registro Nacional de Transportadores Rodoviários de Cargas)</option>
                        <option value="ANTT">ANTT (Agência Nacional de Transportes Terrestres)</option>
                        <option value="Licença Originária ANTT">Licença Originária ANTT</option>
                        <option value="AET">AET (Autorização Especial de Trânsito)</option>
                        <option value="Licença Sanitária ANVISA">Licença Sanitária ANVISA</option>
                        <option value="CRLV">CRLV (Certificado de Registro e Licenciamento de Veículo)</option>
                        <option value="Autorização Transporte Internacional">Autorização de Transporte Rodoviário Internacional</option>
                        <option value="Permissão MERCOSUL">Permissão para Transporte Internacional de Cargas (MERCOSUL)</option>
                        <option value="Licença Polícia Federal">Licença da Polícia Federal para Transporte de Cargas</option>
                        <option value="Alvará Municipal">Alvará de Funcionamento Municipal</option>
                        <option value="Licença Ambiental">Licença Ambiental</option>
                        <option value="CRT">CRT (Certificado de Regularidade Técnica)</option>
                        <option value="Autorização Produtos Perigosos">Autorização para Transporte de Produtos Perigosos</option>
                        <option value="Licença IBAMA">Licença IBAMA</option>
                        <option value="CISV">CISV (Certificado de Inspeção de Segurança Veicular)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Número de Registro</label>
                    <input type="text" name="regulamentacoes[${index}][numero_registro]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data de Emissão</label>
                    <input type="date" name="regulamentacoes[${index}][data_emissao]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data de Validade</label>
                    <input type="date" name="regulamentacoes[${index}][data_validade]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Órgão Emissor</label>
                    <input type="text" name="regulamentacoes[${index}][orgao_emissor]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            `;
            container.appendChild(div);
        }

        function addCertificacao() {
            const container = document.getElementById("certificacoes-container");
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-md relative';
            div.innerHTML = `
                <button type="button" onclick="this.parentNode.remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Certificação</label>
                    <select name="certificacoes[${index}][nome_certificacao]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="ISO 9001">ISO 9001 (Sistema de Gestão da Qualidade)</option>
                        <option value="ISO 14001">ISO 14001 (Sistema de Gestão Ambiental)</option>
                        <option value="ISO 45001">ISO 45001 (Sistema de Gestão de Saúde e Segurança Ocupacional)</option>
                        <option value="ISO 28000">ISO 28000 (Sistema de Gestão de Segurança para a Cadeia de Suprimentos)</option>
                        <option value="ISO 39001">ISO 39001 (Sistema de Gestão de Segurança Viária)</option>
                        <option value="SASSMAQ">SASSMAQ (Sistema de Avaliação de Saúde, Segurança, Meio Ambiente e Qualidade)</option>
                        <option value="OEA">OEA (Operador Econômico Autorizado)</option>
                        <option value="Transqualit">Transqualit (Certificação de Qualidade em Transporte)</option>
                        <option value="ANVISA">ANVISA (Agência Nacional de Vigilância Sanitária)</option>
                        <option value="AFE">AFE (Autorização de Funcionamento de Empresa)</option>
                        <option value="AE">AE (Autorização Especial)</option>
                        <option value="CIPP">CIPP (Certificado de Inspeção para Produtos Perigosos)</option>
                        <option value="Certificação ABIQUIM">Certificação ABIQUIM</option>
                        <option value="Certificação INMETRO">Certificação INMETRO</option>
                        <option value="Certificação ANAC">Certificação ANAC</option>
                        <option value="Certificação ANTAQ">Certificação ANTAQ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Número da Certificação</label>
                    <input type="text" name="certificacoes[${index}][numero_certificacao]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data de Emissão</label>
                    <input type="date" name="certificacoes[${index}][data_emissao]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data de Validade</label>
                    <input type="date" name="certificacoes[${index}][data_validade]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Órgão Certificador</label>
                    <input type="text" name="certificacoes[${index}][orgao_certificador]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            `;
            container.appendChild(div);
        }

        function addAbrangencia() {
            const container = document.getElementById("abrangencia-container");
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-md relative';
            div.innerHTML = `
                <button type="button" onclick="this.parentNode.remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Abrangência</label>
                    <select name="abrangencia_geografica[${index}][tipo_abrangencia]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="Nacional">Nacional</option>
                        <option value="Regional">Regional</option>
                        <option value="Estadual">Estadual</option>
                        <option value="Interestadual">Interestadual</option>
                        <option value="Municipal">Municipal</option>
                        <option value="Intermunicipal">Intermunicipal</option>
                        <option value="Metropolitano">Metropolitano</option>
                        <option value="Internacional">Internacional</option>
                        <option value="Mercosul">Mercosul</option>
                        <option value="América do Sul">América do Sul</option>
                        <option value="Região Norte">Região Norte</option>
                        <option value="Região Nordeste">Região Nordeste</option>
                        <option value="Região Centro-Oeste">Região Centro-Oeste</option>
                        <option value="Região Sudeste">Região Sudeste</option>
                        <option value="Região Sul">Região Sul</option>
                        <option value="Eixo Rio-São Paulo">Eixo Rio-São Paulo</option>
                        <option value="Grande São Paulo">Grande São Paulo</option>
                        <option value="Grande Rio de Janeiro">Grande Rio de Janeiro</option>
                        <option value="Triângulo Mineiro">Triângulo Mineiro</option>
                        <option value="Vale do Paraíba">Vale do Paraíba</option>
                        <option value="Litoral">Litoral</option>
                        <option value="Interior">Interior</option>
                        <option value="Fronteira">Fronteira</option>
                        <option value="Zona Franca">Zona Franca</option>
                        <option value="Portuário">Portuário</option>
                        <option value="Aeroportuário">Aeroportuário</option>
                        <option value="Rodoviário">Rodoviário</option>
                        <option value="Ferroviário">Ferroviário</option>
                        <option value="Hidroviário">Hidroviário</option>
                        <option value="Multimodal">Multimodal</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Detalhes</label>
                    <textarea name="abrangencia_geografica[${index}][detalhes]" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: Estados atendidos, rotas específicas"></textarea>
                </div>
            `;
            container.appendChild(div);
        }

        function addFrota() {
            const container = document.getElementById("frota-container");
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-md relative';
            div.innerHTML = `
                <button type="button" onclick="this.parentNode.remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Frota</label>
                    <select name="frota[${index}][tipo_frota]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="Frota Própria">Frota Própria</option>
                        <option value="Frota Terceirizada">Frota Terceirizada</option>
                        <option value="Frota Mista">Frota Mista (Própria + Terceirizada)</option>
                        <option value="Frota Agregada">Frota Agregada</option>
                        <option value="Frota Alugada">Frota Alugada</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Veículo</label>
                    <select name="frota[${index}][tipo_veiculo]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="Caminhão Toco">Caminhão Toco</option>
                        <option value="Caminhão Truck">Caminhão Truck</option>
                        <option value="Carreta">Carreta (Cavalo Mecânico + Semirreboque)</option>
                        <option value="Bitrem">Bitrem</option>
                        <option value="Tritrem">Tritrem</option>
                        <option value="Rodotrem">Rodotrem</option>
                        <option value="Van">Van</option>
                        <option value="Furgão">Furgão</option>
                        <option value="Caminhonete">Caminhonete</option>
                        <option value="Utilitário">Utilitário</option>
                        <option value="VUC">VUC (Veículo Urbano de Carga)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Carroceria/Equipamento</label>
                    <select name="frota[${index}][tipo_carroceria]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="Baú Seco">Baú Seco</option>
                        <option value="Baú Refrigerado">Baú Refrigerado</option>
                        <option value="Graneleiro">Graneleiro</option>
                        <option value="Tanque">Tanque</option>
                        <option value="Prancha">Prancha/Prancha Rebaixada</option>
                        <option value="Sider">Sider</option>
                        <option value="Caçamba">Caçamba</option>
                        <option value="Porta Container">Porta Container</option>
                        <option value="Cegonheira">Cegonheira</option>
                        <option value="Munk">Munk (com guindaste)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Quantidade</label>
                    <input type="number" name="frota[${index}][quantidade]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Capacidade (toneladas)</label>
                    <input type="number" step="0.1" name="frota[${index}][capacidade]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ano Médio da Frota</label>
                    <input type="number" name="frota[${index}][ano_medio]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            `;
            container.appendChild(div);
        }

        function addArmazenagem() {
            const container = document.getElementById("armazenagem-container");
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-md relative';
            div.innerHTML = `
                <button type="button" onclick="this.parentNode.remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                <div class="md:col-span-2">
                    <label class="flex items-center">
                        <input type="checkbox" name="armazenagem[${index}][possui_armazem]" value="true" class="mr-2">
                        Possui Armazém?
                    </label>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Localização</label>
                    <input type="text" name="armazenagem[${index}][localizacao]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Capacidade (m²)</label>
                    <input type="number" step="0.01" name="armazenagem[${index}][capacidade_m2]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Capacidade (m³)</label>
                    <input type="number" step="0.01" name="armazenagem[${index}][capacidade_m3]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipos de Armazenagem</label>
                    <select name="armazenagem[${index}][tipos_armazenagem]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="Armazém Seco">Armazém Seco</option>
                        <option value="Armazém Refrigerado">Armazém Refrigerado</option>
                        <option value="Armazém Climatizado">Armazém Climatizado</option>
                        <option value="Armazém para Produtos Perigosos">Armazém para Produtos Perigosos</option>
                        <option value="Armazém Alfandegado">Armazém Alfandegado</option>
                        <option value="Armazém Geral">Armazém Geral</option>
                        <option value="Silo">Silo</option>
                        <option value="Tanque de Armazenagem">Tanque de Armazenagem</option>
                        <option value="Pátio Descoberto">Pátio Descoberto</option>
                        <option value="Galpão Industrial">Galpão Industrial</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Serviços Oferecidos</label>
                    <select name="armazenagem[${index}][servicos_oferecidos]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="Cross-docking">Cross-docking</option>
                        <option value="Picking">Picking</option>
                        <option value="Packing">Packing</option>
                        <option value="Etiquetagem">Etiquetagem</option>
                        <option value="Paletização">Paletização</option>
                        <option value="Conferência">Conferência</option>
                        <option value="Inventário">Inventário</option>
                        <option value="Controle de Estoque">Controle de Estoque</option>
                        <option value="Separação de Pedidos">Separação de Pedidos</option>
                        <option value="Consolidação de Cargas">Consolidação de Cargas</option>
                    </select>
                </div>
            `;
            container.appendChild(div);
        }

        function addPortoTerminal() {
            const container = document.getElementById("portos-terminais-container");
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-md relative';
            div.innerHTML = `
                <button type="button" onclick="this.parentNode.remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Porto/Terminal</label>
                    <select name="portos_terminais[${index}][nome_porto_terminal]" class="porto-select w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="atualizarTerminais(this, ${index})">
                        <option value="">Selecione...</option>
                        <option value="Ponta da Madeira (Maranhão)">Ponta da Madeira (Maranhão)</option>
                        <option value="Porto da Alumar (Maranhão)">Porto da Alumar (Maranhão)</option>
                        <option value="Porto de Angra dos Reis (Rio de Janeiro)">Porto de Angra dos Reis (Rio de Janeiro)</option>
                        <option value="Porto de Antonina (Paraná)">Porto de Antonina (Paraná)</option>
                        <option value="Porto de Aratu (Bahia)">Porto de Aratu (Bahia)</option>
                        <option value="Porto de Areia Branca (Rio Grande do Norte)">Porto de Areia Branca (Rio Grande do Norte)</option>
                        <option value="Porto de Barra do Riacho (Espírito Santo)">Porto de Barra do Riacho (Espírito Santo)</option>
                        <option value="Porto de Barra dos Coqueiros (Sergipe)">Porto de Barra dos Coqueiros (Sergipe)</option>
                        <option value="Porto de Belém (Pará)">Porto de Belém (Pará)</option>
                        <option value="Porto de Cabedelo (Paraíba)">Porto de Cabedelo (Paraíba)</option>
                        <option value="Porto de Ilhéus (Bahia)">Porto de Ilhéus (Bahia)</option>
                        <option value="Porto de Imbituba (Santa Catarina)">Porto de Imbituba (Santa Catarina)</option>
                        <option value="Porto de Itaguaí (Rio de Janeiro)">Porto de Itaguaí (Rio de Janeiro)</option>
                        <option value="Porto de Itajaí (Santa Catarina)">Porto de Itajaí (Santa Catarina)</option>
                        <option value="Porto de Itapoá (Santa Catarina)">Porto de Itapoá (Santa Catarina)</option>
                        <option value="Porto de Jaraguá (Alagoas)">Porto de Jaraguá (Alagoas)</option>
                        <option value="Porto de Natal (Rio Grande do Norte)">Porto de Natal (Rio Grande do Norte)</option>
                        <option value="Porto de Navegantes (Santa Catarina)">Porto de Navegantes (Santa Catarina)</option>
                        <option value="Porto de Niterói (Rio de Janeiro)">Porto de Niterói (Rio de Janeiro)</option>
                        <option value="Porto de Paranaguá (Paraná)">Porto de Paranaguá (Paraná)</option>
                        <option value="Porto do Pecém (Ceará)">Porto do Pecém (Ceará)</option>
                        <option value="Porto de Rio Grande (Rio Grande do Sul)">Porto de Rio Grande (Rio Grande do Sul)</option>
                        <option value="Porto de Salvador (Bahia)">Porto de Salvador (Bahia)</option>
                        <option value="Porto de Macapá (Amapá)">Porto de Macapá (Amapá)</option>
                        <option value="Porto de Santos (São Paulo)">Porto de Santos (São Paulo)</option>
                        <option value="Porto de São Francisco do Sul (Santa Catarina)">Porto de São Francisco do Sul (Santa Catarina)</option>
                        <option value="Porto de São Sebastião (São Paulo)">Porto de São Sebastião (São Paulo)</option>
                        <option value="Porto de Suape (Pernambuco)">Porto de Suape (Pernambuco)</option>
                        <option value="Porto de Tubarão (Espírito Santo)">Porto de Tubarão (Espírito Santo)</option>
                        <option value="Porto de Vila do Conde (Pará)">Porto de Vila do Conde (Pará)</option>
                        <option value="Porto de Vitória (Espírito Santo)">Porto de Vitória (Espírito Santo)</option>
                        <option value="Porto do Açu (Rio de Janeiro)">Porto do Açu (Rio de Janeiro)</option>
                        <option value="Porto do Forno (Rio de Janeiro)">Porto do Forno (Rio de Janeiro)</option>
                        <option value="Porto do Itaqui (Maranhão)">Porto do Itaqui (Maranhão)</option>
                        <option value="Porto do Mucuripe (Ceará)">Porto do Mucuripe (Ceará)</option>
                        <option value="Porto do Recife (Pernambuco)">Porto do Recife (Pernambuco)</option>
                        <option value="Porto do Rio de Janeiro (Rio de Janeiro)">Porto do Rio de Janeiro (Rio de Janeiro)</option>
                        <option value="Porto Pesqueiro de Laguna (Santa Catarina)">Porto Pesqueiro de Laguna (Santa Catarina)</option>
                        <option value="Porto Piauí (Piauí)">Porto Piauí (Piauí)</option>
                        <option value="Porto Sudeste (Rio de Janeiro)">Porto Sudeste (Rio de Janeiro)</option>
                        <option value="Terminal de Miramar (Pará)">Terminal de Miramar (Pará)</option>
                        <option value="Terminal de Praia Mole (Espírito Santo)">Terminal de Praia Mole (Espírito Santo)</option>
                        <option value="Porto de Cáceres (Mato Grosso)">Porto de Cáceres (Mato Grosso)</option>
                        <option value="Porto de Cachoeira do Sul (Rio Grande do Sul)">Porto de Cachoeira do Sul (Rio Grande do Sul)</option>
                        <option value="Porto de Caracaraí (Roraima)">Porto de Caracaraí (Roraima)</option>
                        <option value="Porto de Charqueadas (Rio Grande do Sul)">Porto de Charqueadas (Rio Grande do Sul)</option>
                        <option value="Porto de Corumbá (Mato Grosso do Sul)">Porto de Corumbá (Mato Grosso do Sul)</option>
                        <option value="Porto de Eirunepé (Amazonas)">Porto de Eirunepé (Amazonas)</option>
                        <option value="Porto de Estrela (Rio Grande do Sul)">Porto de Estrela (Rio Grande do Sul)</option>
                        <option value="Terminal de Itacoatiara (Amazonas)">Terminal de Itacoatiara (Amazonas)</option>
                        <option value="Porto de Juazeiro (Bahia)">Porto de Juazeiro (Bahia)</option>
                        <option value="Porto de Ladário (Mato Grosso do Sul)">Porto de Ladário (Mato Grosso do Sul)</option>
                        <option value="Porto de Manaus (Amazonas)">Porto de Manaus (Amazonas)</option>
                        <option value="Porto de Pelotas (Rio Grande do Sul)">Porto de Pelotas (Rio Grande do Sul)</option>
                        <option value="Porto de Parintins (Amazonas)">Porto de Parintins (Amazonas)</option>
                        <option value="Porto de Petrolina (Pernambuco)">Porto de Petrolina (Pernambuco)</option>
                        <option value="Porto de Pirapora (Minas Gerais)">Porto de Pirapora (Minas Gerais)</option>
                        <option value="Porto de Porto Alegre (Rio Grande do Sul)">Porto de Porto Alegre (Rio Grande do Sul)</option>
                        <option value="Porto de Porto Murtinho (Mato Grosso do Sul)">Porto de Porto Murtinho (Mato Grosso do Sul)</option>
                        <option value="Porto de Porto Velho (Rondônia)">Porto de Porto Velho (Rondônia)</option>
                        <option value="Porto Internacional de Porto Xavier (Rio Grande do Sul)">Porto Internacional de Porto Xavier (Rio Grande do Sul)</option>
                        <option value="Porto de Santana (Amapá)">Porto de Santana (Amapá)</option>
                        <option value="Porto de Santarém (Pará)">Porto de Santarém (Pará)</option>
                        <option value="Porto de Tabatinga (Amazonas)">Porto de Tabatinga (Amazonas)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Terminal</label>
                    <select name="portos_terminais[${index}][tipo_terminal]" class="terminal-select w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione primeiro o porto...</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <button type="button" onclick="adicionarTerminalAoPorto(${index})" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Adicionar Outro Terminal a Este Porto
                    </button>
                </div>
                <div class="terminais-adicionais md:col-span-2" id="terminais-adicionais-${index}">
                    <!-- Terminais adicionais serão adicionados aqui -->
                </div>
            `;
            container.appendChild(div);
        }

        function addSeguroCobertura() {
            const container = document.getElementById("seguros-coberturas-container");
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-md relative';
            div.innerHTML = `
                <button type="button" onclick="this.parentNode.remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Seguro</label>
                    <select name="seguros_coberturas[${index}][tipo_seguro]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="RCTR-C">RCTR-C (Responsabilidade Civil do Transportador Rodoviário de Cargas)</option>
                        <option value="RC-V">RC-V (Responsabilidade Civil de Veículo)</option>
                        <option value="SPVAT">SPVAT (Seguro de Proteção de Veículos Automotores Terrestres)</option>
                        <option value="RCF-DC">RCF-DC (Responsabilidade Civil Facultativa - Desaparecimento de Carga)</option>
                        <option value="Seguro de Transporte Nacional">Seguro de Transporte Nacional</option>
                        <option value="RCTR-VI">RCTR-VI (Responsabilidade Civil do Transportador Rodoviário - Viagem Internacional)</option>
                        <option value="Seguro de Carga">Seguro de Carga</option>
                        <option value="Seguro de Frota">Seguro de Frota</option>
                        <option value="Seguro de Responsabilidade Civil Geral">Seguro de Responsabilidade Civil Geral</option>
                        <option value="Seguro de Vida para Motoristas">Seguro de Vida para Motoristas</option>
                        <option value="Seguro de Acidentes Pessoais">Seguro de Acidentes Pessoais</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Seguradora</label>
                    <input type="text" name="seguros_coberturas[${index}][seguradora]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor da Cobertura</label>
                    <input type="text" name="seguros_coberturas[${index}][valor_cobertura]" class="valor-cobertura w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="R$ 0,00">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data de Validade</label>
                    <input type="date" name="seguros_coberturas[${index}][data_validade]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            `;
            container.appendChild(div);
            
            // Adicionar formatação automática para o campo de valor da cobertura
            const valorInput = div.querySelector('.valor-cobertura');
            valorInput.addEventListener('input', function(e) {
                formatarValorCobertura(e.target);
            });
        }

        function addTecnologia() {
            const container = document.getElementById("tecnologias-container");
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-md relative';
            div.innerHTML = `
                <button type="button" onclick="this.parentNode.remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Tecnologia</label>
                    <select name="tecnologias[${index}][nome_tecnologia]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="TMS">TMS (Transportation Management System)</option>
                        <option value="WMS">WMS (Warehouse Management System)</option>
                        <option value="ERP">ERP (Enterprise Resource Planning)</option>
                        <option value="CRM">CRM (Customer Relationship Management)</option>
                        <option value="BI">BI (Business Intelligence)</option>
                        <option value="EDI">EDI (Electronic Data Interchange)</option>
                        <option value="GPS">GPS (Sistema de Posicionamento Global)</option>
                        <option value="RFID">RFID (Identificação por Radiofrequência)</option>
                        <option value="IoT">IoT (Internet das Coisas)</option>
                        <option value="Telemetria">Telemetria</option>
                        <option value="Monitoramento por Satélite">Monitoramento por Satélite</option>
                        <option value="Rastreamento em Tempo Real">Rastreamento em Tempo Real</option>
                        <option value="Cerca Eletrônica">Cerca Eletrônica (Geofencing)</option>
                        <option value="Rádio Comunicação">Rádio Comunicação</option>
                        <option value="Telefonia Móvel">Telefonia Móvel</option>
                        <option value="Internet Móvel">Internet Móvel</option>
                        <option value="Comunicação por Satélite">Comunicação por Satélite</option>
                        <option value="Sistema de Emergência">Sistema de Emergência</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Detalhes</label>
                    <textarea name="tecnologias[${index}][detalhes]" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
            `;
            container.appendChild(div);
        }

        function addDesempenhoQualidade() {
            const container = document.getElementById("desempenho-qualidade-container");
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-md relative';
            div.innerHTML = `
                <button type="button" onclick="this.parentNode.remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Prazo Médio de Atendimento</label>
                    <div class="flex gap-2">
                        <input type="text" step="0.01" name="desempenho_qualidade[${index}][prazo_medio_atendimento]" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: 5">
                        <select name="desempenho_qualidade[${index}][unidade_prazo]" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="horas">horas</option>
                            <option value="dias">dias</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Índice de Avarias/Extravios (%)</label>
                    <input type="number" step="0.01" name="desempenho_qualidade[${index}][indice_avarias_extravios]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Índice de Entregas no Prazo (%)</label>
                    <input type="number" step="0.01" name="desempenho_qualidade[${index}][indice_entregas_prazo]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            `;
            container.appendChild(div);
        }

        function addClienteSegmento() {
            const container = document.getElementById("clientes-segmentos-container");
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-md relative';
            div.innerHTML = `
                <button type="button" onclick="this.parentNode.remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Segmento</label>
                    <select name="clientes_segmentos[${index}][segmento]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="Indústria Automobilística">Indústria Automobilística</option>
                        <option value="Indústria Alimentícia">Indústria Alimentícia</option>
                        <option value="Indústria Química">Indústria Química</option>
                        <option value="Indústria Farmacêutica">Indústria Farmacêutica</option>
                        <option value="Indústria Têxtil">Indústria Têxtil</option>
                        <option value="Indústria Metalúrgica">Indústria Metalúrgica</option>
                        <option value="Indústria de Papel e Celulose">Indústria de Papel e Celulose</option>
                        <option value="Indústria Petroquímica">Indústria Petroquímica</option>
                        <option value="Indústria de Bebidas">Indústria de Bebidas</option>
                        <option value="Indústria de Cosméticos">Indústria de Cosméticos</option>
                        <option value="Varejo">Varejo</option>
                        <option value="E-commerce">E-commerce</option>
                        <option value="Atacado">Atacado</option>
                        <option value="Supermercados">Supermercados</option>
                        <option value="Shopping Centers">Shopping Centers</option>
                        <option value="Distribuidoras">Distribuidoras</option>
                        <option value="Importadores/Exportadores">Importadores/Exportadores</option>
                        <option value="Agronegócio">Agronegócio</option>
                        <option value="Mineração">Mineração</option>
                        <option value="Construção Civil">Construção Civil</option>
                        <option value="Energia">Energia</option>
                        <option value="Telecomunicações">Telecomunicações</option>
                        <option value="Saúde">Saúde</option>
                        <option value="Educação">Educação</option>
                        <option value="Governo">Governo</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Principais Clientes</label>
                    <textarea name="clientes_segmentos[${index}][principais_clientes]" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: Empresa A, Empresa B"></textarea>
                </div>
            `;
            container.appendChild(div);
        }

        function addRecursoHumano() {
            const container = document.getElementById("recursos-humanos-container");
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-md relative';
            div.innerHTML = `
                <button type="button" onclick="this.parentNode.remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Número de Funcionários</label>
                    <input type="number" name="recursos_humanos[${index}][numero_funcionarios]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Programas de Treinamento</label>
                    <textarea name="recursos_humanos[${index}][programas_treinamento]" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: Direção defensiva, Produtos perigosos"></textarea>
                </div>
            `;
            container.appendChild(div);
        }

        function addSustentabilidade() {
            const container = document.getElementById("sustentabilidade-container");
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-md relative';
            div.innerHTML = `
                <button type="button" onclick="this.parentNode.remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Certificação Ambiental</label>
                    <select name="sustentabilidade[${index}][certificacao_ambiental]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="ISO 14001">ISO 14001 (Sistema de Gestão Ambiental)</option>
                        <option value="Selo Verde">Selo Verde</option>
                        <option value="Certificação LEED">Certificação LEED</option>
                        <option value="Certificação AQUA">Certificação AQUA</option>
                        <option value="Programa Brasileiro GHG Protocol">Programa Brasileiro GHG Protocol</option>
                        <option value="Carbon Trust">Carbon Trust</option>
                        <option value="Certificação FSC">Certificação FSC (Forest Stewardship Council)</option>
                        <option value="Certificação PEFC">Certificação PEFC (Programme for the Endorsement of Forest Certification)</option>
                        <option value="Certificação Cradle to Cradle">Certificação Cradle to Cradle</option>
                        <option value="Certificação BREEAM">Certificação BREEAM</option>
                        <option value="Programa de Redução de Emissões">Programa de Redução de Emissões</option>
                        <option value="Programa de Eficiência Energética">Programa de Eficiência Energética</option>
                        <option value="Programa de Gestão de Resíduos">Programa de Gestão de Resíduos</option>
                        <option value="Programa de Uso Racional da Água">Programa de Uso Racional da Água</option>
                        <option value="Programa de Biodiesel">Programa de Biodiesel</option>
                        <option value="Programa de Renovação de Frota">Programa de Renovação de Frota</option>
                        <option value="Programa de Compensação de Carbono">Programa de Compensação de Carbono</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Programas de Redução de Emissões</label>
                    <textarea name="sustentabilidade[${index}][programas_reducao_emissoes]" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: Frota Euro 5/6, Biodiesel"></textarea>
                </div>
            `;
            container.appendChild(div);
        }
        
        // Função para limpar formulário de cadastro
        function limparFormularioCadastro() {
            console.log('Limpando formulário de cadastro...');
            
            // Limpar campos básicos
            const form = document.getElementById('form-cadastro');
            if (form) {
                form.reset();
            }
            
            // Limpar campos dinâmicos
            limparCamposDinamicos();
            
            // Resetar estado de edição
            resetarFormulario();
        }
        
        // Função para formatar valor da cobertura
        function formatarValorCobertura(input) {
            let valor = input.value;
            
            // Remove tudo que não é número
            valor = valor.replace(/\D/g, '');
            
            // Se não há valor, limpa o campo
            if (!valor) {
                input.value = '';
                return;
            }
            
            // Converte para número e formata
            const numero = parseInt(valor);
            
            // Formata no padrão brasileiro (4.000,00) sem símbolo de moeda
            const formatado = new Intl.NumberFormat('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(numero / 100);
            
            input.value = formatado;
        }
        
        // Função para atualizar opções de terminais baseado no porto selecionado
        function atualizarTerminais(portoSelect, index) {
            const terminalSelect = portoSelect.parentNode.parentNode.querySelector('.terminal-select');
            const porto = portoSelect.value;
            
            // Limpar opções existentes
            terminalSelect.innerHTML = '<option value="">Selecione...</option>';
            
            // Adicionar opções baseadas no porto selecionado
            const terminaisComuns = [
                'Terminal de Contêineres',
                'Terminal de Granéis Sólidos', 
                'Terminal de Granéis Líquidos',
                'Terminal de Carga Geral',
                'Terminal Roll-on/Roll-off',
                'Terminal Marítimo',
                'Terminal Intermodal',
                'Terminal de Transbordo'
            ];
            
            terminaisComuns.forEach(terminal => {
                const option = document.createElement('option');
                option.value = terminal;
                option.textContent = terminal;
                terminalSelect.appendChild(option);
            });
        }
        
        // Função para adicionar terminal adicional ao mesmo porto
        function adicionarTerminalAoPorto(portoIndex) {
            const portoDiv = document.querySelector(`#portos-terminais-container > div:nth-child(${portoIndex + 1})`);
            const portoSelect = portoDiv.querySelector('.porto-select');
            const porto = portoSelect.value;
            
            if (!porto) {
                alert('Selecione primeiro um porto antes de adicionar terminais adicionais.');
                return;
            }
            
            const terminaisContainer = document.getElementById(`terminais-adicionais-${portoIndex}`);
            const terminalIndex = terminaisContainer.children.length;
            
            const terminalDiv = document.createElement('div');
            terminalDiv.className = 'flex gap-4 items-center p-2 bg-blue-50 rounded-md mb-2';
            terminalDiv.innerHTML = `
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Terminal Adicional</label>
                    <select name="portos_terminais[${portoIndex}_${terminalIndex}][tipo_terminal]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="Terminal de Contêineres">Terminal de Contêineres</option>
                        <option value="Terminal de Granéis Sólidos">Terminal de Granéis Sólidos</option>
                        <option value="Terminal de Granéis Líquidos">Terminal de Granéis Líquidos</option>
                        <option value="Terminal de Carga Geral">Terminal de Carga Geral</option>
                        <option value="Terminal Roll-on/Roll-off">Terminal Roll-on/Roll-off</option>
                        <option value="Terminal Marítimo">Terminal Marítimo</option>
                        <option value="Terminal Intermodal">Terminal Intermodal</option>
                        <option value="Terminal de Transbordo">Terminal de Transbordo</option>
                    </select>
                    <input type="hidden" name="portos_terminais[${portoIndex}_${terminalIndex}][nome_porto_terminal]" value="${porto}">
                </div>
                <button type="button" onclick="this.parentNode.remove()" class="text-red-500 hover:text-red-700">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            terminaisContainer.appendChild(terminalDiv);
        }
    </script>

    <!-- Analytics Dashboard Scripts -->
    <script>
        // Dados para os gráficos (serão carregados via API)
        let analyticsData = {
            empresasPorRegiao: [],
            tiposCarga: [],
            crescimentoMensal: [],
            certificacoes: []
        };

        // Variáveis para controle dos gráficos
        let graficosRenderizados = false;
        let graficosInstancias = {};

        // Função para carregar dados analytics
        async function carregarDadosAnalytics() {
            console.log('🔄 Carregando dados analytics...');
            
            // Verificar se já está carregando
            if (window.carregandoAnalytics) {
                console.log('⏳ Já está carregando analytics, aguardando...');
                return;
            }
            
            window.carregandoAnalytics = true;
            
            try {
                const response = await fetch('/api/analytics');
                if (response.ok) {
                    analyticsData = await response.json();
                    console.log('✅ Dados da API carregados:', analyticsData);
                } else {
                    console.log('⚠️ Erro na API, usando dados de exemplo:', response.status);
                    await carregarDadosReais();
                }
            } catch (error) {
                console.log('⚠️ Erro na API, usando dados de exemplo:', error.message);
                await carregarDadosReais();
            }
            
            console.log('📊 Dados de exemplo carregados:', analyticsData);
            
            // Aguardar um pouco antes de renderizar
            setTimeout(() => {
                console.log('🎨 Renderizando gráficos...');
                renderizarGraficos();
                window.carregandoAnalytics = false;
            }, 500);
        }

               // Função para carregar dados reais da API
        async function carregarDadosReais() {
            try {
                const response = await fetch('/api/analytics');
                if (response.ok) {
                    const data = await response.json();
                    analyticsData = data;
                } else {
                    console.error('Erro ao carregar dados da API');
                    // Em caso de erro, manter dados vazios
                    analyticsData = {
                        empresasPorRegiao: [],
                        tiposCarga: [],
                        crescimentoMensal: [],
                        certificacoes: []
                    };
                }
            } catch (error) {
                console.error('Erro ao conectar com a API:', error);
                // Em caso de erro, manter dados vazios
                analyticsData = {
                    empresasPorRegiao: [],
                    tiposCarga: [],
                    crescimentoMensal: [],
                    certificacoes: []
                };
            }
        }

        // Função para destruir gráficos anteriores
        function destruirGraficosAnteriores() {
            console.log('🧹 Destruindo gráficos anteriores...');
            
            // Destruir instâncias do Chart.js
            Object.keys(graficosInstancias).forEach(key => {
                if (graficosInstancias[key]) {
                    graficosInstancias[key].destroy();
                    delete graficosInstancias[key];
                }
            });
            
            // Limpar canvas
            const canvasIds = ['chart-empresas-regiao', 'chart-tipos-carga', 'chart-crescimento', 'chart-certificacoes'];
            canvasIds.forEach(id => {
                const canvas = document.getElementById(id);
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    // Resetar tamanho do canvas
                    canvas.width = canvas.offsetWidth;
                    canvas.height = 300;
                    canvas.style.height = '300px';
                    canvas.style.width = '100%';
                }
            });
            
            graficosRenderizados = false;
            console.log('✅ Gráficos anteriores destruídos');
        }

        // Função para renderizar todos os gráficos
        function renderizarGraficos() {
            // Verificar se já foram renderizados
            if (graficosRenderizados) {
                console.log('⚠️ Gráficos já renderizados, ignorando...');
                return;
            }
            
            console.log('🎨 Iniciando renderização dos gráficos...');
            
            // Destruir gráficos anteriores primeiro
            destruirGraficosAnteriores();
            
            // Aguardar um pouco antes de renderizar novos
            setTimeout(() => {
                renderizarGraficoRegiao();
                renderizarGraficoTiposCarga();
                renderizarGraficoCrescimento();
                renderizarGraficoCertificacoes();
                carregarMetricasDetalhadas();
                
                graficosRenderizados = true;
                console.log('✅ Todos os gráficos renderizados!');
            }, 100);
        }

        // Gráfico de Pizza - Empresas por Região
        function renderizarGraficoRegiao() {
            const canvas = document.getElementById('chart-empresas-regiao');
            if (!canvas) return;
            
            // Definir tamanho fixo
            canvas.width = canvas.offsetWidth;
            canvas.height = 300;
            canvas.style.height = '300px';
            
            const ctx = canvas.getContext('2d');
            
            graficosInstancias['regiao'] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: analyticsData.empresasPorRegiao.map(item => item.regiao),
                    datasets: [{
                        data: analyticsData.empresasPorRegiao.map(item => item.empresas),
                        backgroundColor: ['#10B981', '#3B82F6', '#F59E0B', '#EF4444', '#8B5CF6'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((context.parsed * 100) / total);
                                    return `${context.label}: ${context.parsed} empresas (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Gráfico de Barras - Tipos de Carga
        function renderizarGraficoTiposCarga() {
            const canvas = document.getElementById('chart-tipos-carga');
            if (!canvas) return;
            
            // Definir tamanho fixo
            canvas.width = canvas.offsetWidth;
            canvas.height = 300;
            canvas.style.height = '300px';
            
            const ctx = canvas.getContext('2d');
            
            graficosInstancias['tiposCarga'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: analyticsData.tiposCarga.map(item => item.tipo),
                    datasets: [{
                        label: 'Quantidade de Empresas',
                        data: analyticsData.tiposCarga.map(item => item.quantidade),
                        backgroundColor: '#10B981',
                        borderColor: '#059669',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#E5E7EB'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // Gráfico de Linha - Crescimento Mensal
        function renderizarGraficoCrescimento() {
            const canvas = document.getElementById('chart-crescimento');
            if (!canvas) return;
            
            // Definir tamanho fixo
            canvas.width = canvas.offsetWidth;
            canvas.height = 300;
            canvas.style.height = '300px';
            
            const ctx = canvas.getContext('2d');
            
            graficosInstancias['crescimento'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: analyticsData.crescimentoMensal.map(item => item.mes),
                    datasets: [{
                        label: 'Total de Empresas',
                        data: analyticsData.crescimentoMensal.map(item => item.empresas),
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#3B82F6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: '#E5E7EB'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Gráfico de Barras Horizontais - Certificações
        function renderizarGraficoCertificacoes() {
            const canvas = document.getElementById('chart-certificacoes');
            if (!canvas) return;
            
            // Definir tamanho fixo
            canvas.width = canvas.offsetWidth;
            canvas.height = 300;
            canvas.style.height = '300px';
            
            const ctx = canvas.getContext('2d');
            
            graficosInstancias['certificacoes'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: analyticsData.certificacoes.map(item => item.certificacao),
                    datasets: [{
                        label: 'Quantidade de Empresas',
                        data: analyticsData.certificacoes.map(item => item.quantidade),
                        backgroundColor: '#F59E0B',
                        borderColor: '#D97706',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                color: '#E5E7EB'
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Carregar métricas detalhadas na tabela
        function carregarMetricasDetalhadas() {
            fetch("/api/analytics")
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById("metricas-tabela");
                    tbody.innerHTML = "";

                    if (data.metricas_detalhadas) {
                        data.metricas_detalhadas.forEach(metrica => {
                            const row = document.createElement("tr");
                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${metrica.metrica}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold">${metrica.valor}</td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                })
                .catch(error => console.error("Erro ao carregar métricas detalhadas:", error));
        }

        // Inicializar analytics quando a página carregar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📱 DOM carregado, verificando se dashboard está visível...');
            
            // Aguardar um pouco para garantir que tudo foi carregado
            setTimeout(() => {
                const dashboard = document.getElementById('dashboard');
                if (dashboard && dashboard.style.display !== 'none') {
                    console.log('📊 Dashboard visível, carregando analytics...');
                    carregarDadosAnalytics();
                }
            }, 100);
        });

        // Event listener para recarregar gráficos removido para evitar conflitos
        // O carregamento de gráficos já é feito na função showSection

        // Funções de exportação de relatórios
        document.getElementById('btn-export-pdf').addEventListener('click', function() {
            exportarRelatorioPDF();
        });

        document.getElementById('btn-export-excel').addEventListener('click', function() {
            exportarRelatorioExcel();
        });

        // Exportar relatório em PDF
        async function exportarRelatorioPDF() {
            try {
                // Mostrar loading
                const btn = document.getElementById('btn-export-pdf');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Gerando PDF...';
                btn.disabled = true;

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // Título do relatório
                pdf.setFontSize(20);
                pdf.setTextColor(40, 40, 40);
                pdf.text('Relatório Analytics - BRCCSiS', 20, 30);
                
                // Data do relatório
                const hoje = new Date().toLocaleDateString('pt-BR');
                pdf.setFontSize(12);
                pdf.setTextColor(100, 100, 100);
                pdf.text(`Gerado em: ${hoje}`, 20, 40);

                // Buscar métricas avançadas
                const response = await fetch('/api/metricas-avancadas');
                const metricas = await response.json();

                // Seção de métricas gerais
                pdf.setFontSize(16);
                pdf.setTextColor(40, 40, 40);
                pdf.text('Métricas Gerais', 20, 60);
                
                pdf.setFontSize(12);
                let yPos = 75;
                
                const metricasTexto = [
                    `Total de Empresas: ${metricas.total_empresas}`,
                    `Taxa de Certificação: ${metricas.taxa_certificacao}%`,
                    `Cobertura Nacional: ${metricas.cobertura_nacional}%`,
                    `Empresas com Armazenagem: ${metricas.taxa_armazenagem}%`,
                    `Diversificação de Carga: ${metricas.diversificacao_carga}`,
                    `Estados Cobertos: ${metricas.estados_cobertos}/27`
                ];

                metricasTexto.forEach(texto => {
                    pdf.text(texto, 25, yPos);
                    yPos += 10;
                });

                // Seção de distribuição por região
                pdf.setFontSize(16);
                pdf.text('Distribuição por Região', 20, yPos + 15);
                yPos += 30;

                analyticsData.empresasPorRegiao.forEach(regiao => {
                    pdf.setFontSize(12);
                    pdf.text(`${regiao.regiao}: ${regiao.empresas} empresas (${regiao.porcentagem}%)`, 25, yPos);
                    yPos += 8;
                });

                // Nova página para tipos de carga
                pdf.addPage();
                yPos = 30;
                
                pdf.setFontSize(16);
                pdf.text('Tipos de Carga Mais Comuns', 20, yPos);
                yPos += 15;

                analyticsData.tiposCarga.forEach(tipo => {
                    pdf.setFontSize(12);
                    pdf.text(`${tipo.tipo}: ${tipo.quantidade} empresas`, 25, yPos);
                    yPos += 8;
                });

                // Seção de certificações
                yPos += 20;
                pdf.setFontSize(16);
                pdf.text('Certificações Mais Utilizadas', 20, yPos);
                yPos += 15;

                analyticsData.certificacoes.forEach(cert => {
                    pdf.setFontSize(12);
                    pdf.text(`${cert.certificacao}: ${cert.quantidade} empresas`, 25, yPos);
                    yPos += 8;
                });

                // Rodapé
                const totalPages = pdf.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    pdf.setPage(i);
                    pdf.setFontSize(10);
                    pdf.setTextColor(150, 150, 150);
                    pdf.text(`Página ${i} de ${totalPages}`, 170, 285);
                    pdf.text('BRCCSiS - Sistema de Empresas Logísticas', 20, 285);
                }

                // Salvar PDF
                pdf.save(`relatorio-analytics-${hoje.replace(/\//g, '-')}.pdf`);

                // Restaurar botão
                btn.innerHTML = originalText;
                btn.disabled = false;

                // Mostrar mensagem de sucesso
                alert('Relatório PDF gerado com sucesso!');

            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('Erro ao gerar relatório PDF. Tente novamente.');
                
                // Restaurar botão
                const btn = document.getElementById('btn-export-pdf');
                btn.innerHTML = '<i class="fas fa-file-pdf mr-2"></i>PDF';
                btn.disabled = false;
            }
        }

        // Exportar relatório em Excel
        async function exportarRelatorioExcel() {
            try {
                // Mostrar loading
                const btn = document.getElementById('btn-export-excel');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Gerando Excel...';
                btn.disabled = true;

                // Buscar métricas avançadas
                const response = await fetch('/api/metricas-avancadas');
                const metricas = await response.json();

                // Criar workbook
                const wb = XLSX.utils.book_new();

                // Aba 1: Resumo Executivo
                const resumoData = [
                    ['Relatório Analytics - BRCCSiS', '', ''],
                    ['Gerado em:', new Date().toLocaleDateString('pt-BR'), ''],
                    ['', '', ''],
                    ['MÉTRICAS GERAIS', '', ''],
                    ['Total de Empresas', metricas.total_empresas, ''],
                    ['Taxa de Certificação', metricas.taxa_certificacao + '%', ''],
                    ['Cobertura Nacional', metricas.cobertura_nacional + '%', ''],
                    ['Empresas com Armazenagem', metricas.taxa_armazenagem + '%', ''],
                    ['Diversificação de Carga', metricas.diversificacao_carga, ''],
                    ['Estados Cobertos', metricas.estados_cobertos + '/27', '']
                ];

                const wsResumo = XLSX.utils.aoa_to_sheet(resumoData);
                XLSX.utils.book_append_sheet(wb, wsResumo, 'Resumo Executivo');

                // Aba 2: Distribuição por Região
                const regiaoData = [
                    ['Região', 'Empresas', 'Porcentagem'],
                    ...analyticsData.empresasPorRegiao.map(r => [r.regiao, r.empresas, r.porcentagem + '%'])
                ];

                const wsRegiao = XLSX.utils.aoa_to_sheet(regiaoData);
                XLSX.utils.book_append_sheet(wb, wsRegiao, 'Por Região');

                // Aba 3: Tipos de Carga
                const cargaData = [
                    ['Tipo de Carga', 'Quantidade de Empresas'],
                    ...analyticsData.tiposCarga.map(t => [t.tipo, t.quantidade])
                ];

                const wsCarga = XLSX.utils.aoa_to_sheet(cargaData);
                XLSX.utils.book_append_sheet(wb, wsCarga, 'Tipos de Carga');

                // Aba 4: Certificações
                const certData = [
                    ['Certificação', 'Quantidade de Empresas'],
                    ...analyticsData.certificacoes.map(c => [c.certificacao, c.quantidade])
                ];

                const wsCert = XLSX.utils.aoa_to_sheet(certData);
                XLSX.utils.book_append_sheet(wb, wsCert, 'Certificações');

                // Aba 5: Crescimento Mensal
                const crescimentoData = [
                    ['Mês', 'Total de Empresas'],
                    ...analyticsData.crescimentoMensal.map(c => [c.mes, c.empresas])
                ];

                const wsCrescimento = XLSX.utils.aoa_to_sheet(crescimentoData);
                XLSX.utils.book_append_sheet(wb, wsCrescimento, 'Crescimento Mensal');

                // Salvar arquivo
                const hoje = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
                XLSX.writeFile(wb, `relatorio-analytics-${hoje}.xlsx`);

                // Restaurar botão
                btn.innerHTML = originalText;
                btn.disabled = false;

                // Mostrar mensagem de sucesso
                alert('Relatório Excel gerado com sucesso!');

            } catch (error) {
                console.error('Erro ao gerar Excel:', error);
                alert('Erro ao gerar relatório Excel. Tente novamente.');
                
                // Restaurar botão
                const btn = document.getElementById('btn-export-excel');
                btn.innerHTML = '<i class="fas fa-file-excel mr-2"></i>Excel';
                btn.disabled = false;
            }
        }
    </script>

    <!-- Modal de Cotação -->
    <div id="modal-cotacao" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 fade-in max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-calculator mr-2 text-orange-600"></i>
                        Solicitar Cotação
                    </h3>
                    <button id="fechar-modal-cotacao" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <form id="form-cotacao" class="space-y-6">
                    <!-- Empresa de Transporte -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Empresa de Transporte</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-100">
                                <input type="radio" name="empresa_transporte" value="brcargo_rodoviario" checked class="mr-3">
                                <div>
                                    <div class="font-semibold text-green-600">BRCargo Rodoviário</div>
                                    <div class="text-sm text-gray-500">Disponível</div>
                                </div>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-100">
                                <input type="radio" name="empresa_transporte" value="brcargo_maritimo" class="mr-3">
                                <div>
                                    <div class="font-semibold text-blue-600">BRCargo Marítimo</div>
                                    <div class="text-sm text-gray-500">Disponível</div>
                                </div>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-100">
                                <input type="radio" name="empresa_transporte" value="frete_aereo" class="mr-3">
                                <div>
                                    <div class="font-semibold text-purple-600">Frete Aéreo</div>
                                    <div class="text-sm text-gray-500">Disponível</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Dados do Cliente -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Dados do Cliente</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Número do Cliente *</label>
                                <input type="text" name="numero_cliente" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nome/Razão Social *</label>
                                <input type="text" name="cliente_nome" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">CNPJ *</label>
                                <input type="text" name="cliente_cnpj" required placeholder="00.000.000/0000-00" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Endereço *</label>
                                <input type="text" name="cliente_endereco" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Complemento</label>
                                <input type="text" name="cliente_complemento" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                                <input type="tel" name="cliente_contato_telefone" placeholder="(11) 99999-9999" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" name="cliente_contato_email" placeholder="cliente@empresa.com" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                            </div>
                        </div>
                    </div>

                    <!-- Origem e Destino -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Origem -->
                        <div id="campos-origem-endereco" class="bg-green-50 p-4 rounded-lg">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">
                                <i class="fas fa-map-marker-alt text-green-600 mr-2"></i>Origem
                            </h4>
                            
                            <!-- Opção de tipo de origem (apenas para rodoviário) -->
                            <div id="tipo-origem-rodoviario" class="mb-4" style="display:none;">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Origem</label>
                                <div class="flex gap-4">
                                    <label class="flex items-center">
                                        <input type="radio" name="tipo_origem" value="endereco" checked class="mr-2">
                                        <span>Endereço</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="tipo_origem" value="porto" class="mr-2">
                                        <span>Porto</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Campos de endereço -->
                            <div id="campos-endereco-origem" class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">CEP *</label>
                                    <input type="text" name="origem_cep" required placeholder="00000-000" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Endereço Completo *</label>
                                    <input type="text" name="origem_endereco" required placeholder="Rua, número, bairro" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Cidade *</label>
                                        <input type="text" name="origem_cidade" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Estado *</label>
                                        <select name="origem_estado" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                            <option value="">Selecione</option>
                                            <option value="AC">AC</option>
                                            <option value="AL">AL</option>
                                            <option value="AP">AP</option>
                                            <option value="AM">AM</option>
                                            <option value="BA">BA</option>
                                            <option value="CE">CE</option>
                                            <option value="DF">DF</option>
                                            <option value="ES">ES</option>
                                            <option value="GO">GO</option>
                                            <option value="MA">MA</option>
                                            <option value="MT">MT</option>
                                            <option value="MS">MS</option>
                                            <option value="MG">MG</option>
                                            <option value="PA">PA</option>
                                            <option value="PB">PB</option>
                                            <option value="PR">PR</option>
                                            <option value="PE">PE</option>
                                            <option value="PI">PI</option>
                                            <option value="RJ">RJ</option>
                                            <option value="RN">RN</option>
                                            <option value="RS">RS</option>
                                            <option value="RO">RO</option>
                                            <option value="RR">RR</option>
                                            <option value="SC">SC</option>
                                            <option value="SP">SP</option>
                                            <option value="SE">SE</option>
                                            <option value="TO">TO</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Campo de porto (alternativa ao endereço) -->
                            <div id="campos-porto-origem" class="space-y-3" style="display:none;">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Porto de Origem *</label>
                                    <input type="text" name="origem_porto" placeholder="Ex: Porto de Santos, Porto de Paranaguá..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                            </div>
                        </div>

                        <!-- Destino -->
                        <div id="campos-destino-endereco" class="bg-red-50 p-4 rounded-lg">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">
                                <i class="fas fa-flag-checkered text-red-600 mr-2"></i>Destino
                            </h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">CEP *</label>
                                    <input type="text" name="destino_cep" required placeholder="00000-000" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Endereço Completo *</label>
                                    <input type="text" name="destino_endereco" required placeholder="Rua, número, bairro" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Cidade *</label>
                                        <input type="text" name="destino_cidade" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Estado *</label>
                                        <select name="destino_estado" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                            <option value="">Selecione</option>
                                            <option value="AC">AC</option>
                                            <option value="AL">AL</option>
                                            <option value="AP">AP</option>
                                            <option value="AM">AM</option>
                                            <option value="BA">BA</option>
                                            <option value="CE">CE</option>
                                            <option value="DF">DF</option>
                                            <option value="ES">ES</option>
                                            <option value="GO">GO</option>
                                            <option value="MA">MA</option>
                                            <option value="MT">MT</option>
                                            <option value="MS">MS</option>
                                            <option value="MG">MG</option>
                                            <option value="PA">PA</option>
                                            <option value="PB">PB</option>
                                            <option value="PR">PR</option>
                                            <option value="PE">PE</option>
                                            <option value="PI">PI</option>
                                            <option value="RJ">RJ</option>
                                            <option value="RN">RN</option>
                                            <option value="RS">RS</option>
                                            <option value="RO">RO</option>
                                            <option value="RR">RR</option>
                                            <option value="SC">SC</option>
                                            <option value="SP">SP</option>
                                            <option value="SE">SE</option>
                                            <option value="TO">TO</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dados da Carga (não exibir para marítimo) -->
                    <div id="dados-carga" class="bg-orange-50 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">
                            <i class="fas fa-box text-orange-600 mr-2"></i>Dados da Carga
                        </h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Descrição da Carga *</label>
                                <textarea name="carga_descricao" required rows="3" placeholder="Descreva detalhadamente a mercadoria a ser transportada..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"></textarea>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Peso Total (kg) *</label>
                                    <input type="number" name="carga_peso_kg" required min="0.01" step="0.01" placeholder="0.00" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Valor da Mercadoria (R$) *</label>
                                    <input type="text" name="carga_valor_mercadoria" required placeholder="R$ 0,00" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Embalagem</label>
                                    <select name="carga_tipo_embalagem" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                        <option value="">Selecione</option>
                                        <option value="Caixa de Papelão">Caixa de Papelão</option>
                                        <option value="Caixa de Madeira">Caixa de Madeira</option>
                                        <option value="Pallet">Pallet</option>
                                        <option value="Tambor">Tambor</option>
                                        <option value="Saco">Saco</option>
                                        <option value="Envelope">Envelope</option>
                                        <option value="Outros">Outros</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Comprimento (cm)</label>
                                    <input type="number" name="carga_comprimento_cm" min="1" placeholder="0" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Largura (cm)</label>
                                    <input type="number" name="carga_largura_cm" min="1" placeholder="0" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Altura (cm)</label>
                                    <input type="number" name="carga_altura_cm" min="1" placeholder="0" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                            </div>
                            
                            <!-- Campo de cubagem para rodoviário -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Cubagem Total (m³) *</label>
                                    <input type="number" name="carga_cubagem" required min="0.001" step="0.001" placeholder="0.000" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dados Específicos para Transporte Marítimo -->
                    <div id="campos-maritimo" class="bg-blue-50 p-4 rounded-lg" style="display:none;">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">
                            <i class="fas fa-ship text-blue-600 mr-2"></i>Dados Específicos - Transporte Marítimo
                        </h4>
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Net Weight (kg) *</label>
                                    <input type="number" name="net_weight" min="0.01" step="0.01" placeholder="0.00" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Gross Weight (kg) *</label>
                                    <input type="number" name="gross_weight" min="0.01" step="0.01" placeholder="0.00" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Cubagem (m³) *</label>
                                    <input type="number" name="cubagem" min="0.001" step="0.001" placeholder="0.000" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Incoterm *</label>
                                    <select name="incoterm" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                        <option value="">Selecione o Incoterm</option>
                                        <option value="EXW">EXW - Ex Works</option>
                                        <option value="FCA">FCA - Free Carrier</option>
                                        <option value="CPT">CPT - Carriage Paid To</option>
                                        <option value="CIP">CIP - Carriage and Insurance Paid To</option>
                                        <option value="DAP">DAP - Delivered at Place</option>
                                        <option value="DPU">DPU - Delivered at Place Unloaded</option>
                                        <option value="DDP">DDP - Delivered Duty Paid</option>
                                        <option value="FAS">FAS - Free Alongside Ship</option>
                                        <option value="FOB">FOB - Free on Board</option>
                                        <option value="CFR">CFR - Cost and Freight</option>
                                        <option value="CIF">CIF - Cost, Insurance and Freight</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Carga *</label>
                                    <select name="tipo_carga_maritima" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                        <option value="">Selecione</option>
                                        <option value="FCL">FCL - Full Container Load</option>
                                        <option value="LCL">LCL - Less than Container Load</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Campos específicos para FCL -->
                            <div id="campos-fcl" class="grid grid-cols-1 md:grid-cols-2 gap-4" style="display:none;">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tamanho do Container</label>
                                    <select name="tamanho_container" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                        <option value="">Selecione</option>
                                        <option value="20'">20' - 20 pés</option>
                                        <option value="40'">40' - 40 pés</option>
                                        <option value="40'HC">40'HC - 40 pés High Cube</option>
                                        <option value="45'">45' - 45 pés</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Quantidade de Containers</label>
                                    <input type="number" name="quantidade_containers" min="1" placeholder="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Porto de Origem *</label>
                                    <input type="text" name="porto_origem" placeholder="Ex: Porto de Santos" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Porto de Destino *</label>
                                    <input type="text" name="porto_destino" placeholder="Ex: Porto de Hamburgo" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Valor da Mercadoria (R$) *</label>
                                    <input type="text" name="carga_valor_mercadoria" placeholder="R$ 0,00" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Peso Total (kg)</label>
                                    <input type="number" name="carga_peso_kg" step="0.01" min="0" placeholder="0,00" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dados Específicos para Transporte Aéreo -->
                    <div id="campos-aereo" class="bg-purple-50 p-4 rounded-lg" style="display:none;">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">
                            <i class="fas fa-plane text-purple-600 mr-2"></i>Dados Específicos - Transporte Aéreo
                        </h4>
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Aeroporto de Origem *</label>
                                    <select name="aeroporto_origem" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                        <option value="">Selecione</option>
                                        <option value="GRU">GRU - Guarulhos (São Paulo)</option>
                                        <option value="CGH">CGH - Congonhas (São Paulo)</option>
                                        <option value="GIG">GIG - Galeão (Rio de Janeiro)</option>
                                        <option value="SDU">SDU - Santos Dumont (Rio de Janeiro)</option>
                                        <option value="BSB">BSB - Brasília</option>
                                        <option value="CNF">CNF - Confins (Belo Horizonte)</option>
                                        <option value="SSA">SSA - Salvador</option>
                                        <option value="REC">REC - Recife</option>
                                        <option value="FOR">FOR - Fortaleza</option>
                                        <option value="CWB">CWB - Curitiba</option>
                                        <option value="POA">POA - Porto Alegre</option>
                                        <option value="MAO">MAO - Manaus</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Aeroporto de Destino *</label>
                                    <select name="aeroporto_destino" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                        <option value="">Selecione</option>
                                        <option value="GRU">GRU - Guarulhos (São Paulo)</option>
                                        <option value="CGH">CGH - Congonhas (São Paulo)</option>
                                        <option value="GIG">GIG - Galeão (Rio de Janeiro)</option>
                                        <option value="SDU">SDU - Santos Dumont (Rio de Janeiro)</option>
                                        <option value="BSB">BSB - Brasília</option>
                                        <option value="CNF">CNF - Confins (Belo Horizonte)</option>
                                        <option value="SSA">SSA - Salvador</option>
                                        <option value="REC">REC - Recife</option>
                                        <option value="FOR">FOR - Fortaleza</option>
                                        <option value="CWB">CWB - Curitiba</option>
                                        <option value="POA">POA - Porto Alegre</option>
                                        <option value="MAO">MAO - Manaus</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Serviço Aéreo *</label>
                                    <select name="tipo_servico_aereo" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                        <option value="">Selecione</option>
                                        <option value="express">Express (24-48h)</option>
                                        <option value="standard">Standard (3-5 dias)</option>
                                        <option value="economico">Econômico (5-7 dias)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Peso Volumétrico (kg)</label>
                                    <input type="number" name="peso_volumetrico" min="0.01" step="0.01" placeholder="0.00" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Mercadoria Perigosa</label>
                                    <select name="mercadoria_perigosa" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                        <option value="nao">Não</option>
                                        <option value="sim">Sim</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Temperatura Controlada</label>
                                    <select name="temperatura_controlada" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                        <option value="nao">Não</option>
                                        <option value="refrigerado">Refrigerado (2-8°C)</option>
                                        <option value="congelado">Congelado (-18°C)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Serviço -->
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">
                            <i class="fas fa-shipping-fast text-yellow-600 mr-2"></i>Serviço
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Prazo Desejado (dias)</label>
                                <input type="number" name="servico_prazo_desejado" min="1" placeholder="Ex: 5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Serviço</label>
                                <select name="servico_tipo" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                    <option value="">Selecione</option>
                                    <option value="Expresso">Expresso</option>
                                    <option value="Econômico">Econômico</option>
                                    <option value="Normal">Normal</option>
                                    <option value="Urgente">Urgente</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Observações Especiais</label>
                            <textarea name="servico_observacoes" rows="3" placeholder="Instruções especiais, horários preferenciais, etc..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"></textarea>
                        </div>
                    </div>

                    <!-- Dados Opcionais -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">
                            <i class="fas fa-cog text-gray-600 mr-2"></i>Dados Opcionais
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Data Preferencial de Coleta</label>
                                <input type="date" name="data_coleta_preferencial" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                            </div>
                            <div class="flex items-center">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" name="seguro_adicional" class="mr-3 h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded">
                                    <span class="text-sm font-medium text-gray-700">Solicitar Seguro Adicional</span>
                                </label>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Instruções de Manuseio</label>
                            <textarea name="instrucoes_manuseio" rows="2" placeholder="Cuidados especiais, fragilidade, etc..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"></textarea>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Serviços Complementares</label>
                            <textarea name="servicos_complementares" rows="2" placeholder="Embalagem especial, montagem, etc..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"></textarea>
                        </div>
                    </div>

                    <!-- Botões -->
                    <div class="flex justify-end space-x-4 pt-6 border-t">
                        <button type="button" id="cancelar-cotacao" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                            <i class="fas fa-times mr-2"></i>Cancelar
                        </button>
                        <button type="submit" id="salvar-cotacao" class="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors">
                            <i class="fas fa-paper-plane mr-2"></i>Solicitar Cotação
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Seção de Cotações -->
    <div id="secao-cotacoes" class="hidden">
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-calculator mr-2 text-orange-600"></i>
                    Sistema de Cotações
                </h2>
                <button id="btn-nova-cotacao" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Nova Cotação
                </button>
            </div>

            <!-- Abas de Modalidade -->
            <div class="mb-6">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button id="tab-todas" class="tab-modalidade active border-orange-500 text-orange-600 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm" data-modalidade="todas">
                            <i class="fas fa-list mr-2"></i>Todas as Cotações
                        </button>
                        <button id="tab-rodoviarias" class="tab-modalidade border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm" data-modalidade="rodoviarias">
                            <i class="fas fa-truck mr-2"></i>Rodoviárias
                        </button>
                        <button id="tab-maritimas" class="tab-modalidade border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm" data-modalidade="maritimas">
                            <i class="fas fa-ship mr-2"></i>Marítimas
                        </button>
                        <button id="tab-aereas" class="tab-modalidade border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm" data-modalidade="aereas">
                            <i class="fas fa-plane mr-2"></i>Aéreas
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Filtros por Perfil de Usuário -->
            <div id="filtros-usuario" class="mb-6">
                <!-- Filtros serão adicionados dinamicamente baseados no tipo de usuário -->
            </div>

            <!-- Estatísticas -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                            <i class="fas fa-list text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total</p>
                            <p class="text-2xl font-bold text-gray-900" id="total-cotacoes">-</p>
                        </div>
                    </div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                            <i class="fas fa-clock text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Pendentes</p>
                            <p class="text-2xl font-bold text-gray-900" id="cotacoes-pendentes">-</p>
                        </div>
                    </div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100 text-green-600">
                            <i class="fas fa-check text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Finalizadas</p>
                            <p class="text-2xl font-bold text-gray-900" id="cotacoes-finalizadas">-</p>
                        </div>
                    </div>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                            <i class="fas fa-paper-plane text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Enviadas</p>
                            <p class="text-2xl font-bold text-gray-900" id="cotacoes-enviadas">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <h4 class="text-lg font-semibold text-gray-800 mb-3">Filtros</h4>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="filtro-status" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="">Todos</option>
                            <option value="solicitada">Solicitada</option>
                            <option value="em_analise">Em Análise</option>
                            <option value="cotacao_enviada">Cotação Enviada</option>
                            <option value="aprovada_cliente">Aprovada</option>
                            <option value="recusada_cliente">Recusada</option>
                            <option value="finalizada">Finalizada</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
                        <input type="text" id="filtro-cliente" placeholder="Nome do cliente" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data Início</label>
                        <input type="date" id="filtro-data-inicio" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data Fim</label>
                        <input type="date" id="filtro-data-fim" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button id="aplicar-filtros" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-filter mr-2"></i>Aplicar Filtros
                    </button>
                    <button id="limpar-filtros" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        <i class="fas fa-eraser mr-2"></i>Limpar
                    </button>
                </div>
            </div>

            <!-- Lista de Cotações -->
            <div id="lista-cotacoes" class="space-y-4">
                <!-- Cotações serão carregadas aqui via JavaScript -->
            </div>

            <!-- Paginação -->
            <div id="paginacao-cotacoes" class="flex justify-center mt-6">
                <!-- Paginação será carregada aqui via JavaScript -->
            </div>
        </div>
     </div>

    <!-- Seção de Analytics v1.3.3 -->
    <div id="secao-analytics-v133" class="hidden">
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-chart-bar mr-2 text-orange-600"></i>
                    Dashboard de Análise
                </h2>
                <div class="flex gap-2">
                    <button id="btn-exportar-relatorio" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-download mr-2"></i>Exportar Relatório
                    </button>
                    <button id="btn-atualizar-analytics" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Atualizar
                    </button>
                </div>
            </div>

            <!-- Abas de Analytics -->
            <div class="mb-6">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button id="tab-geral" class="tab-analytics active border-orange-500 text-orange-600 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm" data-analytics="geral">
                            <i class="fas fa-chart-pie mr-2"></i>Visão Geral
                        </button>
                        <button id="tab-empresas" class="tab-analytics border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm" data-analytics="empresas">
                            <i class="fas fa-building mr-2"></i>Por Empresa
                        </button>
                        <button id="tab-usuarios" class="tab-analytics border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm" data-analytics="usuarios">
                            <i class="fas fa-users mr-2"></i>Por Usuário
                        </button>
                        <button id="tab-tempo-real" class="tab-analytics border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm" data-analytics="tempo-real">
                            <i class="fas fa-clock mr-2"></i>Tempo Real
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Conteúdo das Abas -->
            <div id="conteudo-analytics">
                <!-- Conteúdo será carregado dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white text-center p-4 mt-8">
        <p>&copy; 2025 BRCcSis. Todos os direitos reservados. Projetado por Inácio Victor.    </div>

    <!-- Modal de Importação Excel -->
    <div id="modal-importar-excel" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 fade-in">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800">Importar Planilha Excel</h3>
                    <button id="fechar-modal-importar-excel" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-3">
                        Selecione um arquivo Excel (.xlsx) com os dados das empresas para importar.
                    </p>
                    
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                        <input type="file" id="arquivo-importacao-excel" accept=".xlsx,.xls" class="hidden">
                        <label for="arquivo-importacao-excel" class="cursor-pointer">
                            <i class="fas fa-file-excel text-3xl text-green-500 mb-2"></i>
                            <p class="text-sm text-gray-600">Clique para selecionar arquivo Excel</p>
                            <p class="text-xs text-gray-400 mt-1">Formatos aceitos: .xlsx, .xls</p>
                        </label>
                    </div>
                    
                    <div id="arquivo-selecionado-excel" class="hidden mt-3 p-3 bg-green-50 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-file-excel text-green-600 mr-2"></i>
                            <span id="nome-arquivo-excel" class="text-sm text-green-800"></span>
                            <button id="remover-arquivo-excel" class="ml-auto text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-3">
                    <button id="cancelar-importacao-excel" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button id="confirmar-importacao-excel" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <span id="texto-importacao-excel">Importar</span>
                        <div id="loading-importacao-excel" class="loading hidden ml-2"></div>
                    </button>
                </div>
                
                <div id="resultado-importacao-excel" class="hidden mt-4 p-3 rounded-lg">
                    <div id="conteudo-resultado-excel"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Importação de Dados -->
    <div id="modal-importar" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 fade-in">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800">Importar Dados</h3>
                    <button id="fechar-modal-importar" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-3">
                        Selecione um arquivo JSON de backup para importar os dados das empresas.
                    </p>
                    
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                        <input type="file" id="arquivo-importacao" accept=".json" class="hidden">
                        <label for="arquivo-importacao" class="cursor-pointer">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-600">Clique para selecionar arquivo JSON</p>
                            <p class="text-xs text-gray-400 mt-1">Ou arraste e solte aqui</p>
                        </label>
                    </div>
                    
                    <div id="arquivo-selecionado" class="hidden mt-3 p-3 bg-blue-50 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-file-alt text-blue-600 mr-2"></i>
                            <span id="nome-arquivo" class="text-sm text-blue-800"></span>
                            <button id="remover-arquivo" class="ml-auto text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-3">
                    <button id="cancelar-importacao" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button id="confirmar-importacao" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <span id="texto-importacao">Importar</span>
                        <div id="loading-importacao" class="loading hidden ml-2"></div>
                    </button>
                </div>
                
                <div id="resultado-importacao" class="hidden mt-4 p-3 rounded-lg">
                    <div id="conteudo-resultado"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Função para confirmar exclusão com delay
        async function confirmarExclusao(empresaId, razaoSocial) {
            if (!confirm(`Tem certeza que deseja excluir a empresa ${razaoSocial}? Esta ação é irreversível.`)) {
                return;
            }
            const deleteButton = event.target;
            deleteButton.disabled = true;
            deleteButton.textContent = 'Aguarde (5s)';
            let countdown = 5;
            const countdownInterval = setInterval(() => {
                countdown--;
                deleteButton.textContent = `Aguarde (${countdown}s)`;
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    deleteButton.textContent = 'Confirmar Exclusão';
                    deleteButton.disabled = false;
                    deleteButton.onclick = () => excluirEmpresa(empresaId);
                }
            }, 1000);
        }
        
        // Função para excluir empresa
        async function excluirEmpresa(empresaId) {
            try {
                const response = await fetch(`/api/empresas/${empresaId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    alert('Empresa excluída com sucesso!');
                    loadEmpresas(); // Recarregar a lista de empresas
                } else {
                    const errorData = await response.json();
                    alert(`Erro ao excluir empresa: ${errorData.error}`);
                }
            } catch (error) {
                console.error('Erro ao excluir empresa:', error);
                alert('Erro ao excluir empresa. Verifique a conexão.');
            }
        }

        // Função para exportar dados
        async function exportarDados() {
            try {
                const response = await fetch('/api/empresas/export');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `brccsis_backup_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    alert('Dados exportados com sucesso!');
                } else {
                    const errorData = await response.json();
                    alert(`Erro ao exportar dados: ${errorData.error}`);
                }
            } catch (error) {
                console.error('Erro ao exportar dados:', error);
                alert('Erro ao exportar dados. Verifique a conexão.');
            }
        }

        // Função para importar dados
        async function importarDados(arquivo) {
            const formData = new FormData();
            formData.append('file', arquivo);

            try {
                const response = await fetch('/api/empresas/import', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (response.ok) {
                    return {
                        sucesso: true,
                        dados: result
                    };
                } else {
                    return {
                        sucesso: false,
                        erro: result.error
                    };
                }
            } catch (error) {
                return {
                    sucesso: false,
                    erro: `Erro de conexão: ${error.message}`
                };
            }
        }

        // Função para importar dados Excel
        async function importarDadosExcel(arquivo) {
            const formData = new FormData();
            formData.append('file', arquivo);

            try {
                const response = await fetch('/api/empresas/import-excel', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (response.ok) {
                    return {
                        sucesso: true,
                        dados: result
                    };
                } else {
                    return {
                        sucesso: false,
                        erro: result.error
                    };
                }
            } catch (error) {
                return {
                    sucesso: false,
                    erro: `Erro de conexão: ${error.message}`
                };
            }
        }

        // Event listeners para importação
        document.addEventListener('DOMContentLoaded', function() {
            const btnImportar = document.getElementById('btn-importar-dados');
            const modalImportar = document.getElementById('modal-importar');
            const fecharModal = document.getElementById('fechar-modal-importar');
            const cancelarImportacao = document.getElementById('cancelar-importacao');
            const arquivoInput = document.getElementById('arquivo-importacao');
            const arquivoSelecionado = document.getElementById('arquivo-selecionado');
            const nomeArquivo = document.getElementById('nome-arquivo');
            const removerArquivo = document.getElementById('remover-arquivo');
            const confirmarImportacao = document.getElementById('confirmar-importacao');
            const textoImportacao = document.getElementById('texto-importacao');
            const loadingImportacao = document.getElementById('loading-importacao');
            const resultadoImportacao = document.getElementById('resultado-importacao');
            const conteudoResultado = document.getElementById('conteudo-resultado');

            // Event listeners para importação Excel
            const btnImportarExcel = document.getElementById('btn-importar-excel');
            const modalImportarExcel = document.getElementById('modal-importar-excel');
            const fecharModalExcel = document.getElementById('fechar-modal-importar-excel');
            const cancelarImportacaoExcel = document.getElementById('cancelar-importacao-excel');
            const arquivoInputExcel = document.getElementById('arquivo-importacao-excel');
            const arquivoSelecionadoExcel = document.getElementById('arquivo-selecionado-excel');
            const nomeArquivoExcel = document.getElementById('nome-arquivo-excel');
            const removerArquivoExcel = document.getElementById('remover-arquivo-excel');
            const confirmarImportacaoExcel = document.getElementById('confirmar-importacao-excel');
            const textoImportacaoExcel = document.getElementById('texto-importacao-excel');
            const loadingImportacaoExcel = document.getElementById('loading-importacao-excel');
            const resultadoImportacaoExcel = document.getElementById('resultado-importacao-excel');
            const conteudoResultadoExcel = document.getElementById('conteudo-resultado-excel');

            // Event listener para template Excel
            const btnTemplateExcel = document.getElementById('btn-template-excel');

            // Abrir modal de importação JSON
            btnImportar.addEventListener('click', async function() {
                try {
                    // Verificar se o usuário tem permissão
                    const response = await fetch('/api/auth/check-permission', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ recurso: 'importar_dados' })
                    });
                    
                    const result = await response.json();
                    
                    if (result.permitido) {
                        modalImportar.classList.add('show');
                    } else {
                        alert('❌ Acesso negado!\n\nVocê não tem permissão para importar dados.\n\nApenas administradores e gerentes podem importar dados.');
                    }
                } catch (error) {
                    console.error('Erro ao verificar permissão:', error);
                    alert('Erro ao verificar permissões. Tente novamente.');
                }
            });

            // Abrir modal de importação Excel
            btnImportarExcel.addEventListener('click', async function() {
                try {
                    // Verificar se o usuário tem permissão
                    const response = await fetch('/api/auth/check-permission', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ recurso: 'importar_excel' })
                    });
                    
                    const result = await response.json();
                    
                    if (result.permitido) {
                        modalImportarExcel.classList.add('show');
                    } else {
                        alert('❌ Acesso negado!\n\nVocê não tem permissão para importar planilhas Excel.\n\nApenas administradores, gerentes e operadores podem importar Excel.');
                    }
                } catch (error) {
                    console.error('Erro ao verificar permissão:', error);
                    alert('Erro ao verificar permissões. Tente novamente.');
                }
            });

            // Baixar template Excel
            btnTemplateExcel.addEventListener('click', function() {
                window.open('/api/empresas/template-excel', '_blank');
            });

            // Fechar modal JSON
            function fecharModalImportacao() {
                modalImportar.classList.remove('show');
                arquivoInput.value = '';
                arquivoSelecionado.classList.add('hidden');
                confirmarImportacao.disabled = true;
                resultadoImportacao.classList.add('hidden');
            }

            // Fechar modal Excel
            function fecharModalImportacaoExcel() {
                modalImportarExcel.classList.remove('show');
                arquivoInputExcel.value = '';
                arquivoSelecionadoExcel.classList.add('hidden');
                confirmarImportacaoExcel.disabled = true;
                resultadoImportacaoExcel.classList.add('hidden');
            }

            fecharModal.addEventListener('click', fecharModalImportacao);
            cancelarImportacao.addEventListener('click', fecharModalImportacao);
            fecharModalExcel.addEventListener('click', fecharModalImportacaoExcel);
            cancelarImportacaoExcel.addEventListener('click', fecharModalImportacaoExcel);

            // Seleção de arquivo JSON
            arquivoInput.addEventListener('change', function(e) {
                const arquivo = e.target.files[0];
                if (arquivo) {
                    if (arquivo.type === 'application/json' || arquivo.name.endsWith('.json')) {
                        nomeArquivo.textContent = arquivo.name;
                        arquivoSelecionado.classList.remove('hidden');
                        confirmarImportacao.disabled = false;
                    } else {
                        alert('Por favor, selecione um arquivo JSON válido.');
                        arquivoInput.value = '';
                    }
                }
            });

            // Seleção de arquivo Excel
            arquivoInputExcel.addEventListener('change', function(e) {
                const arquivo = e.target.files[0];
                if (arquivo) {
                    if (arquivo.name.endsWith('.xlsx') || arquivo.name.endsWith('.xls')) {
                        nomeArquivoExcel.textContent = arquivo.name;
                        arquivoSelecionadoExcel.classList.remove('hidden');
                        confirmarImportacaoExcel.disabled = false;
                    } else {
                        alert('Por favor, selecione um arquivo Excel válido (.xlsx ou .xls).');
                        arquivoInputExcel.value = '';
                    }
                }
            });

            // Remover arquivo selecionado JSON
            removerArquivo.addEventListener('click', function() {
                arquivoInput.value = '';
                arquivoSelecionado.classList.add('hidden');
                confirmarImportacao.disabled = true;
            });

            // Remover arquivo selecionado Excel
            removerArquivoExcel.addEventListener('click', function() {
                arquivoInputExcel.value = '';
                arquivoSelecionadoExcel.classList.add('hidden');
                confirmarImportacaoExcel.disabled = true;
            });

            // Confirmar importação JSON
            confirmarImportacao.addEventListener('click', async function() {
                const arquivo = arquivoInput.files[0];
                if (!arquivo) return;

                // Mostrar loading
                textoImportacao.textContent = 'Importando...';
                loadingImportacao.classList.remove('hidden');
                confirmarImportacao.disabled = true;

                const resultado = await importarDados(arquivo);

                // Esconder loading
                textoImportacao.textContent = 'Importar';
                loadingImportacao.classList.add('hidden');
                confirmarImportacao.disabled = false;

                // Mostrar resultado
                resultadoImportacao.classList.remove('hidden');
                
                if (resultado.sucesso) {
                    const stats = resultado.dados.estatisticas;
                    resultadoImportacao.className = 'mt-4 p-3 rounded-lg bg-green-50 border border-green-200';
                    conteudoResultado.innerHTML = `
                        <div class="text-green-800">
                            <h4 class="font-bold mb-2">✅ Importação concluída com sucesso!</h4>
                            <ul class="text-sm space-y-1">
                                <li>• Total processadas: ${stats.total_processadas}</li>
                                <li>• Empresas criadas: ${stats.criadas}</li>
                                <li>• Empresas atualizadas: ${stats.atualizadas}</li>
                                <li>• Erros: ${stats.erros}</li>
                            </ul>
                            ${stats.detalhes_erros.length > 0 ? `
                                <details class="mt-2">
                                    <summary class="cursor-pointer text-red-600">Ver detalhes dos erros</summary>
                                    <ul class="mt-1 text-xs text-red-600">
                                        ${stats.detalhes_erros.map(erro => `<li>• ${erro}</li>`).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                        </div>
                    `;
                    
                    // Recarregar dados se estiver na aba de empresas
                    if (document.getElementById('empresas').style.display !== 'none') {
                        loadEmpresas();
                    }
                    
                    // Recarregar analytics do dashboard
                    carregarDadosAnalytics();
                } else {
                    resultadoImportacao.className = 'mt-4 p-3 rounded-lg bg-red-50 border border-red-200';
                    conteudoResultado.innerHTML = `
                        <div class="text-red-800">
                            <h4 class="font-bold mb-2">❌ Erro na importação</h4>
                            <p class="text-sm">${resultado.erro}</p>
                        </div>
                    `;
                }
            });

            // Confirmar importação Excel
            confirmarImportacaoExcel.addEventListener('click', async function() {
                const arquivo = arquivoInputExcel.files[0];
                if (!arquivo) return;

                // Mostrar loading
                textoImportacaoExcel.textContent = 'Importando...';
                loadingImportacaoExcel.classList.remove('hidden');
                confirmarImportacaoExcel.disabled = true;

                const resultado = await importarDadosExcel(arquivo);

                // Esconder loading
                textoImportacaoExcel.textContent = 'Importar';
                loadingImportacaoExcel.classList.add('hidden');
                confirmarImportacaoExcel.disabled = false;

                // Mostrar resultado
                resultadoImportacaoExcel.classList.remove('hidden');
                
                if (resultado.sucesso) {
                    const stats = resultado.dados.estatisticas;
                    resultadoImportacaoExcel.className = 'mt-4 p-3 rounded-lg bg-green-50 border border-green-200';
                    conteudoResultadoExcel.innerHTML = `
                        <div class="text-green-800">
                            <h4 class="font-bold mb-2">✅ Importação de Excel concluída com sucesso!</h4>
                            <ul class="text-sm space-y-1">
                                <li>• Total processadas: ${stats.total_processadas}</li>
                                <li>• Empresas criadas: ${stats.criadas}</li>
                                <li>• Empresas atualizadas: ${stats.atualizadas}</li>
                                <li>• Erros: ${stats.erros}</li>
                            </ul>
                            ${stats.detalhes_erros.length > 0 ? `
                                <details class="mt-2">
                                    <summary class="cursor-pointer text-red-600">Ver detalhes dos erros</summary>
                                    <ul class="mt-1 text-xs text-red-600">
                                        ${stats.detalhes_erros.map(erro => `<li>• ${erro}</li>`).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                        </div>
                    `;
                    
                    // Recarregar dados se estiver na aba de empresas
                    if (document.getElementById('empresas').style.display !== 'none') {
                        loadEmpresas();
                    }
                    
                    // Recarregar analytics do dashboard
                    carregarDadosAnalytics();
                } else {
                    resultadoImportacaoExcel.className = 'mt-4 p-3 rounded-lg bg-red-50 border border-red-200';
                    conteudoResultadoExcel.innerHTML = `
                        <div class="text-red-800">
                            <h4 class="font-bold mb-2">❌ Erro na importação</h4>
                            <p class="text-sm">${resultado.erro}</p>
                        </div>
                    `;
                }
            });

            // Event listener para exportação
            document.getElementById('btn-exportar-dados').addEventListener('click', async function() {
                try {
                    // Verificar se o usuário tem permissão
                    const response = await fetch('/api/auth/check-permission', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ recurso: 'exportar_dados' })
                    });
                    
                    const result = await response.json();
                    
                    if (result.permitido) {
                        exportarDados();
                    } else {
                        alert('❌ Acesso negado!\n\nVocê não tem permissão para exportar dados.\n\nApenas administradores e gerentes podem exportar dados.');
                    }
                } catch (error) {
                    console.error('Erro ao verificar permissão:', error);
                    alert('Erro ao verificar permissões. Tente novamente.');
                }
            });
            
            // Event listener para administração
            document.getElementById('btn-administracao').addEventListener('click', async function() {
                try {
                    // Verificar se o usuário tem permissão
                    const response = await fetch('/api/auth/check-permission', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ recurso: 'acessar_administracao' })
                    });
                    
                    const result = await response.json();
                    
                    if (result.permitido) {
                        window.location.href = '/admin.html';
                    } else {
                        alert('❌ Acesso negado!\n\nVocê não tem permissão para acessar a página de administração.\n\nContate um administrador se precisar de acesso.');
                    }
                } catch (error) {
                    console.error('Erro ao verificar permissão:', error);
                    alert('Erro ao verificar permissões. Tente novamente.');
                }
            });
            
            // Event listener para logout
            document.getElementById('btn-logout').addEventListener('click', async function() {
                try {
                    await fetch('/api/auth/logout', { method: 'POST' });
                    window.location.href = '/login';
                } catch (error) {
                    console.error('Erro no logout:', error);
                    window.location.href = '/login';
                }
            });
        });
    </script>
    </script>

    <!-- Rodapé -->
    <footer class="bg-gray-800 text-white py-4 mt-8">
        <div class="container mx-auto px-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-2 md:mb-0">
                    <p class="text-sm">© 2024 BRCcSis - Sistema de Gestão Logística</p>
                </div>
                <div class="flex items-center space-x-4 text-sm">
                    <span id="usuario-logado" class="flex items-center">
                        <i class="fas fa-user mr-2"></i>
                        <span id="nome-usuario">Carregando...</span>
                    </span>
                    <span id="horario-sistema" class="flex items-center">
                        <i class="fas fa-clock mr-2"></i>
                        <span id="horario-atual">--:--</span>
                    </span>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Função para carregar informações do usuário logado
        async function carregarInfoUsuario() {
            try {
                const response = await fetch('/api/auth/user-info');
                if (response.ok) {
                    const userInfo = await response.json();
                    document.getElementById('nome-usuario').textContent = userInfo.nome || userInfo.username;
                } else {
                    document.getElementById('nome-usuario').textContent = 'Usuário';
                }
            } catch (error) {
                console.error('Erro ao carregar info do usuário:', error);
                document.getElementById('nome-usuario').textContent = 'Usuário';
            }
        }

        // Função para atualizar horário (Brasília)
        function atualizarHorario() {
            const agora = new Date();
            // Converter para horário de Brasília (UTC-3)
            const brasilia = new Date(agora.toLocaleString("en-US", {timeZone: "America/Sao_Paulo"}));
            const horarioFormatado = brasilia.toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('horario-atual').textContent = horarioFormatado;
        }

        // ===== SISTEMA DE COTAÇÕES =====
        
        // Variáveis globais para cotações
        let cotacoesData = [];
        let cotacoesCurrentPage = 1;
        let cotacoesTotalPages = 1;
        let filtrosAtivos = {};

        // Função para verificar permissões do usuário
        async function verificarPermissoesCotacao() {
            try {
                const response = await fetch('/api/auth/user-info');
                if (response.ok) {
                    const userInfo = await response.json();
                    console.log('User info:', userInfo); // Debug
                    
                    // Admin e Gerente têm acesso total
                    const tipoUpper = (userInfo.tipo || '').toUpperCase();
                    return tipoUpper === 'CONSULTOR' || 
                           tipoUpper === 'OPERADOR' || 
                           tipoUpper === 'GERENTE' || 
                           tipoUpper === 'ADMINISTRADOR' ||
                           userInfo.tipo === 'consultor' || 
                           userInfo.tipo === 'operador' || 
                           userInfo.tipo === 'gerente' || 
                           userInfo.tipo === 'administrador';
                }
                console.log('Erro na resposta da API:', response.status);
                return false;
            } catch (error) {
                console.error('Erro ao verificar permissões:', error);
                return false;
            }
        }

        // Função para mostrar/ocultar botão de cotação baseado nas permissões
        async function configurarBotaoCotacao() {
            const btnSolicitarCotacao = document.getElementById('btn-solicitar-cotacao');
            console.log('Configurando botão de cotação...', btnSolicitarCotacao);
            
            if (btnSolicitarCotacao) {
                // Sempre mostrar o botão por enquanto para debug
                btnSolicitarCotacao.style.display = 'flex';
                
                // Remover event listeners anteriores
                btnSolicitarCotacao.replaceWith(btnSolicitarCotacao.cloneNode(true));
                const newBtn = document.getElementById('btn-solicitar-cotacao');
                
                console.log('Adicionando event listener ao botão...');
                newBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Botão clicado! Abrindo modal...');
                    abrirModalCotacao();
                });
                
                // Verificar permissões em background
                const temPermissao = await verificarPermissoesCotacao();
                console.log('Tem permissão:', temPermissao);
                
                if (!temPermissao) {
                    console.log('Usuário sem permissão, ocultando botão');
                    newBtn.style.display = 'none';
                }
            } else {
                console.log('Botão não encontrado!');
            }
        }

        // Função para abrir modal de cotação
        function abrirModalCotacao() {
            console.log('Função abrirModalCotacao chamada');
            const modal = document.getElementById('modal-cotacao');
            console.log('Modal encontrado:', modal);
            
            if (modal) {
                console.log('Adicionando classe show ao modal');
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
                console.log('Modal deve estar visível agora');
                
                // Inicializar campos baseado na modalidade selecionada
                setTimeout(() => {
                    if (typeof inicializarCamposPorModalidade === 'function') {
                        inicializarCamposPorModalidade();
                    }
                }, 100);
            } else {
                console.log('ERRO: Modal não encontrado!');
            }
        }

        // Função para fechar modal de cotação
        function fecharModalCotacao() {
            const modal = document.getElementById('modal-cotacao');
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = 'auto';
                // Limpar formulário
                document.getElementById('form-cotacao').reset();
            }
        }

        // Função para carregar cotações
        async function carregarCotacoes(page = 1) {
            try {
                const params = new URLSearchParams({
                    page: page,
                    per_page: 10,
                    ...filtrosAtivos
                });

                const response = await fetch(`/api/cotacoes?${params}`);
                if (response.ok) {
                    const data = await response.json();
                    cotacoesData = data.cotacoes;
                    cotacoesCurrentPage = data.current_page;
                    cotacoesTotalPages = data.pages;
                    
                    renderizarListaCotacoes();
                    renderizarPaginacao();
                } else {
                    throw new Error('Erro ao carregar cotações');
                }
            } catch (error) {
                console.error('Erro ao carregar cotações:', error);
                mostrarMensagem('Erro ao carregar cotações', 'error');
            }
        }

        // Função para carregar estatísticas
        async function carregarEstatisticasCotacoes() {
            try {
                const response = await fetch('/api/cotacoes/estatisticas');
                if (response.ok) {
                    const data = await response.json();
                    const stats = data.estatisticas;
                    
                    document.getElementById('total-cotacoes').textContent = stats.total_cotacoes || 0;
                    document.getElementById('cotacoes-pendentes').textContent = 
                        (stats.por_status.solicitada || 0) + (stats.por_status.em_analise || 0);
                    document.getElementById('cotacoes-finalizadas').textContent = stats.por_status.finalizada || 0;
                    document.getElementById('cotacoes-enviadas').textContent = stats.por_status.cotacao_enviada || 0;
                }
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            }
        }

        // Função para renderizar lista de cotações
        function renderizarListaCotacoes() {
            const container = document.getElementById('lista-cotacoes');
            if (!container) return;

            if (cotacoesData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-inbox text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-500">Nenhuma cotação encontrada</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = cotacoesData.map(cotacao => `
                <div class="bg-white border rounded-lg p-6 hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-4">
                            <h3 class="text-lg font-semibold text-gray-800">${cotacao.numero_cotacao}</h3>
                            <span class="px-3 py-1 rounded-full text-sm font-medium ${cotacao.status_color}">
                                ${cotacao.status_display}
                            </span>
                        </div>
                        <div class="text-sm text-gray-500">
                            ${new Date(cotacao.data_solicitacao).toLocaleDateString('pt-BR')}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Cliente</p>
                            <p class="text-gray-800">${cotacao.cliente_nome}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-600">Origem → Destino</p>
                            <p class="text-gray-800">${cotacao.origem_cidade}/${cotacao.origem_estado} → ${cotacao.destino_cidade}/${cotacao.destino_estado}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-600">Peso</p>
                            <p class="text-gray-800">${cotacao.carga_peso_kg} kg</p>
                        </div>
                    </div>
                    
                    ${cotacao.cotacao_valor_frete ? `
                        <div class="bg-green-50 p-3 rounded-lg mb-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-green-800">Valor da Cotação</p>
                                    <p class="text-lg font-bold text-green-600">R$ ${parseFloat(cotacao.cotacao_valor_frete).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-green-800">Prazo</p>
                                    <p class="text-green-600">${cotacao.cotacao_prazo_entrega} dias</p>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-gray-500">
                            ${cotacao.operador_nome ? `Operador: ${cotacao.operador_nome}` : 'Aguardando operador'}
                        </div>
                        <div class="flex space-x-2">
                            ${getBotoesAcao(cotacao)}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Função para obter botões de ação baseados no status e tipo de usuário
        function getBotoesAcao(cotacao) {
            let botoes = [];
            
            console.log('Cotação:', cotacao.id, 'Status:', cotacao.status, 'Operador ID:', cotacao.operador_id);
            
            // Botão Ver Detalhes (sempre presente)
            botoes.push(`<button onclick="verDetalhesCotacao(${cotacao.id})" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                <i class="fas fa-eye mr-1"></i>Detalhes
            </button>`);
            
            // Verificar tipo de usuário (será obtido via API)
            // Por enquanto, vamos assumir que operadores podem aceitar cotações
            
            if (cotacao.status === 'solicitada' && !cotacao.operador_id) {
                console.log('Adicionando botão ACEITAR para cotação', cotacao.id);
                // Cotação pode ser aceita por qualquer operador
                botoes.push(`<button onclick="aceitarCotacao(${cotacao.id})" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                    <i class="fas fa-check mr-1"></i>Aceitar
                </button>`);
            } else if (cotacao.status === 'em_analise' && cotacao.operador_id) {
                console.log('Adicionando botão RESPONDER para cotação', cotacao.id);
                // Cotação em análise - operador pode responder
                botoes.push(`<button onclick="responderCotacao(${cotacao.id})" class="px-3 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors text-sm">
                    <i class="fas fa-reply mr-1"></i>Responder
                </button>`);
            } else if (cotacao.status === 'cotacao_enviada') {
                console.log('Adicionando botão FINALIZAR para cotação', cotacao.id);
                // Cotação enviada - pode finalizar
                botoes.push(`<button onclick="finalizarCotacao(${cotacao.id})" class="px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm">
                    <i class="fas fa-flag-checkered mr-1"></i>Finalizar
                </button>`);
            }
            
            console.log('Botões gerados para cotação', cotacao.id, ':', botoes.length);
            return botoes.join('');
        }

        // Função para renderizar paginação
        function renderizarPaginacao() {
            const container = document.getElementById('paginacao-cotacoes');
            if (!container || cotacoesTotalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let paginacao = '<div class="flex items-center space-x-2">';
            
            // Botão anterior
            if (cotacoesCurrentPage > 1) {
                paginacao += `<button onclick="carregarCotacoes(${cotacoesCurrentPage - 1})" class="px-3 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Anterior</button>`;
            }
            
            // Números das páginas
            for (let i = Math.max(1, cotacoesCurrentPage - 2); i <= Math.min(cotacoesTotalPages, cotacoesCurrentPage + 2); i++) {
                const isActive = i === cotacoesCurrentPage;
                paginacao += `<button onclick="carregarCotacoes(${i})" class="px-3 py-2 ${isActive ? 'bg-orange-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'} rounded">${i}</button>`;
            }
            
            // Botão próximo
            if (cotacoesCurrentPage < cotacoesTotalPages) {
                paginacao += `<button onclick="carregarCotacoes(${cotacoesCurrentPage + 1})" class="px-3 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Próximo</button>`;
            }
            
            paginacao += '</div>';
            container.innerHTML = paginacao;
        }

        // Função para aplicar filtros
        function aplicarFiltrosCotacoes() {
            filtrosAtivos = {};
            
            const status = document.getElementById('filtro-status').value;
            const cliente = document.getElementById('filtro-cliente').value;
            const dataInicio = document.getElementById('filtro-data-inicio').value;
            const dataFim = document.getElementById('filtro-data-fim').value;
            
            if (status) filtrosAtivos.status = status;
            if (cliente) filtrosAtivos.cliente_nome = cliente;
            if (dataInicio) filtrosAtivos.data_inicio = dataInicio;
            if (dataFim) filtrosAtivos.data_fim = dataFim;
            
            carregarCotacoes(1);
        }

        // Função para limpar filtros
        function limparFiltrosCotacoes() {
            document.getElementById('filtro-status').value = '';
            document.getElementById('filtro-cliente').value = '';
            document.getElementById('filtro-data-inicio').value = '';
            document.getElementById('filtro-data-fim').value = '';
            
            filtrosAtivos = {};
            carregarCotacoes(1);
        }

        // ==================== FUNÇÕES PARA ABAS DE MODALIDADE ====================
        
        let modalidadeAtiva = 'todas';
        let filtrosUsuario = {};
        
        // Função para configurar filtros baseados no tipo de usuário
        function configurarFiltrosUsuario() {
            const filtrosContainer = document.getElementById('filtros-usuario');
            if (!filtrosContainer) return;
            
            // Obter informações do usuário (será implementado)
            const tipoUsuario = window.userInfo?.tipo || 'consultor';
            
            let filtrosHTML = '<div class="flex flex-wrap gap-4">';
            
            if (tipoUsuario === 'consultor') {
                filtrosHTML += `
                    <button id="filtro-minhas-solicitacoes" class="filtro-usuario active px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors" data-filtro="minhas-solicitacoes">
                        <i class="fas fa-user mr-2"></i>Minhas Solicitações
                    </button>
                `;
            } else if (tipoUsuario === 'operador') {
                filtrosHTML += `
                    <button id="filtro-disponiveis" class="filtro-usuario active px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors" data-filtro="disponiveis">
                        <i class="fas fa-clock mr-2"></i>Disponíveis
                    </button>
                    <button id="filtro-minhas-operacoes" class="filtro-usuario px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" data-filtro="minhas-operacoes">
                        <i class="fas fa-cogs mr-2"></i>Minhas Operações
                    </button>
                `;
            } else {
                // Admin/Gerente - ver todas
                filtrosHTML += `
                    <button id="filtro-todas" class="filtro-usuario active px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors" data-filtro="todas">
                        <i class="fas fa-list mr-2"></i>Todas
                    </button>
                    <button id="filtro-disponiveis" class="filtro-usuario px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors" data-filtro="disponiveis">
                        <i class="fas fa-clock mr-2"></i>Disponíveis
                    </button>
                `;
            }
            
            filtrosHTML += '</div>';
            filtrosContainer.innerHTML = filtrosHTML;
            
            // Adicionar event listeners
            document.querySelectorAll('.filtro-usuario').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remover classe active de todos
                    document.querySelectorAll('.filtro-usuario').forEach(b => {
                        b.classList.remove('active');
                        b.classList.add('bg-gray-200', 'text-gray-700');
                        b.classList.remove('bg-blue-600', 'text-white', 'bg-green-600', 'bg-purple-600');
                    });
                    
                    // Adicionar classe active ao clicado
                    this.classList.add('active');
                    this.classList.remove('bg-gray-200', 'text-gray-700');
                    
                    const filtro = this.dataset.filtro;
                    if (filtro === 'disponiveis') {
                        this.classList.add('bg-green-600', 'text-white');
                    } else if (filtro === 'minhas-operacoes') {
                        this.classList.add('bg-orange-600', 'text-white');
                    } else if (filtro === 'minhas-solicitacoes') {
                        this.classList.add('bg-blue-600', 'text-white');
                    } else {
                        this.classList.add('bg-purple-600', 'text-white');
                    }
                    
                    filtrosUsuario.tipo = filtro;
                    carregarCotacoesPorModalidade();
                });
            });
            
            // Definir filtro inicial
            const tipoUsuarioMap = {
                'consultor': 'minhas-solicitacoes',
                'operador': 'disponiveis',
                'administrador': 'todas',
                'gerente': 'todas'
            };
            
            filtrosUsuario.tipo = tipoUsuarioMap[tipoUsuario] || 'todas';
        }
        
        // Função para configurar abas de modalidade
        function configurarAbasModalidade() {
            document.querySelectorAll('.tab-modalidade').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remover classe active de todas as abas
                    document.querySelectorAll('.tab-modalidade').forEach(t => {
                        t.classList.remove('active', 'border-orange-500', 'text-orange-600');
                        t.classList.add('border-transparent', 'text-gray-500');
                    });
                    
                    // Adicionar classe active à aba clicada
                    this.classList.add('active', 'border-orange-500', 'text-orange-600');
                    this.classList.remove('border-transparent', 'text-gray-500');
                    
                    // Atualizar modalidade ativa
                    modalidadeAtiva = this.dataset.modalidade;
                    
                    // Carregar cotações da modalidade
                    carregarCotacoesPorModalidade();
                });
            });
        }
        
        // Função para carregar cotações por modalidade
        async function carregarCotacoesPorModalidade(page = 1) {
            try {
                let endpoint = '/api/cotacoes';
                
                // Determinar endpoint baseado na modalidade e filtro de usuário
                if (filtrosUsuario.tipo === 'disponiveis') {
                    endpoint = '/api/v133/cotacoes/disponiveis';
                } else if (filtrosUsuario.tipo === 'minhas-operacoes') {
                    endpoint = '/api/v133/cotacoes/minhas-operacoes';
                } else if (filtrosUsuario.tipo === 'minhas-solicitacoes') {
                    endpoint = '/api/v133/cotacoes/minhas-solicitacoes';
                } else if (modalidadeAtiva === 'rodoviarias') {
                    endpoint = '/api/v133/cotacoes/rodoviarias';
                } else if (modalidadeAtiva === 'maritimas') {
                    endpoint = '/api/v133/cotacoes/maritimas';
                } else if (modalidadeAtiva === 'aereas') {
                    endpoint = '/api/v133/cotacoes/aereas';
                }
                
                const params = new URLSearchParams({
                    page: page,
                    per_page: 10
                });
                
                const response = await fetch(`${endpoint}?${params}`);
                const data = await response.json();
                
                if (data.success) {
                    renderizarCotacoes(data.cotacoes || []);
                    renderizarPaginacao(data.pagination || { current_page: 1, total_pages: 1 });
                    atualizarEstatisticasModalidade(data.cotacoes || []);
                } else {
                    console.error('Erro ao carregar cotações:', data.message);
                    renderizarCotacoes([]);
                }
                
            } catch (error) {
                console.error('Erro ao carregar cotações por modalidade:', error);
                renderizarCotacoes([]);
            }
        }
        
        // Função para renderizar cotações com design melhorado
        function renderizarCotacoes(cotacoes) {
            const container = document.getElementById('lista-cotacoes');
            if (!container) return;
            
            if (cotacoes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Nenhuma cotação encontrada</h3>
                        <p class="text-gray-500">Não há cotações para exibir nesta modalidade.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = cotacoes.map(cotacao => `
                <div class="cotacao-card ${cotacao.status} bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-all">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="text-lg font-semibold text-gray-900">${cotacao.numero_cotacao}</h3>
                                <span class="status-badge status-${cotacao.status}">${getStatusDisplay(cotacao.status)}</span>
                                <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs font-medium">
                                    ${getModalidadeDisplay(cotacao.empresa_transporte)}
                                </span>
                            </div>
                            <p class="text-gray-600 mb-1"><strong>Cliente:</strong> ${cotacao.numero_cliente ? `#${cotacao.numero_cliente} - ` : ''}${cotacao.cliente_nome}</p>
                            <p class="text-gray-600 mb-1"><strong>CNPJ:</strong> ${formatarCNPJ(cotacao.cliente_cnpj)}</p>
                            ${cotacao.consultor_nome ? `<p class="text-gray-600 mb-1"><strong>Consultor:</strong> ${cotacao.consultor_nome}</p>` : ''}
                            ${cotacao.operador_nome ? `<p class="text-gray-600 mb-1"><strong>Operador:</strong> ${cotacao.operador_nome}</p>` : ''}
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-500">${formatarData(cotacao.created_at)}</p>
                            ${cotacao.cotacao_valor_frete ? `<p class="text-lg font-bold text-green-600 mt-1">R$ ${formatarMoeda(cotacao.cotacao_valor_frete)}</p>` : ''}
                        </div>
                    </div>
                    
                    <div class="border-t pt-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4 text-sm text-gray-600">
                                ${getInfoTransporte(cotacao)}
                            </div>
                            <div class="flex gap-2">
                                ${getBotoesAcaoV133(cotacao)}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Função para obter botões de ação v1.3.3
        function getBotoesAcaoV133(cotacao) {
            let botoes = [];
            const tipoUsuario = window.userInfo?.tipo || 'consultor';
            
            // Botão Ver Detalhes (sempre presente)
            botoes.push(`
                <button onclick="verDetalhesCotacao(${cotacao.id})" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                    <i class="fas fa-eye mr-1"></i>Detalhes
                </button>
            `);
            
            // Botões específicos por status e tipo de usuário
            if (tipoUsuario === 'operador' || tipoUsuario === 'administrador' || tipoUsuario === 'gerente') {
                if (cotacao.status === 'solicitada') {
                    botoes.push(`
                        <button onclick="aceitarCotacaoV133(${cotacao.id})" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                            <i class="fas fa-check mr-1"></i>Aceitar
                        </button>
                    `);
                } else if (cotacao.status === 'aceita_operador' && (cotacao.operador_id === window.userInfo?.id || tipoUsuario !== 'operador')) {
                    botoes.push(`
                        <button onclick="enviarRespostaCotacao(${cotacao.id})" class="px-3 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors text-sm">
                            <i class="fas fa-reply mr-1"></i>Responder
                        </button>
                    `);
                }
            }
            
            if (tipoUsuario === 'consultor' || tipoUsuario === 'administrador' || tipoUsuario === 'gerente') {
                if (cotacao.status === 'cotacao_enviada' && (cotacao.consultor_id === window.userInfo?.id || tipoUsuario !== 'consultor')) {
                    botoes.push(`
                        <button onclick="aceitarCotacaoConsultor(${cotacao.id})" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                            <i class="fas fa-thumbs-up mr-1"></i>Aceitar
                        </button>
                        <button onclick="negarCotacaoConsultor(${cotacao.id})" class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">
                            <i class="fas fa-thumbs-down mr-1"></i>Negar
                        </button>
                    `);
                }
            }
            
            return botoes.join('');
        }
        
        // Funções auxiliares para exibição
        function getStatusDisplay(status) {
            const statusMap = {
                'solicitada': 'Solicitada',
                'aceita_operador': 'Aceita pelo Operador',
                'cotacao_enviada': 'Cotação Enviada',
                'aceita_consultor': 'Aceita pelo Consultor',
                'negada_consultor': 'Negada pelo Consultor',
                'finalizada': 'Finalizada'
            };
            return statusMap[status] || status;
        }
        
        function getModalidadeDisplay(empresa_transporte) {
            const modalidadeMap = {
                'brcargo_rodoviario': 'Rodoviário',
                'brcargo_maritimo': 'Marítimo',
                'frete_aereo': 'Aéreo'
            };
            return modalidadeMap[empresa_transporte] || empresa_transporte;
        }
        
        function getInfoTransporte(cotacao) {
            if (cotacao.empresa_transporte === 'brcargo_maritimo') {
                return `
                    <span><i class="fas fa-anchor mr-1"></i>${cotacao.porto_origem || 'N/A'} → ${cotacao.porto_destino || 'N/A'}</span>
                    ${cotacao.tipo_carga_maritima ? `<span><i class="fas fa-box mr-1"></i>${cotacao.tipo_carga_maritima}</span>` : ''}
                `;
            } else {
                return `
                    <span><i class="fas fa-map-marker-alt mr-1"></i>${cotacao.origem_cidade || 'N/A'} → ${cotacao.destino_cidade || 'N/A'}</span>
                    <span><i class="fas fa-weight-hanging mr-1"></i>${cotacao.carga_peso_kg || 0} kg</span>
                `;
            }
        }
        
        function atualizarEstatisticasModalidade(cotacoes) {
            const total = cotacoes.length;
            const pendentes = cotacoes.filter(c => ['solicitada', 'aceita_operador'].includes(c.status)).length;
            const finalizadas = cotacoes.filter(c => c.status === 'finalizada').length;
            const enviadas = cotacoes.filter(c => c.status === 'cotacao_enviada').length;
            
            document.getElementById('total-cotacoes').textContent = total;
            document.getElementById('cotacoes-pendentes').textContent = pendentes;
            document.getElementById('cotacoes-finalizadas').textContent = finalizadas;
            document.getElementById('cotacoes-enviadas').textContent = enviadas;
        }

        // Função para criar cotação
        async function criarCotacao(formData) {
            try {
                const response = await fetch('/api/cotacoes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                
                if (response.ok) {
                    mostrarMensagem('Cotação criada com sucesso!', 'success');
                    fecharModalCotacao();
                    if (document.getElementById('secao-cotacoes').style.display !== 'none') {
                        carregarCotacoes();
                        carregarEstatisticasCotacoes();
                    }
                } else {
                    throw new Error(data.message || 'Erro ao criar cotação');
                }
            } catch (error) {
                console.error('Erro ao criar cotação:', error);
                mostrarMensagem(error.message, 'error');
            }
        }

        // Função para aceitar cotação
        async function aceitarCotacao(cotacaoId) {
            try {
                console.log('Aceitando cotação:', cotacaoId);
                const response = await fetch(`/api/cotacoes/${cotacaoId}/aceitar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    mostrarMensagem('Cotação aceita com sucesso!', 'success');
                    carregarCotacoes(); // Recarregar lista
                    carregarEstatisticasCotacoes(); // Atualizar estatísticas
                } else {
                    throw new Error(data.message || 'Erro ao aceitar cotação');
                }
            } catch (error) {
                console.error('Erro ao aceitar cotação:', error);
                mostrarMensagem(error.message, 'error');
            }
        }

        // Função para responder cotação
        async function responderCotacao(cotacaoId) {
            // Abrir modal de resposta
            const valor = prompt('Digite o valor do frete (R$):');
            const prazo = prompt('Digite o prazo de entrega (dias):');
            
            if (!valor || !prazo) {
                mostrarMensagem('Valor e prazo são obrigatórios', 'error');
                return;
            }

            try {
                console.log('Respondendo cotação:', cotacaoId);
                const response = await fetch(`/api/cotacoes/${cotacaoId}/responder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        valor_frete: parseFloat(valor.replace(',', '.')),
                        prazo_entrega: parseInt(prazo),
                        observacoes: 'Cotação respondida via sistema'
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    mostrarMensagem('Cotação respondida com sucesso!', 'success');
                    carregarCotacoes();
                    carregarEstatisticasCotacoes();
                } else {
                    throw new Error(data.message || 'Erro ao responder cotação');
                }
            } catch (error) {
                console.error('Erro ao responder cotação:', error);
                mostrarMensagem(error.message, 'error');
            }
        }

        // Função para finalizar cotação
        async function finalizarCotacao(cotacaoId) {
            if (!confirm('Tem certeza que deseja finalizar esta cotação?')) {
                return;
            }

            try {
                console.log('Finalizando cotação:', cotacaoId);
                const response = await fetch(`/api/cotacoes/${cotacaoId}/finalizar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        acao: 'marcar_finalizada',
                        observacoes: 'Cotação finalizada via sistema'
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    mostrarMensagem('Cotação finalizada com sucesso!', 'success');
                    carregarCotacoes();
                    carregarEstatisticasCotacoes();
                } else {
                    throw new Error(data.message || 'Erro ao finalizar cotação');
                }
            } catch (error) {
                console.error('Erro ao finalizar cotação:', error);
                mostrarMensagem(error.message, 'error');
            }
        }

        // Função para ver detalhes da cotação
        async function verDetalhesCotacao(cotacaoId) {
            try {
                const response = await fetch(`/api/cotacoes/${cotacaoId}`);
                if (response.ok) {
                    const data = await response.json();
                    mostrarModalDetalhes(data.cotacao);
                } else {
                    throw new Error('Erro ao carregar detalhes da cotação');
                }
            } catch (error) {
                console.error('Erro ao carregar detalhes:', error);
                mostrarMensagem('Erro ao carregar detalhes da cotação', 'error');
            }
        }

        // Função para mostrar modal de detalhes
        function mostrarModalDetalhes(cotacao) {
            console.log('📋 Mostrando detalhes da cotação:', cotacao);
            
            // Criar o modal se não existir
            let modal = document.getElementById('modal-detalhes-cotacao');
            if (!modal) {
                modal = criarModalDetalhes();
            }
            
            // Preencher os dados no modal
            preencherModalDetalhes(modal, cotacao);
            
            // Mostrar o modal
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        // Função para criar o modal de detalhes
        function criarModalDetalhes() {
            const modalHTML = `
                <div id="modal-detalhes-cotacao" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
                    <div class="modal-content" style="background-color: white; margin: 2% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 15px;">
                            <h2 id="modal-titulo" style="margin: 0; color: #333;">Detalhes da Cotação</h2>
                            <span class="close" onclick="fecharModalDetalhes()" style="font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa;">&times;</span>
                        </div>
                        
                        <div class="modal-body">
                            <!-- Informações Básicas -->
                            <div class="info-section" style="margin-bottom: 20px;">
                                <h3 style="color: #2c5aa0; border-bottom: 2px solid #2c5aa0; padding-bottom: 5px;">Informações Básicas</h3>
                                <div class="info-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
                                    <div><strong>Número:</strong> <span id="det-numero"></span></div>
                                    <div><strong>Status:</strong> <span id="det-status"></span></div>
                                    <div><strong>Empresa:</strong> <span id="det-empresa"></span></div>
                                    <div><strong>Data Solicitação:</strong> <span id="det-data"></span></div>
                                    <div><strong>Consultor:</strong> <span id="det-consultor"></span></div>
                                    <div><strong>Operador:</strong> <span id="det-operador"></span></div>
                                </div>
                            </div>
                            
                            <!-- Dados do Cliente -->
                            <div class="info-section" style="margin-bottom: 20px;">
                                <h3 style="color: #2c5aa0; border-bottom: 2px solid #2c5aa0; padding-bottom: 5px;">Dados do Cliente</h3>
                                <div class="info-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
                                    <div><strong>Nome/Razão Social:</strong> <span id="det-cliente-nome"></span></div>
                                    <div><strong>CNPJ:</strong> <span id="det-cliente-cnpj"></span></div>
                                    <div><strong>Telefone:</strong> <span id="det-cliente-telefone"></span></div>
                                    <div><strong>Email:</strong> <span id="det-cliente-email"></span></div>
                                    <div id="det-numero-cliente-container" style="display: none;"><strong>Número Cliente:</strong> <span id="det-numero-cliente"></span></div>
                                </div>
                            </div>
                            
                            <!-- Origem e Destino -->
                            <div class="info-section" style="margin-bottom: 20px;">
                                <h3 style="color: #2c5aa0; border-bottom: 2px solid #2c5aa0; padding-bottom: 5px;">Origem e Destino</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                                    <div>
                                        <h4 style="color: #28a745; margin-bottom: 10px;">📍 Origem</h4>
                                        <div id="det-origem-endereco" style="display: none;">
                                            <div><strong>CEP:</strong> <span id="det-origem-cep"></span></div>
                                            <div><strong>Endereço:</strong> <span id="det-origem-endereco-completo"></span></div>
                                            <div><strong>Cidade:</strong> <span id="det-origem-cidade"></span></div>
                                            <div><strong>Estado:</strong> <span id="det-origem-estado"></span></div>
                                        </div>
                                        <div id="det-origem-porto" style="display: none;">
                                            <div><strong>Porto:</strong> <span id="det-porto-origem"></span></div>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 style="color: #dc3545; margin-bottom: 10px;">🎯 Destino</h4>
                                        <div id="det-destino-endereco" style="display: none;">
                                            <div><strong>CEP:</strong> <span id="det-destino-cep"></span></div>
                                            <div><strong>Endereço:</strong> <span id="det-destino-endereco-completo"></span></div>
                                            <div><strong>Cidade:</strong> <span id="det-destino-cidade"></span></div>
                                            <div><strong>Estado:</strong> <span id="det-destino-estado"></span></div>
                                        </div>
                                        <div id="det-destino-porto" style="display: none;">
                                            <div><strong>Porto:</strong> <span id="det-porto-destino"></span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Dados da Carga -->
                            <div class="info-section" style="margin-bottom: 20px;">
                                <h3 style="color: #2c5aa0; border-bottom: 2px solid #2c5aa0; padding-bottom: 5px;">Dados da Carga</h3>
                                <div class="info-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
                                    <div><strong>Descrição:</strong> <span id="det-carga-descricao"></span></div>
                                    <div><strong>Peso Total:</strong> <span id="det-carga-peso"></span> kg</div>
                                    <div><strong>Valor da Mercadoria:</strong> R$ <span id="det-carga-valor"></span></div>
                                    <div id="det-carga-cubagem-rodoviario" style="display: none;"><strong>Cubagem:</strong> <span id="det-carga-cubagem"></span> m³</div>
                                    <div id="det-carga-dimensoes" style="display: none;"><strong>Dimensões:</strong> <span id="det-dimensoes"></span></div>
                                </div>
                            </div>
                            
                            <!-- Dados Específicos Marítimos -->
                            <div id="det-dados-maritimos" class="info-section" style="margin-bottom: 20px; display: none;">
                                <h3 style="color: #2c5aa0; border-bottom: 2px solid #2c5aa0; padding-bottom: 5px;">🚢 Dados Específicos - Transporte Marítimo</h3>
                                <div class="info-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
                                    <div><strong>Net Weight:</strong> <span id="det-net-weight"></span> kg</div>
                                    <div><strong>Gross Weight:</strong> <span id="det-gross-weight"></span> kg</div>
                                    <div><strong>Cubagem:</strong> <span id="det-cubagem"></span> m³</div>
                                    <div><strong>Incoterm:</strong> <span id="det-incoterm"></span></div>
                                    <div><strong>Tipo de Carga:</strong> <span id="det-tipo-carga"></span></div>
                                    <div id="det-container-info" style="display: none;"><strong>Container:</strong> <span id="det-container-detalhes"></span></div>
                                </div>
                            </div>
                            
                            <!-- Histórico -->
                            <div class="info-section" style="margin-bottom: 20px;">
                                <h3 style="color: #2c5aa0; border-bottom: 2px solid #2c5aa0; padding-bottom: 5px;">📋 Histórico</h3>
                                <div id="det-historico" style="margin-top: 15px;">
                                    <!-- Histórico será preenchido dinamicamente -->
                                </div>
                            </div>
                            
                            <!-- Ações do Operador -->
                            <div id="det-acoes-operador" class="info-section" style="margin-bottom: 20px; display: none;">
                                <h3 style="color: #2c5aa0; border-bottom: 2px solid #2c5aa0; padding-bottom: 5px;">⚡ Ações</h3>
                                <div style="display: flex; gap: 10px; margin-top: 15px;">
                                    <button id="btn-aceitar-cotacao" onclick="aceitarCotacao()" class="btn btn-success">✅ Aceitar Cotação</button>
                                    <button id="btn-enviar-cotacao" onclick="mostrarFormularioCotacao()" class="btn btn-primary" style="display: none;">📤 Enviar Cotação</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            return document.getElementById('modal-detalhes-cotacao');
        }
        
        // Função para preencher os dados no modal
        function preencherModalDetalhes(modal, cotacao) {
            // Informações básicas
            modal.querySelector('#det-numero').textContent = cotacao.numero_cotacao || '';
            modal.querySelector('#det-status').innerHTML = `<span class="badge ${cotacao.status_color || ''}">${cotacao.status_display || cotacao.status}</span>`;
            modal.querySelector('#det-empresa').textContent = getEmpresaDisplay(cotacao.empresa_transporte) || '';
            modal.querySelector('#det-data').textContent = formatarData(cotacao.data_solicitacao) || '';
            modal.querySelector('#det-consultor').textContent = cotacao.consultor_nome || 'Não atribuído';
            modal.querySelector('#det-operador').textContent = cotacao.operador_nome || 'Aguardando operador';
            
            // Dados do cliente
            modal.querySelector('#det-cliente-nome').textContent = cotacao.cliente_nome || '';
            modal.querySelector('#det-cliente-cnpj').textContent = cotacao.cliente_cnpj || '';
            modal.querySelector('#det-cliente-telefone').textContent = cotacao.cliente_contato_telefone || '';
            modal.querySelector('#det-cliente-email').textContent = cotacao.cliente_contato_email || '';
            
            // Número do cliente (para todas as modalidades quando disponível)
            if (cotacao.numero_cliente) {
                modal.querySelector('#det-numero-cliente-container').style.display = 'block';
                modal.querySelector('#det-numero-cliente').textContent = cotacao.numero_cliente;
            } else {
                modal.querySelector('#det-numero-cliente-container').style.display = 'none';
            }
            
            // Origem e destino
            if (cotacao.empresa_transporte === 'brcargo_maritimo') {
                // Para marítimo, mostrar portos
                modal.querySelector('#det-origem-endereco').style.display = 'none';
                modal.querySelector('#det-destino-endereco').style.display = 'none';
                modal.querySelector('#det-origem-porto').style.display = 'block';
                modal.querySelector('#det-destino-porto').style.display = 'block';
                modal.querySelector('#det-porto-origem').textContent = cotacao.porto_origem || '';
                modal.querySelector('#det-porto-destino').textContent = cotacao.porto_destino || '';
            } else {
                // Para rodoviário/aéreo, mostrar endereços
                modal.querySelector('#det-origem-endereco').style.display = 'block';
                modal.querySelector('#det-destino-endereco').style.display = 'block';
                modal.querySelector('#det-origem-porto').style.display = 'none';
                modal.querySelector('#det-destino-porto').style.display = 'none';
                
                modal.querySelector('#det-origem-cep').textContent = cotacao.origem_cep || '';
                modal.querySelector('#det-origem-endereco-completo').textContent = cotacao.origem_endereco || '';
                modal.querySelector('#det-origem-cidade').textContent = cotacao.origem_cidade || '';
                modal.querySelector('#det-origem-estado').textContent = cotacao.origem_estado || '';
                
                modal.querySelector('#det-destino-cep').textContent = cotacao.destino_cep || '';
                modal.querySelector('#det-destino-endereco-completo').textContent = cotacao.destino_endereco || '';
                modal.querySelector('#det-destino-cidade').textContent = cotacao.destino_cidade || '';
                modal.querySelector('#det-destino-estado').textContent = cotacao.destino_estado || '';
            }
            
            // Dados da carga
            modal.querySelector('#det-carga-descricao').textContent = cotacao.carga_descricao || '';
            modal.querySelector('#det-carga-peso').textContent = cotacao.carga_peso_kg || '0';
            modal.querySelector('#det-carga-valor').textContent = formatarMoeda(cotacao.carga_valor_mercadoria) || '0,00';
            
            // Cubagem para transporte rodoviário
            if (cotacao.empresa_transporte === 'brcargo_rodoviario' && cotacao.cubagem) {
                modal.querySelector('#det-carga-cubagem-rodoviario').style.display = 'block';
                modal.querySelector('#det-carga-cubagem').textContent = cotacao.cubagem.toFixed(3) || '0.000';
            } else {
                modal.querySelector('#det-carga-cubagem-rodoviario').style.display = 'none';
            }
            
            // Dimensões (se disponível)
            if (cotacao.carga_comprimento_cm || cotacao.carga_largura_cm || cotacao.carga_altura_cm) {
                modal.querySelector('#det-carga-dimensoes').style.display = 'block';
                const dimensoes = `${cotacao.carga_comprimento_cm || 0} x ${cotacao.carga_largura_cm || 0} x ${cotacao.carga_altura_cm || 0} cm`;
                modal.querySelector('#det-dimensoes').textContent = dimensoes;
            } else {
                modal.querySelector('#det-carga-dimensoes').style.display = 'none';
            }
            
            // Dados específicos marítimos
            if (cotacao.empresa_transporte === 'brcargo_maritimo') {
                modal.querySelector('#det-dados-maritimos').style.display = 'block';
                modal.querySelector('#det-net-weight').textContent = cotacao.net_weight || '0';
                modal.querySelector('#det-gross-weight').textContent = cotacao.gross_weight || '0';
                modal.querySelector('#det-cubagem').textContent = cotacao.cubagem || '0';
                modal.querySelector('#det-incoterm').textContent = cotacao.incoterm || '';
                modal.querySelector('#det-tipo-carga').textContent = cotacao.tipo_carga_maritima || '';
                
                // Informações do container (se FCL)
                if (cotacao.tipo_carga_maritima === 'FCL' && cotacao.tamanho_container) {
                    modal.querySelector('#det-container-info').style.display = 'block';
                    const containerInfo = `${cotacao.quantidade_containers || 1}x ${cotacao.tamanho_container}`;
                    modal.querySelector('#det-container-detalhes').textContent = containerInfo;
                } else {
                    modal.querySelector('#det-container-info').style.display = 'none';
                }
            } else {
                modal.querySelector('#det-dados-maritimos').style.display = 'none';
            }
            
            // Histórico
            preencherHistorico(modal, cotacao.historico || []);
            
            // Ações do operador (mostrar apenas se for operador e cotação estiver disponível)
            // TODO: Implementar verificação de perfil do usuário
            if (cotacao.status === 'solicitada') {
                modal.querySelector('#det-acoes-operador').style.display = 'block';
                modal.querySelector('#btn-aceitar-cotacao').setAttribute('data-cotacao-id', cotacao.id);
            } else {
                modal.querySelector('#det-acoes-operador').style.display = 'none';
            }
        }
        
        // Função para preencher histórico
        function preencherHistorico(modal, historico) {
            const historicoContainer = modal.querySelector('#det-historico');
            
            if (!historico || historico.length === 0) {
                historicoContainer.innerHTML = '<p style="color: #666; font-style: italic;">Nenhum histórico disponível.</p>';
                return;
            }
            
            let historicoHTML = '';
            historico.forEach(item => {
                const dataFormatada = formatarDataHora(item.timestamp);
                const statusAnterior = item.status_anterior ? `${item.status_anterior} → ` : '';
                
                historicoHTML += `
                    <div style="border-left: 3px solid #2c5aa0; padding-left: 15px; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                        <div style="font-weight: bold; color: #2c5aa0;">${statusAnterior}${item.status_novo}</div>
                        <div style="color: #666; font-size: 0.9em;">por ${item.usuario_nome} em ${dataFormatada}</div>
                        ${item.observacoes ? `<div style="margin-top: 5px; font-style: italic;">"${item.observacoes}"</div>` : ''}
                    </div>
                `;
            });
            
            historicoContainer.innerHTML = historicoHTML;
        }
        
        // Função para fechar o modal
        function fecharModalDetalhes() {
            const modal = document.getElementById('modal-detalhes-cotacao');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }
        
        // Função auxiliar para formatar data
        function formatarData(dataISO) {
            if (!dataISO) return '';
            const data = new Date(dataISO);
            return data.toLocaleDateString('pt-BR');
        }
        
        // Função auxiliar para formatar data e hora
        function formatarDataHora(dataISO) {
            if (!dataISO) return '';
            const data = new Date(dataISO);
            return data.toLocaleString('pt-BR');
        }
        
        // Função auxiliar para formatar moeda
        function formatarMoeda(valor) {
            if (!valor) return '0,00';
            return parseFloat(valor).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        // Função auxiliar para obter nome da empresa
        function getEmpresaDisplay(empresa) {
            const empresas = {
                'brcargo_rodoviario': 'BRCargo Rodoviário',
                'brcargo_maritimo': 'BRCargo Marítimo',
                'frete_aereo': 'Frete Aéreo'
            };
            return empresas[empresa] || empresa;
        }

        // Função para mostrar mensagens
        function mostrarMensagem(mensagem, tipo = 'info') {
            // Criar elemento de notificação
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg transition-all duration-300 transform ${
                tipo === 'success' ? 'bg-green-500 text-white' :
                tipo === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            
            // Z-index muito alto para aparecer por cima de tudo
            notification.style.zIndex = '99999';
            notification.style.maxWidth = '400px';
            notification.style.wordWrap = 'break-word';
            notification.textContent = mensagem;
            
            // Adicionar ícone baseado no tipo
            const icon = document.createElement('i');
            icon.className = `fas ${
                tipo === 'success' ? 'fa-check-circle' :
                tipo === 'error' ? 'fa-exclamation-triangle' :
                'fa-info-circle'
            } mr-2`;
            
            notification.insertBefore(icon, notification.firstChild);
            
            document.body.appendChild(notification);
            
            // Animação de entrada
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
                notification.style.opacity = '1';
            }, 10);
            
            // Remover após 5 segundos com animação
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 5000);
        }

        // Função para atualizar página ao mudar de aba - REMOVIDA
        // Esta função estava causando reload automático e impedindo navegação
        function configurarAtualizacaoAba() {
            // Função desabilitada para permitir navegação normal
            console.log('Função de atualização de aba desabilitada para permitir navegação');
        }

        // Inicializar funcionalidades do rodapé
        document.addEventListener('DOMContentLoaded', function() {
            carregarInfoUsuario();
            atualizarHorario();
            configurarAtualizacaoAba();
            
            // Configurar sistema de cotações
            configurarBotaoCotacao();
            
            // Event listeners para modal de cotação
            const fecharModalBtn = document.getElementById('fechar-modal-cotacao');
            const cancelarBtn = document.getElementById('cancelar-cotacao');
            const formCotacao = document.getElementById('form-cotacao');
            const btnNovaCotacao = document.getElementById('btn-nova-cotacao');
            
            if (fecharModalBtn) {
                fecharModalBtn.addEventListener('click', fecharModalCotacao);
            }
            
            if (cancelarBtn) {
                cancelarBtn.addEventListener('click', fecharModalCotacao);
            }
            
            if (btnNovaCotacao) {
                btnNovaCotacao.addEventListener('click', abrirModalCotacao);
            }
            
            // Controle de campos específicos por modalidade
            const empresaTransporteInputs = document.querySelectorAll('input[name="empresa_transporte"]');
            const camposMaritimo = document.getElementById('campos-maritimo');
            const camposAereo = document.getElementById('campos-aereo');
            const maritimoRequired = document.querySelectorAll('.maritimo-required');
            const tipoCargarMaritimaSelect = document.querySelector('select[name="tipo_carga_maritima"]');
            const camposFcl = document.getElementById('campos-fcl');
            
            // Event listener para mudança de empresa de transporte
            empresaTransporteInputs.forEach(input => {
                input.addEventListener('change', function() {
                    const isMaritimo = this.value === 'brcargo_maritimo';
                    const isAereo = this.value === 'frete_aereo';
                    const isRodoviario = this.value === 'brcargo_rodoviario';
                    
                    console.log('Modalidade selecionada:', this.value, {isMaritimo, isAereo, isRodoviario});
                    
                    // Controlar campos de origem e destino
                    const camposOrigemEndereco = document.getElementById('campos-origem-endereco');
                    const camposDestinoEndereco = document.getElementById('campos-destino-endereco');
                    const dadosCarga = document.getElementById('dados-carga');
                    const tipoOrigemRodoviario = document.getElementById('tipo-origem-rodoviario');
                    
                    // Mostrar/ocultar campos marítimos
                    if (camposMaritimo) {
                        camposMaritimo.style.display = isMaritimo ? 'block' : 'none';
                        console.log('Campos marítimos:', isMaritimo ? 'mostrados' : 'ocultos');
                    }
                    
                    // Mostrar/ocultar campos aéreos
                    if (camposAereo) {
                        camposAereo.style.display = isAereo ? 'block' : 'none';
                        console.log('Campos aéreos:', isAereo ? 'mostrados' : 'ocultos');
                    }
                    
                    if (camposOrigemEndereco && camposDestinoEndereco) {
                        if (isMaritimo) {
                            // Para marítimo, ocultar campos de endereço
                            camposOrigemEndereco.style.display = 'none';
                            camposDestinoEndereco.style.display = 'none';
                            
                            // Ocultar opção de tipo de origem
                            if (tipoOrigemRodoviario) {
                                tipoOrigemRodoviario.style.display = 'none';
                            }
                            
                            // Ocultar seção de dados da carga para marítimo
                            if (dadosCarga) {
                                dadosCarga.style.display = 'none';
                            }
                            
                            // Remover obrigatoriedade dos campos de endereço e carga
                            ['origem_cep', 'origem_endereco', 'origem_cidade', 'origem_estado',
                             'destino_cep', 'destino_endereco', 'destino_cidade', 'destino_estado',
                             'carga_descricao', 'carga_peso_kg', 'carga_valor_mercadoria', 'carga_cubagem'].forEach(campo => {
                                const input = document.querySelector(`[name="${campo}"]`);
                                if (input) input.removeAttribute('required');
                            });
                        } else {
                            // Para rodoviário e aéreo, mostrar campos de endereço e dados da carga
                            camposOrigemEndereco.style.display = 'block';
                            camposDestinoEndereco.style.display = 'block';
                            
                            // Mostrar opção de tipo de origem apenas para rodoviário
                            if (tipoOrigemRodoviario) {
                                if (isRodoviario) {
                                    tipoOrigemRodoviario.style.display = 'block';
                                    
                                    // Garantir que "endereço" esteja selecionado por padrão
                                    const enderecoRadio = document.querySelector('input[name="tipo_origem"][value="endereco"]');
                                    if (enderecoRadio && !document.querySelector('input[name="tipo_origem"]:checked')) {
                                        enderecoRadio.checked = true;
                                        // Disparar evento change para aplicar as regras
                                        enderecoRadio.dispatchEvent(new Event('change'));
                                    }
                                } else {
                                    tipoOrigemRodoviario.style.display = 'none';
                                }
                            }
                            
                            // Mostrar seção de dados da carga para rodoviário e aéreo
                            if (dadosCarga) {
                                dadosCarga.style.display = 'block';
                            }
                            
                            // Adicionar obrigatoriedade aos campos de endereço e carga
                            ['origem_cep', 'origem_endereco', 'origem_cidade', 'origem_estado',
                             'destino_cep', 'destino_endereco', 'destino_cidade', 'destino_estado',
                             'carga_descricao', 'carga_peso_kg', 'carga_valor_mercadoria', 'carga_cubagem'].forEach(campo => {
                                const input = document.querySelector(`[name="${campo}"]`);
                                if (input) input.setAttribute('required', 'required');
                            });
                        }
                    }
                    
                    // Mostrar/ocultar campos marítimos
                    if (camposMaritimo) {
                        camposMaritimo.style.display = isMaritimo ? 'block' : 'none';
                    }
                    
                    // Mostrar/ocultar campos aéreos
                    if (camposAereo) {
                        camposAereo.style.display = isAereo ? 'block' : 'none';
                    }
                    
                    // Mostrar/ocultar asteriscos de obrigatório
                    maritimoRequired.forEach(span => {
                        span.style.display = isMaritimo ? 'inline' : 'none';
                    });
                    
                    // Definir campos obrigatórios condicionalmente para marítimo
                    const camposObrigatoriosMaritimo = [
                        'numero_cliente', 'net_weight', 'gross_weight', 
                        'cubagem', 'incoterm', 'tipo_carga_maritima',
                        'porto_origem', 'porto_destino'
                    ];
                    
                    camposObrigatoriosMaritimo.forEach(campo => {
                        const input = document.querySelector(`[name="${campo}"]`);
                        if (input) {
                            if (isMaritimo) {
                                input.setAttribute('required', 'required');
                            } else {
                                input.removeAttribute('required');
                            }
                        }
                    });
                    
                    // Definir campos obrigatórios condicionalmente para aéreo
                    const camposObrigatoriosAereo = ['aeroporto_origem', 'aeroporto_destino'];
                    camposObrigatoriosAereo.forEach(campo => {
                        const input = document.querySelector(`[name="${campo}"]`);
                        if (input) {
                            if (isAereo) {
                                input.setAttribute('required', 'required');
                            } else {
                                input.removeAttribute('required');
                            }
                        }
                    });
                });
            });
            
            // Event listener para controle de tipo de origem (endereço vs porto)
            const tipoOrigemInputs = document.querySelectorAll('input[name="tipo_origem"]');
            tipoOrigemInputs.forEach(input => {
                input.addEventListener('change', function() {
                    const isPorto = this.value === 'porto';
                    const camposEnderecoOrigem = document.getElementById('campos-endereco-origem');
                    const camposPortoOrigem = document.getElementById('campos-porto-origem');
                    
                    if (camposEnderecoOrigem && camposPortoOrigem) {
                        if (isPorto) {
                            // Mostrar campo de porto, ocultar campos de endereço
                            camposEnderecoOrigem.style.display = 'none';
                            camposPortoOrigem.style.display = 'block';
                            
                            // Remover obrigatoriedade dos campos de endereço
                            ['origem_cep', 'origem_endereco', 'origem_cidade', 'origem_estado'].forEach(campo => {
                                const input = document.querySelector(`[name="${campo}"]`);
                                if (input) input.removeAttribute('required');
                            });
                            
                            // Adicionar obrigatoriedade ao campo de porto
                            const portoInput = document.querySelector('[name="origem_porto"]');
                            if (portoInput) portoInput.setAttribute('required', 'required');
                        } else {
                            // Mostrar campos de endereço, ocultar campo de porto
                            camposEnderecoOrigem.style.display = 'block';
                            camposPortoOrigem.style.display = 'none';
                            
                            // Adicionar obrigatoriedade aos campos de endereço
                            ['origem_cep', 'origem_endereco', 'origem_cidade', 'origem_estado'].forEach(campo => {
                                const input = document.querySelector(`[name="${campo}"]`);
                                if (input) input.setAttribute('required', 'required');
                            });
                            
                            // Remover obrigatoriedade do campo de porto
                            const portoInput = document.querySelector('[name="origem_porto"]');
                            if (portoInput) portoInput.removeAttribute('required');
                        }
                    }
                });
            });
            
            // Função para inicializar estado dos campos baseado na modalidade selecionada
            function inicializarCamposPorModalidade() {
                // Primeiro, verificar se há uma modalidade pré-selecionada
                const modalidadeSelecionada = document.querySelector('input[name="empresa_transporte"]:checked');
                if (modalidadeSelecionada) {
                    // Disparar evento change para aplicar as regras
                    modalidadeSelecionada.dispatchEvent(new Event('change'));
                } else {
                    // Se não há modalidade selecionada, verificar se rodoviário está disponível
                    const rodoviarioInput = document.querySelector('input[value="brcargo_rodoviario"]');
                    if (rodoviarioInput) {
                        // Simular seleção temporária para inicializar campos
                        rodoviarioInput.checked = true;
                        rodoviarioInput.dispatchEvent(new Event('change'));
                        // Desmarcar para deixar o usuário escolher
                        rodoviarioInput.checked = false;
                    }
                }
                
                // Garantir que o tipo de origem seja sempre visível para rodoviário quando disponível
                const tipoOrigemRodoviario = document.getElementById('tipo-origem-rodoviario');
                const rodoviarioInput = document.querySelector('input[value="brcargo_rodoviario"]');
                
                if (tipoOrigemRodoviario) {
                    // Sempre mostrar tipo de origem para rodoviário
                    tipoOrigemRodoviario.style.display = 'block';
                    
                    // Inicializar com "endereço" selecionado por padrão
                    const enderecoRadio = document.querySelector('input[name="tipo_origem"][value="endereco"]');
                    if (enderecoRadio && !document.querySelector('input[name="tipo_origem"]:checked')) {
                        enderecoRadio.checked = true;
                        enderecoRadio.dispatchEvent(new Event('change'));
                    }
                }
            }
            
            // Event listener para tipo de carga marítima (FCL/LCL)
            if (tipoCargarMaritimaSelect) {
                tipoCargarMaritimaSelect.addEventListener('change', function() {
                    const isFcl = this.value === 'FCL';
                    
                    if (camposFcl) {
                        camposFcl.style.display = isFcl ? 'grid' : 'none';
                    }
                    
                    // Definir campos FCL como obrigatórios condicionalmente
                    const camposFclObrigatorios = ['tamanho_container', 'quantidade_containers'];
                    camposFclObrigatorios.forEach(campo => {
                        const input = document.querySelector(`[name="${campo}"]`);
                        if (input) {
                            if (isFcl) {
                                input.setAttribute('required', 'required');
                            } else {
                                input.removeAttribute('required');
                            }
                        }
                    });
                });
            }
            
            // Event listener para formulário de cotação
            if (formCotacao) {
                formCotacao.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(formCotacao);
                    const data = {};
                    
                    // Converter FormData para objeto
                    for (let [key, value] of formData.entries()) {
                        if (key === 'seguro_adicional') {
                            data[key] = formData.has(key);
                        } else if (value !== '') {
                            // Converter valores monetários formatados para números
                            if (key.includes('valor_mercadoria') || key.includes('valor') || key.includes('preco')) {
                                const campo = formCotacao.querySelector(`[name="${key}"]`);
                                if (campo && campo.dataset.valorNumerico) {
                                    data[key] = parseFloat(campo.dataset.valorNumerico);
                                } else {
                                    // Fallback: remover formatação manualmente
                                    const valorLimpo = value.replace(/[^\d,]/g, '').replace(',', '.');
                                    data[key] = parseFloat(valorLimpo) || 0;
                                }
                            } else {
                                data[key] = value;
                            }
                        }
                    }
                    
                    await criarCotacao(data);
                });
            }
            
            // Event listeners para filtros de cotação
            const aplicarFiltrosBtn = document.getElementById('aplicar-filtros');
            const limparFiltrosBtn = document.getElementById('limpar-filtros');
            
            if (aplicarFiltrosBtn) {
                aplicarFiltrosBtn.addEventListener('click', aplicarFiltrosCotacoes);
            }
            
            if (limparFiltrosBtn) {
                limparFiltrosBtn.addEventListener('click', limparFiltrosCotacoes);
            }
            
            // Fechar modal ao clicar fora - REMOVIDO para evitar fechamento acidental
            // const modalCotacao = document.getElementById('modal-cotacao');
            // if (modalCotacao) {
            //     modalCotacao.addEventListener('click', function(e) {
            //         if (e.target === modalCotacao) {
            //             fecharModalCotacao();
            //         }
            //     });
            // }
            
            // Atualizar horário a cada segundo
            setInterval(atualizarHorario, 1000);
            
            // ==================== CONFIGURAÇÃO ANALYTICS V1.3.3 ====================
            
            // Configurar navegação para analytics
            const navAnalytics = document.getElementById('nav-analytics');
            if (navAnalytics) {
                navAnalytics.addEventListener('click', function(e) {
                    e.preventDefault();
                    mostrarSecaoAnalytics();
                });
            }
            
            // Configurar abas de analytics
            configurarAbasAnalytics();
            
            // Configurar botões de analytics
            const btnAtualizarAnalytics = document.getElementById('btn-atualizar-analytics');
            if (btnAtualizarAnalytics) {
                btnAtualizarAnalytics.addEventListener('click', atualizarAnalytics);
            }
            
            const btnExportarRelatorio = document.getElementById('btn-exportar-relatorio');
            if (btnExportarRelatorio) {
                btnExportarRelatorio.addEventListener('click', exportarRelatorio);
            }
        });
        
        // ==================== FUNÇÕES ANALYTICS V1.3.3 ====================
        
        let analyticsAtivo = 'geral';
        let dadosAnalytics = {};
        
        // Função para configurar abas de analytics
        function configurarAbasAnalytics() {
            document.querySelectorAll('.tab-analytics').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remover classe active de todas as abas
                    document.querySelectorAll('.tab-analytics').forEach(t => {
                        t.classList.remove('active', 'border-orange-500', 'text-orange-600');
                        t.classList.add('border-transparent', 'text-gray-500');
                    });
                    
                    // Adicionar classe active à aba clicada
                    this.classList.add('active', 'border-orange-500', 'text-orange-600');
                    this.classList.remove('border-transparent', 'text-gray-500');
                    
                    // Atualizar analytics ativo
                    analyticsAtivo = this.dataset.analytics;
                    
                    // Carregar conteúdo da aba
                    carregarConteudoAnalytics();
                });
            });
        }
        
        // Função para carregar conteúdo de analytics
        async function carregarConteudoAnalytics() {
            const container = document.getElementById('conteudo-analytics');
            if (!container) return;
            
            // Mostrar loading
            container.innerHTML = `
                <div class="flex items-center justify-center py-12">
                    <div class="loading mr-3"></div>
                    <span class="text-gray-600">Carregando dados...</span>
                </div>
            `;
            
            try {
                switch (analyticsAtivo) {
                    case 'geral':
                        await carregarVisaoGeral();
                        break;
                    case 'empresas':
                        await carregarAnalyticsEmpresas();
                        break;
                    case 'usuarios':
                        await carregarAnalyticsUsuarios();
                        break;
                    case 'tempo-real':
                        await carregarTempoReal();
                        break;
                }
            } catch (error) {
                console.error('Erro ao carregar analytics:', error);
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-exclamation-triangle text-6xl text-red-300 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Erro ao carregar dados</h3>
                        <p class="text-gray-500">${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Função para carregar visão geral
        async function carregarVisaoGeral() {
            const response = await fetch('/api/v133/analytics/sistema/geral');
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message || 'Erro ao carregar dados gerais');
            }
            
            dadosAnalytics.geral = data.relatorio_geral;
            renderizarVisaoGeral(data.relatorio_geral);
        }
        
        // Função para renderizar visão geral
        function renderizarVisaoGeral(dados) {
            const container = document.getElementById('conteudo-analytics');
            
            // Calcular total de cotações
            const totalCotacoes = Object.values(dados.cotacoes_por_status || {}).reduce((sum, count) => sum + count, 0);
            
            container.innerHTML = `
                <!-- Estatísticas Gerais -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-blue-50 p-6 rounded-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                <i class="fas fa-calculator text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total de Cotações</p>
                                <p class="text-2xl font-bold text-gray-900">${totalCotacoes || 0}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 p-6 rounded-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 text-green-600">
                                <i class="fas fa-check-circle text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Cotações Finalizadas</p>
                                <p class="text-2xl font-bold text-gray-900">${dados.cotacoes_finalizadas || 0}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 p-6 rounded-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                                <i class="fas fa-clock text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Em Andamento</p>
                                <p class="text-2xl font-bold text-gray-900">${dados.cotacoes_andamento || 0}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 p-6 rounded-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                                <i class="fas fa-percentage text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Taxa de Sucesso</p>
                                <p class="text-2xl font-bold text-gray-900">${dados.taxa_sucesso || 0}%</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Gráficos -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Gráfico de Cotações por Modalidade -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Cotações por Modalidade</h3>
                        <canvas id="chart-modalidades" width="400" height="300"></canvas>
                    </div>
                    
                    <!-- Gráfico de Status -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Distribuição por Status</h3>
                        <canvas id="chart-status" width="400" height="300"></canvas>
                    </div>
                </div>
                
                <!-- Gráfico de Evolução Temporal -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Evolução das Cotações</h3>
                    <canvas id="chart-evolucao" width="800" height="400"></canvas>
                </div>
            `;
            
            // Renderizar gráficos
            setTimeout(() => {
                renderizarGraficosGerais(dados);
            }, 100);
        }
        
        // Função para renderizar gráficos gerais
        function renderizarGraficosGerais(dados) {
            // Gráfico de modalidades
            const ctxModalidades = document.getElementById('chart-modalidades');
            if (ctxModalidades) {
                new Chart(ctxModalidades, {
                    type: 'doughnut',
                    data: {
                        labels: ['Rodoviário', 'Marítimo', 'Aéreo'],
                        datasets: [{
                            data: [
                                dados.por_modalidade?.rodoviario || 0,
                                dados.por_modalidade?.maritimo || 0,
                                dados.por_modalidade?.aereo || 0
                            ],
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // Gráfico de status
            const ctxStatus = document.getElementById('chart-status');
            if (ctxStatus) {
                new Chart(ctxStatus, {
                    type: 'pie',
                    data: {
                        labels: ['Solicitadas', 'Em Análise', 'Enviadas', 'Finalizadas'],
                        datasets: [{
                            data: [
                                dados.por_status?.solicitadas || 0,
                                dados.por_status?.em_analise || 0,
                                dados.por_status?.enviadas || 0,
                                dados.por_status?.finalizadas || 0
                            ],
                            backgroundColor: ['#3b82f6', '#f59e0b', '#8b5cf6', '#10b981']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // Gráfico de evolução
            const ctxEvolucao = document.getElementById('chart-evolucao');
            if (ctxEvolucao) {
                new Chart(ctxEvolucao, {
                    type: 'line',
                    data: {
                        labels: dados.evolucao?.labels || [],
                        datasets: [{
                            label: 'Cotações Criadas',
                            data: dados.evolucao?.criadas || [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        }, {
                            label: 'Cotações Finalizadas',
                            data: dados.evolucao?.finalizadas || [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }
        
        // Função para carregar analytics de empresas
        async function carregarAnalyticsEmpresas() {
            const response = await fetch('/api/v133/analytics/empresas/ranking');
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message || 'Erro ao carregar dados de empresas');
            }
            
            dadosAnalytics.empresas = data.data;
            renderizarAnalyticsEmpresas(data.data);
        }
        
        // Função para renderizar analytics de empresas
        function renderizarAnalyticsEmpresas(dados) {
            const container = document.getElementById('conteudo-analytics');
            
            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Ranking de Empresas -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Ranking por Taxa de Aceitação</h3>
                        <div class="space-y-4">
                            ${dados.ranking?.map((empresa, index) => `
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div class="flex items-center">
                                        <span class="w-8 h-8 bg-orange-600 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">
                                            ${index + 1}
                                        </span>
                                        <div>
                                            <p class="font-medium text-gray-900">${empresa.nome}</p>
                                            <p class="text-sm text-gray-500">${empresa.total_cotacoes} cotações</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-lg font-bold text-green-600">${empresa.taxa_aceitacao}%</p>
                                        <p class="text-sm text-gray-500">${empresa.aceitas}/${empresa.total_cotacoes}</p>
                                    </div>
                                </div>
                            `).join('') || '<p class="text-gray-500 text-center py-8">Nenhum dado disponível</p>'}
                        </div>
                    </div>
                    
                    <!-- Detalhes por Empresa -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Selecionar Empresa para Detalhes</h3>
                        <select id="select-empresa-detalhes" class="w-full p-3 border border-gray-300 rounded-lg mb-4">
                            <option value="">Selecione uma empresa...</option>
                            ${dados.ranking?.map(empresa => `
                                <option value="${empresa.id}">${empresa.nome}</option>
                            `).join('') || ''}
                        </select>
                        <div id="detalhes-empresa">
                            <p class="text-gray-500 text-center py-8">Selecione uma empresa para ver os detalhes</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Configurar seletor de empresa
            const selectEmpresa = document.getElementById('select-empresa-detalhes');
            if (selectEmpresa) {
                selectEmpresa.addEventListener('change', function() {
                    if (this.value) {
                        carregarDetalhesEmpresa(this.value);
                    } else {
                        document.getElementById('detalhes-empresa').innerHTML = 
                            '<p class="text-gray-500 text-center py-8">Selecione uma empresa para ver os detalhes</p>';
                    }
                });
            }
        }
        
        // Função para carregar detalhes de empresa específica
        async function carregarDetalhesEmpresa(empresaId) {
            try {
                const response = await fetch(`/api/v133/analytics/empresas/${empresaId}/metricas`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Erro ao carregar detalhes da empresa');
                }
                
                renderizarDetalhesEmpresa(data.data);
            } catch (error) {
                console.error('Erro ao carregar detalhes da empresa:', error);
                document.getElementById('detalhes-empresa').innerHTML = 
                    `<p class="text-red-500 text-center py-8">Erro: ${error.message}</p>`;
            }
        }
        
        // Função para renderizar detalhes da empresa
        function renderizarDetalhesEmpresa(dados) {
            const container = document.getElementById('detalhes-empresa');
            
            container.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="text-sm font-medium text-gray-600">Total Solicitadas</p>
                            <p class="text-xl font-bold text-blue-600">${dados.total_solicitadas || 0}</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-sm font-medium text-gray-600">Total Aceitas</p>
                            <p class="text-xl font-bold text-green-600">${dados.total_aceitas || 0}</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg">
                            <p class="text-sm font-medium text-gray-600">Total Negadas</p>
                            <p class="text-xl font-bold text-red-600">${dados.total_negadas || 0}</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <p class="text-sm font-medium text-gray-600">Taxa de Aceitação</p>
                            <p class="text-xl font-bold text-purple-600">${dados.taxa_aceitacao || 0}%</p>
                        </div>
                    </div>
                    
                    ${dados.ultimas_cotacoes?.length ? `
                        <div class="mt-6">
                            <h4 class="font-medium text-gray-800 mb-3">Últimas Cotações</h4>
                            <div class="space-y-2">
                                ${dados.ultimas_cotacoes.map(cotacao => `
                                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                        <span class="text-sm">${cotacao.numero_cotacao}</span>
                                        <span class="status-badge status-${cotacao.status}">${getStatusDisplay(cotacao.status)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // Função para carregar analytics de usuários
        async function carregarAnalyticsUsuarios() {
            const response = await fetch('/api/v133/analytics/usuarios/ranking');
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message || 'Erro ao carregar dados de usuários');
            }
            
            dadosAnalytics.usuarios = data.data;
            renderizarAnalyticsUsuarios(data.data);
        }
        
        // Função para renderizar analytics de usuários
        function renderizarAnalyticsUsuarios(dados) {
            const container = document.getElementById('conteudo-analytics');
            
            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Ranking de Consultores -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Ranking de Consultores</h3>
                        <div class="space-y-3">
                            ${dados.consultores?.map((consultor, index) => `
                                <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                                    <div class="flex items-center">
                                        <span class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">
                                            ${index + 1}
                                        </span>
                                        <div>
                                            <p class="font-medium text-gray-900">${consultor.nome}</p>
                                            <p class="text-sm text-gray-500">Consultor</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-lg font-bold text-blue-600">${consultor.total_cotacoes}</p>
                                        <p class="text-sm text-gray-500">cotações</p>
                                    </div>
                                </div>
                            `).join('') || '<p class="text-gray-500 text-center py-8">Nenhum dado disponível</p>'}
                        </div>
                    </div>
                    
                    <!-- Ranking de Operadores -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Ranking de Operadores</h3>
                        <div class="space-y-3">
                            ${dados.operadores?.map((operador, index) => `
                                <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                    <div class="flex items-center">
                                        <span class="w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">
                                            ${index + 1}
                                        </span>
                                        <div>
                                            <p class="font-medium text-gray-900">${operador.nome}</p>
                                            <p class="text-sm text-gray-500">Operador</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-lg font-bold text-green-600">${operador.total_operacoes}</p>
                                        <p class="text-sm text-gray-500">operações</p>
                                    </div>
                                </div>
                            `).join('') || '<p class="text-gray-500 text-center py-8">Nenhum dado disponível</p>'}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Função para carregar dados em tempo real
        async function carregarTempoReal() {
            const response = await fetch('/api/v133/analytics/sistema/tempo-real');
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message || 'Erro ao carregar dados em tempo real');
            }
            
            dadosAnalytics.tempoReal = data.data;
            renderizarTempoReal(data.data);
        }
        
        // Função para renderizar dados em tempo real
        function renderizarTempoReal(dados) {
            const container = document.getElementById('conteudo-analytics');
            
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-blue-50 p-6 rounded-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                <i class="fas fa-clock text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Hoje</p>
                                <p class="text-2xl font-bold text-gray-900">${dados.hoje?.total || 0}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 p-6 rounded-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 text-green-600">
                                <i class="fas fa-calendar-week text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Esta Semana</p>
                                <p class="text-2xl font-bold text-gray-900">${dados.semana?.total || 0}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 p-6 rounded-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                                <i class="fas fa-calendar-alt text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Este Mês</p>
                                <p class="text-2xl font-bold text-gray-900">${dados.mes?.total || 0}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 p-6 rounded-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                                <i class="fas fa-chart-line text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Tendência</p>
                                <p class="text-2xl font-bold text-gray-900">${dados.tendencia || '+0%'}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Atividade Recente -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Atividade Recente</h3>
                    <div class="space-y-3">
                        ${dados.atividade_recente?.map(atividade => `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-2 h-2 bg-orange-600 rounded-full mr-3"></div>
                                    <div>
                                        <p class="font-medium text-gray-900">${atividade.descricao}</p>
                                        <p class="text-sm text-gray-500">${formatarData(atividade.timestamp)}</p>
                                    </div>
                                </div>
                                <span class="status-badge status-${atividade.status}">${getStatusDisplay(atividade.status)}</span>
                            </div>
                        `).join('') || '<p class="text-gray-500 text-center py-8">Nenhuma atividade recente</p>'}
                    </div>
                </div>
            `;
            
            // Auto-atualizar a cada 30 segundos
            setTimeout(() => {
                if (analyticsAtivo === 'tempo-real') {
                    carregarTempoReal();
                }
            }, 30000);
        }
        
        // Função para atualizar analytics
        function atualizarAnalytics() {
            carregarConteudoAnalytics();
        }
        
        // Função para exportar relatório
        async function exportarRelatorio() {
            try {
                const response = await fetch('/api/v133/analytics/sistema/geral');
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Erro ao gerar relatório');
                }
                
                // Criar CSV
                const csvContent = gerarCSVRelatorio(data.relatorio_geral);
                
                // Download do arquivo
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `relatorio_analytics_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                mostrarMensagem('Relatório exportado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao exportar relatório:', error);
                mostrarMensagem('Erro ao exportar relatório: ' + error.message, 'error');
            }
        }
        
        // Função para gerar CSV do relatório
        function gerarCSVRelatorio(dados) {
            let csv = 'Métrica,Valor\n';
            
            // Calcular total de cotações
            const totalCotacoes = Object.values(dados.cotacoes_por_status || {}).reduce((sum, count) => sum + count, 0);
            
            csv += `Total de Cotações,${totalCotacoes || 0}\n`;
            csv += `Cotações Finalizadas,${dados.total_cotacoes_finalizadas || 0}\n`;
            csv += `Empresas Ativas,${dados.empresas_prestadoras_ativas || 0}\n`;
            csv += `Consultores Ativos,${dados.usuarios_ativos?.consultores || 0}\n`;
            csv += `Operadores Ativos,${dados.usuarios_ativos?.operadores || 0}\n`;
            csv += '\nPor Modalidade\n';
            
            if (dados.cotacoes_por_modalidade) {
                Object.entries(dados.cotacoes_por_modalidade).forEach(([modalidade, count]) => {
                    csv += `${modalidade},${count}\n`;
                });
            }
            
            return csv;
        }
        
        // Função para mostrar seção analytics
        function showAnalytics() {
            // Ocultar todas as seções
            document.querySelectorAll('section, #secao-cotacoes, #secao-analytics-v133').forEach(section => {
                section.style.display = 'none';
                section.classList.add('hidden');
            });
            
            // Mostrar seção de analytics
            const secaoAnalytics = document.getElementById('secao-analytics-v133');
            if (secaoAnalytics) {
                secaoAnalytics.style.display = 'block';
                secaoAnalytics.classList.remove('hidden');
                
                // Carregar conteúdo inicial
                carregarConteudoAnalytics();
            }
        }
        
        // Atualizar função showSection para incluir analytics
        const originalShowSection = window.showSection;
        window.showSection = function(section) {
            if (section === 'analytics') {
                showAnalytics();
                // Controlar visibilidade do rodapé
                const footers = document.querySelectorAll('footer');
                footers.forEach(footer => {
                    footer.style.display = 'none';
                });
                return;
            }
            
            if (originalShowSection) {
                originalShowSection(section);
            }
        };
        
        // ==================== FORMATAÇÃO AUTOMÁTICA DE NÚMEROS ====================
        
        // Função para formatar números com ponto e vírgula (padrão brasileiro)
        function formatarNumero(valor) {
            // Remove tudo que não é número, ponto ou vírgula
            valor = valor.replace(/[^\d.,]/g, '');
            
            // Se está vazio, retorna vazio
            if (!valor) return '';
            
            // Se tem vírgula, trata como decimal brasileiro
            if (valor.includes(',')) {
                let partes = valor.split(',');
                let inteira = partes[0].replace(/\./g, ''); // Remove pontos da parte inteira
                let decimal = partes[1] ? partes[1].substring(0, 2) : ''; // Máximo 2 casas decimais
                
                // Adiciona pontos como separadores de milhares
                inteira = inteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                
                return decimal ? inteira + ',' + decimal : inteira;
            }
            
            // Se tem apenas ponto, verifica se é decimal ou separador de milhares
            if (valor.includes('.')) {
                let partes = valor.split('.');
                if (partes[partes.length - 1].length <= 2 && partes.length === 2) {
                    // Último ponto com 1-2 dígitos = decimal
                    let inteira = partes[0];
                    let decimal = partes[1];
                    inteira = inteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    return inteira + ',' + decimal;
                } else {
                    // Pontos como separadores de milhares
                    valor = valor.replace(/\./g, '');
                    return valor.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                }
            }
            
            // Apenas números inteiros
            return valor.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }
        
        // Função específica para formatar valores monetários (similar ao cadastro de empresas)
        function formatarValorMonetario(input) {
            let valor = input.value;
            
            // Remove tudo que não é número
            valor = valor.replace(/\D/g, '');
            
            // Se não há valor, limpa o campo
            if (!valor) {
                input.value = '';
                return;
            }
            
            // Converte para número e formata como moeda brasileira
            const numero = parseInt(valor);
            const formatado = new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2
            }).format(numero / 100);
            
            input.value = formatado;
        }
        
        // Função melhorada para formatação monetária em tempo real
        function formatarMoedaBrasileira(input) {
            let valor = input.value;
            
            // Remove tudo que não é dígito
            valor = valor.replace(/\D/g, '');
            
            if (!valor) {
                input.value = '';
                input.dataset.valorNumerico = '';
                return;
            }
            
            // Converte para centavos
            const numero = parseInt(valor);
            const valorDecimal = numero / 100;
            
            // Formata como moeda brasileira
            const formatado = new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2
            }).format(valorDecimal);
            
            input.value = formatado;
            // Armazenar valor numérico para envio
            input.dataset.valorNumerico = valorDecimal.toString();
        }
        
        // Função para formatação monetária no padrão brasileiro (4.000,00) sem símbolo de moeda
        function formatarValorMonetario(input) {
            let valor = input.value;
            
            // Remove tudo que não é dígito
            valor = valor.replace(/\D/g, '');
            
            if (!valor) {
                input.value = '';
                input.dataset.valorNumerico = '';
                return;
            }
            
            // Converte para centavos
            const numero = parseInt(valor);
            const valorDecimal = numero / 100;
            
            // Formata no padrão brasileiro (4.000,00)
            const formatado = new Intl.NumberFormat('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(valorDecimal);
            
            input.value = formatado;
            // Armazenar valor numérico para envio
            input.dataset.valorNumerico = valorDecimal.toString();
        }
        
        // Função para formatar números normais (peso, dimensões, etc.)
        function formatarNumeroNormal(valor) {
            // Remove tudo que não é número, ponto ou vírgula
            valor = valor.replace(/[^\d.,]/g, '');
            
            // Se está vazio, retorna vazio
            if (!valor) return '';
            
            // Se tem vírgula, trata como decimal brasileiro
            if (valor.includes(',')) {
                let partes = valor.split(',');
                let inteira = partes[0].replace(/\./g, ''); // Remove pontos da parte inteira
                let decimal = partes[1] ? partes[1].substring(0, 3) : ''; // Máximo 3 casas decimais para peso
                
                // Adiciona pontos como separadores de milhares
                inteira = inteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                
                return decimal ? inteira + ',' + decimal : inteira;
            }
            
            // Se tem apenas ponto, verifica se é decimal ou separador de milhares
            if (valor.includes('.')) {
                let partes = valor.split('.');
                if (partes[partes.length - 1].length <= 3 && partes.length === 2) {
                    // Último ponto com 1-3 dígitos = decimal
                    let inteira = partes[0];
                    let decimal = partes[1];
                    inteira = inteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    return inteira + ',' + decimal;
                } else {
                    // Pontos como separadores de milhares
                    valor = valor.replace(/\./g, '');
                    return valor.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                }
            }
            
            // Apenas números inteiros - adiciona separadores de milhares
            return valor.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }
        
        // Função específica para formatação de peso (kg)
        function formatarPeso(input) {
            let valor = input.value;
            
            // Remove tudo que não é número, ponto ou vírgula
            valor = valor.replace(/[^\d.,]/g, '');
            
            if (!valor) {
                input.value = '';
                return;
            }
            
            // Aplicar formatação brasileira para peso
            const valorFormatado = formatarNumeroNormal(valor);
            input.value = valorFormatado;
        }
        
        // Função para converter formato brasileiro para formato numérico
        function converterParaNumero(valor) {
            if (!valor) return '';
            
            // Remove símbolos de moeda (R$, US$, etc.)
            valor = valor.replace(/^(R\$|US\$|\$)\s*/, '');
            
            // Remove pontos (separadores de milhares) e substitui vírgula por ponto
            return valor.replace(/\./g, '').replace(',', '.');
        }
        
        // Aplicar formatação aos campos numéricos (exceto CNPJ)
        document.addEventListener('DOMContentLoaded', function() {
            // Selecionar campos monetários (valor da mercadoria)
            const camposMonetarios = document.querySelectorAll('input[name*="valor_mercadoria"], input[name*="valor"], input[name*="preco"]');
            
            // Selecionar outros campos numéricos (peso, dimensões, etc.)
            const camposNumericos = document.querySelectorAll('input[type="number"]:not([name*="cnpj"]):not([name*="cep"]):not([name*="telefone"]):not([name*="valor_mercadoria"]):not([name*="valor"]):not([name*="preco"])');
            
            // Aplicar formatação monetária
            camposMonetarios.forEach(campo => {
                // Usar a nova função de formatação no padrão brasileiro (4.000,00)
                campo.addEventListener('input', function(e) {
                    formatarValorMonetario(e.target);
                });
                
                // Converter para formato numérico antes do envio
                campo.addEventListener('blur', function(e) {
                    let valorFormatado = e.target.value;
                    e.target.dataset.valorOriginal = valorFormatado;
                });
            });
            
            // Aplicar formatação numérica normal
            camposNumericos.forEach(campo => {
                // Verificar se é campo de peso para usar formatação específica
                if (campo.name && (campo.name.includes('peso') || campo.name.includes('weight'))) {
                    campo.addEventListener('input', function(e) {
                        formatarPeso(e.target);
                    });
                } else {
                    // Formatação durante a digitação para outros campos
                    campo.addEventListener('input', function(e) {
                        let valor = e.target.value;
                        let posicaoCursor = e.target.selectionStart;
                        
                        // Aplicar formatação
                        let valorFormatado = formatarNumeroNormal(valor);
                        
                        // Atualizar valor
                        e.target.value = valorFormatado;
                        
                        // Ajustar posição do cursor
                        let diferenca = valorFormatado.length - valor.length;
                        let novaPosicao = posicaoCursor + diferenca;
                        if (novaPosicao >= 0) {
                            e.target.setSelectionRange(novaPosicao, novaPosicao);
                        }
                    });
                }
                
                // Converter para formato numérico antes do envio
                campo.addEventListener('blur', function(e) {
                    let valorFormatado = e.target.value;
                    e.target.dataset.valorOriginal = valorFormatado;
                });
            });
            
            // Interceptar envio de formulários para converter valores
            document.addEventListener('submit', function(e) {
                const camposNumericos = e.target.querySelectorAll('input[type="number"]:not([name*="cnpj"]):not([name*="cep"]):not([name*="telefone"])');
                
                camposNumericos.forEach(campo => {
                    if (campo.value) {
                        campo.value = converterParaNumero(campo.value);
                    }
                });
            });
        });
    </script>
</body>
</html>
