<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRCcSis</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <!-- Bibliotecas para exportação -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #228B22 0%, #DC143C 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* Estilos específicos para botões de cotação */
        #btn-solicitar-cotacao,
        #btn-nova-cotacao,
        #salvar-cotacao,
        button[onclick*="cotacao"],
        .bg-orange-600 {
            background-color: #ea580c !important;
            color: white !important;
            border: none !important;
        }
        
        #btn-solicitar-cotacao:hover,
        #btn-nova-cotacao:hover,
        #salvar-cotacao:hover,
        button[onclick*="cotacao"]:hover,
        .bg-orange-600:hover {
            background-color: #c2410c !important;
        }
        
        /* Garantir que links com aparência de botão também funcionem */
        a.bg-orange-600 {
            background-color: #ea580c !important;
            color: white !important;
            text-decoration: none !important;
        }
        
        a.bg-orange-600:hover {
            background-color: #c2410c !important;
            color: white !important;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <img src="logo-brchina.png" alt="BRChina" class="h-10 mr-3">
                    <div>
                        <h1 class="text-2xl font-bold">BRCcSis</h1>
                        <p class="text-sm text-green-200">v1.3.2</p>
                    </div>
                </div>
                <nav class="hidden md:flex space-x-6">
                    <a href="#" class="hover:text-green-200 transition-colors" id="nav-dashboard">Dashboard</a>
                    <a href="#" class="hover:text-green-200 transition-colors" id="nav-empresas">Empresas</a>
                    <a href="#" class="hover:text-green-200 transition-colors" id="nav-cotacoes">Cotações</a>
                    <a href="#" class="hover:text-green-200 transition-colors" id="nav-cadastro">Cadastrar</a>
                    <button id="btn-logout" class="hover:text-green-200 transition-colors">
                        <i class="fas fa-sign-out-alt mr-1"></i>Sair
                    </button>
                </nav>
                <button class="md:hidden text-white">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Dashboard Section -->
    <section id="dashboard" class="container mx-auto px-6 py-8">
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Dashboard</h2>
            <p class="text-gray-600">Visão geral do sistema BRCcSis</p>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        <i class="fas fa-building text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total de Empresas</p>
                        <p class="text-2xl font-bold text-gray-900" id="total-empresas">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-red-100 text-red-600">
                        <i class="fas fa-certificate text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Certificadas</p>
                        <p class="text-2xl font-bold text-gray-900" id="empresas-certificadas">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        <i class="fas fa-warehouse text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Com Armazém</p>
                        <p class="text-2xl font-bold text-gray-900" id="empresas-armazem">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-red-100 text-red-600">
                        <i class="fas fa-globe text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Abrangência Nacional</p>
                        <p class="text-2xl font-bold text-gray-900" id="empresas-nacional">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Ações Rápidas</h3>
            <div class="grid grid-cols-1 md:grid-cols-8 gap-4">
                <button id="btn-cadastrar-nova" class="flex items-center justify-center p-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>
                    Cadastrar Nova Empresa
                </button>
                <button id="btn-buscar-empresas" class="flex items-center justify-center p-4 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                    <i class="fas fa-search mr-2"></i>
                    Buscar Empresas
                </button>
                <button id="btn-solicitar-cotacao" class="flex items-center justify-center p-4 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors">
                    <i class="fas fa-calculator mr-2"></i>
                    Solicitar Cotação
                </button>
                <button id="btn-exportar-dados" class="flex items-center justify-center p-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-download mr-2"></i>
                    Exportar Dados
                </button>
                <button id="btn-importar-dados" class="flex items-center justify-center p-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-upload mr-2"></i>
                    Importar Dados
                </button>
                <button id="btn-importar-excel" class="flex items-center justify-center p-4 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                    <i class="fas fa-file-excel mr-2"></i>
                    Importar Excel
                </button>
                <button id="btn-template-excel" class="flex items-center justify-center p-4 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                    <i class="fas fa-download mr-2"></i>
                    Baixar Template Excel
                </button>
                <button id="btn-administracao" class="flex items-center justify-center p-4 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors">
                    <i class="fas fa-users-cog mr-2"></i>
                    Administração
                </button>
            </div>
        </div>

        <!-- Analytics Dashboard -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Gráfico de Empresas por Região -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Empresas por Região</h3>
                    <i class="fas fa-map-marked-alt text-gray-400"></i>
                </div>
                <canvas id="chart-empresas-regiao" width="400" height="300" style="width: 100%; height: 300px;"></canvas>
            </div>

            <!-- Gráfico de Tipos de Carga -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Tipos de Carga</h3>
                    <i class="fas fa-boxes text-gray-400"></i>
                </div>
                <canvas id="chart-tipos-carga" width="400" height="300" style="width: 100%; height: 300px;"></canvas>
            </div>
        </div>

        <!-- Gráficos de Linha -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Crescimento de Empresas -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Crescimento Mensal</h3>
                    <i class="fas fa-chart-line text-gray-400"></i>
                </div>
                <canvas id="chart-crescimento" width="400" height="300" style="width: 100%; height: 300px;"></canvas>
            </div>

            <!-- Certificações -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Certificações</h3>
                    <i class="fas fa-award text-gray-400"></i>
                </div>
                <canvas id="chart-certificacoes" width="400" height="300" style="width: 100%; height: 300px;"></canvas>
            </div>
        </div>

        <!-- Tabela de Métricas Avançadas -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">Métricas Detalhadas</h3>
                <div class="flex space-x-2">
                    <button id="btn-export-pdf" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                        <i class="fas fa-file-pdf mr-2"></i>PDF
                    </button>
                    <button id="btn-export-excel" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-file-excel mr-2"></i>Excel
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full table-auto">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Métrica</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>
                        </tr>
                    </thead>
                    <tbody id="metricas-tabela" class="bg-white divide-y divide-gray-200">
                        <!-- Dados serão carregados via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Empresas Section -->
    <section id="empresas" class="container mx-auto px-6 py-8" style="display: none;">
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Empresas Cadastradas</h2>
            <p class="text-gray-600">Busque e filtre empresas de transporte e logística</p>
        </div>

        <!-- Filtros -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Filtros de Busca</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Razão Social</label>
                    <input type="text" id="filtro-razao-social" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite a razão social">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">CNPJ</label>
                    <input type="text" id="filtro-cnpj" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite o CNPJ">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Etiqueta</label>
                    <select id="filtro-etiqueta" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todas as etiquetas</option>
                        <option value="CADASTRADA">CADASTRADA</option>
                        <option value="PARCEIRA">PARCEIRA</option>
                        <option value="ENCERRADO">ENCERRADO</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Carga</label>
                    <select id="filtro-tipo-carga" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todos os tipos</option>
                        <option value="Carga Fracionada">Carga Fracionada</option>
                        <option value="Carga Geral">Carga Geral</option>
                        <option value="Carga Lotação">Carga Lotação</option>
                        <option value="Carga Perigosa">Carga Perigosa</option>
                        <option value="Carga Refrigerada">Carga Refrigerada</option>
                        <option value="Granel Líquido">Granel Líquido</option>
                        <option value="Granel Sólido">Granel Sólido</option>
                        <option value="Produtos Químicos">Produtos Químicos</option>
                        <option value="Transporte de Container">Transporte de Container</option>
                        <option value="Materiais de Construção">Materiais de Construção</option>
                        <option value="Veículos">Veículos</option>
                        <option value="Máquinas e Equipamentos">Máquinas e Equipamentos</option>
                        <option value="Produtos Eletrônicos">Produtos Eletrônicos</option>
                        <option value="Produtos Têxteis">Produtos Têxteis</option>
                        <option value="Produtos Siderúrgicos">Produtos Siderúrgicos</option>
                        <option value="Produtos Agrícolas">Produtos Agrícolas</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Certificação</label>
                    <select id="filtro-certificacao" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todas as certificações</option>
                        <option value="ISO 9001">ISO 9001</option>
                        <option value="SASSMAQ">SASSMAQ</option>
                        <option value="OEA">OEA</option>
                        <option value="ISO 14001">ISO 14001</option>
                        <option value="ISO 45001">ISO 45001</option>
                        <option value="PBQP-H">PBQP-H</option>
                        <option value="HACCP">HACCP</option>
                        <option value="BRC">BRC</option>
                        <option value="IFS">IFS</option>
                        <option value="SQF">SQF</option>
                        <option value="FSSC 22000">FSSC 22000</option>
                        <option value="ISO 22000">ISO 22000</option>
                        <option value="GDP">GDP</option>
                        <option value="IATA">IATA</option>
                        <option value="IMDG">IMDG</option>
                        <option value="ADR">ADR</option>
                        <option value="C-TPAT">C-TPAT</option>
                        <option value="BASC">BASC</option>
                        <option value="CTPAT">CTPAT</option>
                        <option value="AEO">AEO</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Portos Atendidos</label>
                    <select id="filtro-portos-atendidos" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todos os portos</option>
                        <option value="Ponta da Madeira (Maranhão)">Ponta da Madeira (Maranhão)</option>
                        <option value="Porto da Alumar (Maranhão)">Porto da Alumar (Maranhão)</option>
                        <option value="Porto de Angra dos Reis (Rio de Janeiro)">Porto de Angra dos Reis (Rio de Janeiro)</option>
                        <option value="Porto de Antonina (Paraná)">Porto de Antonina (Paraná)</option>
                        <option value="Porto de Aratu (Bahia)">Porto de Aratu (Bahia)</option>
                        <option value="Porto de Areia Branca (Rio Grande do Norte)">Porto de Areia Branca (Rio Grande do Norte)</option>
                        <option value="Porto de Barra do Riacho (Espírito Santo)">Porto de Barra do Riacho (Espírito Santo)</option>
                        <option value="Porto de Barra dos Coqueiros (Sergipe)">Porto de Barra dos Coqueiros (Sergipe)</option>
                        <option value="Porto de Belém (Pará)">Porto de Belém (Pará)</option>
                        <option value="Porto de Cabedelo (Paraíba)">Porto de Cabedelo (Paraíba)</option>
                        <option value="Porto de Ilhéus (Bahia)">Porto de Ilhéus (Bahia)</option>
                        <option value="Porto de Imbituba (Santa Catarina)">Porto de Imbituba (Santa Catarina)</option>
                        <option value="Porto de Itaguaí (Rio de Janeiro)">Porto de Itaguaí (Rio de Janeiro)</option>
                        <option value="Porto de Itajaí (Santa Catarina)">Porto de Itajaí (Santa Catarina)</option>
                        <option value="Porto de Itapoá (Santa Catarina)">Porto de Itapoá (Santa Catarina)</option>
                        <option value="Porto de Jaraguá (Alagoas)">Porto de Jaraguá (Alagoas)</option>
                        <option value="Porto de Natal (Rio Grande do Norte)">Porto de Natal (Rio Grande do Norte)</option>
                        <option value="Porto de Navegantes (Santa Catarina)">Porto de Navegantes (Santa Catarina)</option>
                        <option value="Porto de Niterói (Rio de Janeiro)">Porto de Niterói (Rio de Janeiro)</option>
                        <option value="Porto de Paranaguá (Paraná)">Porto de Paranaguá (Paraná)</option>
                        <option value="Porto do Pecém (Ceará)">Porto do Pecém (Ceará)</option>
                        <option value="Porto de Rio Grande (Rio Grande do Sul)">Porto de Rio Grande (Rio Grande do Sul)</option>
                        <option value="Porto de Salvador (Bahia)">Porto de Salvador (Bahia)</option>
                        <option value="Porto de Macapá (Amapá)">Porto de Macapá (Amapá)</option>
                        <option value="Porto de Santos (São Paulo)">Porto de Santos (São Paulo)</option>
                        <option value="Porto de São Francisco do Sul (Santa Catarina)">Porto de São Francisco do Sul (Santa Catarina)</option>
                        <option value="Porto de São Sebastião (São Paulo)">Porto de São Sebastião (São Paulo)</option>
                        <option value="Porto de Suape (Pernambuco)">Porto de Suape (Pernambuco)</option>
                        <option value="Porto de Tubarão (Espírito Santo)">Porto de Tubarão (Espírito Santo)</option>
                        <option value="Porto de Vila do Conde (Pará)">Porto de Vila do Conde (Pará)</option>
                        <option value="Porto de Vitória (Espírito Santo)">Porto de Vitória (Espírito Santo)</option>
                        <option value="Porto do Açu (Rio de Janeiro)">Porto do Açu (Rio de Janeiro)</option>
                        <option value="Porto do Forno (Rio de Janeiro)">Porto do Forno (Rio de Janeiro)</option>
                        <option value="Porto do Itaqui (Maranhão)">Porto do Itaqui (Maranhão)</option>
                        <option value="Porto do Mucuripe (Ceará)">Porto do Mucuripe (Ceará)</option>
                        <option value="Porto do Recife (Pernambuco)">Porto do Recife (Pernambuco)</option>
                        <option value="Porto do Rio de Janeiro (Rio de Janeiro)">Porto do Rio de Janeiro (Rio de Janeiro)</option>
                        <option value="Porto Pesqueiro de Laguna (Santa Catarina)">Porto Pesqueiro de Laguna (Santa Catarina)</option>
                        <option value="Porto Piauí (Piauí)">Porto Piauí (Piauí)</option>
                        <option value="Porto Sudeste (Rio de Janeiro)">Porto Sudeste (Rio de Janeiro)</option>
                        <option value="Terminal de Miramar (Pará)">Terminal de Miramar (Pará)</option>
                        <option value="Terminal de Praia Mole (Espírito Santo)">Terminal de Praia Mole (Espírito Santo)</option>
                        <option value="Porto de Cáceres (Mato Grosso)">Porto de Cáceres (Mato Grosso)</option>
                        <option value="Porto de Cachoeira do Sul (Rio Grande do Sul)">Porto de Cachoeira do Sul (Rio Grande do Sul)</option>
                        <option value="Porto de Caracaraí (Roraima)">Porto de Caracaraí (Roraima)</option>
                        <option value="Porto de Charqueadas (Rio Grande do Sul)">Porto de Charqueadas (Rio Grande do Sul)</option>
                        <option value="Porto de Corumbá (Mato Grosso do Sul)">Porto de Corumbá (Mato Grosso do Sul)</option>
                        <option value="Porto de Eirunepé (Amazonas)">Porto de Eirunepé (Amazonas)</option>
                        <option value="Porto de Estrela (Rio Grande do Sul)">Porto de Estrela (Rio Grande do Sul)</option>
                        <option value="Terminal de Itacoatiara (Amazonas)">Terminal de Itacoatiara (Amazonas)</option>
                        <option value="Porto de Juazeiro (Bahia)">Porto de Juazeiro (Bahia)</option>
                        <option value="Porto de Ladário (Mato Grosso do Sul)">Porto de Ladário (Mato Grosso do Sul)</option>
                        <option value="Porto de Manaus (Amazonas)">Porto de Manaus (Amazonas)</option>
                        <option value="Porto de Pelotas (Rio Grande do Sul)">Porto de Pelotas (Rio Grande do Sul)</option>
                        <option value="Porto de Parintins (Amazonas)">Porto de Parintins (Amazonas)</option>
                        <option value="Porto de Petrolina (Pernambuco)">Porto de Petrolina (Pernambuco)</option>
                        <option value="Porto de Pirapora (Minas Gerais)">Porto de Pirapora (Minas Gerais)</option>
                        <option value="Porto de Porto Alegre (Rio Grande do Sul)">Porto de Porto Alegre (Rio Grande do Sul)</option>
                        <option value="Porto de Porto Murtinho (Mato Grosso do Sul)">Porto de Porto Murtinho (Mato Grosso do Sul)</option>
                        <option value="Porto de Porto Velho (Rondônia)">Porto de Porto Velho (Rondônia)</option>
                        <option value="Porto Internacional de Porto Xavier (Rio Grande do Sul)">Porto Internacional de Porto Xavier (Rio Grande do Sul)</option>
                        <option value="Porto de Santana (Amapá)">Porto de Santana (Amapá)</option>
                        <option value="Porto de Santarém (Pará)">Porto de Santarém (Pará)</option>
                        <option value="Porto de Tabatinga (Amazonas)">Porto de Tabatinga (Amazonas)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Regulamentação</label>
                    <select id="filtro-tipo-regulamentacao" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todas as regulamentações</option>
                        <option value="RNTRC">RNTRC</option>
                        <option value="ANTT">ANTT</option>
                        <option value="AET">AET</option>
                        <option value="AATPP">AATPP</option>
                        <option value="CIPP">CIPP</option>
                        <option value="ANVISA">ANVISA</option>
                        <option value="IBAMA">IBAMA</option>
                        <option value="INMETRO">INMETRO</option>
                        <option value="MAPA">MAPA</option>
                        <option value="ANP">ANP</option>
                        <option value="ANTAQ">ANTAQ</option>
                        <option value="ANAC">ANAC</option>
                        <option value="Receita Federal">Receita Federal</option>
                        <option value="Polícia Federal">Polícia Federal</option>
                        <option value="Exército Brasileiro">Exército Brasileiro</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Frota</label>
                    <select id="filtro-tipo-frota" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todos os tipos</option>
                        <option value="Própria">Própria</option>
                        <option value="Terceirizada">Terceirizada</option>
                        <option value="Mista">Mista</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Veículo</label>
                    <select id="filtro-tipo-veiculo" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todos os veículos</option>
                        <option value="Caminhão Toco">Caminhão Toco</option>
                        <option value="Caminhão Truck">Caminhão Truck</option>
                        <option value="Carreta">Carreta</option>
                        <option value="Bitrem">Bitrem</option>
                        <option value="Rodotrem">Rodotrem</option>
                        <option value="Van">Van</option>
                        <option value="Utilitário">Utilitário</option>
                        <option value="Caminhão Baú">Caminhão Baú</option>
                        <option value="Caminhão Frigorífico">Caminhão Frigorífico</option>
                        <option value="Caminhão Tanque">Caminhão Tanque</option>
                        <option value="Caminhão Cegonha">Caminhão Cegonha</option>
                        <option value="Caminhão Munck">Caminhão Munck</option>
                        <option value="Caminhão Prancha">Caminhão Prancha</option>
                        <option value="Caminhão Graneleiro">Caminhão Graneleiro</option>
                        <option value="Caminhão Silo">Caminhão Silo</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Possui Seguro?</label>
                    <select id="filtro-possui-seguro" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todos</option>
                        <option value="true">Sim</option>
                        <option value="false">Não</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tecnologia</label>
                    <select id="filtro-nome-tecnologia" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todas as tecnologias</option>
                        <option value="TMS">TMS</option>
                        <option value="WMS">WMS</option>
                        <option value="GPS">GPS</option>
                        <option value="RFID">RFID</option>
                        <option value="IoT">IoT</option>
                        <option value="EDI">EDI</option>
                        <option value="API">API</option>
                        <option value="ERP">ERP</option>
                        <option value="CRM">CRM</option>
                        <option value="BI">BI</option>
                        <option value="Blockchain">Blockchain</option>
                        <option value="Inteligência Artificial">Inteligência Artificial</option>
                        <option value="Machine Learning">Machine Learning</option>
                        <option value="Big Data">Big Data</option>
                        <option value="Cloud Computing">Cloud Computing</option>
                        <option value="Mobile">Mobile</option>
                        <option value="Telemática">Telemática</option>
                        <option value="Rastreamento Satelital">Rastreamento Satelital</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Segmento Cliente</label>
                    <select id="filtro-segmento-cliente" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todos os segmentos</option>
                        <option value="Indústria Automotiva">Indústria Automotiva</option>
                        <option value="Indústria Alimentícia">Indústria Alimentícia</option>
                        <option value="Indústria Farmacêutica">Indústria Farmacêutica</option>
                        <option value="Indústria Química">Indústria Química</option>
                        <option value="Indústria Têxtil">Indústria Têxtil</option>
                        <option value="Indústria Siderúrgica">Indústria Siderúrgica</option>
                        <option value="Indústria de Papel e Celulose">Indústria de Papel e Celulose</option>
                        <option value="Indústria de Construção Civil">Indústria de Construção Civil</option>
                        <option value="Agronegócio">Agronegócio</option>
                        <option value="Varejo">Varejo</option>
                        <option value="E-commerce">E-commerce</option>
                        <option value="Atacado">Atacado</option>
                        <option value="Distribuidoras">Distribuidoras</option>
                        <option value="Supermercados">Supermercados</option>
                        <option value="Farmácias">Farmácias</option>
                        <option value="Hospitais">Hospitais</option>
                        <option value="Laboratórios">Laboratórios</option>
                        <option value="Petróleo e Gás">Petróleo e Gás</option>
                        <option value="Mineração">Mineração</option>
                        <option value="Energia">Energia</option>
                        <option value="Telecomunicações">Telecomunicações</option>
                        <option value="Tecnologia">Tecnologia</option>
                        <option value="Governo">Governo</option>
                        <option value="ONGs">ONGs</option>
                        <option value="Cooperativas">Cooperativas</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Certificação Ambiental</label>
                    <select id="filtro-certificacao-ambiental" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todas as certificações</option>
                        <option value="ISO 14001">ISO 14001</option>
                        <option value="LEED">LEED</option>
                        <option value="BREEAM">BREEAM</option>
                        <option value="AQUA">AQUA</option>
                        <option value="PROCEL">PROCEL</option>
                        <option value="INMETRO">INMETRO</option>
                        <option value="Carbon Trust">Carbon Trust</option>
                        <option value="GHG Protocol">GHG Protocol</option>
                        <option value="CDP">CDP</option>
                        <option value="FSC">FSC</option>
                        <option value="PEFC">PEFC</option>
                        <option value="Cradle to Cradle">Cradle to Cradle</option>
                        <option value="EPEAT">EPEAT</option>
                        <option value="Energy Star">Energy Star</option>
                        <option value="Green Seal">Green Seal</option>
                        <option value="EcoVadis">EcoVadis</option>
                        <option value="B Corp">B Corp</option>
                    </select>
                </div>
            </div>
            <div class="mt-4 flex space-x-4">
                <button id="btn-buscar-filtros" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                    <i class="fas fa-search mr-2"></i>Buscar
                </button>
                <button id="btn-limpar-filtros" class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
                    <i class="fas fa-eraser mr-2"></i>Limpar
                </button>
            </div>
        </div>

        <!-- Lista de Empresas -->
        <div class="bg-white rounded-lg shadow-md">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">Resultados da Busca</h3>
                <p class="text-sm text-gray-600" id="resultado-count">Carregando...</p>
            </div>
            <div id="lista-empresas" class="divide-y divide-gray-200">
                <!-- Empresas serão carregadas aqui -->
            </div>
            <div class="p-6 border-t border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                        Mostrando <span id="showing-from">1</span> a <span id="showing-to">10</span> de <span id="total-results">0</span> resultados
                    </div>
                    <div class="flex space-x-2">
                        <button id="btn-prev" class="px-3 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors" disabled>
                            Anterior
                        </button>
                        <button id="btn-next" class="px-3 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors" disabled>
                            Próximo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Cadastro Section -->
    <section id="cadastro" class="container mx-auto px-6 py-8" style="display: none;">
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Cadastrar Nova Empresa</h2>
            <p class="text-gray-600">Preencha os dados da empresa de transporte e logística</p>
        </div>

        <form id="form-cadastro" class="space-y-8">
            <!-- Dados Básicos -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Dados Básicos</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Razão Social *</label>
                        <input type="text" name="razao_social" id="razao_social" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p id="razao_social_error" class="text-red-500 text-xs italic hidden">A Razão Social é obrigatória.</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome Fantasia</label>
                        <input type="text" name="nome_fantasia" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">CNPJ *</label>
                        <input type="text" name="cnpj" id="cnpj" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="00.000.000/0000-00">
                        <p id="cnpj_error" class="text-red-500 text-xs italic hidden">O CNPJ é obrigatório e deve estar no formato 00.000.000/0000-00.</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Inscrição Estadual</label>
                        <input type="text" name="inscricao_estadual" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Endereço Completo</label>
                        <textarea name="endereco_completo" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Telefone Comercial</label>
                        <input type="text" name="telefone_comercial" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="(00) 0000-0000">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Telefone Emergencial</label>
                        <input type="text" name="telefone_emergencial" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="(00) 00000-0000">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">E-mail</label>
                        <input type="email" name="email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Website</label>
                        <input type="url" name="website" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="www.exemplo.com.br">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data de Fundação</label>
                        <input type="date" name="data_fundacao" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Link para Cotação</label>
                        <input type="url" name="link_cotacao" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Link direto para cotação da transportadora">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                        <textarea name="observacoes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Observações gerais sobre a empresa..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Etiqueta</label>
                        <select name="etiqueta" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="CADASTRADA">CADASTRADA</option>
                            <option value="PARCEIRA">PARCEIRA</option>
                            <option value="ENCERRADO">ENCERRADO</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Status da empresa no sistema</p>
                    </div>
                </div>
            </div>

            <!-- Modalidades e Tipos de Carga -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Modalidades e Tipos de Carga</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Modalidades de Transporte</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" name="modalidades_transporte" value="Rodoviário" class="mr-2">
                                Rodoviário
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="modalidades_transporte" value="Multimodal" class="mr-2">
                                Multimodal
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="modalidades_transporte" value="Ferroviário" class="mr-2">
                                Ferroviário
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="modalidades_transporte" value="Aquaviário" class="mr-2">
                                Aquaviário
                            </label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipos de Carga</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Carga Geral" class="mr-2">
                                Carga Geral
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Carga Perigosa" class="mr-2">
                                Carga Perigosa
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Carga Refrigerada" class="mr-2">
                                Carga Refrigerada
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Granel Líquido" class="mr-2">
                                Granel Líquido
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Granel Sólido" class="mr-2">
                                Granel Sólido
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Produtos Químicos" class="mr-2">
                                Produtos Químicos
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Produtos Farmacêuticos" class="mr-2">
                                Produtos Farmacêuticos
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Carga Fracionada" class="mr-2">
                                Carga Fracionada
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Carga Lotação" class="mr-2">
                                Carga Lotação
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Transporte de Container" class="mr-2">
                                Transporte de Container
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Produtos Alimentícios" class="mr-2">
                                Produtos Alimentícios
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Materiais de Construção" class="mr-2">
                                Materiais de Construção
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Veículos" class="mr-2">
                                Veículos
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Máquinas e Equipamentos" class="mr-2">
                                Máquinas e Equipamentos
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Produtos Eletrônicos" class="mr-2">
                                Produtos Eletrônicos
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Produtos Têxteis" class="mr-2">
                                Produtos Têxteis
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Produtos Siderúrgicos" class="mr-2">
                                Produtos Siderúrgicos
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="tipos_carga" value="Produtos Agrícolas" class="mr-2">
                                Produtos Agrícolas
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Regulamentação e Licenças -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Regulamentação e Licenças</h3>
                <div id="regulamentacoes-container" class="space-y-4 mb-4">
                    <!-- Regulamentações serão adicionadas aqui via JS -->
                </div>
                <button type="button" id="btn-add-regulamentacao" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Adicionar Regulamentação
                </button>
            </div>

            <!-- Certificações de Qualidade e Segurança -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Certificações de Qualidade e Segurança</h3>
                <div id="certificacoes-container" class="space-y-4 mb-4">
                    <!-- Certificações serão adicionadas aqui via JS -->
                </div>
                <button type="button" id="btn-add-certificacao" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Adicionar Certificação
                </button>
            </div>

            <!-- Abrangência Geográfica -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Abrangência Geográfica</h3>
                <div id="abrangencia-container" class="space-y-4 mb-4">
                    <!-- Abrangências serão adicionadas aqui via JS -->
                </div>
                <button type="button" id="btn-add-abrangencia" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Adicionar Abrangência
                </button>
            </div>

            <!-- Frota -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Frota</h3>
                <div id="frota-container" class="space-y-4 mb-4">
                    <!-- Frota será adicionada aqui via JS -->
                </div>
                <button type="button" id="btn-add-frota" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Adicionar Frota
                </button>
            </div>

            <!-- Armazenagem -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Armazenagem</h3>
                <div id="armazenagem-container" class="space-y-4 mb-4">
                    <!-- Armazenagem será adicionada aqui via JS -->
                </div>
                <button type="button" id="btn-add-armazenagem" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Adicionar Armazenagem
                </button>
            </div>

            <!-- Portos e Terminais -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Portos e Terminais</h3>
                <div id="portos-terminais-container" class="space-y-4 mb-4">
                    <!-- Portos e Terminais serão adicionados aqui via JS -->
                </div>
                <button type="button" id="btn-add-porto-terminal" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Adicionar Porto/Terminal
                </button>
            </div>

            <!-- Seguros e Coberturas -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Seguros e Coberturas</h3>
                <div id="seguros-coberturas-container" class="space-y-4 mb-4">
                    <!-- Seguros e Coberturas serão adicionados aqui via JS -->
                </div>
                <button type="button" id="btn-add-seguro-cobertura" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Adicionar Seguro/Cobertura
                </button>
            </div>

            <!-- Tecnologia e Integração -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Tecnologia e Integração</h3>
                <div id="tecnologias-container" class="space-y-4 mb-4">
                    <!-- Tecnologias serão adicionadas aqui via JS -->
                </div>
                <button type="button" id="btn-add-tecnologia" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Adicionar Tecnologia
                </button>
            </div>

            <!-- Desempenho e Qualidade de Serviço -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Desempenho e Qualidade de Serviço</h3>
                <div id="desempenho-qualidade-container" class="space-y-4 mb-4">
                    <!-- Desempenho e Qualidade serão adicionados aqui via JS -->
                </div>
                <button type="button" id="btn-add-desempenho-qualidade" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Adicionar Desempenho/Qualidade
                </button>
            </div>

            <!-- Clientes e Segmentos -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Clientes e Segmentos</h3>
                <div id="clientes-segmentos-container" class="space-y-4 mb-4">
                    <!-- Clientes e Segmentos serão adicionados aqui via JS -->
                </div>
                <button type="button" id="btn-add-cliente-segmento" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Adicionar Cliente/Segmento
                </button>
            </div>

            <!-- Recursos Humanos -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Recursos Humanos</h3>
                <div id="recursos-humanos-container" class="space-y-4 mb-4">
                    <!-- Recursos Humanos serão adicionados aqui via JS -->
                </div>
                <button type="button" id="btn-add-recurso-humano" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Adicionar Recurso Humano
                </button>
            </div>

            <!-- Sustentabilidade e Responsabilidade Social -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Sustentabilidade e Responsabilidade Social</h3>
                <div id="sustentabilidade-container" class="space-y-4 mb-4">
                    <!-- Sustentabilidade será adicionada aqui via JS -->
                </div>
                <button type="button" id="btn-add-sustentabilidade" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Adicionar Sustentabilidade
                </button>
            </div>

            <!-- Botões de Ação -->
            <div class="flex justify-end space-x-4">
                <button type="button" id="btn-cancelar-cadastro" class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
                    Cancelar
                </button>
                <button type="submit" id="btn-salvar-empresa" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                    <i class="fas fa-save mr-2"></i>Salvar Empresa
                </button>
            </div>
        </form>
    </section>

    <!-- Cotações Section -->
    <section id="cotacoes" class="container mx-auto px-6 py-8" style="display: none;">
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">
                <i class="fas fa-calculator mr-2 text-orange-600"></i>
                Minhas Cotações
            </h2>
            <p class="text-gray-600">Gerencie suas solicitações de cotação</p>
        </div>

        <!-- Estatísticas -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-blue-50 p-4 rounded-lg">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                        <i class="fas fa-list text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total</p>
                        <p class="text-2xl font-bold text-gray-900" id="total-cotacoes">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-yellow-50 p-4 rounded-lg">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                        <i class="fas fa-clock text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Pendentes</p>
                        <p class="text-2xl font-bold text-gray-900" id="cotacoes-pendentes">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-green-50 p-4 rounded-lg">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        <i class="fas fa-check text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Finalizadas</p>
                        <p class="text-2xl font-bold text-gray-900" id="cotacoes-finalizadas">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-purple-50 p-4 rounded-lg">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                        <i class="fas fa-paper-plane text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Enviadas</p>
                        <p class="text-2xl font-bold text-gray-900" id="cotacoes-enviadas">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ações Rápidas -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">Ações</h3>
            </div>
            <div class="flex space-x-4">
                <button id="btn-nova-cotacao" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Nova Cotação
                </button>
            </div>
        </div>

        <!-- Filtros -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">Filtros</h4>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="filtro-status" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="">Todos</option>
                        <option value="solicitada">Solicitada</option>
                        <option value="em_analise">Em Análise</option>
                        <option value="cotacao_enviada">Cotação Enviada</option>
                        <option value="aprovada_cliente">Aprovada</option>
                        <option value="recusada_cliente">Recusada</option>
                        <option value="finalizada">Finalizada</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
                    <input type="text" id="filtro-cliente" placeholder="Nome do cliente" class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Data Início</label>
                    <input type="date" id="filtro-data-inicio" class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Data Fim</label>
                    <input type="date" id="filtro-data-fim" class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
            </div>
            <div class="mt-4 flex space-x-2">
                <button id="aplicar-filtros" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-filter mr-2"></i>Aplicar Filtros
                </button>
                <button id="limpar-filtros" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                    <i class="fas fa-eraser mr-2"></i>Limpar
                </button>
            </div>
        </div>

        <!-- Lista de Cotações -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">Lista de Cotações</h4>
            <div id="lista-cotacoes" class="space-y-4">
                <!-- Cotações serão carregadas aqui via JavaScript -->
            </div>

            <!-- Paginação -->
            <div id="paginacao-cotacoes" class="flex justify-center mt-6">
                <!-- Paginação será carregada aqui via JavaScript -->
            </div>
        </div>
    </section>

    <!-- Modal de Detalhes da Empresa -->
    <div id="modal-detalhes" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-gray-800">Detalhes da Empresa</h3>
                    <button id="btn-fechar-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div id="conteudo-modal" class="p-6">
                <!-- Conteúdo será carregado aqui -->
            </div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let currentPage = 1;
        let totalPages = 1;
        let currentFilters = {};

        // Função para formatar data corretamente no padrão dia/mês/ano
        function formatarDataBrasil(dataString) {
            if (!dataString) return 'N/A';
            
            // Parse da data considerando que vem no formato YYYY-MM-DD
            const partes = dataString.split('-');
            if (partes.length !== 3) return 'N/A';
            
            const ano = partes[0];
            const mes = partes[1];
            const dia = partes[2];
            
            return `${dia}/${mes}/${ano}`;
        }

        // Função para mostrar seção de cotações
        function mostrarSecaoCotacoes() {
            console.log('Mostrando seção de cotações...');
            showSection('cotacoes');
        }

        // Configurar event listeners para navegação
        function setupNavigationListeners() {
            // Navegação principal
            const navDashboard = document.getElementById('nav-dashboard');
            if (navDashboard) {
                navDashboard.addEventListener('click', function(e) {
                    e.preventDefault();
                    showSection('dashboard');
                });
            }
            
            const navEmpresas = document.getElementById('nav-empresas');
            if (navEmpresas) {
                navEmpresas.addEventListener('click', function(e) {
                    e.preventDefault();
                    showSection('empresas');
                });
            }
            
            const navCotacoes = document.getElementById('nav-cotacoes');
            if (navCotacoes) {
                navCotacoes.addEventListener('click', function(e) {
                    e.preventDefault();
                    showSection('cotacoes');
                });
            }
            
            const navCadastro = document.getElementById('nav-cadastro');
            if (navCadastro) {
                navCadastro.addEventListener('click', function(e) {
                    e.preventDefault();
                    showSection('cadastro');
                });
            }
        }

        // Configurar event listeners para botões
        function setupButtonListeners() {
            // Botões do dashboard
            const btnCadastrarNova = document.getElementById('btn-cadastrar-nova');
            if (btnCadastrarNova) {
                btnCadastrarNova.addEventListener('click', function() {
                    showSection('cadastro');
                });
            }
            
            const btnBuscarEmpresas = document.getElementById('btn-buscar-empresas');
            if (btnBuscarEmpresas) {
                btnBuscarEmpresas.addEventListener('click', function() {
                    showSection('empresas');
                });
            }
            
            const btnExportarDados = document.getElementById('btn-exportar-dados');
            if (btnExportarDados) {
                btnExportarDados.addEventListener('click', function() {
                    exportData();
                });
            }
            
            // Botões de filtros
            const btnBuscarFiltros = document.getElementById('btn-buscar-filtros');
            if (btnBuscarFiltros) {
                btnBuscarFiltros.addEventListener('click', function() {
                    buscarEmpresas();
                });
            }
            
            const btnLimparFiltros = document.getElementById('btn-limpar-filtros');
            if (btnLimparFiltros) {
                btnLimparFiltros.addEventListener('click', function() {
                    limparFiltros();
                });
            }
            
            // Botões de paginação
            document.getElementById('btn-prev').addEventListener('click', function() {
                previousPage();
            });
            
            document.getElementById('btn-next').addEventListener('click', function() {
                nextPage();
            });
            
            // Botões de adicionar campos dinâmicos
            document.getElementById('btn-add-regulamentacao').addEventListener('click', function() {
                addRegulamentacao();
            });
            
            document.getElementById('btn-add-certificacao').addEventListener('click', function() {
                addCertificacao();
            });
            
            document.getElementById('btn-add-abrangencia').addEventListener('click', function() {
                addAbrangencia();
            });
            
            document.getElementById('btn-add-frota').addEventListener('click', function() {
                addFrota();
            });
            
            document.getElementById('btn-add-armazenagem').addEventListener('click', function() {
                addArmazenagem();
            });
            
            document.getElementById('btn-add-porto-terminal').addEventListener('click', function() {
                addPortoTerminal();
            });
            
            document.getElementById('btn-add-seguro-cobertura').addEventListener('click', function() {
                addSeguroCobertura();
            });
            
            document.getElementById('btn-add-tecnologia').addEventListener('click', function() {
                addTecnologia();
            });
            
            document.getElementById('btn-add-desempenho-qualidade').addEventListener('click', function() {
                addDesempenhoQualidade();
            });
            
            document.getElementById('btn-add-cliente-segmento').addEventListener('click', function() {
                addClienteSegmento();
            });
            
            document.getElementById('btn-add-recurso-humano').addEventListener('click', function() {
                addRecursoHumano();
            });
            
            document.getElementById('btn-add-sustentabilidade').addEventListener('click', function() {
                addSustentabilidade();
            });
            
            // Botões do formulário de cadastro
            document.getElementById('btn-cancelar-cadastro').addEventListener('click', function() {
                limparFormularioCadastro();
                showSection('empresas');
            });
        }

        // Configurar event listeners para formulários
        function setupFormListeners() {
            document.getElementById("form-cadastro").addEventListener("submit", function(e) {
                e.preventDefault();
                if (validateForm()) {
                    cadastrarEmpresa();
                }
            });
            
            // Configurar modal de detalhes
            document.getElementById('btn-fechar-modal').addEventListener('click', function() {
                fecharModal();
            });
            
            // Fechar modal ao clicar fora
            document.getElementById('modal-detalhes').addEventListener('click', function(e) {
                if (e.target === this) {
                    fecharModal();
                }
            });
        }

        // Função de validação do formulário
        function validateForm() {
            let isValid = true;

            // Validação Razão Social
            const razaoSocialInput = document.getElementById("razao_social");
            const razaoSocialError = document.getElementById("razao_social_error");
            if (razaoSocialInput.value.trim() === "") {
                razaoSocialError.classList.remove("hidden");
                isValid = false;
            } else {
                razaoSocialError.classList.add("hidden");
            }

            // Validação CNPJ - mais flexível
            const cnpjInput = document.getElementById("cnpj");
            const cnpjError = document.getElementById("cnpj_error");
            const cnpjValue = cnpjInput.value.trim();
            
            // Aceitar CNPJ com ou sem formatação
            const cnpjPattern = /^\d{2}\.?\d{3}\.?\d{3}\/?\d{4}-?\d{2}$/;
            const cnpjSomenteNumeros = /^\d{14}$/;
            
            if (cnpjValue === "" || (!cnpjPattern.test(cnpjValue) && !cnpjSomenteNumeros.test(cnpjValue))) {
                cnpjError.textContent = "CNPJ é obrigatório. Use formato 00.000.000/0000-00 ou apenas números.";
                cnpjError.classList.remove("hidden");
                isValid = false;
            } else {
                cnpjError.classList.add("hidden");
            }

            return isValid;
        }

        // Função para mostrar seção específica
        function showSection(sectionId) {
            console.log('Navegando para seção:', sectionId);
            
            // Se estiver saindo da seção de cadastro, limpar o formulário (EXCETO se estiver editando)
            const currentSection = document.querySelector('section:not([style*="display: none"])');
            if (currentSection && currentSection.id === 'cadastro' && sectionId !== 'cadastro' && !window.editingEmpresaId) {
                limparFormularioCadastro();
            }
            
            const sections = ['dashboard', 'empresas', 'cadastro', 'cotacoes'];
            sections.forEach(id => {
                const section = document.getElementById(id);
                if (section) {
                    section.style.display = id === sectionId ? 'block' : 'none';
                    if (id !== sectionId) {
                        section.classList.add('hidden');
                    } else {
                        section.classList.remove('hidden');
                    }
                }
            });
            
            // Resetar estado dos gráficos quando sair do dashboard
            if (sectionId !== 'dashboard') {
                window.graficosJaCriados = false;
                window.analyticsLoaded = false;
                window.loadingAnalytics = false;
                window.creatingCharts = false;
            }
            
            if (sectionId === 'empresas') {
                loadEmpresas();
            } else if (sectionId === 'dashboard') {
                loadDashboardStats();
            } else if (sectionId === 'cotacoes') {
                carregarCotacoes();
                carregarEstatisticasCotacoes();
            }
        }

        // Carregar estatísticas do dashboard
        async function loadDashboardStats() {
            try {
                console.log('Carregando estatísticas do dashboard...');
                const response = await fetch('/api/empresas');
                const data = await response.json();
                
                document.getElementById('total-empresas').textContent = data.total || 0;
                
                // Carregar detalhes para estatísticas específicas
                let certificadas = 0;
                let comArmazem = 0;
                let nacional = 0;
                
                for (let i = 1; i <= data.total; i++) {
                    try {
                        const detailResponse = await fetch(`/api/empresas/${i}`);
                        const empresa = await detailResponse.json();
                        
                        if (empresa.certificacoes && empresa.certificacoes.length > 0) {
                            certificadas++;
                        }
                        
                        if (empresa.armazenagem && empresa.armazenagem.some(a => a.possui_armazem)) {
                            comArmazem++;
                        }
                        
                        if (empresa.abrangencia_geografica && empresa.abrangencia_geografica.some(a => a.tipo_abrangencia === 'Nacional')) {
                            nacional++;
                        }
                    } catch (e) {
                        console.error('Erro ao carregar detalhes da empresa:', e);
                    }
                }
                
                document.getElementById('empresas-certificadas').textContent = certificadas;
                document.getElementById('empresas-armazem').textContent = comArmazem;
                document.getElementById('empresas-nacional').textContent = nacional;
                
                // Carregar gráficos apenas se ainda não foram carregados
                if (!window.analyticsLoaded) {
                    loadAnalytics();
                }
                
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            }
        }

        // Carregar dados de analytics e gráficos
        async function loadAnalytics() {
            // Verificação tripla para evitar carregamento múltiplo
            if (window.analyticsLoaded || window.graficosJaCriados || window.loadingAnalytics) {
                console.log('Analytics já carregados ou em carregamento, pulando...');
                return;
            }
            
            // Marcar que está carregando
            window.loadingAnalytics = true;
            
            try {
                console.log('Carregando analytics...');
                const response = await fetch('/api/analytics');
                
                if (!response.ok) {
                    console.log('Endpoint de analytics não disponível, criando dados mock...');
                    // Criar dados mock para os gráficos
                    const mockData = {
                        empresasPorRegiao: [
                            { regiao: 'Sudeste', empresas: 45, porcentagem: 45 },
                            { regiao: 'Sul', empresas: 25, porcentagem: 25 },
                            { regiao: 'Nordeste', empresas: 20, porcentagem: 20 },
                            { regiao: 'Centro-Oeste', empresas: 7, porcentagem: 7 },
                            { regiao: 'Norte', empresas: 3, porcentagem: 3 }
                        ],
                        tiposCarga: [
                            { tipo: 'Geral', quantidade: 35 },
                            { tipo: 'Refrigerada', quantidade: 25 },
                            { tipo: 'Perigosa', quantidade: 15 },
                            { tipo: 'Líquida', quantidade: 12 },
                            { tipo: 'Granéis', quantidade: 8 }
                        ],
                        crescimentoMensal: [
                            { mes: 'Jan', empresas: 85 },
                            { mes: 'Fev', empresas: 88 },
                            { mes: 'Mar', empresas: 92 },
                            { mes: 'Abr', empresas: 95 },
                            { mes: 'Mai', empresas: 98 },
                            { mes: 'Jun', empresas: 100 }
                        ],
                        certificacoes: [
                            { certificacao: 'ISO 9001', quantidade: 45 },
                            { certificacao: 'ISO 14001', quantidade: 32 },
                            { certificacao: 'OHSAS 18001', quantidade: 28 },
                            { certificacao: 'SASSMAQ', quantidade: 22 },
                            { certificacao: 'OEA', quantidade: 18 }
                        ]
                    };
                    
                    window.analyticsData = mockData;
                    createCharts(mockData);
                    window.analyticsLoaded = true;
                    return;
                }
                
                const data = await response.json();
                window.analyticsData = data;
                createCharts(data);
                window.analyticsLoaded = true;
                
            } catch (error) {
                console.error('Erro ao carregar analytics:', error);
                // Em caso de erro, usar dados mock
                const mockData = {
                    empresasPorRegiao: [
                        { regiao: 'Sudeste', empresas: 45, porcentagem: 45 },
                        { regiao: 'Sul', empresas: 25, porcentagem: 25 },
                        { regiao: 'Nordeste', empresas: 20, porcentagem: 20 }
                    ],
                    tiposCarga: [
                        { tipo: 'Geral', quantidade: 35 },
                        { tipo: 'Refrigerada', quantidade: 25 }
                    ],
                    crescimentoMensal: [
                        { mes: 'Jan', empresas: 85 },
                        { mes: 'Fev', empresas: 88 },
                        { mes: 'Mar', empresas: 92 }
                    ],
                    certificacoes: [
                        { certificacao: 'ISO 9001', quantidade: 45 },
                        { certificacao: 'ISO 14001', quantidade: 32 }
                    ]
                };
                
                window.analyticsData = mockData;
                createCharts(mockData);
                window.analyticsLoaded = true;
            } finally {
                // Limpar flag de carregamento
                window.loadingAnalytics = false;
            }
        }

        // Criar gráficos
        function createCharts(analyticsData) {
            console.log('Criando gráficos...');
            
            // Verificação múltipla para evitar criação infinita
            if (window.graficosJaCriados || window.creatingCharts) {
                console.log('Gráficos já foram criados ou estão sendo criados, pulando...');
                return;
            }
            
            // Marcar que está criando gráficos
            window.creatingCharts = true;
            
            // Destruir gráficos existentes
            if (window.graficosInstancias) {
                Object.values(window.graficosInstancias).forEach(chart => {
                    if (chart && typeof chart.destroy === 'function') {
                        chart.destroy();
                    }
                });
            }
            window.graficosInstancias = {};

            // Verificar se Chart.js está disponível
            if (typeof Chart === 'undefined') {
                console.error('Chart.js não está carregado');
                window.creatingCharts = false;
                return;
            }

            // Gráfico de empresas por região
            const ctxRegiao = document.getElementById('chart-empresas-regiao');
            if (ctxRegiao && analyticsData.empresasPorRegiao) {
                try {
                    window.graficosInstancias['regiao'] = new Chart(ctxRegiao, {
                        type: 'pie',
                        data: {
                            labels: analyticsData.empresasPorRegiao.map(item => item.regiao),
                            datasets: [{
                                data: analyticsData.empresasPorRegiao.map(item => item.empresas),
                                backgroundColor: ['#10B981', '#3B82F6', '#F59E0B', '#EF4444', '#8B5CF6'],
                                borderWidth: 2,
                                borderColor: '#ffffff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                    console.log('Gráfico de região criado');
                } catch (e) {
                    console.error('Erro ao criar gráfico de região:', e);
                }
            }

            // Gráfico de tipos de carga
            const ctxCarga = document.getElementById('chart-tipos-carga');
            if (ctxCarga && analyticsData.tiposCarga) {
                try {
                    window.graficosInstancias['tiposCarga'] = new Chart(ctxCarga, {
                        type: 'bar',
                        data: {
                            labels: analyticsData.tiposCarga.map(item => item.tipo),
                            datasets: [{
                                label: 'Quantidade de Empresas',
                                data: analyticsData.tiposCarga.map(item => item.quantidade),
                                backgroundColor: '#10B981',
                                borderColor: '#059669',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                    console.log('Gráfico de tipos de carga criado');
                } catch (e) {
                    console.error('Erro ao criar gráfico de tipos de carga:', e);
                }
            }

            // Gráfico de crescimento
            const ctxCrescimento = document.getElementById('chart-crescimento');
            if (ctxCrescimento && analyticsData.crescimentoMensal) {
                try {
                    window.graficosInstancias['crescimento'] = new Chart(ctxCrescimento, {
                        type: 'line',
                        data: {
                            labels: analyticsData.crescimentoMensal.map(item => item.mes),
                            datasets: [{
                                label: 'Total de Empresas',
                                data: analyticsData.crescimentoMensal.map(item => item.empresas),
                                borderColor: '#3B82F6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 3,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                    console.log('Gráfico de crescimento criado');
                } catch (e) {
                    console.error('Erro ao criar gráfico de crescimento:', e);
                }
            }

            // Gráfico de certificações
            const ctxCert = document.getElementById('chart-certificacoes');
            if (ctxCert && analyticsData.certificacoes) {
                try {
                    window.graficosInstancias['certificacoes'] = new Chart(ctxCert, {
                        type: 'bar',
                        data: {
                            labels: analyticsData.certificacoes.map(item => item.certificacao),
                            datasets: [{
                                label: 'Quantidade de Empresas',
                                data: analyticsData.certificacoes.map(item => item.quantidade),
                                backgroundColor: '#F59E0B',
                                borderColor: '#D97706',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                    console.log('Gráfico de certificações criado');
                } catch (e) {
                    console.error('Erro ao criar gráfico de certificações:', e);
                }
            }
            
            console.log('Todos os gráficos processados');
            
            // Marcar que os gráficos foram criados
            window.graficosJaCriados = true;
            
            // Limpar flag de criação
            window.creatingCharts = false;
        }

        // Carregar lista de empresas
        async function loadEmpresas(page = 1) {
            try {
                console.log('Carregando empresas, página:', page);
                const params = new URLSearchParams({
                    page: page,
                    per_page: 10,
                    ...currentFilters
                });
                
                const response = await fetch(`/api/empresas?${params}`);
                const data = await response.json();
                
                displayEmpresas(data.empresas);
                updatePagination(data);
                
                document.getElementById('resultado-count').textContent = 
                    `${data.total} empresa(s) encontrada(s)`;
                
            } catch (error) {
                console.error('Erro ao carregar empresas:', error);
                document.getElementById('lista-empresas').innerHTML = 
                    '<div class="p-6 text-center text-red-600">Erro ao carregar empresas</div>';
            }
        }

        // Exibir empresas na lista
        function displayEmpresas(empresas) {
            const container = document.getElementById('lista-empresas');
            
            if (empresas.length === 0) {
                container.innerHTML = '<div class="p-6 text-center text-gray-500">Nenhuma empresa encontrada</div>';
                return;
            }
            
            container.innerHTML = empresas.map(empresa => `
                <div class="p-6 hover:bg-gray-50 transition-colors">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3">
                                <h4 class="text-lg font-semibold text-gray-800">${empresa.razao_social}</h4>
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                                    empresa.etiqueta === 'PARCEIRA' ? 'bg-green-100 text-green-800' :
                                    empresa.etiqueta === 'ENCERRADO' ? 'bg-red-100 text-red-800' :
                                    'bg-blue-100 text-blue-800'
                                }">${empresa.etiqueta || 'CADASTRADA'}</span>
                            </div>
                            <p class="text-sm text-gray-600">${empresa.nome_fantasia || 'N/A'}</p>
                            <div class="mt-2 flex items-center space-x-4 text-sm text-gray-500">
                                <span><i class="fas fa-id-card mr-1"></i>${empresa.cnpj}</span>
                                <span><i class="fas fa-envelope mr-1"></i>${empresa.email || 'N/A'}</span>
                                <span><i class="fas fa-phone mr-1"></i>${empresa.telefone_comercial || 'N/A'}</span>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="verDetalhes(${empresa.id})" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                                <i class="fas fa-eye mr-1"></i>Ver Detalhes
                            </button>
                            <button onclick="editarEmpresa(${empresa.id})" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
                                <i class="fas fa-edit mr-1"></i>Editar
                            </button>
                            <button onclick="confirmarExclusao(${empresa.id}, '${empresa.razao_social}')" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors ml-2">
                                <i class="fas fa-trash-alt mr-1"></i>Excluir
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Atualizar paginação
        function updatePagination(data) {
            currentPage = data.current_page;
            totalPages = data.pages;
            
            document.getElementById('showing-from').textContent = 
                data.empresas.length > 0 ? ((currentPage - 1) * data.per_page) + 1 : 0;
            document.getElementById('showing-to').textContent = 
                Math.min(currentPage * data.per_page, data.total);
            document.getElementById('total-results').textContent = data.total;
            
            document.getElementById('btn-prev').disabled = currentPage <= 1;
            document.getElementById('btn-next').disabled = currentPage >= totalPages;
        }

        // Navegação de páginas
        function previousPage() {
            if (currentPage > 1) {
                loadEmpresas(currentPage - 1);
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                loadEmpresas(currentPage + 1);
            }
        }

        // Buscar empresas com filtros
        function buscarEmpresas() {
            console.log('Buscando empresas com filtros...');
            currentFilters = {
                razao_social: document.getElementById('filtro-razao-social').value,
                cnpj: document.getElementById("filtro-cnpj").value,
                etiqueta: document.getElementById("filtro-etiqueta").value,
                tipo_carga: document.getElementById("filtro-tipo-carga").value,
                certificacao: document.getElementById("filtro-certificacao").value,
                portos_atendidos: document.getElementById("filtro-portos-atendidos").value,
                tipo_regulamentacao: document.getElementById("filtro-tipo-regulamentacao").value,
                tipo_frota: document.getElementById("filtro-tipo-frota").value,
                tipo_veiculo: document.getElementById("filtro-tipo-veiculo").value,
                possui_seguro: document.getElementById("filtro-possui-seguro").value,
                nome_tecnologia: document.getElementById("filtro-nome-tecnologia").value,
                segmento_cliente: document.getElementById("filtro-segmento-cliente").value,
                certificacao_ambiental: document.getElementById("filtro-certificacao-ambiental").value
            };
            
            // Remover filtros vazios
            Object.keys(currentFilters).forEach(key => {
                if (!currentFilters[key]) {
                    delete currentFilters[key];
                }
            });
            
            loadEmpresas(1);
        }

        // Limpar filtros
        function limparFiltros() {
            console.log('Limpando filtros...');
            document.getElementById('filtro-razao-social').value = '';
            document.getElementById('filtro-cnpj').value = '';
            document.getElementById('filtro-etiqueta').value = '';
            document.getElementById('filtro-tipo-carga').value = '';
            document.getElementById('filtro-certificacao').value = '';
            document.getElementById('filtro-portos-atendidos').value = '';
            document.getElementById('filtro-tipo-regulamentacao').value = '';
            document.getElementById('filtro-tipo-frota').value = '';
            document.getElementById('filtro-tipo-veiculo').value = '';
            document.getElementById('filtro-possui-seguro').value = '';
            document.getElementById('filtro-nome-tecnologia').value = '';
            document.getElementById('filtro-segmento-cliente').value = '';
            document.getElementById('filtro-certificacao-ambiental').value = '';
            
            currentFilters = {};
            loadEmpresas(1);
        }

        // Ver detalhes da empresa
        async function verDetalhes(empresaId) {
            try {
                console.log('Carregando detalhes da empresa:', empresaId);
                const response = await fetch(`/api/empresas/${empresaId}`);
                const empresa = await response.json();
                
                const modal = document.getElementById('modal-detalhes');
                const conteudo = document.getElementById('conteudo-modal');
                
                conteudo.innerHTML = `
                    <div class="space-y-6">
                        <!-- Dados Básicos -->
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Dados Básicos</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div><strong>Razão Social:</strong> ${empresa.razao_social}</div>
                                <div><strong>Nome Fantasia:</strong> ${empresa.nome_fantasia || 'N/A'}</div>
                                <div><strong>CNPJ:</strong> ${empresa.cnpj}</div>
                                <div><strong>Inscrição Estadual:</strong> ${empresa.inscricao_estadual || 'N/A'}</div>
                                <div class="md:col-span-2"><strong>Endereço:</strong> ${empresa.endereco_completo || 'N/A'}</div>
                                <div><strong>Telefone Comercial:</strong> ${empresa.telefone_comercial || 'N/A'}</div>
                                <div><strong>Telefone Emergencial:</strong> ${empresa.telefone_emergencial || 'N/A'}</div>
                                <div><strong>E-mail:</strong> ${empresa.email ? `<a href="mailto:${empresa.email}" class="text-blue-600 hover:text-blue-800 underline">${empresa.email}</a>` : 'N/A'}</div>
                                <div><strong>Website:</strong> ${empresa.website ? `<a href="${empresa.website.startsWith('http') ? empresa.website : 'https://' + empresa.website}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">${empresa.website}</a>` : 'N/A'}</div>
                                ${empresa.link_cotacao ? `<div><strong>Cotação:</strong> <a href="${empresa.link_cotacao.startsWith('http') ? empresa.link_cotacao : 'https://' + empresa.link_cotacao}" target="_blank" class="inline-flex items-center px-3 py-1 bg-orange-600 text-white text-sm rounded-lg hover:bg-orange-700 transition-colors"><i class="fas fa-calculator mr-2"></i>Solicitar Cotação</a></div>` : ''}
                                <div><strong>Data de Fundação:</strong> ${formatarDataBrasil(empresa.data_fundacao)}</div>
                                ${empresa.observacoes ? `<div><strong>Observações:</strong> ${empresa.observacoes}</div>` : ''}
                            </div>
                        </div>
                        
                        <!-- Certificações -->
                        ${empresa.certificacoes && empresa.certificacoes.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Certificações</h4>
                            <div class="space-y-2">
                                ${empresa.certificacoes.map(cert => `
                                    <div class="bg-green-50 p-3 rounded-md">
                                        <div class="font-medium text-green-800">${cert.nome_certificacao}</div>
                                        <div class="text-sm text-green-600">
                                            Número: ${cert.numero_certificacao || 'N/A'} | 
                                            Válido até: ${formatarDataBrasil(cert.data_validade)} | 
                                            Certificador: ${cert.orgao_certificador || 'N/A'}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Tipos de Carga -->
                        ${empresa.tipos_carga && empresa.tipos_carga.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Tipos de Carga</h4>
                            <div class="flex flex-wrap gap-2">
                                ${empresa.tipos_carga.map(tipo => `
                                    <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">${tipo.tipo_carga}</span>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Modalidades de Transporte -->
                        ${empresa.modalidades_transporte && empresa.modalidades_transporte.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Modalidades de Transporte</h4>
                            <div class="flex flex-wrap gap-2">
                                ${empresa.modalidades_transporte.map(modal => `
                                    <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm">${modal.modalidade}</span>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Abrangência Geográfica -->
                        ${empresa.abrangencia_geografica && empresa.abrangencia_geografica.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Abrangência Geográfica</h4>
                            <div class="space-y-2">
                                ${empresa.abrangencia_geografica.map(abr => `
                                    <div class="bg-yellow-50 p-3 rounded-md">
                                        <div class="font-medium text-yellow-800">${abr.tipo_abrangencia}</div>
                                        <div class="text-sm text-yellow-600">${abr.detalhes || 'N/A'}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Armazenagem -->
                        ${empresa.armazenagem && empresa.armazenagem.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Armazenagem</h4>
                            <div class="space-y-2">
                                ${empresa.armazenagem.map(arm => `
                                    <div class="bg-gray-50 p-3 rounded-md">
                                        <div class="font-medium">${arm.possui_armazem ? 'Possui Armazém' : 'Não possui armazém'}</div>
                                        ${arm.possui_armazem ? `
                                            <div class="text-sm text-gray-600 mt-1">
                                                <div>Localização: ${arm.localizacao || 'N/A'}</div>
                                                <div>Capacidade: ${arm.capacidade_m2 || 'N/A'} m² | ${arm.capacidade_m3 || 'N/A'} m³</div>
                                                <div>Tipos: ${arm.tipos_armazenagem || 'N/A'}</div>
                                                <div>Serviços: ${arm.servicos_oferecidos || 'N/A'}</div>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Regulamentações e Licenças -->
                        ${empresa.regulamentacoes && empresa.regulamentacoes.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Regulamentações e Licenças</h4>
                            <div class="space-y-2">
                                ${empresa.regulamentacoes.map(reg => `
                                    <div class="bg-red-50 p-3 rounded-md">
                                        <div class="font-medium text-red-800">${reg.tipo_regulamentacao}</div>
                                        <div class="text-sm text-red-600">
                                            Registro: ${reg.numero_registro || 'N/A'} | 
                                            Emissão: ${formatarDataBrasil(reg.data_emissao)} | 
                                            Validade: ${formatarDataBrasil(reg.data_validade)} | 
                                            Órgão: ${reg.orgao_emissor || 'N/A'}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Frota -->
                        ${empresa.frota && empresa.frota.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Frota</h4>
                            <div class="space-y-2">
                                ${empresa.frota.map(frota => `
                                    <div class="bg-blue-50 p-3 rounded-md">
                                        <div class="font-medium text-blue-800">${frota.tipo_frota} - ${frota.tipo_veiculo}</div>
                                        <div class="text-sm text-blue-600">
                                            Carroceria: ${frota.tipo_carroceria || 'N/A'} | 
                                            Quantidade: ${frota.quantidade || 'N/A'} | 
                                            Capacidade: ${frota.capacidade || 'N/A'}t | 
                                            Ano Médio: ${frota.ano_medio || 'N/A'}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Portos e Terminais -->
                        ${empresa.portos_terminais && empresa.portos_terminais.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Portos e Terminais</h4>
                            <div class="space-y-2">
                                ${(() => {
                                    // Agrupar terminais por porto
                                    const portoTerminais = {};
                                    empresa.portos_terminais.forEach(item => {
                                        if (!portoTerminais[item.nome_porto_terminal]) {
                                            portoTerminais[item.nome_porto_terminal] = [];
                                        }
                                        portoTerminais[item.nome_porto_terminal].push(item.tipo_terminal);
                                    });
                                    
                                    // Gerar HTML para cada porto com seus terminais
                                    return Object.keys(portoTerminais).map(porto => `
                                        <div class="bg-teal-50 p-3 rounded-md">
                                            <div class="font-medium text-teal-800">${porto}</div>
                                            <div class="text-sm text-teal-600">
                                                Terminais: ${portoTerminais[porto].filter(t => t).join(', ') || 'N/A'}
                                            </div>
                                        </div>
                                    `).join('');
                                })()}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Seguros e Coberturas -->
                        ${empresa.seguros_coberturas && empresa.seguros_coberturas.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Seguros e Coberturas</h4>
                            <div class="space-y-2">
                                ${empresa.seguros_coberturas.map(seguro => `
                                    <div class="bg-orange-50 p-3 rounded-md">
                                        <div class="font-medium text-orange-800">${seguro.tipo_seguro}</div>
                                        <div class="text-sm text-orange-600">
                                            Seguradora: ${seguro.seguradora || 'N/A'} | 
                                            Cobertura: ${seguro.valor_cobertura || 'N/A'} | 
                                            Validade: ${formatarDataBrasil(seguro.data_validade)}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Tecnologias e Integração -->
                        ${empresa.tecnologias && empresa.tecnologias.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Tecnologias e Integração</h4>
                            <div class="space-y-2">
                                ${empresa.tecnologias.map(tech => `
                                    <div class="bg-indigo-50 p-3 rounded-md">
                                        <div class="font-medium text-indigo-800">${tech.nome_tecnologia}</div>
                                        <div class="text-sm text-indigo-600">${tech.detalhes || 'N/A'}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Clientes e Segmentos -->
                        ${empresa.clientes_segmentos && empresa.clientes_segmentos.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Clientes e Segmentos</h4>
                            <div class="space-y-2">
                                ${empresa.clientes_segmentos.map(cliente => `
                                    <div class="bg-pink-50 p-3 rounded-md">
                                        <div class="font-medium text-pink-800">${cliente.segmento}</div>
                                        <div class="text-sm text-pink-600">Principais Clientes: ${cliente.principais_clientes || 'N/A'}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Desempenho e Qualidade -->
                        ${empresa.desempenho_qualidade && empresa.desempenho_qualidade.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Desempenho e Qualidade</h4>
                            <div class="space-y-2">
                                ${empresa.desempenho_qualidade.map(desemp => `
                                    <div class="bg-green-50 p-3 rounded-md">
                                        <div class="text-sm text-green-600">
                                            Prazo Médio: ${desemp.prazo_medio_atendimento || 'N/A'} ${desemp.unidade_prazo || 'dias'} | 
                                            Avarias/Extravios: ${desemp.indice_avarias_extravios || 'N/A'}% | 
                                            Entregas no Prazo: ${desemp.indice_entregas_prazo || 'N/A'}%
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Recursos Humanos -->
                        ${empresa.recursos_humanos && empresa.recursos_humanos.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Recursos Humanos</h4>
                            <div class="space-y-2">
                                ${empresa.recursos_humanos.map(rh => `
                                    <div class="bg-cyan-50 p-3 rounded-md">
                                        <div class="font-medium text-cyan-800">Funcionários: ${rh.numero_funcionarios || 'N/A'}</div>
                                        <div class="text-sm text-cyan-600">Treinamentos: ${rh.programas_treinamento || 'N/A'}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Sustentabilidade -->
                        ${empresa.sustentabilidade && empresa.sustentabilidade.length > 0 ? `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Sustentabilidade</h4>
                            <div class="space-y-2">
                                ${empresa.sustentabilidade.map(sust => `
                                    <div class="bg-emerald-50 p-3 rounded-md">
                                        <div class="font-medium text-emerald-800">${sust.certificacao_ambiental}</div>
                                        <div class="text-sm text-emerald-600">Programas: ${sust.programas_reducao_emissoes || 'N/A'}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                modal.classList.add('show');
                modal.classList.add('fade-in');
                
            } catch (error) {
                console.error('Erro ao carregar detalhes:', error);
                alert('Erro ao carregar detalhes da empresa');
            }
        }

        // Fechar modal
        function fecharModal() {
            const modal = document.getElementById('modal-detalhes');
            modal.classList.remove('show');
            modal.classList.remove('fade-in');
        }

        // Cadastrar nova empresa ou atualizar empresa existente
        async function cadastrarEmpresa() {
            const isEditing = window.editingEmpresaId;
            console.log(isEditing ? 'Atualizando empresa...' : 'Cadastrando nova empresa...');
            
            const form = document.getElementById('form-cadastro');
            if (!form) {
                console.error('Formulário não encontrado!');
                alert('Erro: Formulário não encontrado!');
                return;
            }
            
            const formData = new FormData(form);
            
            // Coletar dados do formulário
            const empresaData = {
                razao_social: formData.get('razao_social'),
                nome_fantasia: formData.get('nome_fantasia'),
                cnpj: formData.get('cnpj'),
                inscricao_estadual: formData.get('inscricao_estadual'),
                endereco_completo: formData.get('endereco_completo'),
                telefone_comercial: formData.get('telefone_comercial'),
                telefone_emergencial: formData.get('telefone_emergencial'),
                email: formData.get('email'),
                website: formData.get('website'),
                link_cotacao: formData.get('link_cotacao'),
                data_fundacao: formData.get('data_fundacao'),
                observacoes: formData.get('observacoes'),
                etiqueta: formData.get('etiqueta'),
                modalidades_transporte: formData.getAll('modalidades_transporte'),
                tipos_carga: formData.getAll('tipos_carga'),
                regulamentacoes: getDynamicFormData('regulamentacoes'),
                certificacoes: getDynamicFormData('certificacoes'),
                abrangencia_geografica: getDynamicFormData('abrangencia'),
                frota: getDynamicFormData('frota'),
                armazenagem: getDynamicFormData('armazenagem'),
                portos_terminais: getDynamicFormData('portos-terminais'),
                seguros_coberturas: getDynamicFormData('seguros-coberturas'),
                tecnologias: getDynamicFormData('tecnologias'),
                desempenho_qualidade: getDynamicFormData('desempenho-qualidade'),
                clientes_segmentos: getDynamicFormData('clientes-segmentos'),
                recursos_humanos: getDynamicFormData('recursos-humanos'),
                sustentabilidade: getDynamicFormData('sustentabilidade')
            };
            
            console.log('Dados da empresa:', empresaData);
            
            try {
                let response;
                if (isEditing) {
                    // Atualizar empresa existente
                    response = await fetch(`/api/empresas/${window.editingEmpresaId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(empresaData)
                    });
                } else {
                    // Criar nova empresa
                    response = await fetch('/api/empresas', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(empresaData)
                    });
                }
                
                if (response.ok) {
                    alert(isEditing ? 'Empresa atualizada com sucesso!' : 'Empresa cadastrada com sucesso!');
                    
                    // Limpar formulário e resetar estado
                    form.reset();
                    limparCamposDinamicos();
                    resetarFormulario();
                    
                    // Navegar para a lista de empresas
                    showSection('empresas');
                    loadEmpresas(1);
                } else {
                    const error = await response.json();
                    alert('Erro ao ' + (isEditing ? 'atualizar' : 'cadastrar') + ' empresa: ' + error.error);
                }
                
            } catch (error) {
                console.error('Erro ao ' + (isEditing ? 'atualizar' : 'cadastrar') + ' empresa:', error);
                alert('Erro ao ' + (isEditing ? 'atualizar' : 'cadastrar') + ' empresa');
            }
        }
        
        // Função para limpar campos dinâmicos
        function limparCamposDinamicos() {
            // Não limpar se estiver editando uma empresa
            if (window.editingEmpresaId) {
                console.log('Não limpando campos dinâmicos - editando empresa:', window.editingEmpresaId);
                return;
            }
            
            console.log('Limpando campos dinâmicos...');
            const containers = [
                'regulamentacoes-container', 'certificacoes-container', 'abrangencia-container',
                'frota-container', 'armazenagem-container', 'portos-terminais-container',
                'seguros-coberturas-container', 'tecnologias-container', 'desempenho-qualidade-container',
                'clientes-segmentos-container', 'recursos-humanos-container', 'sustentabilidade-container'
            ];
            
            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = '';
                }
            });
        }
        
        // Função para resetar o formulário para modo de cadastro
        function resetarFormulario() {
            // Limpar ID de edição
            window.editingEmpresaId = null;
            
            // Resetar texto do botão
            const submitBtn = document.querySelector('#form-cadastro button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Salvar Empresa';
            }
            
            // Resetar título da seção
            const titulo = document.querySelector('#cadastro h2');
            if (titulo) {
                titulo.textContent = 'Cadastrar Nova Empresa';
            }
        }

        // Editar empresa
        async function editarEmpresa(empresaId) {
            try {
                console.log('Carregando empresa para edição:', empresaId);
                const response = await fetch(`/api/empresas/${empresaId}`);
                const empresa = await response.json();
                
                // Limpar formulário antes de preencher com novos dados
                const form = document.getElementById('form-cadastro');
                form.reset();
                
                // Limpar todos os containers dinâmicos
                const containers = [
                    'regulamentacoes-container', 'certificacoes-container', 'modalidades-container',
                    'tipos-carga-container', 'abrangencia-container', 'frota-container', 
                    'armazenagem-container', 'portos-terminais-container', 'seguros-coberturas-container',
                    'tecnologias-container', 'desempenho-qualidade-container', 'clientes-segmentos-container',
                    'recursos-humanos-container', 'sustentabilidade-container'
                ];
                
                containers.forEach(containerId => {
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.innerHTML = '';
                    }
                });
                
                // Armazenar ID da empresa sendo editada
                window.editingEmpresaId = empresaId;
                
                // Navegar para a seção de cadastro
                showSection('cadastro');
                
                // Preencher os dados básicos
                document.querySelector('input[name="razao_social"]').value = empresa.razao_social || '';
                document.querySelector('input[name="nome_fantasia"]').value = empresa.nome_fantasia || '';
                document.querySelector('input[name="cnpj"]').value = empresa.cnpj || '';
                document.querySelector('input[name="inscricao_estadual"]').value = empresa.inscricao_estadual || '';
                document.querySelector('textarea[name="endereco_completo"]').value = empresa.endereco_completo || '';
                document.querySelector('input[name="telefone_comercial"]').value = empresa.telefone_comercial || '';
                document.querySelector('input[name="telefone_emergencial"]').value = empresa.telefone_emergencial || '';
                document.querySelector('input[name="email"]').value = empresa.email || '';
                document.querySelector('input[name="website"]').value = empresa.website || '';
                document.querySelector('input[name="link_cotacao"]').value = empresa.link_cotacao || '';
                document.querySelector('input[name="data_fundacao"]').value = empresa.data_fundacao || '';
                document.querySelector('textarea[name="observacoes"]').value = empresa.observacoes || '';
                document.querySelector('select[name="etiqueta"]').value = empresa.etiqueta || 'CADASTRADA';
                
                // Preencher modalidades de transporte
                empresa.modalidades_transporte?.forEach(modalidade => {
                    const checkbox = document.querySelector(`input[name="modalidades_transporte"][value="${modalidade.modalidade}"]`);
                    if (checkbox) checkbox.checked = true;
                });
                
                // Preencher tipos de carga
                empresa.tipos_carga?.forEach(tipo => {
                    const checkbox = document.querySelector(`input[name="tipos_carga"][value="${tipo.tipo_carga}"]`);
                    if (checkbox) checkbox.checked = true;
                });
                
                // Preencher campos dinâmicos
                preencherCamposDinamicos('regulamentacoes', empresa.regulamentacoes || []);
                preencherCamposDinamicos('certificacoes', empresa.certificacoes || []);
                preencherCamposDinamicos('abrangencia', empresa.abrangencia_geografica || []);
                preencherCamposDinamicos('frota', empresa.frota || []);
                preencherCamposDinamicos('armazenagem', empresa.armazenagem || []);
                
                // LIMPEZA EXTRA PARA PORTOS - GARANTIR QUE ESTÁ VAZIO
                const portosContainer = document.getElementById('portos-terminais-container');
                if (portosContainer) {
                    portosContainer.innerHTML = '';
                    console.log('Container de portos limpo antes de preencher');
                }
                
                preencherCamposDinamicos('portos-terminais', empresa.portos_terminais || []);
                preencherCamposDinamicos('seguros-coberturas', empresa.seguros_coberturas || []);
                preencherCamposDinamicos('tecnologias', empresa.tecnologias || []);
                preencherCamposDinamicos('desempenho-qualidade', empresa.desempenho_qualidade || []);
                preencherCamposDinamicos('clientes-segmentos', empresa.clientes_segmentos || []);
                preencherCamposDinamicos('recursos-humanos', empresa.recursos_humanos || []);
                preencherCamposDinamicos('sustentabilidade', empresa.sustentabilidade || []);
                
                // Alterar o texto do botão para "Atualizar Empresa"
                const submitBtn = document.querySelector('#form-cadastro button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'Atualizar Empresa';
                }
                
                // Alterar o título da seção
                const titulo = document.querySelector('#cadastro h2');
                if (titulo) {
                    titulo.textContent = 'Editar Empresa';
                }
                
            } catch (error) {
                console.error('Erro ao carregar empresa para edição:', error);
                alert('Erro ao carregar dados da empresa');
            }
        }
        
        // Função auxiliar para preencher campos dinâmicos
        function preencherCamposDinamicos(prefix, dados) {
            console.log('Executando preencherCamposDinamicos para:', prefix, 'com', dados?.length || 0, 'itens');
            
            // Proteção específica contra execução dupla para portos-terminais
            // if (prefix === 'portos-terminais') {
            //     if (window.portosJaPreenchidos) {
            //         console.log('EXECUÇÃO DUPLA BLOQUEADA para portos-terminais');
            //         return;
            //     }
            //     window.portosJaPreenchidos = true;
            //     // Reset após 1 segundo para permitir nova edição
            //     setTimeout(() => {
            //         window.portosJaPreenchidos = false;
            //     }, 1000);
            // }
            
            const container = document.getElementById(`${prefix}-container`);
            if (!container || !dados || dados.length === 0) return;
            
            // Limpar container
            container.innerHTML = '';
            
            // Adicionar cada item
            dados.forEach((item, index) => {
                // Chamar a função apropriada para adicionar o campo
                switch(prefix) {
                    case 'regulamentacoes':
                        addRegulamentacao();
                        break;
                    case 'certificacoes':
                        addCertificacao();
                        break;
                    case 'abrangencia':
                        addAbrangencia();
                        break;
                    case 'frota':
                        addFrota();
                        break;
                    case 'armazenagem':
                        addArmazenagem();
                        break;
                    case 'portos-terminais':
                        console.log('Dados de portos recebidos:', dados);
                        
                        // Limpar o container de portos e terminais antes de preencher
                        container.innerHTML = '';

                        dados.forEach(item => {
                            if (item.nome_porto_terminal && item.tipo_terminal) {
                                addPortoTerminal(); // Adiciona um novo conjunto de campos de porto/terminal
                                const portoDiv = container.lastElementChild;
                                const portoSelect = portoDiv.querySelector('.porto-select');
                                const terminalSelect = portoDiv.querySelector('.terminal-select');

                                if (portoSelect) {
                                    portoSelect.value = item.nome_porto_terminal;
                                    // Chamar atualizarTerminais para popular os terminais corretos para o porto selecionado
                                    atualizarTerminais(portoSelect, container.children.length - 1);
                                }
                                if (terminalSelect) {
                                    terminalSelect.value = item.tipo_terminal;
                                }
                            }
                        });
                        break;
                    case 'seguros-coberturas':
                        addSeguroCobertura();
                        break;
                    case 'tecnologias':
                        addTecnologia();
                        break;
                    case 'desempenho-qualidade':
                        addDesempenhoQualidade();
                        break;
                    case 'clientes-segmentos':
                        addClienteSegmento();
                        break;
                    case 'recursos-humanos':
                        addRecursoHumano();
                        break;
                    case 'sustentabilidade':
                        addSustentabilidade();
                        break;
                }
                
                // Preencher os valores no último item adicionado
                const lastDiv = container.lastElementChild;
                if (lastDiv) {
                    Object.keys(item).forEach(key => {
                        const input = lastDiv.querySelector(`[name*="[${key}]"]`);
                        if (input) {
                            if (input.type === 'checkbox') {
                                input.checked = item[key];
                            } else {
                                input.value = item[key];
                            }
                        }
                    });
                }
            });
        }

        // Função auxiliar para coletar dados de campos dinâmicos
        function getDynamicFormData(prefix) {
            // Função específica para portos-terminais
            if (prefix === 'portos-terminais') {
                return getPortosTerminaisData();
            }
            
            const data = [];
            const container = document.getElementById(`${prefix}-container`);
            if (!container) return data;

            Array.from(container.children).forEach(div => {
                const item = {};
                Array.from(div.querySelectorAll('input, select, textarea')).forEach(input => {
                    const nameMatch = input.name.match(/\[(\w+)\]$/);
                    if (nameMatch) {
                        const name = nameMatch[1];
                        if (input.type === 'checkbox') {
                            item[name] = input.checked;
                        } else if (input.type === 'number') {
                            item[name] = parseFloat(input.value) || 0;
                        } else {
                            item[name] = input.value;
                        }
                    }
                });
                if (Object.keys(item).length > 0) {
                    data.push(item);
                }
            });
            return data;
        }

        function getPortosTerminaisData() {
            const dataSet = new Set();
            const container = document.getElementById('portos-terminais-container');
            if (!container) return [];

            Array.from(container.children).forEach(div => {
                const portoSelect = div.querySelector('.porto-select');
                const terminalSelect = div.querySelector('.terminal-select');
                
                if (portoSelect && terminalSelect && portoSelect.value && terminalSelect.value) {
                    const key = `${portoSelect.value}|${terminalSelect.value}`;
                    dataSet.add(key);
                }

                // Coletar terminais adicionais
                const terminaisAdicionais = div.querySelector('[id^="terminais-adicionais-"]');
                if (terminaisAdicionais) {
                    Array.from(terminaisAdicionais.children).forEach(terminalDiv => {
                        const terminalSelect = terminalDiv.querySelector('select');
                        const hiddenInput = terminalDiv.querySelector('input[type="hidden"]');
                        
                        if (terminalSelect && hiddenInput && terminalSelect.value) {
                            const key = `${hiddenInput.value}|${terminalSelect.value}`;
                            dataSet.add(key);
                        }
                    });
                }
            });

            // Converter Set de volta para array de objetos
            const data = [];
            dataSet.forEach(key => {
                const [nome_porto_terminal, tipo_terminal] = key.split('|');
                data.push({
                    nome_porto_terminal,
                    tipo_terminal
                });
            });

            console.log('Dados de portos coletados (sem duplicatas):', data);
            return data;
        }

        // Funções para adicionar campos dinâmicos
        function addRegulamentacao() {
            const container = document.getElementById("regulamentacoes-container");
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-md relative';
            div.innerHTML = `
                <button type="button" onclick="this.parentNode.remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Regulamentação</label>
                    <select name="regulamentacoes[${index}][tipo_regulamentacao]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="RNTRC">RNTRC (Registro Nacional de Transportadores Rodoviários de Cargas)</option>
                        <option value="ANTT">ANTT (Agência Nacional de Transportes Terrestres)</option>
                        <option value="Licença Originária ANTT">Licença Originária ANTT</option>
                        <option value="AET">AET (Autorização Especial de Trânsito)</option>
                        <option value="Licença Sanitária ANVISA">Licença Sanitária ANVISA</option>
                        <option value="CRLV">CRLV (Certificado de Registro e Licenciamento de Veículo)</option>
                        <option value="Autorização Transporte Internacional">Autorização de Transporte Rodoviário Internacional</option>
                        <option value="Permissão MERCOSUL">Permissão para Transporte Internacional de Cargas (MERCOSUL)</option>
                        <option value="Licença Polícia Federal">Licença da Polícia Federal para Transporte de Cargas</option>
                        <option value="Alvará Municipal">Alvará de Funcionamento Municipal</option>
                        <option value="Licença Ambiental">Licença Ambiental</option>
                        <option value="CRT">CRT (Certificado de Regularidade Técnica)</option>
                        <option value="Autorização Produtos Perigosos">Autorização para Transporte de Produtos Perigosos</option>
                        <option value="Licença IBAMA">Licença IBAMA</option>
                        <option value="CISV">CISV (Certificado de Inspeção de Segurança Veicular)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Número de Registro</label>
                    <input type="text" name="regulamentacoes[${index}][numero_registro]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data de Emissão</label>
                    <input type="date" name="regulamentacoes[${index}][data_emissao]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data de Validade</label>
                    <input type="date" name="regulamentacoes[${index}][data_validade]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Órgão Emissor</label>
                    <input type="text" name="regulamentacoes[${index}][orgao_emissor]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            `;
            container.appendChild(div);
        }

        function addCertificacao() {
            const container = document.getElementById("certificacoes-container");
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-md relative';
            div.innerHTML = `
                <button type="button" onclick="this.parentNode.remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Certificação</label>
                    <select name="certificacoes[${index}][nome_certificacao]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="ISO 9001">ISO 9001 (Sistema de Gestão da Qualidade)</option>
                        <option value="ISO 14001">ISO 14001 (Sistema de Gestão Ambiental)</option>
                        <option value="ISO 45001">ISO 45001 (Sistema de Gestão de Saúde e Segurança Ocupacional)</option>
                        <option value="ISO 28000">ISO 28000 (Sistema de Gestão de Segurança para a Cadeia de Suprimentos)</option>
                        <option value="ISO 39001">ISO 39001 (Sistema de Gestão de Segurança Viária)</option>
                        <option value="SASSMAQ">SASSMAQ (Sistema de Avaliação de Saúde, Segurança, Meio Ambiente e Qualidade)</option>
                        <option value="OEA">OEA (Operador Econômico Autorizado)</option>
                        <option value="Transqualit">Transqualit (Certificação de Qualidade em Transporte)</option>
                        <option value="ANVISA">ANVISA (Agência Nacional de Vigilância Sanitária)</option>
                        <option value="AFE">AFE (Autorização de Funcionamento de Empresa)</option>
                        <option value="AE">AE (Autorização Especial)</option>
                        <option value="CIPP">CIPP (Certificado de Inspeção para Produtos Perigosos)</option>
                        <option value="Certificação ABIQUIM">Certificação ABIQUIM</option>
                        <option value="Certificação INMETRO">Certificação INMETRO</option>
                        <option value="Certificação ANAC">Certificação ANAC</option>
                        <option value="Certificação ANTAQ">Certificação ANTAQ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Número da Certificação</label>
                    <input type="text" name="certificacoes[${index}][numero_certificacao]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data de Emissão</label>
                    <input type="date" name="certificacoes[${index}][data_emissao]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data de Validade</label>
                    <input type="date" name="certificacoes[${index}][data_validade]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Órgão Certificador</label>
                    <input type="text" name="certificacoes[${index}][orgao_certificador]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            `;
            container.appendChild(div);
        }

        function addAbrangencia() {
            const container = document.getElementById("abrangencia-container");
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-md relative';
            div.innerHTML = `
                <button type="button" onclick="this.parentNode.remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Abrangência</label>
                    <select name="abrangencia_geografica[${index}][tipo_abrangencia]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="Nacional">Nacional</option>
                        <option value="Regional">Regional</option>
                        <option value="Estadual">Estadual</option>
                        <option value="Interestadual">Interestadual</option>
                        <option value="Municipal">Municipal</option>
                        <option value="Intermunicipal">Intermunicipal</option>
                        <option value="Metropolitano">Metropolitano</option>
                        <option value="Internacional">Internacional</option>
                        <option value="Mercosul">Mercosul</option>
                        <option value="América do Sul">América do Sul</option>
                        <option value="Região Norte">Região Norte</option>
                        <option value="Região Nordeste">Região Nordeste</option>
                        <option value="Região Centro-Oeste">Região Centro-Oeste</option>
                        <option value="Região Sudeste">Região Sudeste</option>
                        <option value="Região Sul">Região Sul</option>
                        <option value="Eixo Rio-São Paulo">Eixo Rio-São Paulo</option>
                        <option value="Grande São Paulo">Grande São Paulo</option>
                        <option value="Grande Rio de Janeiro">Grande Rio de Janeiro</option>
                        <option value="Triângulo Mineiro">Triângulo Mineiro</option>
                        <option value="Vale do Paraíba">Vale do Paraíba</option>
                        <option value="Litoral">Litoral</option>
                        <option value="Interior">Interior</option>
                        <option value="Fronteira">Fronteira</option>
                        <option value="Zona Franca">Zona Franca</option>
                        <option value="Portuário">Portuário</option>
                        <option value="Aeroportuário">Aeroportuário</option>
                        <option value="Rodoviário">Rodoviário</option>
                        <option value="Ferroviário">Ferroviário</option>
                        <option value="Hidroviário">Hidroviário</option>
                        <option value="Multimodal">Multimodal</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Detalhes</label>
                    <textarea name="abrangencia_geografica[${index}][detalhes]" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: Estados atendidos, rotas específicas"></textarea>
                </div>
            `;
            container.appendChild(div);
        }

        function addFrota() {
            const container = document.getElementById("frota-container");
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-md relative';
            div.innerHTML = `
                <button type="button" onclick="this.parentNode.remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Frota</label>
                    <select name="frota[${index}][tipo_frota]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="Frota Própria">Frota Própria</option>
                        <option value="Frota Terceirizada">Frota Terceirizada</option>
                        <option value="Frota Mista">Frota Mista (Própria + Terceirizada)</option>
                        <option value="Frota Agregada">Frota Agregada</option>
                        <option value="Frota Alugada">Frota Alugada</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Veículo</label>
                    <select name="frota[${index}][tipo_veiculo]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="Caminhão Toco">Caminhão Toco</option>
                        <option value="Caminhão Truck">Caminhão Truck</option>
                        <option value="Carreta">Carreta (Cavalo Mecânico + Semirreboque)</option>
                        <option value="Bitrem">Bitrem</option>
                        <option value="Tritrem">Tritrem</option>
                        <option value="Rodotrem">Rodotrem</option>
                        <option value="Van">Van</option>
                        <option value="Furgão">Furgão</option>
                        <option value="Caminhonete">Caminhonete</option>
                        <option value="Utilitário">Utilitário</option>
                        <option value="VUC">VUC (Veículo Urbano de Carga)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Carroceria/Equipamento</label>
                    <select name="frota[${index}][tipo_carroceria]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="Baú Seco">Baú Seco</option>
                        <option value="Baú Refrigerado">Baú Refrigerado</option>
                        <option value="Graneleiro">Graneleiro</option>
                        <option value="Tanque">Tanque</option>
                        <option value="Prancha">Prancha/Prancha Rebaixada</option>
                        <option value="Sider">Sider</option>
                        <option value="Caçamba">Caçamba</option>
                        <option value="Porta Container">Porta Container</option>
                        <option value="Cegonheira">Cegonheira</option>
                        <option value="Munk">Munk (com guindaste)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Quantidade</label>
                    <input type="number" name="frota[${index}][quantidade]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Capacidade (toneladas)</label>
                    <input type="number" step="0.1" name="frota[${index}][capacidade]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ano Médio da Frota</label>
                    <input type="number" name="frota[${index}][ano_medio]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            `;
            container.appendChild(div);
        }

        function addArmazenagem() {
            const container = document.getElementById("armazenagem-container");
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-md relative';
            div.innerHTML = `
                <button type="button" onclick="this.parentNode.remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                <div class="md:col-span-2">
                    <label class="flex items-center">
                        <input type="checkbox" name="armazenagem[${index}][possui_armazem]" value="true" class="mr-2">
                        Possui Armazém?
                    </label>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Localização</label>
                    <input type="text" name="armazenagem[${index}][localizacao]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Capacidade (m²)</label>
                    <input type="number" step="0.01" name="armazenagem[${index}][capacidade_m2]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Capacidade (m³)</label>
                    <input type="number" step="0.01" name="armazenagem[${index}][capacidade_m3]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipos de Armazenagem</label>
                    <select name="armazenagem[${index}][tipos_armazenagem]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="Armazém Seco">Armazém Seco</option>
                        <option value="Armazém Refrigerado">Armazém Refrigerado</option>
                        <option value="Armazém Climatizado">Armazém Climatizado</option>
                        <option value="Armazém para Produtos Perigosos">Armazém para Produtos Perigosos</option>
                        <option value="Armazém Alfandegado">Armazém Alfandegado</option>
                        <option value="Armazém Geral">Armazém Geral</option>
                        <option value="Silo">Silo</option>
                        <option value="Tanque de Armazenagem">Tanque de Armazenagem</option>
                        <option value="Pátio Descoberto">Pátio Descoberto</option>
                        <option value="Galpão Industrial">Galpão Industrial</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Serviços Oferecidos</label>
                    <select name="armazenagem[${index}][servicos_oferecidos]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="Cross-docking">Cross-docking</option>
                        <option value="Picking">Picking</option>
                        <option value="Packing">Packing</option>
                        <option value="Etiquetagem">Etiquetagem</option>
                        <option value="Paletização">Paletização</option>
                        <option value="Conferência">Conferência</option>
                        <option value="Inventário">Inventário</option>
                        <option value="Controle de Estoque">Controle de Estoque</option>
                        <option value="Separação de Pedidos">Separação de Pedidos</option>
                        <option value="Consolidação de Cargas">Consolidação de Cargas</option>
                    </select>
                </div>
            `;
            container.appendChild(div);
        }

        function addPortoTerminal() {
            const container = document.getElementById("portos-terminais-container");
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-md relative';
            div.innerHTML = `
                <button type="button" onclick="this.parentNode.remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Porto/Terminal</label>
                    <select name="portos_terminais[${index}][nome_porto_terminal]" class="porto-select w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="atualizarTerminais(this, ${index})">
                        <option value="">Selecione...</option>
                        <option value="Ponta da Madeira (Maranhão)">Ponta da Madeira (Maranhão)</option>
                        <option value="Porto da Alumar (Maranhão)">Porto da Alumar (Maranhão)</option>
                        <option value="Porto de Angra dos Reis (Rio de Janeiro)">Porto de Angra dos Reis (Rio de Janeiro)</option>
                        <option value="Porto de Antonina (Paraná)">Porto de Antonina (Paraná)</option>
                        <option value="Porto de Aratu (Bahia)">Porto de Aratu (Bahia)</option>
                        <option value="Porto de Areia Branca (Rio Grande do Norte)">Porto de Areia Branca (Rio Grande do Norte)</option>
                        <option value="Porto de Barra do Riacho (Espírito Santo)">Porto de Barra do Riacho (Espírito Santo)</option>
                        <option value="Porto de Barra dos Coqueiros (Sergipe)">Porto de Barra dos Coqueiros (Sergipe)</option>
                        <option value="Porto de Belém (Pará)">Porto de Belém (Pará)</option>
                        <option value="Porto de Cabedelo (Paraíba)">Porto de Cabedelo (Paraíba)</option>
                        <option value="Porto de Ilhéus (Bahia)">Porto de Ilhéus (Bahia)</option>
                        <option value="Porto de Imbituba (Santa Catarina)">Porto de Imbituba (Santa Catarina)</option>
                        <option value="Porto de Itaguaí (Rio de Janeiro)">Porto de Itaguaí (Rio de Janeiro)</option>
                        <option value="Porto de Itajaí (Santa Catarina)">Porto de Itajaí (Santa Catarina)</option>
                        <option value="Porto de Itapoá (Santa Catarina)">Porto de Itapoá (Santa Catarina)</option>
                        <option value="Porto de Jaraguá (Alagoas)">Porto de Jaraguá (Alagoas)</option>
                        <option value="Porto de Natal (Rio Grande do Norte)">Porto de Natal (Rio Grande do Norte)</option>
                        <option value="Porto de Navegantes (Santa Catarina)">Porto de Navegantes (Santa Catarina)</option>
                        <option value="Porto de Niterói (Rio de Janeiro)">Porto de Niterói (Rio de Janeiro)</option>
                        <option value="Porto de Paranaguá (Paraná)">Porto de Paranaguá (Paraná)</option>
                        <option value="Porto do Pecém (Ceará)">Porto do Pecém (Ceará)</option>
                        <option value="Porto de Rio Grande (Rio Grande do Sul)">Porto de Rio Grande (Rio Grande do Sul)</option>
                        <option value="Porto de Salvador (Bahia)">Porto de Salvador (Bahia)</option>
                        <option value="Porto de Macapá (Amapá)">Porto de Macapá (Amapá)</option>
                        <option value="Porto de Santos (São Paulo)">Porto de Santos (São Paulo)</option>
                        <option value="Porto de São Francisco do Sul (Santa Catarina)">Porto de São Francisco do Sul (Santa Catarina)</option>
                        <option value="Porto de São Sebastião (São Paulo)">Porto de São Sebastião (São Paulo)</option>
                        <option value="Porto de Suape (Pernambuco)">Porto de Suape (Pernambuco)</option>
                        <option value="Porto de Tubarão (Espírito Santo)">Porto de Tubarão (Espírito Santo)</option>
                        <option value="Porto de Vila do Conde (Pará)">Porto de Vila do Conde (Pará)</option>
                        <option value="Porto de Vitória (Espírito Santo)">Porto de Vitória (Espírito Santo)</option>
                        <option value="Porto do Açu (Rio de Janeiro)">Porto do Açu (Rio de Janeiro)</option>
                        <option value="Porto do Forno (Rio de Janeiro)">Porto do Forno (Rio de Janeiro)</option>
                        <option value="Porto do Itaqui (Maranhão)">Porto do Itaqui (Maranhão)</option>
                        <option value="Porto do Mucuripe (Ceará)">Porto do Mucuripe (Ceará)</option>
                        <option value="Porto do Recife (Pernambuco)">Porto do Recife (Pernambuco)</option>
                        <option value="Porto do Rio de Janeiro (Rio de Janeiro)">Porto do Rio de Janeiro (Rio de Janeiro)</option>
                        <option value="Porto Pesqueiro de Laguna (Santa Catarina)">Porto Pesqueiro de Laguna (Santa Catarina)</option>
                        <option value="Porto Piauí (Piauí)">Porto Piauí (Piauí)</option>
                        <option value="Porto Sudeste (Rio de Janeiro)">Porto Sudeste (Rio de Janeiro)</option>
                        <option value="Terminal de Miramar (Pará)">Terminal de Miramar (Pará)</option>
                        <option value="Terminal de Praia Mole (Espírito Santo)">Terminal de Praia Mole (Espírito Santo)</option>
                        <option value="Porto de Cáceres (Mato Grosso)">Porto de Cáceres (Mato Grosso)</option>
                        <option value="Porto de Cachoeira do Sul (Rio Grande do Sul)">Porto de Cachoeira do Sul (Rio Grande do Sul)</option>
                        <option value="Porto de Caracaraí (Roraima)">Porto de Caracaraí (Roraima)</option>
                        <option value="Porto de Charqueadas (Rio Grande do Sul)">Porto de Charqueadas (Rio Grande do Sul)</option>
                        <option value="Porto de Corumbá (Mato Grosso do Sul)">Porto de Corumbá (Mato Grosso do Sul)</option>
                        <option value="Porto de Eirunepé (Amazonas)">Porto de Eirunepé (Amazonas)</option>
                        <option value="Porto de Estrela (Rio Grande do Sul)">Porto de Estrela (Rio Grande do Sul)</option>
                        <option value="Terminal de Itacoatiara (Amazonas)">Terminal de Itacoatiara (Amazonas)</option>
                        <option value="Porto de Juazeiro (Bahia)">Porto de Juazeiro (Bahia)</option>
                        <option value="Porto de Ladário (Mato Grosso do Sul)">Porto de Ladário (Mato Grosso do Sul)</option>
                        <option value="Porto de Manaus (Amazonas)">Porto de Manaus (Amazonas)</option>
                        <option value="Porto de Pelotas (Rio Grande do Sul)">Porto de Pelotas (Rio Grande do Sul)</option>
                        <option value="Porto de Parintins (Amazonas)">Porto de Parintins (Amazonas)</option>
                        <option value="Porto de Petrolina (Pernambuco)">Porto de Petrolina (Pernambuco)</option>
                        <option value="Porto de Pirapora (Minas Gerais)">Porto de Pirapora (Minas Gerais)</option>
                        <option value="Porto de Porto Alegre (Rio Grande do Sul)">Porto de Porto Alegre (Rio Grande do Sul)</option>
                        <option value="Porto de Porto Murtinho (Mato Grosso do Sul)">Porto de Porto Murtinho (Mato Grosso do Sul)</option>
                        <option value="Porto de Porto Velho (Rondônia)">Porto de Porto Velho (Rondônia)</option>
                        <option value="Porto Internacional de Porto Xavier (Rio Grande do Sul)">Porto Internacional de Porto Xavier (Rio Grande do Sul)</option>
                        <option value="Porto de Santana (Amapá)">Porto de Santana (Amapá)</option>
                        <option value="Porto de Santarém (Pará)">Porto de Santarém (Pará)</option>
                        <option value="Porto de Tabatinga (Amazonas)">Porto de Tabatinga (Amazonas)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Terminal</label>
                    <select name="portos_terminais[${index}][tipo_terminal]" class="terminal-select w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione primeiro o porto...</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <button type="button" onclick="adicionarTerminalAoPorto(${index})" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Adicionar Outro Terminal a Este Porto
                    </button>
                </div>
                <div class="terminais-adicionais md:col-span-2" id="terminais-adicionais-${index}">
                    <!-- Terminais adicionais serão adicionados aqui -->
                </div>
            `;
            container.appendChild(div);
        }

        function addSeguroCobertura() {
            const container = document.getElementById("seguros-coberturas-container");
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-md relative';
            div.innerHTML = `
                <button type="button" onclick="this.parentNode.remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Seguro</label>
                    <select name="seguros_coberturas[${index}][tipo_seguro]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="RCTR-C">RCTR-C (Responsabilidade Civil do Transportador Rodoviário de Cargas)</option>
                        <option value="RC-V">RC-V (Responsabilidade Civil de Veículo)</option>
                        <option value="SPVAT">SPVAT (Seguro de Proteção de Veículos Automotores Terrestres)</option>
                        <option value="RCF-DC">RCF-DC (Responsabilidade Civil Facultativa - Desaparecimento de Carga)</option>
                        <option value="Seguro de Transporte Nacional">Seguro de Transporte Nacional</option>
                        <option value="RCTR-VI">RCTR-VI (Responsabilidade Civil do Transportador Rodoviário - Viagem Internacional)</option>
                        <option value="Seguro de Carga">Seguro de Carga</option>
                        <option value="Seguro de Frota">Seguro de Frota</option>
                        <option value="Seguro de Responsabilidade Civil Geral">Seguro de Responsabilidade Civil Geral</option>
                        <option value="Seguro de Vida para Motoristas">Seguro de Vida para Motoristas</option>
                        <option value="Seguro de Acidentes Pessoais">Seguro de Acidentes Pessoais</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Seguradora</label>
                    <input type="text" name="seguros_coberturas[${index}][seguradora]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor da Cobertura</label>
                    <input type="text" name="seguros_coberturas[${index}][valor_cobertura]" class="valor-cobertura w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="R$ 0,00">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data de Validade</label>
                    <input type="date" name="seguros_coberturas[${index}][data_validade]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            `;
            container.appendChild(div);
            
            // Adicionar formatação automática para o campo de valor da cobertura
            const valorInput = div.querySelector('.valor-cobertura');
            valorInput.addEventListener('input', function(e) {
                formatarValorCobertura(e.target);
            });
        }

        function addTecnologia() {
            const container = document.getElementById("tecnologias-container");
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-md relative';
            div.innerHTML = `
                <button type="button" onclick="this.parentNode.remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Tecnologia</label>
                    <select name="tecnologias[${index}][nome_tecnologia]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="TMS">TMS (Transportation Management System)</option>
                        <option value="WMS">WMS (Warehouse Management System)</option>
                        <option value="ERP">ERP (Enterprise Resource Planning)</option>
                        <option value="CRM">CRM (Customer Relationship Management)</option>
                        <option value="BI">BI (Business Intelligence)</option>
                        <option value="EDI">EDI (Electronic Data Interchange)</option>
                        <option value="GPS">GPS (Sistema de Posicionamento Global)</option>
                        <option value="RFID">RFID (Identificação por Radiofrequência)</option>
                        <option value="IoT">IoT (Internet das Coisas)</option>
                        <option value="Telemetria">Telemetria</option>
                        <option value="Monitoramento por Satélite">Monitoramento por Satélite</option>
                        <option value="Rastreamento em Tempo Real">Rastreamento em Tempo Real</option>
                        <option value="Cerca Eletrônica">Cerca Eletrônica (Geofencing)</option>
                        <option value="Rádio Comunicação">Rádio Comunicação</option>
                        <option value="Telefonia Móvel">Telefonia Móvel</option>
                        <option value="Internet Móvel">Internet Móvel</option>
                        <option value="Comunicação por Satélite">Comunicação por Satélite</option>
                        <option value="Sistema de Emergência">Sistema de Emergência</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Detalhes</label>
                    <textarea name="tecnologias[${index}][detalhes]" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
            `;
            container.appendChild(div);
        }

        function addDesempenhoQualidade() {
            const container = document.getElementById("desempenho-qualidade-container");
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-md relative';
            div.innerHTML = `
                <button type="button" onclick="this.parentNode.remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Prazo Médio de Atendimento</label>
                    <div class="flex gap-2">
                        <input type="text" step="0.01" name="desempenho_qualidade[${index}][prazo_medio_atendimento]" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: 5">
                        <select name="desempenho_qualidade[${index}][unidade_prazo]" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="horas">horas</option>
                            <option value="dias">dias</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Índice de Avarias/Extravios (%)</label>
                    <input type="number" step="0.01" name="desempenho_qualidade[${index}][indice_avarias_extravios]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Índice de Entregas no Prazo (%)</label>
                    <input type="number" step="0.01" name="desempenho_qualidade[${index}][indice_entregas_prazo]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            `;
            container.appendChild(div);
        }

        function addClienteSegmento() {
            const container = document.getElementById("clientes-segmentos-container");
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-md relative';
            div.innerHTML = `
                <button type="button" onclick="this.parentNode.remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Segmento</label>
                    <select name="clientes_segmentos[${index}][segmento]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="Indústria Automobilística">Indústria Automobilística</option>
                        <option value="Indústria Alimentícia">Indústria Alimentícia</option>
                        <option value="Indústria Química">Indústria Química</option>
                        <option value="Indústria Farmacêutica">Indústria Farmacêutica</option>
                        <option value="Indústria Têxtil">Indústria Têxtil</option>
                        <option value="Indústria Metalúrgica">Indústria Metalúrgica</option>
                        <option value="Indústria de Papel e Celulose">Indústria de Papel e Celulose</option>
                        <option value="Indústria Petroquímica">Indústria Petroquímica</option>
                        <option value="Indústria de Bebidas">Indústria de Bebidas</option>
                        <option value="Indústria de Cosméticos">Indústria de Cosméticos</option>
                        <option value="Varejo">Varejo</option>
                        <option value="E-commerce">E-commerce</option>
                        <option value="Atacado">Atacado</option>
                        <option value="Supermercados">Supermercados</option>
                        <option value="Shopping Centers">Shopping Centers</option>
                        <option value="Distribuidoras">Distribuidoras</option>
                        <option value="Importadores/Exportadores">Importadores/Exportadores</option>
                        <option value="Agronegócio">Agronegócio</option>
                        <option value="Mineração">Mineração</option>
                        <option value="Construção Civil">Construção Civil</option>
                        <option value="Energia">Energia</option>
                        <option value="Telecomunicações">Telecomunicações</option>
                        <option value="Saúde">Saúde</option>
                        <option value="Educação">Educação</option>
                        <option value="Governo">Governo</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Principais Clientes</label>
                    <textarea name="clientes_segmentos[${index}][principais_clientes]" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: Empresa A, Empresa B"></textarea>
                </div>
            `;
            container.appendChild(div);
        }

        function addRecursoHumano() {
            const container = document.getElementById("recursos-humanos-container");
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-md relative';
            div.innerHTML = `
                <button type="button" onclick="this.parentNode.remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Número de Funcionários</label>
                    <input type="number" name="recursos_humanos[${index}][numero_funcionarios]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Programas de Treinamento</label>
                    <textarea name="recursos_humanos[${index}][programas_treinamento]" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: Direção defensiva, Produtos perigosos"></textarea>
                </div>
            `;
            container.appendChild(div);
        }

        function addSustentabilidade() {
            const container = document.getElementById("sustentabilidade-container");
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-md relative';
            div.innerHTML = `
                <button type="button" onclick="this.parentNode.remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Certificação Ambiental</label>
                    <select name="sustentabilidade[${index}][certificacao_ambiental]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="ISO 14001">ISO 14001 (Sistema de Gestão Ambiental)</option>
                        <option value="Selo Verde">Selo Verde</option>
                        <option value="Certificação LEED">Certificação LEED</option>
                        <option value="Certificação AQUA">Certificação AQUA</option>
                        <option value="Programa Brasileiro GHG Protocol">Programa Brasileiro GHG Protocol</option>
                        <option value="Carbon Trust">Carbon Trust</option>
                        <option value="Certificação FSC">Certificação FSC (Forest Stewardship Council)</option>
                        <option value="Certificação PEFC">Certificação PEFC (Programme for the Endorsement of Forest Certification)</option>
                        <option value="Certificação Cradle to Cradle">Certificação Cradle to Cradle</option>
                        <option value="Certificação BREEAM">Certificação BREEAM</option>
                        <option value="Programa de Redução de Emissões">Programa de Redução de Emissões</option>
                        <option value="Programa de Eficiência Energética">Programa de Eficiência Energética</option>
                        <option value="Programa de Gestão de Resíduos">Programa de Gestão de Resíduos</option>
                        <option value="Programa de Uso Racional da Água">Programa de Uso Racional da Água</option>
                        <option value="Programa de Biodiesel">Programa de Biodiesel</option>
                        <option value="Programa de Renovação de Frota">Programa de Renovação de Frota</option>
                        <option value="Programa de Compensação de Carbono">Programa de Compensação de Carbono</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Programas de Redução de Emissões</label>
                    <textarea name="sustentabilidade[${index}][programas_reducao_emissoes]" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: Frota Euro 5/6, Biodiesel"></textarea>
                </div>
            `;
            container.appendChild(div);
        }
        
        // Função para limpar formulário de cadastro
        function limparFormularioCadastro() {
            console.log('Limpando formulário de cadastro...');
            
            // Limpar campos básicos
            const form = document.getElementById('form-cadastro');
            if (form) {
                form.reset();
            }
            
            // Limpar campos dinâmicos
            limparCamposDinamicos();
            
            // Resetar estado de edição
            resetarFormulario();
        }
        
        // Função para formatar valor da cobertura
        function formatarValorCobertura(input) {
            let valor = input.value;
            
            // Remove tudo que não é número
            valor = valor.replace(/\D/g, '');
            
            // Se não há valor, limpa o campo
            if (!valor) {
                input.value = '';
                return;
            }
            
            // Converte para número e formata
            const numero = parseInt(valor);
            
            // Formata como moeda brasileira
            const formatado = new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2
            }).format(numero / 100);
            
            input.value = formatado;
        }
        
        // Função para atualizar opções de terminais baseado no porto selecionado
        function atualizarTerminais(portoSelect, index) {
            const terminalSelect = portoSelect.parentNode.parentNode.querySelector('.terminal-select');
            const porto = portoSelect.value;
            
            // Limpar opções existentes
            terminalSelect.innerHTML = '<option value="">Selecione...</option>';
            
            // Adicionar opções baseadas no porto selecionado
            const terminaisComuns = [
                'Terminal de Contêineres',
                'Terminal de Granéis Sólidos', 
                'Terminal de Granéis Líquidos',
                'Terminal de Carga Geral',
                'Terminal Roll-on/Roll-off',
                'Terminal Marítimo',
                'Terminal Intermodal',
                'Terminal de Transbordo'
            ];
            
            terminaisComuns.forEach(terminal => {
                const option = document.createElement('option');
                option.value = terminal;
                option.textContent = terminal;
                terminalSelect.appendChild(option);
            });
        }
        
        // Função para adicionar terminal adicional ao mesmo porto
        function adicionarTerminalAoPorto(portoIndex) {
            const portoDiv = document.querySelector(`#portos-terminais-container > div:nth-child(${portoIndex + 1})`);
            const portoSelect = portoDiv.querySelector('.porto-select');
            const porto = portoSelect.value;
            
            if (!porto) {
                alert('Selecione primeiro um porto antes de adicionar terminais adicionais.');
                return;
            }
            
            const terminaisContainer = document.getElementById(`terminais-adicionais-${portoIndex}`);
            const terminalIndex = terminaisContainer.children.length;
            
            const terminalDiv = document.createElement('div');
            terminalDiv.className = 'flex gap-4 items-center p-2 bg-blue-50 rounded-md mb-2';
            terminalDiv.innerHTML = `
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Terminal Adicional</label>
                    <select name="portos_terminais[${portoIndex}_${terminalIndex}][tipo_terminal]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione...</option>
                        <option value="Terminal de Contêineres">Terminal de Contêineres</option>
                        <option value="Terminal de Granéis Sólidos">Terminal de Granéis Sólidos</option>
                        <option value="Terminal de Granéis Líquidos">Terminal de Granéis Líquidos</option>
                        <option value="Terminal de Carga Geral">Terminal de Carga Geral</option>
                        <option value="Terminal Roll-on/Roll-off">Terminal Roll-on/Roll-off</option>
                        <option value="Terminal Marítimo">Terminal Marítimo</option>
                        <option value="Terminal Intermodal">Terminal Intermodal</option>
                        <option value="Terminal de Transbordo">Terminal de Transbordo</option>
                    </select>
                    <input type="hidden" name="portos_terminais[${portoIndex}_${terminalIndex}][nome_porto_terminal]" value="${porto}">
                </div>
                <button type="button" onclick="this.parentNode.remove()" class="text-red-500 hover:text-red-700">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            terminaisContainer.appendChild(terminalDiv);
        }
    </script>

    <!-- Analytics Dashboard Scripts -->
    <script>
        // Dados para os gráficos (serão carregados via API)
        let analyticsData = {
            empresasPorRegiao: [],
            tiposCarga: [],
            crescimentoMensal: [],
            certificacoes: []
        };

        // Variáveis para controle dos gráficos
        let graficosRenderizados = false;
        let graficosInstancias = {};

        // Função para carregar dados analytics
        async function carregarDadosAnalytics() {
            console.log('🔄 Carregando dados analytics...');
            
            // Verificar se já está carregando
            if (window.carregandoAnalytics) {
                console.log('⏳ Já está carregando analytics, aguardando...');
                return;
            }
            
            window.carregandoAnalytics = true;
            
            try {
                const response = await fetch('/api/analytics');
                if (response.ok) {
                    analyticsData = await response.json();
                    console.log('✅ Dados da API carregados:', analyticsData);
                } else {
                    console.log('⚠️ Erro na API, usando dados de exemplo:', response.status);
                    await carregarDadosReais();
                }
            } catch (error) {
                console.log('⚠️ Erro na API, usando dados de exemplo:', error.message);
                await carregarDadosReais();
            }
            
            console.log('📊 Dados de exemplo carregados:', analyticsData);
            
            // Aguardar um pouco antes de renderizar
            setTimeout(() => {
                console.log('🎨 Renderizando gráficos...');
                renderizarGraficos();
                window.carregandoAnalytics = false;
            }, 500);
        }

               // Função para carregar dados reais da API
        async function carregarDadosReais() {
            try {
                const response = await fetch('/api/analytics');
                if (response.ok) {
                    const data = await response.json();
                    analyticsData = data;
                } else {
                    console.error('Erro ao carregar dados da API');
                    // Em caso de erro, manter dados vazios
                    analyticsData = {
                        empresasPorRegiao: [],
                        tiposCarga: [],
                        crescimentoMensal: [],
                        certificacoes: []
                    };
                }
            } catch (error) {
                console.error('Erro ao conectar com a API:', error);
                // Em caso de erro, manter dados vazios
                analyticsData = {
                    empresasPorRegiao: [],
                    tiposCarga: [],
                    crescimentoMensal: [],
                    certificacoes: []
                };
            }
        }

        // Função para destruir gráficos anteriores
        function destruirGraficosAnteriores() {
            console.log('🧹 Destruindo gráficos anteriores...');
            
            // Destruir instâncias do Chart.js
            Object.keys(graficosInstancias).forEach(key => {
                if (graficosInstancias[key]) {
                    graficosInstancias[key].destroy();
                    delete graficosInstancias[key];
                }
            });
            
            // Limpar canvas
            const canvasIds = ['chart-empresas-regiao', 'chart-tipos-carga', 'chart-crescimento', 'chart-certificacoes'];
            canvasIds.forEach(id => {
                const canvas = document.getElementById(id);
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    // Resetar tamanho do canvas
                    canvas.width = canvas.offsetWidth;
                    canvas.height = 300;
                    canvas.style.height = '300px';
                    canvas.style.width = '100%';
                }
            });
            
            graficosRenderizados = false;
            console.log('✅ Gráficos anteriores destruídos');
        }

        // Função para renderizar todos os gráficos
        function renderizarGraficos() {
            // Verificar se já foram renderizados
            if (graficosRenderizados) {
                console.log('⚠️ Gráficos já renderizados, ignorando...');
                return;
            }
            
            console.log('🎨 Iniciando renderização dos gráficos...');
            
            // Destruir gráficos anteriores primeiro
            destruirGraficosAnteriores();
            
            // Aguardar um pouco antes de renderizar novos
            setTimeout(() => {
                renderizarGraficoRegiao();
                renderizarGraficoTiposCarga();
                renderizarGraficoCrescimento();
                renderizarGraficoCertificacoes();
                carregarMetricasDetalhadas();
                
                graficosRenderizados = true;
                console.log('✅ Todos os gráficos renderizados!');
            }, 100);
        }

        // Gráfico de Pizza - Empresas por Região
        function renderizarGraficoRegiao() {
            const canvas = document.getElementById('chart-empresas-regiao');
            if (!canvas) return;
            
            // Definir tamanho fixo
            canvas.width = canvas.offsetWidth;
            canvas.height = 300;
            canvas.style.height = '300px';
            
            const ctx = canvas.getContext('2d');
            
            graficosInstancias['regiao'] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: analyticsData.empresasPorRegiao.map(item => item.regiao),
                    datasets: [{
                        data: analyticsData.empresasPorRegiao.map(item => item.empresas),
                        backgroundColor: ['#10B981', '#3B82F6', '#F59E0B', '#EF4444', '#8B5CF6'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((context.parsed * 100) / total);
                                    return `${context.label}: ${context.parsed} empresas (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Gráfico de Barras - Tipos de Carga
        function renderizarGraficoTiposCarga() {
            const canvas = document.getElementById('chart-tipos-carga');
            if (!canvas) return;
            
            // Definir tamanho fixo
            canvas.width = canvas.offsetWidth;
            canvas.height = 300;
            canvas.style.height = '300px';
            
            const ctx = canvas.getContext('2d');
            
            graficosInstancias['tiposCarga'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: analyticsData.tiposCarga.map(item => item.tipo),
                    datasets: [{
                        label: 'Quantidade de Empresas',
                        data: analyticsData.tiposCarga.map(item => item.quantidade),
                        backgroundColor: '#10B981',
                        borderColor: '#059669',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#E5E7EB'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // Gráfico de Linha - Crescimento Mensal
        function renderizarGraficoCrescimento() {
            const canvas = document.getElementById('chart-crescimento');
            if (!canvas) return;
            
            // Definir tamanho fixo
            canvas.width = canvas.offsetWidth;
            canvas.height = 300;
            canvas.style.height = '300px';
            
            const ctx = canvas.getContext('2d');
            
            graficosInstancias['crescimento'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: analyticsData.crescimentoMensal.map(item => item.mes),
                    datasets: [{
                        label: 'Total de Empresas',
                        data: analyticsData.crescimentoMensal.map(item => item.empresas),
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#3B82F6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: '#E5E7EB'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Gráfico de Barras Horizontais - Certificações
        function renderizarGraficoCertificacoes() {
            const canvas = document.getElementById('chart-certificacoes');
            if (!canvas) return;
            
            // Definir tamanho fixo
            canvas.width = canvas.offsetWidth;
            canvas.height = 300;
            canvas.style.height = '300px';
            
            const ctx = canvas.getContext('2d');
            
            graficosInstancias['certificacoes'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: analyticsData.certificacoes.map(item => item.certificacao),
                    datasets: [{
                        label: 'Quantidade de Empresas',
                        data: analyticsData.certificacoes.map(item => item.quantidade),
                        backgroundColor: '#F59E0B',
                        borderColor: '#D97706',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                color: '#E5E7EB'
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Carregar métricas detalhadas na tabela
        function carregarMetricasDetalhadas() {
            fetch("/api/analytics")
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById("metricas-tabela");
                    tbody.innerHTML = "";

                    if (data.metricas_detalhadas) {
                        data.metricas_detalhadas.forEach(metrica => {
                            const row = document.createElement("tr");
                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${metrica.metrica}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold">${metrica.valor}</td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                })
                .catch(error => console.error("Erro ao carregar métricas detalhadas:", error));
        }

        // Funções de exportação de relatórios
        document.getElementById('btn-export-pdf').addEventListener('click', function() {
            exportarRelatorioPDF();
        });

        document.getElementById('btn-export-excel').addEventListener('click', function() {
            exportarRelatorioExcel();
        });

        // Exportar relatório em PDF
        async function exportarRelatorioPDF() {
            try {
                // Mostrar loading
                const btn = document.getElementById('btn-export-pdf');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Gerando PDF...';
                btn.disabled = true;

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // Título do relatório
                pdf.setFontSize(20);
                pdf.setTextColor(40, 40, 40);
                pdf.text('Relatório Analytics - BRCCSiS', 20, 30);
                
                // Data do relatório
                const hoje = new Date().toLocaleDateString('pt-BR');
                pdf.setFontSize(12);
                pdf.setTextColor(100, 100, 100);
                pdf.text(`Gerado em: ${hoje}`, 20, 40);

                // Buscar métricas avançadas
                const response = await fetch('/api/metricas-avancadas');
                const metricas = await response.json();

                // Seção de métricas gerais
                pdf.setFontSize(16);
                pdf.setTextColor(40, 40, 40);
                pdf.text('Métricas Gerais', 20, 60);
                
                pdf.setFontSize(12);
                let yPos = 75;
                
                const metricasTexto = [
                    `Total de Empresas: ${metricas.total_empresas}`,
                    `Taxa de Certificação: ${metricas.taxa_certificacao}%`,
                    `Cobertura Nacional: ${metricas.cobertura_nacional}%`,
                    `Empresas com Armazenagem: ${metricas.taxa_armazenagem}%`,
                    `Diversificação de Carga: ${metricas.diversificacao_carga}`,
                    `Estados Cobertos: ${metricas.estados_cobertos}/27`
                ];

                metricasTexto.forEach(texto => {
                    pdf.text(texto, 25, yPos);
                    yPos += 10;
                });

                // Seção de distribuição por região
                pdf.setFontSize(16);
                pdf.text('Distribuição por Região', 20, yPos + 15);
                yPos += 30;

                analyticsData.empresasPorRegiao.forEach(regiao => {
                    pdf.setFontSize(12);
                    pdf.text(`${regiao.regiao}: ${regiao.empresas} empresas (${regiao.porcentagem}%)`, 25, yPos);
                    yPos += 8;
                });

                // Nova página para tipos de carga
                pdf.addPage();
                yPos = 30;
                
                pdf.setFontSize(16);
                pdf.text('Tipos de Carga Mais Comuns', 20, yPos);
                yPos += 15;

                analyticsData.tiposCarga.forEach(tipo => {
                    pdf.setFontSize(12);
                    pdf.text(`${tipo.tipo}: ${tipo.quantidade} empresas`, 25, yPos);
                    yPos += 8;
                });

                // Seção de certificações
                yPos += 20;
                pdf.setFontSize(16);
                pdf.text('Certificações Mais Utilizadas', 20, yPos);
                yPos += 15;

                analyticsData.certificacoes.forEach(cert => {
                    pdf.setFontSize(12);
                    pdf.text(`${cert.certificacao}: ${cert.quantidade} empresas`, 25, yPos);
                    yPos += 8;
                });

                // Rodapé
                const totalPages = pdf.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    pdf.setPage(i);
                    pdf.setFontSize(10);
                    pdf.setTextColor(150, 150, 150);
                    pdf.text(`Página ${i} de ${totalPages}`, 170, 285);
                    pdf.text('BRCCSiS - Sistema de Empresas Logísticas', 20, 285);
                }

                // Salvar PDF
                pdf.save(`relatorio-analytics-${hoje.replace(/\//g, '-')}.pdf`);

                // Restaurar botão
                btn.innerHTML = originalText;
                btn.disabled = false;

                // Mostrar mensagem de sucesso
                alert('Relatório PDF gerado com sucesso!');

            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('Erro ao gerar relatório PDF. Tente novamente.');
                
                // Restaurar botão
                const btn = document.getElementById('btn-export-pdf');
                btn.innerHTML = '<i class="fas fa-file-pdf mr-2"></i>PDF';
                btn.disabled = false;
            }
        }

        // Exportar relatório em Excel
        async function exportarRelatorioExcel() {
            try {
                // Mostrar loading
                const btn = document.getElementById('btn-export-excel');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Gerando Excel...';
                btn.disabled = true;

                // Buscar métricas avançadas
                const response = await fetch('/api/metricas-avancadas');
                const metricas = await response.json();

                // Criar workbook
                const wb = XLSX.utils.book_new();

                // Aba 1: Resumo Executivo
                const resumoData = [
                    ['Relatório Analytics - BRCCSiS', '', ''],
                    ['Gerado em:', new Date().toLocaleDateString('pt-BR'), ''],
                    ['', '', ''],
                    ['MÉTRICAS GERAIS', '', ''],
                    ['Total de Empresas', metricas.total_empresas, ''],
                    ['Taxa de Certificação', metricas.taxa_certificacao + '%', ''],
                    ['Cobertura Nacional', metricas.cobertura_nacional + '%', ''],
                    ['Empresas com Armazenagem', metricas.taxa_armazenagem + '%', ''],
                    ['Diversificação de Carga', metricas.diversificacao_carga, ''],
                    ['Estados Cobertos', metricas.estados_cobertos + '/27', '']
                ];

                const wsResumo = XLSX.utils.aoa_to_sheet(resumoData);
                XLSX.utils.book_append_sheet(wb, wsResumo, 'Resumo Executivo');

                // Aba 2: Distribuição por Região
                const regiaoData = [
                    ['Região', 'Empresas', 'Porcentagem'],
                    ...analyticsData.empresasPorRegiao.map(r => [r.regiao, r.empresas, r.porcentagem + '%'])
                ];

                const wsRegiao = XLSX.utils.aoa_to_sheet(regiaoData);
                XLSX.utils.book_append_sheet(wb, wsRegiao, 'Por Região');

                // Aba 3: Tipos de Carga
                const cargaData = [
                    ['Tipo de Carga', 'Quantidade de Empresas'],
                    ...analyticsData.tiposCarga.map(t => [t.tipo, t.quantidade])
                ];

                const wsCarga = XLSX.utils.aoa_to_sheet(cargaData);
                XLSX.utils.book_append_sheet(wb, wsCarga, 'Tipos de Carga');

                // Aba 4: Certificações
                const certData = [
                    ['Certificação', 'Quantidade de Empresas'],
                    ...analyticsData.certificacoes.map(c => [c.certificacao, c.quantidade])
                ];

                const wsCert = XLSX.utils.aoa_to_sheet(certData);
                XLSX.utils.book_append_sheet(wb, wsCert, 'Certificações');

                // Aba 5: Crescimento Mensal
                const crescimentoData = [
                    ['Mês', 'Total de Empresas'],
                    ...analyticsData.crescimentoMensal.map(c => [c.mes, c.empresas])
                ];

                const wsCrescimento = XLSX.utils.aoa_to_sheet(crescimentoData);
                XLSX.utils.book_append_sheet(wb, wsCrescimento, 'Crescimento Mensal');

                // Salvar arquivo
                const hoje = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
                XLSX.writeFile(wb, `relatorio-analytics-${hoje}.xlsx`);

                // Restaurar botão
                btn.innerHTML = originalText;
                btn.disabled = false;

                // Mostrar mensagem de sucesso
                alert('Relatório Excel gerado com sucesso!');

            } catch (error) {
                console.error('Erro ao gerar Excel:', error);
                alert('Erro ao gerar relatório Excel. Tente novamente.');
                
                // Restaurar botão
                const btn = document.getElementById('btn-export-excel');
                btn.innerHTML = '<i class="fas fa-file-excel mr-2"></i>Excel';
                btn.disabled = false;
            }
        }
    </script>

    <!-- Modal de Cotação -->
    <div id="modal-cotacao" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 fade-in max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-calculator mr-2 text-orange-600"></i>
                        Solicitar Cotação
                    </h3>
                    <button id="fechar-modal-cotacao" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <form id="form-cotacao" class="space-y-6">
                    <!-- Empresa de Transporte -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Empresa de Transporte</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-100">
                                <input type="radio" name="empresa_transporte" value="brcargo_rodoviario" checked class="mr-3">
                                <div>
                                    <div class="font-semibold text-green-600">BRCargo Rodoviário</div>
                                    <div class="text-sm text-gray-500">Disponível</div>
                                </div>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-100">
                                <input type="radio" name="empresa_transporte" value="brcargo_maritimo" class="mr-3">
                                <div>
                                    <div class="font-semibold text-blue-600">BRCargo Marítimo</div>
                                    <div class="text-sm text-gray-500">Disponível</div>
                                </div>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-100">
                                <input type="radio" name="empresa_transporte" value="frete_aereo" class="mr-3">
                                <div>
                                    <div class="font-semibold text-purple-600">Frete Aéreo</div>
                                    <div class="text-sm text-gray-500">Disponível</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Campos Específicos para BRCargo Marítimo -->
                    <div id="campos-maritimo" class="hidden">
                        <!-- Dados do Cliente Marítimo -->
                        <div class="bg-blue-50 p-4 rounded-lg mb-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">
                                <i class="fas fa-user-tie mr-2 text-blue-600"></i>
                                Dados do Cliente (Transporte Marítimo)
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Número do Cliente *</label>
                                    <input type="text" name="maritimo_numero_cliente" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: CLI001">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Razão Social *</label>
                                    <input type="text" name="maritimo_razao_social" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Nome da empresa">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">CNPJ *</label>
                                    <input type="text" name="maritimo_cnpj" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="00.000.000/0000-00">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                                    <input type="tel" name="maritimo_telefone" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="(11) 99999-9999">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <input type="email" name="maritimo_email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="cliente@empresa.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Endereço</label>
                                    <input type="text" name="maritimo_endereco" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Rua, número, bairro">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Complemento</label>
                                    <input type="text" name="maritimo_complemento" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Sala, andar, etc.">
                                </div>
                            </div>
                        </div>

                        <!-- Dados da Carga Marítima -->
                        <div class="bg-green-50 p-4 rounded-lg mb-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">
                                <i class="fas fa-ship mr-2 text-green-600"></i>
                                Dados da Carga (Transporte Marítimo)
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Net Weight (kg) *</label>
                                    <input type="number" name="maritimo_net_weight" step="0.01" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="1000.00">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Gross Weight (kg) *</label>
                                    <input type="number" name="maritimo_gross_weight" step="0.01" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="1200.00">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Cubagem (m³) *</label>
                                    <input type="number" name="maritimo_cubagem" step="0.01" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="10.50">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Incoterm *</label>
                                    <select name="maritimo_incoterm" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                        <option value="">Selecione...</option>
                                        <option value="EXW">EXW - Ex Works</option>
                                        <option value="FCA">FCA - Free Carrier</option>
                                        <option value="CPT">CPT - Carriage Paid To</option>
                                        <option value="CIP">CIP - Carriage and Insurance Paid To</option>
                                        <option value="DAP">DAP - Delivered at Place</option>
                                        <option value="DPU">DPU - Delivered at Place Unloaded</option>
                                        <option value="DDP">DDP - Delivered Duty Paid</option>
                                        <option value="FAS">FAS - Free Alongside Ship</option>
                                        <option value="FOB">FOB - Free on Board</option>
                                        <option value="CFR">CFR - Cost and Freight</option>
                                        <option value="CIF">CIF - Cost, Insurance and Freight</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Carga</label>
                                    <select name="maritimo_tipo_carga" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                        <option value="">Selecione...</option>
                                        <option value="geral">Carga Geral</option>
                                        <option value="granel_solido">Granel Sólido</option>
                                        <option value="granel_liquido">Granel Líquido</option>
                                        <option value="perigosa">Carga Perigosa</option>
                                        <option value="refrigerada">Carga Refrigerada</option>
                                        <option value="projeto">Carga de Projeto</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">FCL ou LCL *</label>
                                    <select name="maritimo_fcl_lcl" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" onchange="toggleContainerFields(this.value)">
                                        <option value="">Selecione...</option>
                                        <option value="FCL">FCL - Full Container Load</option>
                                        <option value="LCL">LCL - Less than Container Load</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Campos específicos para FCL -->
                            <div id="campos-fcl" class="hidden mt-4 p-4 bg-yellow-50 rounded-lg">
                                <h5 class="text-md font-semibold text-gray-800 mb-3">Informações do Container (FCL)</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Tamanho do Container</label>
                                        <select name="maritimo_tamanho_container" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500">
                                            <option value="">Selecione...</option>
                                            <option value="20">20' - Dry Container</option>
                                            <option value="40">40' - Dry Container</option>
                                            <option value="40HC">40' HC - High Cube</option>
                                            <option value="45">45' - High Cube</option>
                                            <option value="20RF">20' - Reefer</option>
                                            <option value="40RF">40' - Reefer</option>
                                            <option value="20OT">20' - Open Top</option>
                                            <option value="40OT">40' - Open Top</option>
                                            <option value="20FR">20' - Flat Rack</option>
                                            <option value="40FR">40' - Flat Rack</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Quantidade de Containers</label>
                                        <input type="number" name="maritimo_quantidade_containers" min="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500" placeholder="1">
                                    </div>
                                </div>
                            </div>

                            <!-- Portos -->
                            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Porto de Origem *</label>
                                    <select name="maritimo_porto_origem" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                        <option value="">Selecione...</option>
                                        <option value="CNSHA">Shanghai, China (CNSHA)</option>
                                        <option value="CNNGB">Ningbo, China (CNNGB)</option>
                                        <option value="CNSZX">Shenzhen, China (CNSZX)</option>
                                        <option value="CNQIN">Qingdao, China (CNQIN)</option>
                                        <option value="CNTAO">Tianjin, China (CNTAO)</option>
                                        <option value="CNXMN">Xiamen, China (CNXMN)</option>
                                        <option value="CNDLC">Dalian, China (CNDLC)</option>
                                        <option value="CNLYG">Lianyungang, China (CNLYG)</option>
                                        <option value="HKHKG">Hong Kong (HKHKG)</option>
                                        <option value="SGSIN">Singapura (SGSIN)</option>
                                        <option value="KRPUS">Busan, Coreia do Sul (KRPUS)</option>
                                        <option value="JPYOK">Yokohama, Japão (JPYOK)</option>
                                        <option value="JPTYO">Tóquio, Japão (JPTYO)</option>
                                        <option value="USNYC">Nova York, EUA (USNYC)</option>
                                        <option value="USLAX">Los Angeles, EUA (USLAX)</option>
                                        <option value="DEHAM">Hamburgo, Alemanha (DEHAM)</option>
                                        <option value="NLRTM">Rotterdam, Holanda (NLRTM)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Porto de Destino *</label>
                                    <select name="maritimo_porto_destino" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                        <option value="">Selecione...</option>
                                        <option value="BRSSZ">Santos, SP (BRSSZ)</option>
                                        <option value="BRRIG">Rio Grande, RS (BRRIG)</option>
                                        <option value="BRPNG">Paranaguá, PR (BRPNG)</option>
                                        <option value="BRITJ">Itajaí, SC (BRITJ)</option>
                                        <option value="BRNVT">Navegantes, SC (BRNVT)</option>
                                        <option value="BRRIO">Rio de Janeiro, RJ (BRRIO)</option>
                                        <option value="BRSSA">Salvador, BA (BRSSA)</option>
                                        <option value="BRFOR">Fortaleza, CE (BRFOR)</option>
                                        <option value="BRPEC">Recife, PE (BRPEC)</option>
                                        <option value="BRVIX">Vitória, ES (BRVIX)</option>
                                        <option value="BRMAN">Manaus, AM (BRMAN)</option>
                                        <option value="BRBEL">Belém, PA (BRBEL)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dados do Cliente (Padrão) -->
                    <div id="campos-padrao" class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Dados do Cliente</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nome/Razão Social *</label>
                                <input type="text" name="cliente_nome" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">CNPJ *</label>
                                <input type="text" name="cliente_cnpj" required placeholder="00.000.000/0000-00" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                                <input type="tel" name="cliente_contato_telefone" placeholder="(11) 99999-9999" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" name="cliente_contato_email" placeholder="cliente@empresa.com" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                            </div>
                        </div>
                    </div>

                    <!-- Origem e Destino (Apenas para Rodoviário e Aéreo) -->
                    <div id="campos-origem-destino" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Origem -->
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">
                                <i class="fas fa-map-marker-alt text-green-600 mr-2"></i>Origem
                            </h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">CEP *</label>
                                    <input type="text" name="origem_cep" required placeholder="00000-000" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Endereço Completo *</label>
                                    <input type="text" name="origem_endereco" required placeholder="Rua, número, bairro" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Cidade *</label>
                                        <input type="text" name="origem_cidade" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Estado *</label>
                                        <select name="origem_estado" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                            <option value="">Selecione</option>
                                            <option value="AC">AC</option>
                                            <option value="AL">AL</option>
                                            <option value="AP">AP</option>
                                            <option value="AM">AM</option>
                                            <option value="BA">BA</option>
                                            <option value="CE">CE</option>
                                            <option value="DF">DF</option>
                                            <option value="ES">ES</option>
                                            <option value="GO">GO</option>
                                            <option value="MA">MA</option>
                                            <option value="MT">MT</option>
                                            <option value="MS">MS</option>
                                            <option value="MG">MG</option>
                                            <option value="PA">PA</option>
                                            <option value="PB">PB</option>
                                            <option value="PR">PR</option>
                                            <option value="PE">PE</option>
                                            <option value="PI">PI</option>
                                            <option value="RJ">RJ</option>
                                            <option value="RN">RN</option>
                                            <option value="RS">RS</option>
                                            <option value="RO">RO</option>
                                            <option value="RR">RR</option>
                                            <option value="SC">SC</option>
                                            <option value="SP">SP</option>
                                            <option value="SE">SE</option>
                                            <option value="TO">TO</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Destino -->
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">
                                <i class="fas fa-flag-checkered text-red-600 mr-2"></i>Destino
                            </h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">CEP *</label>
                                    <input type="text" name="destino_cep" required placeholder="00000-000" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Endereço Completo *</label>
                                    <input type="text" name="destino_endereco" required placeholder="Rua, número, bairro" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Cidade *</label>
                                        <input type="text" name="destino_cidade" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Estado *</label>
                                        <select name="destino_estado" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                            <option value="">Selecione</option>
                                            <option value="AC">AC</option>
                                            <option value="AL">AL</option>
                                            <option value="AP">AP</option>
                                            <option value="AM">AM</option>
                                            <option value="BA">BA</option>
                                            <option value="CE">CE</option>
                                            <option value="DF">DF</option>
                                            <option value="ES">ES</option>
                                            <option value="GO">GO</option>
                                            <option value="MA">MA</option>
                                            <option value="MT">MT</option>
                                            <option value="MS">MS</option>
                                            <option value="MG">MG</option>
                                            <option value="PA">PA</option>
                                            <option value="PB">PB</option>
                                            <option value="PR">PR</option>
                                            <option value="PE">PE</option>
                                            <option value="PI">PI</option>
                                            <option value="RJ">RJ</option>
                                            <option value="RN">RN</option>
                                            <option value="RS">RS</option>
                                            <option value="RO">RO</option>
                                            <option value="RR">RR</option>
                                            <option value="SC">SC</option>
                                            <option value="SP">SP</option>
                                            <option value="SE">SE</option>
                                            <option value="TO">TO</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dados da Carga (Apenas para Rodoviário e Aéreo) -->
                    <div id="campos-carga-padrao" class="bg-purple-50 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">
                            <i class="fas fa-boxes text-purple-600 mr-2"></i>Dados da Carga
                        </h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Descrição da Mercadoria *</label>
                                <textarea name="carga_descricao" required rows="3" placeholder="Descreva detalhadamente a mercadoria..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"></textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Peso Total (kg) *</label>
                                    <input type="number" name="carga_peso_kg" required min="0.01" step="0.01" placeholder="0.00" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Comprimento (cm)</label>
                                    <input type="number" name="carga_comprimento_cm" min="0" step="0.01" placeholder="0.00" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Largura (cm)</label>
                                    <input type="number" name="carga_largura_cm" min="0" step="0.01" placeholder="0.00" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Altura (cm)</label>
                                    <input type="number" name="carga_altura_cm" min="0" step="0.01" placeholder="0.00" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Valor da Mercadoria (R$)</label>
                                    <input type="number" name="carga_valor_mercadoria" min="0" step="0.01" placeholder="0.00" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Embalagem</label>
                                    <select name="carga_tipo_embalagem" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                        <option value="">Selecione</option>
                                        <option value="Caixa de Papelão">Caixa de Papelão</option>
                                        <option value="Caixa de Madeira">Caixa de Madeira</option>
                                        <option value="Pallet">Pallet</option>
                                        <option value="Saco/Bag">Saco/Bag</option>
                                        <option value="Tambor">Tambor</option>
                                        <option value="Container">Container</option>
                                        <option value="Outro">Outro</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Campo de Seguro -->
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">
                            <i class="fas fa-shield-alt text-yellow-600 mr-2"></i>Seguro da Carga
                        </h4>
                        <div class="space-y-4">
                            <div class="flex items-center">
                                <input type="checkbox" id="solicitar_seguro" name="solicitar_seguro" class="mr-3 h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded" onchange="toggleSeguroFields(this.checked)">
                                <label for="solicitar_seguro" class="text-sm font-medium text-gray-700">Solicitar seguro para a carga</label>
                            </div>
                            <div id="campos-seguro" class="hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Valor do Produto (USD) *</label>
                                        <input type="number" name="valor_produto_usd" min="0.01" step="0.01" placeholder="0.00" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Cobertura</label>
                                        <select name="tipo_cobertura_seguro" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500">
                                            <option value="">Selecione...</option>
                                            <option value="basica">Cobertura Básica</option>
                                            <option value="ampla">Cobertura Ampla</option>
                                            <option value="total">Cobertura Total</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Serviço -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">
                            <i class="fas fa-shipping-fast text-gray-600 mr-2"></i>Serviço
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Prazo Desejado (dias)</label>
                                <input type="number" name="servico_prazo_desejado" min="1" placeholder="Ex: 5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Serviço</label>
                                <select name="servico_tipo" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                    <option value="">Selecione</option>
                                    <option value="Expresso">Expresso</option>
                                    <option value="Econômico">Econômico</option>
                                    <option value="Normal">Normal</option>
                                    <option value="Urgente">Urgente</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Observações Especiais</label>
                            <textarea name="servico_observacoes" rows="3" placeholder="Instruções especiais, horários preferenciais, etc..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"></textarea>
                        </div>
                    </div>

                    <!-- Botões -->
                    <div class="flex justify-end space-x-4 pt-6 border-t">
                        <button type="button" id="cancelar-cotacao" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                            <i class="fas fa-times mr-2"></i>Cancelar
                        </button>
                        <button type="submit" id="salvar-cotacao" class="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors">
                            <i class="fas fa-paper-plane mr-2"></i>Solicitar Cotação
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>




    <!-- Footer -->
    <footer class="bg-gray-800 text-white text-center p-4 mt-8">
        <p>&copy; 2025 BRCcSis. Todos os direitos reservados. Projetado por Inácio Victor.    </div>

    <!-- Modal de Importação Excel -->
    <div id="modal-importar-excel" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 fade-in">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800">Importar Planilha Excel</h3>
                    <button id="fechar-modal-importar-excel" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-3">
                        Selecione um arquivo Excel (.xlsx) com os dados das empresas para importar.
                    </p>
                    
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                        <input type="file" id="arquivo-importacao-excel" accept=".xlsx,.xls" class="hidden">
                        <label for="arquivo-importacao-excel" class="cursor-pointer">
                            <i class="fas fa-file-excel text-3xl text-green-500 mb-2"></i>
                            <p class="text-sm text-gray-600">Clique para selecionar arquivo Excel</p>
                            <p class="text-xs text-gray-400 mt-1">Formatos aceitos: .xlsx, .xls</p>
                        </label>
                    </div>
                    
                    <div id="arquivo-selecionado-excel" class="hidden mt-3 p-3 bg-green-50 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-file-excel text-green-600 mr-2"></i>
                            <span id="nome-arquivo-excel" class="text-sm text-green-800"></span>
                            <button id="remover-arquivo-excel" class="ml-auto text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-3">
                    <button id="cancelar-importacao-excel" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button id="confirmar-importacao-excel" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <span id="texto-importacao-excel">Importar</span>
                        <div id="loading-importacao-excel" class="loading hidden ml-2"></div>
                    </button>
                </div>
                
                <div id="resultado-importacao-excel" class="hidden mt-4 p-3 rounded-lg">
                    <div id="conteudo-resultado-excel"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Importação de Dados -->
    <div id="modal-importar" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 fade-in">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800">Importar Dados</h3>
                    <button id="fechar-modal-importar" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-3">
                        Selecione um arquivo JSON de backup para importar os dados das empresas.
                    </p>
                    
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                        <input type="file" id="arquivo-importacao" accept=".json" class="hidden">
                        <label for="arquivo-importacao" class="cursor-pointer">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-600">Clique para selecionar arquivo JSON</p>
                            <p class="text-xs text-gray-400 mt-1">Ou arraste e solte aqui</p>
                        </label>
                    </div>
                    
                    <div id="arquivo-selecionado" class="hidden mt-3 p-3 bg-blue-50 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-file-alt text-blue-600 mr-2"></i>
                            <span id="nome-arquivo" class="text-sm text-blue-800"></span>
                            <button id="remover-arquivo" class="ml-auto text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-3">
                    <button id="cancelar-importacao" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button id="confirmar-importacao" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <span id="texto-importacao">Importar</span>
                        <div id="loading-importacao" class="loading hidden ml-2"></div>
                    </button>
                </div>
                
                <div id="resultado-importacao" class="hidden mt-4 p-3 rounded-lg">
                    <div id="conteudo-resultado"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Função para confirmar exclusão com delay
        async function confirmarExclusao(empresaId, razaoSocial) {
            if (!confirm(`Tem certeza que deseja excluir a empresa ${razaoSocial}? Esta ação é irreversível.`)) {
                return;
            }
            const deleteButton = event.target;
            deleteButton.disabled = true;
            deleteButton.textContent = 'Aguarde (5s)';
            let countdown = 5;
            const countdownInterval = setInterval(() => {
                countdown--;
                deleteButton.textContent = `Aguarde (${countdown}s)`;
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    deleteButton.textContent = 'Confirmar Exclusão';
                    deleteButton.disabled = false;
                    deleteButton.onclick = () => excluirEmpresa(empresaId);
                }
            }, 1000);
        }
        
        // Função para excluir empresa
        async function excluirEmpresa(empresaId) {
            try {
                const response = await fetch(`/api/empresas/${empresaId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    alert('Empresa excluída com sucesso!');
                    loadEmpresas(); // Recarregar a lista de empresas
                } else {
                    const errorData = await response.json();
                    alert(`Erro ao excluir empresa: ${errorData.error}`);
                }
            } catch (error) {
                console.error('Erro ao excluir empresa:', error);
                alert('Erro ao excluir empresa. Verifique a conexão.');
            }
        }

        // Função para exportar dados
        async function exportarDados() {
            try {
                const response = await fetch('/api/empresas/export');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `brccsis_backup_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    alert('Dados exportados com sucesso!');
                } else {
                    const errorData = await response.json();
                    alert(`Erro ao exportar dados: ${errorData.error}`);
                }
            } catch (error) {
                console.error('Erro ao exportar dados:', error);
                alert('Erro ao exportar dados. Verifique a conexão.');
            }
        }

        // Função para importar dados
        async function importarDados(arquivo) {
            const formData = new FormData();
            formData.append('file', arquivo);

            try {
                const response = await fetch('/api/empresas/import', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (response.ok) {
                    return {
                        sucesso: true,
                        dados: result
                    };
                } else {
                    return {
                        sucesso: false,
                        erro: result.error
                    };
                }
            } catch (error) {
                return {
                    sucesso: false,
                    erro: `Erro de conexão: ${error.message}`
                };
            }
        }

        // Função para importar dados Excel
        async function importarDadosExcel(arquivo) {
            const formData = new FormData();
            formData.append('file', arquivo);

            try {
                const response = await fetch('/api/empresas/import-excel', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (response.ok) {
                    return {
                        sucesso: true,
                        dados: result
                    };
                } else {
                    return {
                        sucesso: false,
                        erro: result.error
                    };
                }
            } catch (error) {
                return {
                    sucesso: false,
                    erro: `Erro de conexão: ${error.message}`
                };
            }
        }

        // Event listeners para importação
        document.addEventListener('DOMContentLoaded', function() {
            const btnImportar = document.getElementById('btn-importar-dados');
            const modalImportar = document.getElementById('modal-importar');
            const fecharModal = document.getElementById('fechar-modal-importar');
            const cancelarImportacao = document.getElementById('cancelar-importacao');
            const arquivoInput = document.getElementById('arquivo-importacao');
            const arquivoSelecionado = document.getElementById('arquivo-selecionado');
            const nomeArquivo = document.getElementById('nome-arquivo');
            const removerArquivo = document.getElementById('remover-arquivo');
            const confirmarImportacao = document.getElementById('confirmar-importacao');
            const textoImportacao = document.getElementById('texto-importacao');
            const loadingImportacao = document.getElementById('loading-importacao');
            const resultadoImportacao = document.getElementById('resultado-importacao');
            const conteudoResultado = document.getElementById('conteudo-resultado');

            // Event listeners para importação Excel
            const btnImportarExcel = document.getElementById('btn-importar-excel');
            const modalImportarExcel = document.getElementById('modal-importar-excel');
            const fecharModalExcel = document.getElementById('fechar-modal-importar-excel');
            const cancelarImportacaoExcel = document.getElementById('cancelar-importacao-excel');
            const arquivoInputExcel = document.getElementById('arquivo-importacao-excel');
            const arquivoSelecionadoExcel = document.getElementById('arquivo-selecionado-excel');
            const nomeArquivoExcel = document.getElementById('nome-arquivo-excel');
            const removerArquivoExcel = document.getElementById('remover-arquivo-excel');
            const confirmarImportacaoExcel = document.getElementById('confirmar-importacao-excel');
            const textoImportacaoExcel = document.getElementById('texto-importacao-excel');
            const loadingImportacaoExcel = document.getElementById('loading-importacao-excel');
            const resultadoImportacaoExcel = document.getElementById('resultado-importacao-excel');
            const conteudoResultadoExcel = document.getElementById('conteudo-resultado-excel');

            // Event listener para template Excel
            const btnTemplateExcel = document.getElementById('btn-template-excel');

            // Abrir modal de importação JSON
            btnImportar.addEventListener('click', async function() {
                try {
                    // Verificar se o usuário tem permissão
                    const response = await fetch('/api/auth/check-permission', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ recurso: 'importar_dados' })
                    });
                    
                    const result = await response.json();
                    
                    if (result.permitido) {
                        modalImportar.classList.add('show');
                    } else {
                        alert('❌ Acesso negado!\n\nVocê não tem permissão para importar dados.\n\nApenas administradores e gerentes podem importar dados.');
                    }
                } catch (error) {
                    console.error('Erro ao verificar permissão:', error);
                    alert('Erro ao verificar permissões. Tente novamente.');
                }
            });

            // Abrir modal de importação Excel
            btnImportarExcel.addEventListener('click', async function() {
                try {
                    // Verificar se o usuário tem permissão
                    const response = await fetch('/api/auth/check-permission', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ recurso: 'importar_excel' })
                    });
                    
                    const result = await response.json();
                    
                    if (result.permitido) {
                        modalImportarExcel.classList.add('show');
                    } else {
                        alert('❌ Acesso negado!\n\nVocê não tem permissão para importar planilhas Excel.\n\nApenas administradores, gerentes e operadores podem importar Excel.');
                    }
                } catch (error) {
                    console.error('Erro ao verificar permissão:', error);
                    alert('Erro ao verificar permissões. Tente novamente.');
                }
            });

            // Baixar template Excel
            btnTemplateExcel.addEventListener('click', function() {
                window.open('/api/empresas/template-excel', '_blank');
            });

            // Fechar modal JSON
            function fecharModalImportacao() {
                modalImportar.classList.remove('show');
                arquivoInput.value = '';
                arquivoSelecionado.classList.add('hidden');
                confirmarImportacao.disabled = true;
                resultadoImportacao.classList.add('hidden');
            }

            // Fechar modal Excel
            function fecharModalImportacaoExcel() {
                modalImportarExcel.classList.remove('show');
                arquivoInputExcel.value = '';
                arquivoSelecionadoExcel.classList.add('hidden');
                confirmarImportacaoExcel.disabled = true;
                resultadoImportacaoExcel.classList.add('hidden');
            }

            fecharModal.addEventListener('click', fecharModalImportacao);
            cancelarImportacao.addEventListener('click', fecharModalImportacao);
            fecharModalExcel.addEventListener('click', fecharModalImportacaoExcel);
            cancelarImportacaoExcel.addEventListener('click', fecharModalImportacaoExcel);

            // Seleção de arquivo JSON
            arquivoInput.addEventListener('change', function(e) {
                const arquivo = e.target.files[0];
                if (arquivo) {
                    if (arquivo.type === 'application/json' || arquivo.name.endsWith('.json')) {
                        nomeArquivo.textContent = arquivo.name;
                        arquivoSelecionado.classList.remove('hidden');
                        confirmarImportacao.disabled = false;
                    } else {
                        alert('Por favor, selecione um arquivo JSON válido.');
                        arquivoInput.value = '';
                    }
                }
            });

            // Seleção de arquivo Excel
            arquivoInputExcel.addEventListener('change', function(e) {
                const arquivo = e.target.files[0];
                if (arquivo) {
                    if (arquivo.name.endsWith('.xlsx') || arquivo.name.endsWith('.xls')) {
                        nomeArquivoExcel.textContent = arquivo.name;
                        arquivoSelecionadoExcel.classList.remove('hidden');
                        confirmarImportacaoExcel.disabled = false;
                    } else {
                        alert('Por favor, selecione um arquivo Excel válido (.xlsx ou .xls).');
                        arquivoInputExcel.value = '';
                    }
                }
            });

            // Remover arquivo selecionado JSON
            removerArquivo.addEventListener('click', function() {
                arquivoInput.value = '';
                arquivoSelecionado.classList.add('hidden');
                confirmarImportacao.disabled = true;
            });

            // Remover arquivo selecionado Excel
            removerArquivoExcel.addEventListener('click', function() {
                arquivoInputExcel.value = '';
                arquivoSelecionadoExcel.classList.add('hidden');
                confirmarImportacaoExcel.disabled = true;
            });

            // Confirmar importação JSON
            confirmarImportacao.addEventListener('click', async function() {
                const arquivo = arquivoInput.files[0];
                if (!arquivo) return;

                // Mostrar loading
                textoImportacao.textContent = 'Importando...';
                loadingImportacao.classList.remove('hidden');
                confirmarImportacao.disabled = true;

                const resultado = await importarDados(arquivo);

                // Esconder loading
                textoImportacao.textContent = 'Importar';
                loadingImportacao.classList.add('hidden');
                confirmarImportacao.disabled = false;

                // Mostrar resultado
                resultadoImportacao.classList.remove('hidden');
                
                if (resultado.sucesso) {
                    const stats = resultado.dados.estatisticas;
                    resultadoImportacao.className = 'mt-4 p-3 rounded-lg bg-green-50 border border-green-200';
                    conteudoResultado.innerHTML = `
                        <div class="text-green-800">
                            <h4 class="font-bold mb-2">✅ Importação concluída com sucesso!</h4>
                            <ul class="text-sm space-y-1">
                                <li>• Total processadas: ${stats.total_processadas}</li>
                                <li>• Empresas criadas: ${stats.criadas}</li>
                                <li>• Empresas atualizadas: ${stats.atualizadas}</li>
                                <li>• Erros: ${stats.erros}</li>
                            </ul>
                            ${stats.detalhes_erros.length > 0 ? `
                                <details class="mt-2">
                                    <summary class="cursor-pointer text-red-600">Ver detalhes dos erros</summary>
                                    <ul class="mt-1 text-xs text-red-600">
                                        ${stats.detalhes_erros.map(erro => `<li>• ${erro}</li>`).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                        </div>
                    `;
                    
                    // Recarregar dados se estiver na aba de empresas
                    if (document.getElementById('empresas').style.display !== 'none') {
                        loadEmpresas();
                    }
                    
                    // Analytics não precisam ser recarregados após importação
                } else {
                    resultadoImportacao.className = 'mt-4 p-3 rounded-lg bg-red-50 border border-red-200';
                    conteudoResultado.innerHTML = `
                        <div class="text-red-800">
                            <h4 class="font-bold mb-2">❌ Erro na importação</h4>
                            <p class="text-sm">${resultado.erro}</p>
                        </div>
                    `;
                }
            });

            // Confirmar importação Excel
            confirmarImportacaoExcel.addEventListener('click', async function() {
                const arquivo = arquivoInputExcel.files[0];
                if (!arquivo) return;

                // Mostrar loading
                textoImportacaoExcel.textContent = 'Importando...';
                loadingImportacaoExcel.classList.remove('hidden');
                confirmarImportacaoExcel.disabled = true;

                const resultado = await importarDadosExcel(arquivo);

                // Esconder loading
                textoImportacaoExcel.textContent = 'Importar';
                loadingImportacaoExcel.classList.add('hidden');
                confirmarImportacaoExcel.disabled = false;

                // Mostrar resultado
                resultadoImportacaoExcel.classList.remove('hidden');
                
                if (resultado.sucesso) {
                    const stats = resultado.dados.estatisticas;
                    resultadoImportacaoExcel.className = 'mt-4 p-3 rounded-lg bg-green-50 border border-green-200';
                    conteudoResultadoExcel.innerHTML = `
                        <div class="text-green-800">
                            <h4 class="font-bold mb-2">✅ Importação de Excel concluída com sucesso!</h4>
                            <ul class="text-sm space-y-1">
                                <li>• Total processadas: ${stats.total_processadas}</li>
                                <li>• Empresas criadas: ${stats.criadas}</li>
                                <li>• Empresas atualizadas: ${stats.atualizadas}</li>
                                <li>• Erros: ${stats.erros}</li>
                            </ul>
                            ${stats.detalhes_erros.length > 0 ? `
                                <details class="mt-2">
                                    <summary class="cursor-pointer text-red-600">Ver detalhes dos erros</summary>
                                    <ul class="mt-1 text-xs text-red-600">
                                        ${stats.detalhes_erros.map(erro => `<li>• ${erro}</li>`).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                        </div>
                    `;
                    
                    // Recarregar dados se estiver na aba de empresas
                    if (document.getElementById('empresas').style.display !== 'none') {
                        loadEmpresas();
                    }
                    
                    // Analytics não precisam ser recarregados após importação
                } else {
                    resultadoImportacaoExcel.className = 'mt-4 p-3 rounded-lg bg-red-50 border border-red-200';
                    conteudoResultadoExcel.innerHTML = `
                        <div class="text-red-800">
                            <h4 class="font-bold mb-2">❌ Erro na importação</h4>
                            <p class="text-sm">${resultado.erro}</p>
                        </div>
                    `;
                }
            });

            // Event listener para exportação
            document.getElementById('btn-exportar-dados').addEventListener('click', async function() {
                try {
                    // Verificar se o usuário tem permissão
                    const response = await fetch('/api/auth/check-permission', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ recurso: 'exportar_dados' })
                    });
                    
                    const result = await response.json();
                    
                    if (result.permitido) {
                        exportarDados();
                    } else {
                        alert('❌ Acesso negado!\n\nVocê não tem permissão para exportar dados.\n\nApenas administradores e gerentes podem exportar dados.');
                    }
                } catch (error) {
                    console.error('Erro ao verificar permissão:', error);
                    alert('Erro ao verificar permissões. Tente novamente.');
                }
            });
            
            // Event listener para administração
            document.getElementById('btn-administracao').addEventListener('click', async function() {
                try {
                    // Verificar se o usuário tem permissão
                    const response = await fetch('/api/auth/check-permission', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ recurso: 'acessar_administracao' })
                    });
                    
                    const result = await response.json();
                    
                    if (result.permitido) {
                        window.location.href = '/admin.html';
                    } else {
                        alert('❌ Acesso negado!\n\nVocê não tem permissão para acessar a página de administração.\n\nContate um administrador se precisar de acesso.');
                    }
                } catch (error) {
                    console.error('Erro ao verificar permissão:', error);
                    alert('Erro ao verificar permissões. Tente novamente.');
                }
            });
            
            // Event listener para logout
            document.getElementById('btn-logout').addEventListener('click', async function() {
                try {
                    await fetch('/api/auth/logout', { method: 'POST' });
                    window.location.href = '/login';
                } catch (error) {
                    console.error('Erro no logout:', error);
                    window.location.href = '/login';
                }
            });
        });
    </script>
    </script>

    <!-- Rodapé -->
    <footer class="bg-gray-800 text-white py-4 mt-8">
        <div class="container mx-auto px-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-2 md:mb-0">
                    <p class="text-sm">© 2024 BRCcSis - Sistema de Gestão Logística</p>
                </div>
                <div class="flex items-center space-x-4 text-sm">
                    <span id="usuario-logado" class="flex items-center">
                        <i class="fas fa-user mr-2"></i>
                        <span id="nome-usuario">Carregando...</span>
                    </span>
                    <span id="horario-sistema" class="flex items-center">
                        <i class="fas fa-clock mr-2"></i>
                        <span id="horario-atual">--:--</span>
                    </span>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Função para carregar informações do usuário logado
        async function carregarInfoUsuario() {
            try {
                const response = await fetch('/api/auth/user-info');
                if (response.ok) {
                    const userInfo = await response.json();
                    document.getElementById('nome-usuario').textContent = userInfo.nome || userInfo.username;
                } else {
                    document.getElementById('nome-usuario').textContent = 'Usuário';
                }
            } catch (error) {
                console.error('Erro ao carregar info do usuário:', error);
                document.getElementById('nome-usuario').textContent = 'Usuário';
            }
        }

        // Função para atualizar horário (Brasília)
        function atualizarHorario() {
            const agora = new Date();
            // Converter para horário de Brasília (UTC-3)
            const brasilia = new Date(agora.toLocaleString("en-US", {timeZone: "America/Sao_Paulo"}));
            const horarioFormatado = brasilia.toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('horario-atual').textContent = horarioFormatado;
        }

        // ===== SISTEMA DE COTAÇÕES =====
        
        // Variáveis globais para cotações
        let cotacoesData = [];
        let cotacoesCurrentPage = 1;
        let cotacoesTotalPages = 1;
        let filtrosAtivos = {};

        // Função para verificar permissões do usuário
        async function verificarPermissoesCotacao() {
            try {
                const response = await fetch('/api/auth/user-info');
                if (response.ok) {
                    const userInfo = await response.json();
                    console.log('User info:', userInfo); // Debug
                    return userInfo.tipo === 'consultor' || 
                           userInfo.tipo === 'operador' || 
                           userInfo.tipo === 'gerente' || 
                           userInfo.tipo === 'administrador';
                }
                console.log('Erro na resposta da API:', response.status);
                return false;
            } catch (error) {
                console.error('Erro ao verificar permissões:', error);
                return false;
            }
        }

        // Função para mostrar/ocultar botão de cotação baseado nas permissões
        async function configurarBotaoCotacao() {
            const btnSolicitarCotacao = document.getElementById('btn-solicitar-cotacao');
            console.log('Configurando botão de cotação...', btnSolicitarCotacao);
            
            if (btnSolicitarCotacao) {
                // Sempre mostrar o botão por enquanto para debug
                btnSolicitarCotacao.style.display = 'flex';
                
                // Remover event listeners anteriores
                btnSolicitarCotacao.replaceWith(btnSolicitarCotacao.cloneNode(true));
                const newBtn = document.getElementById('btn-solicitar-cotacao');
                
                console.log('Adicionando event listener ao botão...');
                newBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Botão clicado! Abrindo modal...');
                    abrirModalCotacao();
                });
                
                // Verificar permissões em background
                const temPermissao = await verificarPermissoesCotacao();
                console.log('Tem permissão:', temPermissao);
                
                if (!temPermissao) {
                    console.log('Usuário sem permissão, ocultando botão');
                    newBtn.style.display = 'none';
                }
            } else {
                console.log('Botão não encontrado!');
            }
        }

        // Função para abrir modal de cotação
        function abrirModalCotacao() {
            console.log('Função abrirModalCotacao chamada');
            const modal = document.getElementById('modal-cotacao');
            console.log('Modal encontrado:', modal);
            
            if (modal) {
                console.log('Adicionando classe show ao modal');
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
                console.log('Modal deve estar visível agora');
            } else {
                console.log('ERRO: Modal não encontrado!');
            }
        }

        // Função para fechar modal de cotação
        function fecharModalCotacao() {
            const modal = document.getElementById('modal-cotacao');
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = 'auto';
                // Limpar formulário
                document.getElementById('form-cotacao').reset();
            }
        }

        // Função para carregar cotações
        async function carregarCotacoes(page = 1) {
            try {
                const params = new URLSearchParams({
                    page: page,
                    per_page: 10,
                    ...filtrosAtivos
                });

                const response = await fetch(`/api/cotacoes?${params}`);
                if (response.ok) {
                    const data = await response.json();
                    cotacoesData = data.cotacoes;
                    cotacoesCurrentPage = data.current_page;
                    cotacoesTotalPages = data.pages;
                    
                    renderizarListaCotacoes();
                    renderizarPaginacao();
                } else {
                    throw new Error('Erro ao carregar cotações');
                }
            } catch (error) {
                console.error('Erro ao carregar cotações:', error);
                mostrarMensagem('Erro ao carregar cotações', 'error');
            }
        }

        // Função para carregar estatísticas
        async function carregarEstatisticasCotacoes() {
            try {
                const response = await fetch('/api/cotacoes/estatisticas');
                if (response.ok) {
                    const data = await response.json();
                    const stats = data.estatisticas;
                    
                    document.getElementById('total-cotacoes').textContent = stats.total_cotacoes || 0;
                    document.getElementById('cotacoes-pendentes').textContent = 
                        (stats.por_status.solicitada || 0) + (stats.por_status.em_analise || 0);
                    document.getElementById('cotacoes-finalizadas').textContent = stats.por_status.finalizada || 0;
                    document.getElementById('cotacoes-enviadas').textContent = stats.por_status.cotacao_enviada || 0;
                }
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            }
        }

        // Função para renderizar lista de cotações
        function renderizarListaCotacoes() {
            const container = document.getElementById('lista-cotacoes');
            if (!container) return;

            if (cotacoesData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-inbox text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-500">Nenhuma cotação encontrada</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = cotacoesData.map(cotacao => `
                <div class="bg-white border rounded-lg p-6 hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-4">
                            <h3 class="text-lg font-semibold text-gray-800">${cotacao.numero_cotacao}</h3>
                            <span class="px-3 py-1 rounded-full text-sm font-medium ${cotacao.status_color}">
                                ${cotacao.status_display}
                            </span>
                        </div>
                        <div class="text-sm text-gray-500">
                            ${new Date(cotacao.data_solicitacao).toLocaleDateString('pt-BR')}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Cliente</p>
                            <p class="text-gray-800">${cotacao.cliente_nome}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-600">Origem → Destino</p>
                            <p class="text-gray-800">${cotacao.origem_cidade}/${cotacao.origem_estado} → ${cotacao.destino_cidade}/${cotacao.destino_estado}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-600">Peso</p>
                            <p class="text-gray-800">${cotacao.carga_peso_kg} kg</p>
                        </div>
                    </div>
                    
                    ${cotacao.cotacao_valor_frete ? `
                        <div class="bg-green-50 p-3 rounded-lg mb-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-green-800">Valor da Cotação</p>
                                    <p class="text-lg font-bold text-green-600">R$ ${parseFloat(cotacao.cotacao_valor_frete).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-green-800">Prazo</p>
                                    <p class="text-green-600">${cotacao.cotacao_prazo_entrega} dias</p>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-gray-500">
                            ${cotacao.operador_nome ? `Operador: ${cotacao.operador_nome}` : 'Aguardando operador'}
                        </div>
                        <div class="flex space-x-2">
                            ${getBotoesAcao(cotacao)}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Função para obter botões de ação baseados no status e tipo de usuário
        function getBotoesAcao(cotacao) {
            let botoes = [];
            
            console.log('Cotação:', cotacao.id, 'Status:', cotacao.status, 'Operador ID:', cotacao.operador_id);
            
            // Botão Ver Detalhes (sempre presente)
            botoes.push(`<button onclick="verDetalhesCotacao(${cotacao.id})" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                <i class="fas fa-eye mr-1"></i>Detalhes
            </button>`);
            
            // Verificar tipo de usuário (será obtido via API)
            // Por enquanto, vamos assumir que operadores podem aceitar cotações
            
            if (cotacao.status === 'solicitada' && !cotacao.operador_id) {
                console.log('Adicionando botão ACEITAR para cotação', cotacao.id);
                // Cotação pode ser aceita por qualquer operador
                botoes.push(`<button onclick="aceitarCotacao(${cotacao.id})" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                    <i class="fas fa-check mr-1"></i>Aceitar
                </button>`);
            } else if (cotacao.status === 'em_analise' && cotacao.operador_id) {
                console.log('Adicionando botão RESPONDER para cotação', cotacao.id);
                // Cotação em análise - operador pode responder
                botoes.push(`<button onclick="responderCotacao(${cotacao.id})" class="px-3 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors text-sm">
                    <i class="fas fa-reply mr-1"></i>Responder
                </button>`);
            } else if (cotacao.status === 'cotacao_enviada') {
                console.log('Adicionando botão FINALIZAR para cotação', cotacao.id);
                // Cotação enviada - pode finalizar
                botoes.push(`<button onclick="finalizarCotacao(${cotacao.id})" class="px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm">
                    <i class="fas fa-flag-checkered mr-1"></i>Finalizar
                </button>`);
            }
            
            console.log('Botões gerados para cotação', cotacao.id, ':', botoes.length);
            return botoes.join('');
        }

        // Função para renderizar paginação
        function renderizarPaginacao() {
            const container = document.getElementById('paginacao-cotacoes');
            if (!container || cotacoesTotalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let paginacao = '<div class="flex items-center space-x-2">';
            
            // Botão anterior
            if (cotacoesCurrentPage > 1) {
                paginacao += `<button onclick="carregarCotacoes(${cotacoesCurrentPage - 1})" class="px-3 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Anterior</button>`;
            }
            
            // Números das páginas
            for (let i = Math.max(1, cotacoesCurrentPage - 2); i <= Math.min(cotacoesTotalPages, cotacoesCurrentPage + 2); i++) {
                const isActive = i === cotacoesCurrentPage;
                paginacao += `<button onclick="carregarCotacoes(${i})" class="px-3 py-2 ${isActive ? 'bg-orange-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'} rounded">${i}</button>`;
            }
            
            // Botão próximo
            if (cotacoesCurrentPage < cotacoesTotalPages) {
                paginacao += `<button onclick="carregarCotacoes(${cotacoesCurrentPage + 1})" class="px-3 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Próximo</button>`;
            }
            
            paginacao += '</div>';
            container.innerHTML = paginacao;
        }

        // Função para aplicar filtros
        function aplicarFiltrosCotacoes() {
            filtrosAtivos = {};
            
            const status = document.getElementById('filtro-status').value;
            const cliente = document.getElementById('filtro-cliente').value;
            const dataInicio = document.getElementById('filtro-data-inicio').value;
            const dataFim = document.getElementById('filtro-data-fim').value;
            
            if (status) filtrosAtivos.status = status;
            if (cliente) filtrosAtivos.cliente_nome = cliente;
            if (dataInicio) filtrosAtivos.data_inicio = dataInicio;
            if (dataFim) filtrosAtivos.data_fim = dataFim;
            
            carregarCotacoes(1);
        }

        // Função para limpar filtros
        function limparFiltrosCotacoes() {
            document.getElementById('filtro-status').value = '';
            document.getElementById('filtro-cliente').value = '';
            document.getElementById('filtro-data-inicio').value = '';
            document.getElementById('filtro-data-fim').value = '';
            
            filtrosAtivos = {};
            carregarCotacoes(1);
        }

        // Função para criar cotação
        async function criarCotacao(formData) {
            try {
                const response = await fetch('/api/cotacoes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                
                if (response.ok) {
                    mostrarMensagem('Cotação criada com sucesso!', 'success');
                    fecharModalCotacao();
                    if (document.getElementById('cotacoes').style.display !== 'none') {
                        carregarCotacoes();
                        carregarEstatisticasCotacoes();
                    }
                } else {
                    throw new Error(data.message || 'Erro ao criar cotação');
                }
            } catch (error) {
                console.error('Erro ao criar cotação:', error);
                mostrarMensagem(error.message, 'error');
            }
        }

        // Função para aceitar cotação
        async function aceitarCotacao(cotacaoId) {
            try {
                console.log('Aceitando cotação:', cotacaoId);
                const response = await fetch(`/api/cotacoes/${cotacaoId}/aceitar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    mostrarMensagem('Cotação aceita com sucesso!', 'success');
                    carregarCotacoes(); // Recarregar lista
                    carregarEstatisticasCotacoes(); // Atualizar estatísticas
                } else {
                    throw new Error(data.message || 'Erro ao aceitar cotação');
                }
            } catch (error) {
                console.error('Erro ao aceitar cotação:', error);
                mostrarMensagem(error.message, 'error');
            }
        }

        // Função para responder cotação
        async function responderCotacao(cotacaoId) {
            // Abrir modal de resposta
            const valor = prompt('Digite o valor do frete (R$):');
            const prazo = prompt('Digite o prazo de entrega (dias):');
            
            if (!valor || !prazo) {
                mostrarMensagem('Valor e prazo são obrigatórios', 'error');
                return;
            }

            try {
                console.log('Respondendo cotação:', cotacaoId);
                const response = await fetch(`/api/cotacoes/${cotacaoId}/responder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        valor_frete: parseFloat(valor.replace(',', '.')),
                        prazo_entrega: parseInt(prazo),
                        observacoes: 'Cotação respondida via sistema'
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    mostrarMensagem('Cotação respondida com sucesso!', 'success');
                    carregarCotacoes();
                    carregarEstatisticasCotacoes();
                } else {
                    throw new Error(data.message || 'Erro ao responder cotação');
                }
            } catch (error) {
                console.error('Erro ao responder cotação:', error);
                mostrarMensagem(error.message, 'error');
            }
        }

        // Função para finalizar cotação
        async function finalizarCotacao(cotacaoId) {
            if (!confirm('Tem certeza que deseja finalizar esta cotação?')) {
                return;
            }

            try {
                console.log('Finalizando cotação:', cotacaoId);
                const response = await fetch(`/api/cotacoes/${cotacaoId}/finalizar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        acao: 'marcar_finalizada',
                        observacoes: 'Cotação finalizada via sistema'
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    mostrarMensagem('Cotação finalizada com sucesso!', 'success');
                    carregarCotacoes();
                    carregarEstatisticasCotacoes();
                } else {
                    throw new Error(data.message || 'Erro ao finalizar cotação');
                }
            } catch (error) {
                console.error('Erro ao finalizar cotação:', error);
                mostrarMensagem(error.message, 'error');
            }
        }

        // Função para ver detalhes da cotação
        async function verDetalhesCotacao(cotacaoId) {
            try {
                const response = await fetch(`/api/cotacoes/${cotacaoId}`);
                if (response.ok) {
                    const data = await response.json();
                    mostrarModalDetalhes(data.cotacao);
                } else {
                    throw new Error('Erro ao carregar detalhes da cotação');
                }
            } catch (error) {
                console.error('Erro ao carregar detalhes:', error);
                mostrarMensagem('Erro ao carregar detalhes da cotação', 'error');
            }
        }

        // Função para mostrar modal de detalhes
        function mostrarModalDetalhes(cotacao) {
            // Implementar modal de detalhes aqui
            alert(`Detalhes da cotação ${cotacao.numero_cotacao}\nStatus: ${cotacao.status_display}\nCliente: ${cotacao.cliente_nome}`);
        }

        // Função para mostrar mensagens
        function mostrarMensagem(mensagem, tipo = 'info') {
            // Criar elemento de notificação
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg ${
                tipo === 'success' ? 'bg-green-500 text-white' :
                tipo === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            notification.textContent = mensagem;
            
            document.body.appendChild(notification);
            
            // Remover após 3 segundos
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Função para atualizar página ao mudar de aba - REMOVIDA
        // Esta função estava causando reload automático e impedindo navegação
        
        // Inicialização quando DOM estiver carregado
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM carregado, inicializando sistema...');
            
            // Configurar navegação
            setupNavigationListeners();
            
            // Configurar formulários
            setupFormListeners();
            
            // Configurar botões
            setupButtonListeners();
            
            // Carregar dados iniciais
            loadEmpresas();
            loadDashboardStats();
            carregarInfoUsuario();
            atualizarHorario();
            
            // Configurar sistema de cotações
            console.log('Configurando sistema de cotações...');
            configurarBotaoCotacao();
            
            // Event listeners para modal de cotação
            const fecharModalBtn = document.getElementById('fechar-modal-cotacao');
            const cancelarBtn = document.getElementById('cancelar-cotacao');
            const formCotacao = document.getElementById('form-cotacao');
            const btnNovaCotacao = document.getElementById('btn-nova-cotacao');
            
            console.log('Elementos encontrados:', {
                fecharModalBtn: !!fecharModalBtn,
                cancelarBtn: !!cancelarBtn,
                formCotacao: !!formCotacao,
                btnNovaCotacao: !!btnNovaCotacao
            });           
            if (fecharModalBtn) {
                fecharModalBtn.addEventListener('click', fecharModalCotacao);
            }
            
            if (cancelarBtn) {
                cancelarBtn.addEventListener('click', fecharModalCotacao);
            }
            
            if (btnNovaCotacao) {
                btnNovaCotacao.addEventListener('click', abrirModalCotacao);
            }
            
            // Event listener para formulário de cotação
            if (formCotacao) {
                console.log('Configurando event listener para formulário de cotação...');
                formCotacao.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    console.log('Formulário de cotação submetido!');
                    
                    const formData = new FormData(formCotacao);
                    const data = {};
                    
                    // Converter FormData para objeto
                    for (let [key, value] of formData.entries()) {
                        if (key === 'seguro_adicional' || key === 'solicitar_seguro') {
                            data[key] = formData.has(key);
                        } else if (value !== '') {
                            data[key] = value;
                        }
                    }
                    
                    console.log('Dados do formulário:', data);
                    
                    // Mapear campos marítimos para campos esperados pelo backend
                    if (data.empresa_transporte === 'brcargo_maritimo') {
                        // Mapear dados do cliente marítimo
                        if (data.maritimo_razao_social) data.cliente_nome = data.maritimo_razao_social;
                        if (data.maritimo_cnpj) data.cliente_cnpj = data.maritimo_cnpj;
                        if (data.maritimo_telefone) data.cliente_contato_telefone = data.maritimo_telefone;
                        if (data.maritimo_email) data.cliente_contato_email = data.maritimo_email;
                        
                        // Mapear dados da carga marítima
                        if (data.maritimo_net_weight) data.carga_peso_kg = data.maritimo_net_weight;
                        if (data.maritimo_gross_weight) data.carga_peso_bruto = data.maritimo_gross_weight;
                        if (data.maritimo_cubagem) data.carga_dimensoes = data.maritimo_cubagem + ' m³';
                        
                        // Criar descrição da carga marítima
                        let descricaoMaritima = [];
                        if (data.maritimo_incoterm) descricaoMaritima.push('Incoterm: ' + data.maritimo_incoterm);
                        if (data.maritimo_fcl_lcl) descricaoMaritima.push('Tipo: ' + data.maritimo_fcl_lcl);
                        if (data.maritimo_tipo_container) descricaoMaritima.push('Container: ' + data.maritimo_tipo_container);
                        if (data.maritimo_quantidade_container) descricaoMaritima.push('Qtd: ' + data.maritimo_quantidade_container);
                        if (data.maritimo_porto_origem) descricaoMaritima.push('Origem: ' + data.maritimo_porto_origem);
                        if (data.maritimo_porto_destino) descricaoMaritima.push('Destino: ' + data.maritimo_porto_destino);
                        
                        data.carga_descricao = descricaoMaritima.join(' | ');
                        
                        // Definir origem e destino como portos
                        data.origem_endereco = data.maritimo_porto_origem || 'Porto não especificado';
                        data.destino_endereco = data.maritimo_porto_destino || 'Porto não especificado';
                        data.origem_cidade = 'Porto';
                        data.destino_cidade = 'Porto';
                        data.origem_estado = 'N/A';
                        data.destino_estado = 'N/A';
                        data.origem_cep = '00000-000';
                        data.destino_cep = '00000-000';
                    }
                    
                    console.log('Dados mapeados para o backend:', data);
                    
                    // Verificar se há campos obrigatórios vazios
                    const camposObrigatorios = formCotacao.querySelectorAll('[required]');
                    let camposVazios = [];
                    
                    camposObrigatorios.forEach(campo => {
                        if (!campo.value || campo.value.trim() === '') {
                            camposVazios.push(campo.name || campo.id);
                        }
                    });
                    
                    if (camposVazios.length > 0) {
                        console.log('Campos obrigatórios vazios:', camposVazios);
                        mostrarMensagem('Por favor, preencha todos os campos obrigatórios: ' + camposVazios.join(', '), 'error');
                        return;
                    }
                    
                    await criarCotacao(data);
                });
            } else {
                console.log('ERRO: Formulário de cotação não encontrado!');
            }
            
            // Event listeners para filtros de cotação
            const aplicarFiltrosBtn = document.getElementById('aplicar-filtros');
            if (aplicarFiltrosBtn) {
                aplicarFiltrosBtn.addEventListener('click', aplicarFiltrosCotacoes);
            }
            
            const limparFiltrosBtn = document.getElementById('limpar-filtros');
            if (limparFiltrosBtn) {
                limparFiltrosBtn.addEventListener('click', limparFiltrosCotacoes);
            }
            
            // Event listeners para radio buttons de empresa de transporte
            document.querySelectorAll('input[name="empresa_transporte"]').forEach(radio => {
                radio.addEventListener('change', toggleTransportFields);
            });
            
            // Inicializar estado dos campos
            toggleTransportFields();
        });

        // Atualizar horário a cada segundo
        setInterval(atualizarHorario, 1000);

        // Fechar modal ao clicar fora
        const modalCotacao = document.getElementById('modal-cotacao');
        if (modalCotacao) {
            modalCotacao.addEventListener('click', function(e) {
                if (e.target === modalCotacao) {
                    fecharModalCotacao();
                }
            });
        }

        // Função para controlar exibição dos campos específicos por tipo de transporte
        function toggleTransportFields() {
            const empresaTransporte = document.querySelector('input[name="empresa_transporte"]:checked');
            const camposMaritimo = document.getElementById('campos-maritimo');
            const camposPadrao = document.getElementById('campos-padrao');
            const camposOrigemDestino = document.getElementById('campos-origem-destino');
            const camposCargaPadrao = document.getElementById('campos-carga-padrao');
            
            if (empresaTransporte && empresaTransporte.value === 'brcargo_maritimo') {
                // Mostrar campos marítimos
                camposMaritimo.classList.remove('hidden');
                camposPadrao.classList.add('hidden');
                camposOrigemDestino.classList.add('hidden');
                camposCargaPadrao.classList.add('hidden');
                
                // Remover obrigatoriedade de TODOS os campos padrão (incluindo origem/destino)
                document.querySelectorAll('#campos-padrao input, #campos-padrao select, #campos-padrao textarea').forEach(field => {
                    field.required = false;
                });
                document.querySelectorAll('#campos-origem-destino input, #campos-origem-destino select, #campos-origem-destino textarea').forEach(field => {
                    field.required = false;
                });
                document.querySelectorAll('#campos-carga-padrao input, #campos-carga-padrao select, #campos-carga-padrao textarea').forEach(field => {
                    field.required = false;
                });
                
                // Tornar campos marítimos obrigatórios
                document.querySelectorAll('#campos-maritimo input[name*="maritimo_numero_cliente"], #campos-maritimo input[name*="maritimo_razao_social"], #campos-maritimo input[name*="maritimo_cnpj"], #campos-maritimo input[name*="maritimo_net_weight"], #campos-maritimo input[name*="maritimo_gross_weight"], #campos-maritimo input[name*="maritimo_cubagem"], #campos-maritimo select[name*="maritimo_incoterm"], #campos-maritimo select[name*="maritimo_fcl_lcl"], #campos-maritimo select[name*="maritimo_porto_origem"], #campos-maritimo select[name*="maritimo_porto_destino"]').forEach(field => {
                    field.required = true;
                });
            } else {
                // Mostrar campos padrão (rodoviário/aéreo)
                camposMaritimo.classList.add('hidden');
                camposPadrao.classList.remove('hidden');
                camposOrigemDestino.classList.remove('hidden');
                camposCargaPadrao.classList.remove('hidden');
                
                // Remover obrigatoriedade dos campos marítimos
                document.querySelectorAll('#campos-maritimo input, #campos-maritimo select, #campos-maritimo textarea').forEach(field => {
                    field.required = false;
                });
                
                // Restaurar obrigatoriedade dos campos padrão
                document.querySelectorAll('#campos-padrao input[name="cliente_nome"], #campos-padrao input[name="cliente_cnpj"]').forEach(field => {
                    field.required = true;
                });
                document.querySelectorAll('#campos-origem-destino input[name*="cep"], #campos-origem-destino input[name*="cidade"], #campos-origem-destino select[name*="estado"]').forEach(field => {
                    field.required = true;
                });
                document.querySelectorAll('#campos-carga-padrao textarea[name="carga_descricao"], #campos-carga-padrao input[name="carga_peso_kg"]').forEach(field => {
                    field.required = true;
                });
            }
        }

        // Função para controlar campos de container FCL
        function toggleContainerFields(value) {
            const camposFcl = document.getElementById('campos-fcl');
            
            if (value === 'FCL') {
                camposFcl.classList.remove('hidden');
                // Tornar campos de container obrigatórios
                document.querySelectorAll('#campos-fcl select, #campos-fcl input').forEach(field => {
                    field.required = true;
                });
            } else {
                camposFcl.classList.add('hidden');
                // Remover obrigatoriedade dos campos de container
                document.querySelectorAll('#campos-fcl select, #campos-fcl input').forEach(field => {
                    field.required = false;
                });
            }
        }

        // Função para controlar campos de seguro
        function toggleSeguroFields(checked) {
            const camposSeguro = document.getElementById('campos-seguro');
            const valorProdutoUsd = document.querySelector('input[name="valor_produto_usd"]');
            
            if (checked) {
                camposSeguro.classList.remove('hidden');
                valorProdutoUsd.required = true;
            } else {
                camposSeguro.classList.add('hidden');
                valorProdutoUsd.required = false;
            }
        }
    </script>
</body>
</html>

