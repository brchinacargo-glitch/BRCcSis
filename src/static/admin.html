<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administração - BRCcSis</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #228B22 0%, #DC143C 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal.hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <img src="logo-brchina.png" alt="BRChina" class="h-16 mr-4">
                    <div>
                        <h1 class="text-2xl font-bold">BRCcSis - Administração</h1>
                        <p class="text-sm text-green-200">v1.3.1</p>
                    </div>
                </div>
                <nav class="flex items-center space-x-6">
                    <a href="/" class="hover:text-green-200 transition-colors">
                        <i class="fas fa-home mr-2"></i>Dashboard
                    </a>
                    <button id="btn-logout" class="hover:text-green-200 transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>Sair
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-6 py-8">
        <!-- Tabs -->
        <div class="mb-8">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8">
                    <button id="tab-usuarios" class="tab-button active py-2 px-1 border-b-2 border-green-500 font-medium text-sm text-green-600">
                        <i class="fas fa-users mr-2"></i>Usuários
                    </button>
                    <button id="tab-logs" class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        <i class="fas fa-history mr-2"></i>Logs de Auditoria
                    </button>
                </nav>
            </div>
        </div>

        <!-- Usuários Tab -->
        <div id="content-usuarios" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Gerenciar Usuários</h2>
                    <div class="flex space-x-3">
                        <button id="btn-exportar-usuarios" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-download mr-2"></i>Exportar Usuários
                        </button>
                        <button id="btn-migrar-usuarios" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                            <i class="fas fa-upload mr-2"></i>Migrar Usuários
                        </button>
                        <button id="btn-novo-usuario" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>Novo Usuário
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuário</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Último Login</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="usuarios-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Usuários serão carregados aqui -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Logs Tab -->
        <div id="content-logs" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Logs de Auditoria</h2>
                    <button id="btn-exportar-logs" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-download mr-2"></i>Exportar Logs
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data/Hora</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuário</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ação</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Recurso</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detalhes</th>
                            </tr>
                        </thead>
                        <tbody id="logs-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Logs serão carregados aqui -->
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-4 flex justify-center">
                    <button id="btn-carregar-mais-logs" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        Carregar Mais
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Novo Usuário -->
    <div id="modal-usuario" class="modal hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">Novo Usuário</h3>
                <button id="btn-fechar-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="form-usuario" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome Completo</label>
                    <input type="text" id="nome_completo" name="nome_completo" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Usuário</label>
                    <input type="text" id="username" name="username" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="email" name="email" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input type="password" id="password" name="password" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Usuário</label>
                    <select id="tipo_usuario" name="tipo_usuario" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <option value="operador">Operador</option>
                        <option value="consultor">Consultor</option>
                        <option value="gerente">Gerente</option>
                        <option value="administrador">Administrador</option>
                    </select>
                </div>
                
                <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="btn-cancelar" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        Criar Usuário
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Editar Usuário -->
    <div id="modal-editar-usuario" class="modal hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">Editar Usuário</h3>
                <button id="btn-fechar-modal-editar" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="form-editar-usuario" class="space-y-4">
                <input type="hidden" id="edit-usuario-id">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome Completo</label>
                    <input type="text" id="edit-nome_completo" name="nome_completo" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Usuário</label>
                    <input type="text" id="edit-username" name="username" disabled
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="edit-email" name="email" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nova Senha (deixe em branco para manter)</label>
                    <input type="password" id="edit-nova_senha" name="nova_senha"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Usuário</label>
                    <select id="edit-tipo_usuario" name="tipo_usuario" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <option value="operador">Operador</option>
                        <option value="consultor">Consultor</option>
                        <option value="gerente">Gerente</option>
                        <option value="administrador">Administrador</option>
                    </select>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" id="edit-ativo" name="ativo" class="mr-2">
                    <label for="edit-ativo" class="text-sm font-medium text-gray-700">Usuário ativo</label>
                </div>
                
                <div id="error-message-edit" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="btn-cancelar-edit" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Migrar Usuários -->
    <div id="modal-migrar-usuarios" class="modal hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">Migrar Usuários</h3>
                <button id="btn-fechar-modal-migrar" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-3">
                    Selecione um arquivo JSON de backup de usuários para migrar para este sistema.
                </p>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                    <input type="file" id="arquivo-migrar-usuarios" accept=".json" class="hidden">
                    <label for="arquivo-migrar-usuarios" class="cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                        <p class="text-sm text-gray-600">Clique para selecionar arquivo JSON</p>
                        <p class="text-xs text-gray-400 mt-1">Apenas arquivos de backup de usuários</p>
                    </label>
                </div>
                
                <div id="arquivo-migrar-selecionado" class="hidden mt-3 p-3 bg-blue-50 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-file-alt text-blue-600 mr-2"></i>
                        <span id="nome-arquivo-migrar" class="text-sm text-blue-800"></span>
                        <button id="remover-arquivo-migrar" class="ml-auto text-red-500 hover:text-red-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="flex space-x-3">
                <button id="cancelar-migrar" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    Cancelar
                </button>
                <button id="confirmar-migrar" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <span id="texto-migrar">Migrar</span>
                    <div id="loading-migrar" class="loading hidden ml-2"></div>
                </button>
            </div>
            
            <div id="resultado-migrar" class="hidden mt-4 p-3 rounded-lg">
                <div id="conteudo-resultado-migrar"></div>
            </div>
        </div>
    </div>

    <script>
        let currentLogsPage = 1;

        // Gerenciamento de tabs
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                const tabId = this.id.replace('tab-', '');
                
                // Atualizar botões
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active', 'border-green-500', 'text-green-600');
                    btn.classList.add('border-transparent', 'text-gray-500');
                });
                
                this.classList.add('active', 'border-green-500', 'text-green-600');
                this.classList.remove('border-transparent', 'text-gray-500');
                
                // Mostrar conteúdo
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                document.getElementById(`content-${tabId}`).classList.remove('hidden');
                
                // Carregar dados se necessário
                if (tabId === 'usuarios') {
                    carregarUsuarios();
                } else if (tabId === 'logs') {
                    carregarLogs();
                }
            });
        });

        // Modal
        const modal = document.getElementById('modal-usuario');
        const btnNovoUsuario = document.getElementById('btn-novo-usuario');
        const btnFecharModal = document.getElementById('btn-fechar-modal');
        const btnCancelar = document.getElementById('btn-cancelar');

        btnNovoUsuario.addEventListener('click', () => {
            modal.classList.remove('hidden');
        });

        [btnFecharModal, btnCancelar].forEach(btn => {
            btn.addEventListener('click', () => {
                modal.classList.add('hidden');
                document.getElementById('form-usuario').reset();
                document.getElementById('error-message').classList.add('hidden');
            });
        });

        // Logout
        document.getElementById('btn-logout').addEventListener('click', async () => {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                console.error('Erro no logout:', error);
            }
        });

        // Carregar usuários
        async function carregarUsuarios() {
            try {
                const response = await fetch('/api/auth/usuarios');
                const usuarios = await response.json();
                
                const tbody = document.getElementById('usuarios-table-body');
                tbody.innerHTML = '';
                
                usuarios.forEach(usuario => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${usuario.nome_completo}</div>
                            <div class="text-sm text-gray-500">${usuario.username}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${usuario.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getTipoUsuarioClass(usuario.tipo_usuario)}">
                                ${usuario.tipo_usuario}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${usuario.ativo ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${usuario.ativo ? 'Ativo' : 'Inativo'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${usuario.ultimo_login ? new Date(usuario.ultimo_login).toLocaleString('pt-BR') : 'Nunca'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="text-indigo-600 hover:text-indigo-900 mr-3" onclick="editarUsuario(${usuario.id})">Editar</button>
                            <button class="text-${usuario.ativo ? 'red' : 'green'}-600 hover:text-${usuario.ativo ? 'red' : 'green'}-900" onclick="toggleStatusUsuario(${usuario.id})">
                                ${usuario.ativo ? 'Desativar' : 'Ativar'}
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Erro ao carregar usuários:', error);
            }
        }

        // Carregar logs
        async function carregarLogs(page = 1) {
            try {
                const response = await fetch(`/api/auth/logs?page=${page}&per_page=20`);
                const data = await response.json();
                
                const tbody = document.getElementById('logs-table-body');
                if (page === 1) {
                    tbody.innerHTML = '';
                }
                
                data.logs.forEach(log => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${new Date(log.timestamp).toLocaleString('pt-BR')}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${log.usuario_nome}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getAcaoClass(log.acao)}">
                                ${log.acao}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${log.recurso}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${log.ip_address || '-'}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${log.detalhes || '-'}</td>
                    `;
                    tbody.appendChild(tr);
                });
                
                // Mostrar/ocultar botão "Carregar Mais"
                const btnCarregarMais = document.getElementById('btn-carregar-mais-logs');
                if (page >= data.pages) {
                    btnCarregarMais.style.display = 'none';
                } else {
                    btnCarregarMais.style.display = 'block';
                }
                
                currentLogsPage = page;
            } catch (error) {
                console.error('Erro ao carregar logs:', error);
            }
        }

        // Carregar mais logs
        document.getElementById('btn-carregar-mais-logs').addEventListener('click', () => {
            carregarLogs(currentLogsPage + 1);
        });

        // Criar usuário
        document.getElementById('form-usuario').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const userData = Object.fromEntries(formData);
            
            try {
                const response = await fetch('/api/auth/usuarios', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    modal.classList.add('hidden');
                    e.target.reset();
                    carregarUsuarios();
                    alert('Usuário criado com sucesso!');
                } else {
                    const errorDiv = document.getElementById('error-message');
                    errorDiv.textContent = result.error;
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Erro ao criar usuário:', error);
                const errorDiv = document.getElementById('error-message');
                errorDiv.textContent = 'Erro de conexão. Tente novamente.';
                errorDiv.classList.remove('hidden');
            }
        });

        // Funções auxiliares
        function getTipoUsuarioClass(tipo) {
            const classes = {
                'administrador': 'bg-purple-100 text-purple-800',
                'gerente': 'bg-blue-100 text-blue-800',
                'operador': 'bg-green-100 text-green-800',
                'consultor': 'bg-gray-100 text-gray-800'
            };
            return classes[tipo] || 'bg-gray-100 text-gray-800';
        }

        function getAcaoClass(acao) {
            if (acao.includes('LOGIN_SUCESSO')) return 'bg-green-100 text-green-800';
            if (acao.includes('LOGIN_FALHA') || acao.includes('LOGIN_BLOQUEADO')) return 'bg-red-100 text-red-800';
            if (acao.includes('CRIAR') || acao.includes('ATUALIZAR')) return 'bg-blue-100 text-blue-800';
            if (acao.includes('EXCLUIR')) return 'bg-red-100 text-red-800';
            return 'bg-gray-100 text-gray-800';
        }

        // Modal edição
        const modalEditar = document.getElementById('modal-editar-usuario');
        const btnFecharModalEditar = document.getElementById('btn-fechar-modal-editar');
        const btnCancelarEdit = document.getElementById('btn-cancelar-edit');

        [btnFecharModalEditar, btnCancelarEdit].forEach(btn => {
            btn.addEventListener('click', () => {
                modalEditar.classList.add('hidden');
                document.getElementById('form-editar-usuario').reset();
                document.getElementById('error-message-edit').classList.add('hidden');
            });
        });

        // Função para editar usuário
        window.editarUsuario = async function(usuarioId) {
            try {
                const response = await fetch('/api/auth/usuarios');
                const usuarios = await response.json();
                const usuario = usuarios.find(u => u.id === usuarioId);
                
                if (usuario) {
                    document.getElementById('edit-usuario-id').value = usuario.id;
                    document.getElementById('edit-nome_completo').value = usuario.nome_completo;
                    document.getElementById('edit-username').value = usuario.username;
                    document.getElementById('edit-email').value = usuario.email;
                    document.getElementById('edit-tipo_usuario').value = usuario.tipo_usuario;
                    document.getElementById('edit-ativo').checked = usuario.ativo;
                    document.getElementById('edit-nova_senha').value = '';
                    
                    modalEditar.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Erro ao carregar dados do usuário:', error);
                alert('Erro ao carregar dados do usuário');
            }
        };

        // Função para toggle status
        window.toggleStatusUsuario = async function(usuarioId) {
            if (confirm('Tem certeza que deseja alterar o status deste usuário?')) {
                try {
                    const response = await fetch(`/api/auth/usuarios/${usuarioId}/toggle-status`, {
                        method: 'POST'
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        alert(result.message);
                        carregarUsuarios();
                    } else {
                        alert(result.error);
                    }
                } catch (error) {
                    console.error('Erro ao alterar status:', error);
                    alert('Erro ao alterar status do usuário');
                }
            }
        };

        // Editar usuário
        document.getElementById('form-editar-usuario').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const usuarioId = document.getElementById('edit-usuario-id').value;
            const formData = new FormData(e.target);
            const userData = Object.fromEntries(formData);
            userData.ativo = document.getElementById('edit-ativo').checked;
            
            try {
                const response = await fetch(`/api/auth/usuarios/${usuarioId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    modalEditar.classList.add('hidden');
                    e.target.reset();
                    carregarUsuarios();
                    alert('Usuário atualizado com sucesso!');
                } else {
                    const errorDiv = document.getElementById('error-message-edit');
                    errorDiv.textContent = result.error;
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Erro ao editar usuário:', error);
                const errorDiv = document.getElementById('error-message-edit');
                errorDiv.textContent = 'Erro de conexão. Tente novamente.';
                errorDiv.classList.remove('hidden');
            }
        });

        // Carregar dados iniciais
        carregarUsuarios();
        
        // Event listeners para migração de usuários
        document.getElementById('btn-migrar-usuarios').addEventListener('click', function() {
            document.getElementById('modal-migrar-usuarios').classList.remove('hidden');
        });
        
        document.getElementById('btn-fechar-modal-migrar').addEventListener('click', function() {
            document.getElementById('modal-migrar-usuarios').classList.add('hidden');
            resetarModalMigrar();
        });
        
        document.getElementById('cancelar-migrar').addEventListener('click', function() {
            document.getElementById('modal-migrar-usuarios').classList.add('hidden');
            resetarModalMigrar();
        });
        
        // Event listeners para arquivo de migração
        document.getElementById('arquivo-migrar-usuarios').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('nome-arquivo-migrar').textContent = file.name;
                document.getElementById('arquivo-migrar-selecionado').classList.remove('hidden');
                document.getElementById('confirmar-migrar').disabled = false;
            }
        });
        
        document.getElementById('remover-arquivo-migrar').addEventListener('click', function() {
            document.getElementById('arquivo-migrar-usuarios').value = '';
            document.getElementById('arquivo-migrar-selecionado').classList.add('hidden');
            document.getElementById('confirmar-migrar').disabled = true;
        });
        
        // Confirmar migração
        document.getElementById('confirmar-migrar').addEventListener('click', async function() {
            const fileInput = document.getElementById('arquivo-migrar-usuarios');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Selecione um arquivo para migrar.');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            const btn = document.getElementById('confirmar-migrar');
            const texto = document.getElementById('texto-migrar');
            const loading = document.getElementById('loading-migrar');
            
            btn.disabled = true;
            texto.textContent = 'Migrando...';
            loading.classList.remove('hidden');
            
            try {
                const response = await fetch('/api/auth/migrar-usuarios', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                const resultadoDiv = document.getElementById('resultado-migrar');
                const conteudoDiv = document.getElementById('conteudo-resultado-migrar');
                
                if (response.ok) {
                    resultadoDiv.className = 'mt-4 p-3 rounded-lg bg-green-50 border border-green-200';
                    conteudoDiv.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-600 mr-2"></i>
                            <span class="text-green-800 font-medium">Migração concluída!</span>
                        </div>
                        <div class="mt-2 text-sm text-green-700">
                            <p>• ${result.usuarios_migrados} usuários criados</p>
                            <p>• ${result.usuarios_existentes} usuários já existiam</p>
                            ${result.erros.length > 0 ? `<p class="text-red-600">• ${result.erros.length} erros encontrados</p>` : ''}
                        </div>
                    `;
                    
                    // Recarregar lista de usuários
                    setTimeout(() => {
                        carregarUsuarios();
                        document.getElementById('modal-migrar-usuarios').classList.add('hidden');
                        resetarModalMigrar();
                    }, 3000);
                } else {
                    resultadoDiv.className = 'mt-4 p-3 rounded-lg bg-red-50 border border-red-200';
                    conteudoDiv.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-circle text-red-600 mr-2"></i>
                            <span class="text-red-800 font-medium">Erro na migração</span>
                        </div>
                        <div class="mt-2 text-sm text-red-700">
                            ${result.error}
                        </div>
                    `;
                }
                
                resultadoDiv.classList.remove('hidden');
                
            } catch (error) {
                console.error('Erro na migração:', error);
                alert('Erro ao migrar usuários. Verifique a conexão.');
            } finally {
                btn.disabled = false;
                texto.textContent = 'Migrar';
                loading.classList.add('hidden');
            }
        });
        
        // Event listener para exportar usuários
        document.getElementById('btn-exportar-usuarios').addEventListener('click', async function() {
            try {
                const response = await fetch('/api/auth/exportar-usuarios');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `usuarios_backup_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    alert('Backup de usuários exportado com sucesso!');
                } else {
                    const errorData = await response.json();
                    alert(`Erro ao exportar usuários: ${errorData.error}`);
                }
            } catch (error) {
                console.error('Erro ao exportar usuários:', error);
                alert('Erro ao exportar usuários. Verifique a conexão.');
            }
        });
        
        function resetarModalMigrar() {
            document.getElementById('arquivo-migrar-usuarios').value = '';
            document.getElementById('arquivo-migrar-selecionado').classList.add('hidden');
            document.getElementById('confirmar-migrar').disabled = true;
            document.getElementById('resultado-migrar').classList.add('hidden');
            document.getElementById('texto-migrar').textContent = 'Migrar';
            document.getElementById('loading-migrar').classList.add('hidden');
        }
        
        // Event listener para exportar logs
        document.getElementById('btn-exportar-logs').addEventListener('click', async function() {
            try {
                const response = await fetch('/api/auth/logs/export');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `logs_auditoria_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    alert('Logs exportados com sucesso!');
                } else {
                    const errorData = await response.json();
                    alert(`Erro ao exportar logs: ${errorData.error}`);
                }
            } catch (error) {
                console.error('Erro ao exportar logs:', error);
                alert('Erro ao exportar logs. Verifique a conexão.');
            }
        });
    </script>

    <!-- Rodapé -->
    <footer class="bg-gray-800 text-white py-4 mt-8">
        <div class="container mx-auto px-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-2 md:mb-0">
                    <p class="text-sm">© 2024 BRCcSis - Sistema de Gestão Logística</p>
                </div>
                <div class="flex items-center space-x-4 text-sm">
                    <span id="usuario-logado" class="flex items-center">
                        <i class="fas fa-user mr-2"></i>
                        <span id="nome-usuario">Carregando...</span>
                    </span>
                    <span id="horario-sistema" class="flex items-center">
                        <i class="fas fa-clock mr-2"></i>
                        <span id="horario-atual">--:--</span>
                    </span>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Função para carregar informações do usuário logado
        async function carregarInfoUsuario() {
            try {
                const response = await fetch('/api/auth/user-info');
                if (response.ok) {
                    const userInfo = await response.json();
                    document.getElementById('nome-usuario').textContent = userInfo.nome || userInfo.username;
                } else {
                    document.getElementById('nome-usuario').textContent = 'Usuário';
                }
            } catch (error) {
                console.error('Erro ao carregar info do usuário:', error);
                document.getElementById('nome-usuario').textContent = 'Usuário';
            }
        }

        // Função para atualizar horário (Brasília)
        function atualizarHorario() {
            const agora = new Date();
            // Converter para horário de Brasília (UTC-3)
            const brasilia = new Date(agora.toLocaleString("en-US", {timeZone: "America/Sao_Paulo"}));
            const horarioFormatado = brasilia.toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('horario-atual').textContent = horarioFormatado;
        }

        // Inicializar funcionalidades do rodapé
        document.addEventListener('DOMContentLoaded', function() {
            carregarInfoUsuario();
            atualizarHorario();
            
            // Atualizar horário a cada segundo
            setInterval(atualizarHorario, 1000);
        });
    </script>
</body>
</html>

